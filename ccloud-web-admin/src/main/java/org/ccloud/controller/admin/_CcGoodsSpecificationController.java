/**
 * Copyright (c) 2015-2016, Eric Huang 黄鑫 (hx50859042@gmail.com).
 *
 * Licensed under the GNU Lesser General Public License (LGPL) ,Version 3.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.gnu.org/licenses/lgpl-3.0.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ccloud.controller.admin;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.ccloud.core.JBaseCRUDController;
import org.ccloud.core.interceptor.ActionCacheClearInterceptor;
import org.ccloud.interceptor.UCodeInterceptor;
import org.ccloud.route.RouterMapping;
import org.ccloud.route.RouterNotAllowConvert;
import org.ccloud.utils.AttachmentUtils;
import org.ccloud.utils.StringUtils;
import org.ccloud.model.CcGoodsSpecification;
import org.ccloud.model.CcGoodsSpecificationValue;
import org.ccloud.model.query.CcGoodsSpecificationQuery;
import org.ccloud.model.query.CcGoodsSpecificationValueQuery;

import com.google.common.collect.ImmutableMap;
import com.jfinal.aop.Before;
import com.jfinal.kit.StrKit;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.upload.UploadFile;
/**
 * Generated by 九毫米(http://9mm.tech).
 */
@RouterMapping(url = "/admin/specification", viewPath = "/WEB-INF/admin/specification")
@Before(ActionCacheClearInterceptor.class)
@RouterNotAllowConvert
public class _CcGoodsSpecificationController extends JBaseCRUDController<CcGoodsSpecification> { 

	public void list() {
		
        String keyword = getPara("k");
        if (StrKit.notBlank(keyword)) {
            keyword = StringUtils.urlDecode(keyword);
            setAttr("k", keyword);
        }

        Page<CcGoodsSpecification> page = CcGoodsSpecificationQuery.me().paginate(getPageNumber(), getPageSize(), keyword, "create_date");
        List<CcGoodsSpecification> ccsList = page.getList();
        List<CcGoodsSpecificationValue> childList = new ArrayList<>();
        for (CcGoodsSpecification ccGoodsSpecification : ccsList) {
			childList = CcGoodsSpecificationValueQuery.me().findByParentId(ccGoodsSpecification.getId());
			ccGoodsSpecification.setChildList(childList);
			break;
		}
        Map<String, Object> map = ImmutableMap.of("total", page.getTotalRow(), "rows", ccsList, "childList", childList);
        renderJson(map);
		
	}
	
	@Override
	public void save() {
		
		List<UploadFile> uploadFiles = getFiles();
		keepPara();
		final CcGoodsSpecification ccGoodsSpecification = getModel(CcGoodsSpecification.class);
		String [] valueName = getParaValues("mytext[]");
		String [] orderList = getParaValues("order[]");
		String [] childIdList = getParaValues("childId[]");
		if (ccGoodsSpecification.getId() == null) {
			ccGoodsSpecification.saveOrUpdate();
		} else {
			List<CcGoodsSpecificationValue> oldIdList = CcGoodsSpecificationValueQuery.me().findByParentId(ccGoodsSpecification.getId());
			if (childIdList == null) {
				childIdList = new String[] {}; 
			}
			List<String> deleteIds = getDiffrent(oldIdList, childIdList);
 			CcGoodsSpecificationValueQuery.me().batchDelete(deleteIds);
			ccGoodsSpecification.saveOrUpdate();
		}
		if (valueName != null) {
			for (int i = 0; i < valueName.length; i++) {
				if (StringUtils.isBlank(valueName[i])) {
					continue;
				}
				CcGoodsSpecificationValue value = new CcGoodsSpecificationValue();
				value.setName(valueName[i]);
				if (StringUtils.isNotBlank(childIdList[i])) {
					value.setId(childIdList[i]);
				}
				if (uploadFiles.size() > 0) {
					value.setImagePath(AttachmentUtils.moveFile(uploadFiles.get(i)).replace("\\", "/"));
				}
				if (StringUtils.isNotBlank(orderList[i])) {
					value.setOrderList(Integer.parseInt(orderList[i]));
				}
				value.setGoodsSpecificationId(ccGoodsSpecification.getId());
				value.saveOrUpdate();
			}
		}
				
		renderAjaxResultForSuccess("ok");
	}
	
	/** 
	 * 获取两个List的不同元素(耗时最低)
	 * @param list1 
	 * @param list2 
	 * @return 
	 */  
	private static List<String> getDiffrent(List<CcGoodsSpecificationValue> csvList, String [] childIdList) {
		List<String> list1 = new ArrayList<String>();
		List<String> list2 = Arrays.asList(childIdList);
		for (CcGoodsSpecificationValue csv : csvList) {
			list1.add(csv.getId());
		}
		List<String> diff = new ArrayList<String>();  
	    List<String> maxList = list1;  
	    List<String> minList = list2;  
	    if(list2.size()>list1.size()) {  
	         maxList = list2;  
	         minList = list1;  
	    }  
	    Map<String,Integer> map = new HashMap<String,Integer>(maxList.size());  
	    for (String string : maxList) {  
	        map.put(string, 1);  
	    }  
	    for (String string : minList) {  
	        if(map.get(string)!=null) {  
	            map.put(string, 2);  
	            continue;  
	        }  
	        diff.add(string);  
	    }  
	    for(Map.Entry<String, Integer> entry:map.entrySet()) {  
	        if(entry.getValue()==1) {  
	            diff.add(entry.getKey());  
	        }  
	    }  
	    return diff;  
	}  	
	
	@Override
	public void edit() {
		String id = getPara("id");
		if (id != null) {
			CcGoodsSpecification ccGoodsSpecification = CcGoodsSpecificationQuery.me().findById(id);
			setAttr("ccGoodsSpecification", ccGoodsSpecification);
			
			List<CcGoodsSpecificationValue> childList = CcGoodsSpecificationValueQuery.me().findByParentId(ccGoodsSpecification.getId());
			setAttr("childList", childList);
		}
	}
	
	@Override
	public void delete() {
		String id = getPara("id");
		final CcGoodsSpecification ccGoodsSpecification = CcGoodsSpecificationQuery.me().findById(id);
		ccGoodsSpecification.delete();
		renderAjaxResultForSuccess("删除成功");
		if (ccGoodsSpecification != null) {
            List<String> ids = new ArrayList<>();
            List<CcGoodsSpecificationValue> cgsList = CcGoodsSpecificationValueQuery.me().findByParentId(id);
            for (CcGoodsSpecificationValue spv : cgsList) {
				ids.add(spv.getId());
			}
            if (ids.size() > 0) {
                int count = CcGoodsSpecificationValueQuery.me().batchDelete(ids);
                if (count > 0) {
                    renderAjaxResultForSuccess("删除成功");
                } else {
                    renderAjaxResultForError("规格值删除失败");
                }
            }
		}
	}	
	
	@Before(UCodeInterceptor.class)
	public void batchDelete() {
		
		String[] ids = getParaValues("dataItem");
		int count = CcGoodsSpecificationQuery.me().batchDelete(ids);
		if (count > 0) {
			renderAjaxResultForSuccess("删除成功");
		} else {
			renderAjaxResultForError("删除失败!");
		}
		
	}
}
