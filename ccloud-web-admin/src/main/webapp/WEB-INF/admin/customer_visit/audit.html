<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	
	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro css>
    .gallery {
        position: fixed;
        margin: 0 auto;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 1920px;
        height: 1000px;
        background-color: rgba(102,102,102,0.6);
        display: none;
        z-index: 1000;
    }
    .gallery__img {
        position: fixed;
        margin: -200px -100px;
        left: 40%;
        top: 50%;
        z-index: 11;
    }
</#macro>

<#macro script>

    var $gallery = $("#gallery"), $galleryImg = $("#galleryImg");
    var $uploaderFiles = $('#uploaderFiles');

    $(function(){
        var index;
        $(document).on("click", ".uploaderFiles li", function() {
            var src = $(this).children("img").attr("src");
            var img = " <img src=" + src + " class=' img-responsive' style='height:400px' >" ;
            index = $(this).index();
            $galleryImg.empty();
            $galleryImg.append(img);
            $gallery.fadeIn(100);
        });

        $gallery.on("click", function() {
            $gallery.fadeOut(100);
        });
    });

	var $form = $("#form");
	$(function() {
	if('${(taskId)}' == 'null' || '${(taskId)}' == '') {
			$("#do_submit").hide();
			$("#do_submit").hide();
			$("#auditComment").hide();
		}
	})
	function doSubmit(value){
	var l = Ladda.create( document.querySelector( '#do_submit' ) );
	var lt = Ladda.create( document.querySelector( '#_do_submit' ) );
	$('#status').val(value);
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var comment = $('#_comment').val();
				if (value == 0 && (comment == null || comment == '')) {
			        toastr.error('请输入拒绝原因','操作失败');
			        return false;
				}
				l.start();
				lt.start();
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
				setTimeout( function(){
						l.stop();
						lt.stop();
						location.href = '${CPATH}/admin/index';
								}, 2 * 1000 );
			},
			error : function() {
				l.stop();
				lt.stop();
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>拜访审核</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	    <li>客户管理</li>
		<li class="active">审核拜访</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">客户拜访审核</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/customerVisit/complete" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="id" value="${(customerVisit.id)!}">
			<input type="hidden" name="taskId" value="${(taskId)!}">
			<input type="hidden" name="status" id="status">
			<div class="row form-horizontal">
                <div class="gallery" id="gallery">
                    <div class="gallery__img" id="galleryImg"></div>
                </div>
				<div class="form-group">
				    <div class="col-sm-5">
						<label class="control-label col-sm-4">客户名称:</label>
						<div class="input-group col-sm-8">
						    <p class="form-control-static">${(customerVisit.customer_name)!}</p>
						</div>
					</div>
					<div class="col-sm-5">
						<label class="control-label col-sm-4">客户类型:</label>
						<div class="input-group col-sm-8">
							<p class="form-control-static">
								${(cTypeName)!}
							</p>
						</div>
					</div>
				</div>
                
                <div class="form-group">
					<div class="col-sm-5">
						<label class="control-label col-sm-4">联系人:</label>
						<div class="input-group col-sm-8">
							<p class="form-control-static">${(customerVisit.contact)!}</p>
						</div>
					</div>
                    <div class="col-sm-5">
                        <label class="control-label col-sm-4">手机号:</label>
                        <div class="input-group col-sm-8">
                            <p class="form-control-static">${(customerVisit.mobile)!}</p>
                        </div>
                    </div>
                </div>

				<div class="form-group">
					<div class="col-sm-5">
						<label class="control-label col-sm-4">问题类型：</label>
						<div class="input-group col-sm-8">
							<p class="form-control-static">${(customerVisit.typeName)!}</p>
						</div>
					</div>
					<div class="col-sm-5">
						<label class="control-label col-sm-4">拜访时间：</label>
						<div class="input-group col-sm-8">
							<p class="form-control-static">${(customerVisit.create_date?string('yyyy-MM-dd HH:mm'))!}</p>
						</div>
					</div>
				</div>
				<#if expenseDetail??>
					<div class="form-group">
	                    <div class="col-sm-5">
	                        <label class="control-label col-sm-4">费用类型：</label>
	                        <div class="input-group col-sm-8">
	                            <p class="form-control-static">${(expenseDetail.expenseDetailName)!}</p>
	                        </div>
	                    </div>
	                </div>
                </#if>
                <div class="form-group">
                    <div class="col-sm-5">
                        <label class="control-label col-sm-4">描述：</label>
                        <div class="input-group col-sm-8">
                            <p class="form-control-static">${(customerVisit.question_desc)!}</p>
                        </div>
                    </div>
                </div>

				<label class="control-label col-sm-2">拜访图片：</label>
				<div class="form-group">

                           		<#if activityExecutes?size gt 0>
	                           		<#list activityExecutes as list>
	                           			<div class="col-sm-10">
	                           			<label class="control-label col-sm-2">${list.remark}</label>
		                                <ul id="uploaderFiles" class="uploaderFiles">
		                                 <#if (customerVisit.photoList) ??>
			                                <#list customerVisit.photoList as bean>
		                            			<#if (list.orderList == bean.orderList)>
			                                   		<li class="thumbnail col-sm-3"><img src="${(bean.savePath)}" class=" img-responsive" style="width: 100%; height: 200px "> </li>
		                            			</#if>
			                                </#list>
				                            </#if>
		                                </ul>
		                                </div>
		                       		 </#list>
		                       	<#else>
		                       		<div class="col-sm-10">
		                       			<label class="control-label col-sm-2"></label>
		                                <ul id="uploaderFiles" class="uploaderFiles">
		                                 <#if (customerVisit.photoList) ??>
			                                <#list customerVisit.photoList as bean>
			                                   		<li class="thumbnail col-sm-3"><img src="${(bean.savePath)}" class=" img-responsive" style="width: 100%; height: 200px "> </li>
			                                </#list>
				                         </#if>
		                              </ul>
		                            </div>
		                       	</#if>

						<!--<div class="input-group col-sm-8">-->

						<!--</div>-->
				</div>

				<div class="form-group col-sm-10" id="auditComment">
					<label for="_remark" class="col-sm-2 control-label">审核评论:</label>
					<div class="input-group col-sm-10">
						<textarea class="form-control" rows="3" name="comment" id="_comment" placeholder="在此输入评论内容"></textarea>
					</div>
				</div>

			</div>
		</form>
	</div>
	<div class="box-footer">
		<@shiro.hasPermission name="/admin/customerVisit/audit,/admin/all">
		<button  id="do_submit" onclick="doSubmit(1)" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">通过</button >
		<button id="_do_submit" onclick="doSubmit(0)" class="btn btn-sm btn-danger btn-flat ladda-button" data-style="expand-right">拒绝</button>
		</@shiro.hasPermission>
		<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
	</div>
</section>

</@layout>