<#include "../_inc/_layout.html"/>

<#macro script_import>
    <!-- bootstrapValidator -->
    <script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
    <!-- bootstrap-table -->
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>    
    <!-- audio -->
    <script src="${CPATH}/static/plugins/audiojs/audio.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrap-datetimepicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
    <!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <!-- bootstrapValidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
</#macro>

<#macro script>
    var $table = $("#_customer_visit_table");
    var url = '${CPATH}/admin/customerVisit/list';
    var auditInfo = new Array();
    var paramId = 0;
    var batchFlg = true;

    $(function() {
    	jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
        jQuery.mm.initEditTable('#_customer_visit_table', url, initParams, initFields(), null);
        initCustomerType();
        initQuestionType();
        initStatus();
        initBizUser();
    });



    $("#search-submit").click(function() {
        $table.bootstrapTable('refresh');
    });

    var initParams = function(params) {
        var keyword = $('#post-search-input').val();
        var customerType = $('#customer_type').val();
        var questionType = $('#question_type').val();
        var bizUser = $('#bizUser').val();
        var status = $('#status').val();
        var createDate = $('#startDate').val();
        var param = {
            size: params.limit,
            page: params.offset/params.limit + 1,
            k: keyword,
            questionType: questionType,
            customerType: customerType,
            status: status,
            createDate: createDate,
            bizUser : bizUser
        };
        return param;
    };

    var initFields = function() {
        var fields =
            [
            {field: "customer_name", title: "客户", align: "center", width: '7%', edit:false},
            {field: "customer_type", title: "客户类型", align: "center", width: '8%', edit:false},
            {field: "question_type", title: "问题类型", align: "center", width: '5%',
				formatter: function(value, row, rowIndex) {
	                if(value == "100501") return "客户拜访";
	                if(value == "100502") return "网点开发";
	                if(value == "100503") return "氛围布置";
	                if(value == "100504") return "产品陈列";
	                if(value == "100505") return "客情维护";	                	                
				},
				edit: false
			},
            {field: "question_desc", title: "问题描述", align: "center", width: '28%', edit: false},
            {field: "visit_user", title: "拜访人", align: "center", width: '5%',edit: false},
            {field: "status", title: "状态", align: "center", width: '8%',
            formatter: function (value, row, rowIndex){
                if(value == "100101") return "正常";
                if(value == "100102") return "待审核";
                if(value == "100103") return "审核拒绝";
                if(value == "100104") return "待补录";
            }, edit: false},
            {field: "create_date", title: "拜访时间", align: "center", width: '12%', edit: false},
            {field: "action", title: "操作", align: "center", width: '10%',
            formatter: function(value, row, rowIndex) {
                var audit = [row.location,row.lng,row.lat,row.advice,row.solution,row.status,row.photo,row.vedio];
                auditInfo[row.id] = audit;
                var strHtml = '';
                if(row.status == "100102") {
                    strHtml = '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="审核拜访结果" onclick="audit(\''+row.id+'\')">审核</a> ';
                }
                strHtml += '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="查看审核" onclick="audit(\''+row.id+'\')">查看</a> ';
                return strHtml;
                },
                edit:false
            }
        ];
        return fields;
    };

    function audit(id, taskId) {
        var url = "${(CPATH)!}/admin/customerVisit/audit?id=" + id;
        location.href = url;
    };

    var initCustomerType = function () {
        var strHtml = "";
        var url = '${CPATH}/admin/customerVisit/queryCustomerType';
        $.ajax({
        url: url,
        type: 'post',
        success: function (result) {
            var customerType = result.data;
            strHtml = '<option selected="selected" value="">客户类型</option>';
            for(index in customerType){
                var row = customerType[index].columns;
                strHtml +='<option value="'+row.id+'">'+row.name+'</option>';
            }
            $("#customer_type").html(strHtml);
        }
        });
    }

    var initQuestionType = function () {
        var strHtml = "";
        var url = '${CPATH}/admin/customerVisit/queryQuestionType';
        $.ajax({
            url: url,
            type: 'post',
            success: function (result) {
                var questionType = result.data;
                strHtml = '<option selected="selected" value="">问题类型</option>';
                for(index in questionType){
                    var row = questionType[index];
                    strHtml +='<option value="'+row.value+'">'+row.name+'</option>';
                }
                $("#question_type").html(strHtml);
            }
        });
    }

    var initStatus = function () {
        var strHtml = "";
        strHtml = '<option selected="selected" value="">拜访状态</option>';
        strHtml +='<option value="100101"> 正常 </option>';
        strHtml +='<option value="100102"> 待审核 </option>';
        strHtml +='<option value="100103"> 审核拒绝 </option>';
        strHtml +='<option value="100104"> 待补录 </option>';
        $("#status").html(strHtml);
    };
    
    var initBizUser = function(){
    	 var strHtml = "";
        var url = '${CPATH}/admin/customerVisit/queryBizUser';
        $.ajax({
            url: url,
            type: 'post',
            success: function (data) {
                strHtml = '<option selected="selected" value="">全部业务员</option>';
                for(var i = 0 ; i < data.length ; i++){
                    strHtml +='<option value="'+data[i].userId+'">'+data[i].bizUser+'</option>';
                }
                $("#bizUser").html(strHtml);
            }
        });
    }

	$("#exportVisit").click(function(){

    layer.confirm('确定导出吗？',{
        btn : ['确定', '取消']},
        function() {
            layer.closeAll();
            var keyword = $('#post-search-input').val();
            var customerType = $('#customer_type').val();
            var questionType = $('#question_type').val();
            var status = $('#status').val();
            var bizUser = $("#bizUser").val()
            layer.load(1, {
                shade: [0.4,'#000']
            });
            window.open("${CPATH}/admin/customerVisit/exportVisit?k="+keyword+"&questionType="+questionType+"&customerType="+customerType+"&status="+status+"&bizUser="+bizUser,"_parent","","");
            setTimeout(function() {
                layer.closeAll();
            }, 1000);
        },
        function() {
            layer.close();
        }
    );
    });


</#macro>

<@layout active_id=p child_active_id=c>
<section class="content-header">
    <h1>客户拜访列表</h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">客户管理</a></li>
        <li class="active">客户拜访列表</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="row content-row">
	    <form class="form-horizontal" role="form" id="form">
	        <div class="form-group">
                <div class="col-sm-4">
                	<label class="control-label col-sm-4">客户类型:</label>
                	<div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" name="customer_type" id="customer_type" style="float: left;padding-right:5px;margin-right:5px;">
                		</select>
                    </div>
                 </div>
                 <div class="col-sm-4">
                	<label class="control-label col-sm-4">问题类型:</label>
                	<div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" name="question_type" id="question_type" style="float: left;padding-right:5px;margin-right:5px;">
               			</select>
                    </div>
                 </div>
                 <div class="col-sm-4">
                	<label class="control-label col-sm-4">拜访状态:</label>
                	<div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" name="status" id="status" style="float: left;padding-right:5px;margin-right:5px;">
              	  		</select>
                    </div>
                 </div>
             </div>
           <div class="form-group">
           		 <div class="col-sm-4">
                	<label class="control-label col-sm-4">业务员:</label>
                	<div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" name="bizUser" id="bizUser" style="float: left;padding-right:5px;margin-right:5px;">
               			</select>
                    </div>
                 </div>
                <div class="col-sm-4">
                	<label class="control-label col-sm-4">客户:</label>
                	<div class="col-sm-8 input-group input-group-sm">
                        <input id="post-search-input" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称"  style="width:100%;">
                    </div>
                </div>
				<div class="col-sm-4">
					<label class="control-label col-sm-4">拜访日期:</label>
					<div class="col-sm-8 input-group input-group-sm">
						<input id="startDate" class="form-control" value="${startDate!}" name="startDate" placeholder="拜访日期" >
					</div>
				</div>                
            </div>
            <div class="form-group">
                <div class="col-sm-12" style="text-align:center;">
                     <input id="search-submit" class="btn btn-sm btn-primary btn-flat" type="button" value="搜索">
                </div>
            </div>
        <div class="validata-box">
            <input type="hidden" name="searchParams" id="searchParams" value="">
        </div>
        <div class="row content-row">
      		<div class="jp-left " style="float: left">
                <input id="exportVisit" class="btn btn-sm btn-primary btn-flat" type="button" value="拜访导出"/>
            </div>
            <div class="input-group input-group-sm " style="float: right">
                <a href="${CPATH}/admin/customerVisit/image"class="btn btn-sm btn-primary btn-flat">图片导出</a>
            </div>
        </div>
        <div class="box">
            <table class="table table-striped table-hover table-condensed" id="_customer_visit_table" ></table>
        </div>
    </form>
    <!-- /.box -->
</section>
</@layout>