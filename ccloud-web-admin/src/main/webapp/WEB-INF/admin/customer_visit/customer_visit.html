<#include "../_inc/_layout.html"/>

<#macro script_import>
    <!-- bootstrapValidator -->
    <script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
    <!-- bootstrap-table -->
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <!-- audio -->
    <script src="${CPATH}/static/plugins/audiojs/audio.min.js"></script>
</#macro>

<#macro css_import>

    <!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <!-- bootstrapValidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
</#macro>

<#macro script>
    var $table = $("#_customer_visit_table");
    var url = '${CPATH}/admin/customerVisit/list';
    var auditInfo = new Array();
    var paramId = 0;
    var batchFlg = true;

    $(function() {
        jQuery.mm.initEditTable('#_customer_visit_table', url, initParams, initFields(), null);
        initCustomerType();
        initQuestionType();
        initStatus();
    });



    $("#search-submit").click(function() {
        $table.bootstrapTable('refresh');
        paramId = 0;
        $("#_customer_visit_table").bootstrapTable('refresh');
    });

    var initParams = function(params) {
        var keyword = $('#post-search-input').val();
        if (keyword) keyword = encodeURIComponent(keyword);
        var customerType = $('#customer_type').val();
        if (customerType) customerType = encodeURIComponent(customerType);
        var questionType = $('#question_type').val();
        if (questionType) questionType = encodeURIComponent(questionType);
        var status = $('#status').val();
        if (status) status = encodeURIComponent(status);
        var param = {
            size: params.limit,
            page: params.offset/params.limit + 1,
            k: keyword,
            'questionType':questionType,
            'customerType':customerType,
            'status':status
        };
        return param;
    };

    var initFields = function() {
        var fields =
            [
            {field: "customer_name", title: "客户", align: "center", width: '7%', edit:false},
            {field: "customer_type", title: "客户类型", align: "center", width: '8%', edit:false},
            {field: "questionName", title: "问题类型", align: "center", width: '5%', edit: false},
            {field: "question_desc", title: "问题描述", align: "center", width: '28%', edit: false},
            {field: "visit_user", title: "拜访人", align: "center", width: '5%',edit: false},
            {field: "status", title: "状态", align: "center", width: '8%',
            formatter: function (value, row, rowIndex){
                if(value == "100101") return "正常";
                if(value == "100102") return "待审核";
                if(value == "100103") return "审核拒绝";
            }, edit: false},
            {field: "review_user", title: "审核人", align: "center", width: '5%', edit: false},
            {field: "create_date", title: "创建时间", align: "center", width: '12%', edit: false},
            {field: "modify_date", title: "审核时间", align: "center", width: '12%', edit: false},
            {field: "action", title: "操作", align: "center", width: '10%',
            formatter: function(value, row, rowIndex) {
                var audit = [row.location,row.lng,row.lat,row.advice,row.solution,row.status,row.photo,row.vedio];
                auditInfo[row.id] = audit;
                var strHtml = '';
                if(row.status == "100102") {
                    strHtml = '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="审核拜访结果" onclick="audit(\''+row.id+'\', \'' + row.taskId + '\')">审核</a> ';
                }
                strHtml += '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="查看审核" onclick="audit(\''+row.id+'\', \'' + row.taskId + '\')">查看</a> ';
                return strHtml;
                },
                edit:false
            }
        ];
        return fields;
    };

    function audit(id, taskId) {
        var url = "${(CPATH)!}/admin/customerVisit/audit?id=" + id + "&taskId=" + taskId;
        location.href = url;
    };

    var initCustomerType = function () {
        var strHtml = "";
        var url = '${CPATH}/admin/customerVisit/queryCustomerType';
        $.ajax({
        url: url,
        type: 'post',
        success: function (result) {
            var customerType = result.data;
            strHtml = '<option selected="selected" value="">客户类型</option>';
            for(index in customerType){
                var row = customerType[index].columns;
                strHtml +='<option value="'+row.id+'">'+row.name+'</option>';
            }
            $("#customer_type").html(strHtml);
        }
        });
    }

    var initQuestionType = function () {
        var strHtml = "";
        var url = '${CPATH}/admin/customerVisit/queryQuestionType';
        $.ajax({
            url: url,
            type: 'post',
            success: function (result) {
                var questionType = result.data;
                strHtml = '<option selected="selected" value="">活动类型</option>';
                for(index in questionType){
                    var row = questionType[index];
                    strHtml +='<option value="'+row.value+'">'+row.name+'</option>';
                }
                $("#question_type").html(strHtml);
            }
        });
    }

    var initStatus = function () {
        var strHtml = "";
        strHtml = '<option selected="selected" value="">拜访状态</option>';
        strHtml +='<option value="100101"> 正常 </option>';
        strHtml +='<option value="100102"> 待审核 </option>';
        strHtml +='<option value="100103"> 审核拒绝 </option>';
        $("#status").html(strHtml);
    };



</#macro>

<@layout active_id=p child_active_id=c>
<section class="content-header">
    <h1>客户拜访列表</h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">客户管理</a></li>
        <li class="active">客户拜访列表</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <form class="form-horizontal" id="form">
        <div class="validata-box">
            <input type="hidden" name="searchParams" id="searchParams" value="">
        </div>
        <div class="row content-row">
            <div class="input-group input-group-sm " style="float: right">
                <select class="input-sm" name="customer_type" id="customer_type" style="float: left;padding-right:5px;margin-right:5px;">
                </select>
                <select class="input-sm" name="question_type" id="question_type" style="float: left;padding-right:5px;margin-right:5px;">
                </select>
                <select class="input-sm" name="status" id="status" style="float: left;padding-right:5px;margin-right:5px;">
                </select>
                <input id="post-search-input" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">&nbsp;
                <input id="search-submit" class="btn btn-default btn-sm btn-flat" type="button" value="搜索">
            </div>
        </div>
        <div class="box">
            <table class="table table-striped table-hover table-condensed" id="_customer_visit_table" ></table>
        </div>
    </form>
    <!-- /.box -->
</section>
</@layout>