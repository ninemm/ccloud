<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script> 	
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- bootstrap-datetimepicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">	
</#macro>
<#macro css>
	.select2-container {
		box-sizing: border-box;
		display: inline-block;
		margin: 0;
		position: relative;
		vertical-align: middle;
		margin-bottom: 4px;
	}
</#macro>

<#macro script>

	var $form = $("#form");
	$(function(){
	jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
	$(document).on("change", "#customer_type", function() {
		$.get("${CPATH}/admin/customerVisit/getCustomer?customerType=" + $('#customer_type').val(), function(result){
			$("#customer_name").select2('destroy').empty();
			$("#customer_name").select2({
				data: result
			});
		})
	})
		var customerType = ${(customerType)};
		$("#customer_type").select2({
			minimumResultsForSearch: -1,
			data:customerType
		})

		var customerName = ${(customerName)};

		$("#customer_name").select2({
			data: customerName
		});
		
		var userList = ${(userList)!};
		
		$("#user_id").select2({
			data: userList
		});		

		var questionType = ${(questionType)};

		$("#question_type").select2({
		data: questionType
		});

	})

	function doSubmit(){
		layer.confirm('确定导出吗？',
			{btn : ['确定', '取消']},
			function() {
				layer.closeAll();
				$.get('${CPATH}/admin/customerVisit/count?customer_type=' + $('#customer_type').val() + '&customer_name=' + $('#customer_name').val() + '&user_id='+ $('#user_id').val() + '&startDate=' + $('#startDate').val() + '&question_type=' + $('#question_type').val() ,
				function(result){
					if (result.errorCode > 0) {
						toastr.error(result.message, '没有图片');
					} else {
						layer.load(1, {
							shade: [0.4,'#000']
						});
						window.open('${CPATH}/admin/customerVisit/exportImage?customer_type=' + $('#customer_type').val() + '&customer_name=' + $('#customer_name').val() + '&user_id='+ $('#user_id').val() + '&startDate=' + $('#startDate').val() + '&question_type=' + $('#question_type').val(),"_parent","","");
						setTimeout(function() {
							layer.closeAll();
						}, 1000);
					}
				})
			},
			function() {
				layer.close();
			}
		);
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>导出拜访图片</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>客户管理</li>
		<li class="active">导出拜访图片</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">图片导出</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form id="form" class="form-horizontal" >
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">问题类型:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" type="text" id="question_type" name="question_type" value="" readonly>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">客户类型:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" type="text" id="customer_type" name="customer_type" value="" readonly>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">客户名称:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" type="text" id="customer_name" name="customer_name" value="" readonly>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">业务员:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" type="text" id="user_id" name="user_id" value="" readonly>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">拜访日期:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input id="startDate" class="form-control" value="${startDate!}" name="startDate" placeholder="拜访日期" >
		               	</div>
					</div>			
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat">导出</button>
			<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>
</@layout>