<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
 	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
 	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
    <link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>
 
<#macro script>

var $form = $("#form");
$("#station_option").select2();
$("#group_id").select2();

function getStation(){
	$.ajax({
	url:"${CPATH}/admin/user/getStation",
	type:"post",
	data:{"userid":'${(user.id)!}'},
	dataType:"json",
	success:function(data)
	{
		for (var i = 0; i < data.length; i++) {
			if (data[i].isvalid == 0 ) {
				$("#station_option").append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
			} else {
				$("#station_option").append("<option value=" + data[i].id + " selected >" + data[i].name + "</option>");
			}
		}
	}
	});	
}

 function getGroup(){
 	$.ajax({
	url:"${CPATH}/admin/user/getGroup",
	type:"post",
	data:{"userid":'${(user.id)!}'},
	dataType:"json",
	success:function(data)
	{
		for (var i = 0; i < data.length; i++) {
			if (data[i].isvalid == 0 ) {
				$("#group_id").append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
			} else {
				$("#group_id").append("<option value=" + data[i].id + " selected >" + data[i].name + "</option>");
			}
		}
	}
	});	
 }

$(function() {
	
	jQuery.mm.initValidator('#form', validatorFields)
	getStation();
	getGroup();
	
	$('#_dept_tree').click(function() {
		layer.open({
			title:'所属部门',
		    type: 2,
		    area: ['580px', '530px'],
		    fix: false, //不固定
		    content: '${CPATH}/admin/department/department_tree'
		});
	});	
});

var validatorFields = {
	'user.username': {
		validators: {
            notEmpty: { message: '用户名不能为空' },
            stringLength: { max: 15, message: '用户名最大长度是15字符，请重新输入' }
        }
	},
	'user.mobile': {
		validators: {
            notEmpty: { message: '手机号码不能为空' },
            regexp: {
                regexp: /^1[3|5|7|8]{1}[0-9]{9}$/,
                message: '请输入正确的手机号码'
            }
        }
	},
	'user.password': {
		validators: {
            notEmpty: { message: '用户密码不能为空' },
        }
	},
	'user.group_id': {
		validators: {
            notEmpty: { message: '用户分组不能为空' },
        }
	},
	'parent_name': {
		validators: {
            notEmpty: { message: '用户部门不能为空' },
        }
	},
	'user.realname': {
		validators: {
            notEmpty: { message: '真实姓名不能为空' },
        }
	}
};

function doSubmit(){
	var l = Ladda.create( document.querySelector( '#do_submit' ) );
	var t = '${(t)!}';
	var count = $("#station_option").select2("data").length;
	var list = $("#station_option").select2("val");
	var ids = "";
	if (list != null && list.length > 0) {
		ids = list.toString();
	}
	var name = "";
	
	for(var i=0;i<count;i++){
		if($("station_option").selected = true)  
		{
			if (i == count-1) {
				name = name + $("#station_option").select2("data")[i].text;
				break;
			}
			name = name + $("#station_option").select2("data")[i].text + ",";
		}  
	}	
	
	var groupCount = $("#group_id").select2("data").length;
	var userGroupList = $("#group_id").select2("val");
	var groupIds = "";
	if (userGroupList != null && userGroupList.length > 0) {
		groupIds = userGroupList.toString();
	}
	var groupName = "";
	
	
	for(var i=0;i<groupCount;i++){
		if($("group_id").selected = true)  
		{
			if (i == count-1) {
				groupName = groupName + $("#group_id").select2("data")[i].text;
				break;
			}
			groupName = groupName + $("#group_id").select2("data")[i].text + ",";
		}  
	}	

	$form.ajaxSubmit({
		beforeSubmit: function() {
			var validate = $form.data('bootstrapValidator');
			validate.validate();
			if (validate.isValid()) {
					l.start();
				}
			return validate.isValid();
		},
		type : "post", 
		data : {
		"stationList":ids,
		"stationName":name,
		"groupList":groupIds,
		"groupName":groupName,
		"t":t
		},
		dataType : "json", 
		success : function(data) { 
			if(data.errorCode == 0) {
				//location.reload();
				toastr.success(data.message, '操作成功');
			} else {
				toastr.error(data.message,'操作失败');
			}
			setTimeout( function(){
						l.stop();
								}, 1 * 1000 );
		},
		error : function() {
			l.stop();
			alert("信息提交错误");
		}
	});
}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (user.id) ??>修改<#else>新增</#if>用户信息</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li>用户信息</li>
       	<li class="active"><#if (user.id) ??>修改<#else>新增</#if>用户信息</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">用户信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/user/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="user.id" value="${(user.id)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">用户名:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="user.username" value="${(user.username)!}" placeholder="1-15个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">真实姓名:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="user.realname" value="${(user.realname)!}" placeholder="2-2个任意字母数字">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">昵称:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="user.nickname" value="${(user.nickname)!}" placeholder="2-2个任意字母数字">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">手机:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="user.mobile" value="${(user.mobile)!}" placeholder="2-2个任意字母数字">
		               	</div>
					</div>
					<#if !user??>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">密码:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="user.password" value="${(user.password)!}" placeholder="2-2个任意字母数字">
		               	</div>
					</div>
					<#else>
						<input type="hidden" name="user.password" value="${(user.password)!}">
					</#if>	
					<#if t?? && t == '0'>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">用户状态:</label>
						<div class="input-group col-md-4 col-sm-10">
							<label class="radio-inline">
		                 		<input type="radio" name="user.status" value="1" <#if !user?? || user.status == 1>checked</#if>>启用
		                 	</label>
		                 	<label class="radio-inline">
		                 		<input type="radio" name="user.status" value="0" <#if user?? && user.status == 0>checked</#if>>停用
							</label>		                 		
		               	</div>
					</div>
					</#if>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">用户分组:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="group" id="group_id" multiple="multiple" >
							</select>
						</div>
					</div>	
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">所属部门:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="user.department_id" id="parent_id" value="${(user.department_id)!}">
			                 	<input class="form-control input-sm" type="text" id="parent_name" name="parent_name" value="${(user.department_name)!}">
		                 		<div class="input-group-addon" id="_dept_tree" style="cursor:pointer;">
		                 			<i class="fa fa-search"></i> 选择
								</div>
		                 	</div>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">岗位:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="station" id="station_option" multiple="multiple" >
							</select>
						</div>
					</div>					
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" id="do_submit" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat ladda-button"  data-style="expand-right">保存更改</button>
			<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="javascript:window.location.href='index'" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>