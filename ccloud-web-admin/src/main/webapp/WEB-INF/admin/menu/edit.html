<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
 	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro css>
	.input-group-addon {
		cursor: pointer;
		padding: 6px 4px;
	}
</#macro>

<#macro script>

	var $form = $("#form");
	
	$(function() {
		
		jQuery.mm.initValidator('#form', validatorFields);
		
		$('#_menu_tree').click(function() {
			var systemId = $("#systemChoose").find("option:selected").val();
			if (systemId != null && systemId != "") {
				layer.open({
					title:'菜单资源',
				    type: 2,
				    area: ['580px', '530px'],
				    fix: false, //不固定
				    content: '${CPATH}/admin/menu/menu_tree?id='+systemId
				});
			} else {
				toastr.error(data.message,'请选择系统!');
			}			
		});
		
	});
	
	var validatorFields = {
		'menu.system_id': {
			validators: {
	            notEmpty: { message: '所属系统不能为空' }
	        }
		},
		'menu.name': {
			validators: {
	            notEmpty: { message: '菜单名称不能为空' },
	            stringLength: { min: 2, max: 15, message: '菜单名称最大长度是15字符，请重新输入' }
	        }
		},
		'menu.code': {
            validators: {
                notEmpty: { message: '菜单编号不能为空' },
                stringLength: { min: 2, max: 30, message: '菜单编号最大长度是30字符，请重新输入' }
            }
        },
		'menu.level': {
			validators: {
	            notEmpty: { message: '层级不能为空' },
	            integer: {message: '请输入正整数'},
	            greaterThan: { value: 1, message: '最小层级为1，请重新输入' },
	            lessThan: { value: 5, message: '最大层级为5，请重新输入' }
	        }
		},
		'menu.order_list': {
			validators: {
	            notEmpty: { message: '序号不能为空' },
	            integer: {message: '请输入正整数'}
	        }
		},
		'parentName': {
			validators: {
				notEmpty: { message: '上级菜单不能为空' }
	        }
		}
	};
	
	function grant() {
		layer.open({
			title:'菜单资源',
		    type: 2,
		    area: ['580px', '530px'],
		    fix: false, //不固定
		    content: '${CPATH}/admin/menu/grant'
		});
	}
	
	function doSubmit(){
		var l = Ladda.create( document.querySelector( '#do_submit' ) );
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				if (validate.isValid()) {
					l.start();
				}
				return validate.isValid();
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
					setTimeout( function(){
						l.stop();
								}, 1 * 1000 );
			},
			error : function() {
				l.stop();
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (menu.id) ??>修改<#else>新增</#if>菜单</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">用户权限</a></li>
       	<li class="active"><#if (menu.id) ??>更新<#else>新增</#if>菜单</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">菜单信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/menu/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="menu.id" value="${(menu.id)!}">
		<input type="hidden" name="ucode" value="${(ucode)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">所属系统:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="menu.system_id" id="systemChoose">
								<option value="">--请选择--</option>
								<#list list as system >
									<option value="${system.id}" <#if (menu.system_id)! == (system.id)!>selected="selected"</#if>>${system.name}</option>
								</#list>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">上级菜单:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="menu.parent_id" id="parent_id" value="${(menu.parentId)!}">
			                 	<input class="form-control input-sm" type="text" id="parent_name" name="parentName" value="${(menu.parent_name)!}" placeholder="选择上级菜单" readonly>
		                 		<div class="input-group-addon" id="_menu_tree">
		                 			<i class="fa fa-search"></i> 选择
								</div>
		                 	</div>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">菜单名称:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="menu.name" value="${(menu.name)!}" placeholder="1-15个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
                        <label class="control-label col-sm-2">菜单编号:</label>
                        <div class="input-group col-md-4 col-sm-10">
                            <input class="form-control input-sm" type="text" name="menu.code" value="${(menu.code)!}" placeholder="2-30个任意字符">
                        </div>
                    </div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">层级:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="number" name="menu.level" value="${(menu.level)!1}" placeholder="层级级别">
		               	</div>
					</div>
					<div class="form-group col-sm-12">
						<label class="control-label col-sm-2">菜单图标:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="menu.icon" value="${(menu.icon)!}" placeholder="菜单图标 如 fa fa-conf">
		               	</div>
					</div>
					<div class="form-group col-sm-12">
						<label class="control-label col-sm-2">参数:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="menu.param" value="${(menu.param)!}" placeholder="菜单参数">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">排序:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="number" name="menu.order_list" value="${(menu.orderList)!10}">
		               	</div>
					</div>
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" id="do_submit" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">保存更改</button>
			<input type="button" class="btn btn-sm bg-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>