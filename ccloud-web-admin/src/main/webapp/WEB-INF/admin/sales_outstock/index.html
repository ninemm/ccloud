<#include "../_inc/_layout.html"/>

<#macro script_import>

	<!-- bootstrap-table -->
	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>

</#macro>

<#macro css_import>

	<!-- bootstrap-table-->
<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
	<!-- bootstrap-datetimepicker -->
<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
	<!-- bootstrapvalidator -->
<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">

</#macro>

<#macro script>

	var $table = $("#_salesOutstock_table");
	var url = '${CPATH}/admin/salesOutstock/list';

	$(function() {
	    initCarWarehouse();
	    initUser();
	    var curDate = new Date().Format("yyyy-MM-dd");
		$("#sOutDate").val(curDate);
		jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
		jQuery.mm.initDatetimepicker('form', '#endDate', 'endDate', 'yyyy-MM-dd', 2, 4, 2);
		jQuery.mm.initValidator('#form', validatorFields)
		jQuery.mm.initEditTable('#_salesOutstock_table', url, initParams, initFields(), null);
		$(document).on("change", "#startDate", function() {
          initUser();
	    }).on("change", "#endDate", function() {
          initUser();
	    }).on("change", "#printStatus", function() {
          initUser();
	    }).on("change", "#stockOutStatus", function() {
          initUser();
	    })
	});

	$("#search-submit").click(function() {
		var validate = $('#form').data('bootstrapValidator');
		validate.validate();
		if (validate.isValid()){
			$table.bootstrapTable('refresh');
		}
	});

	var initParams = function(params) {

		var searchSn = $('#searchSn').val();
		var searchName = $('#searchName').val();
		if (searchName) searchName = encodeURIComponent(searchName);
		var param = {
			size: params.limit,
			page: params.offset/params.limit + 1,
			searchSn: searchSn,
			searchName: searchName,
			carWarehouseId: $('#carWarehouse').val(),
			startDate: $('#startDate').val() + " 00:00:00",
			endDate: $('#endDate').val() + " 23:59:59",
			printStatus:$("#printStatus").val(),
			stockOutStatus:$("#stockOutStatus").val(),
			salesman:$("#salesman").val(),
			sortName:params
		};
		return param;
	};

	var initFields = function() {
		var fields =
			[
				{field: "id", title: "ID", align: "center", visible:false, edit:false},
				{field: "checkbox", title: '<input class="jp-common-pad " id="dataItem" onclick="checkAll(this)" title="全选" type="checkbox">', align: "center", width: '2%', 
					formatter: function(value, row, rowIndex) {
						return '<input class="jp-common-pad" name="dataItem" type="checkbox" value="' + row.id + '">' + 
						'<input name="pstatus" type="hidden" value="' + row.is_print + '">'+
						'<input name="oStockSn" type="hidden" value="' + row.outstock_sn + '">'+
						'<input name="cDate" type="hidden" value="' + row.create_date + '">'+
						'<input name="cName" type="hidden" value="' + row.customer_name + '">';
					},
					edit:false
				},
				{field: "create_date", title: "出库单号/创建时间", align: "center", width: '10%',
					formatter: function(value, row, rowIndex) {
						return row.outstock_sn + '<br>' + row.create_date;
					},
					edit: false,
				sortable: true},
				
				{field: "create_date", title: "销售订单单号/创建时间", align: "center", width: '10%',
					formatter: function(value, row, rowIndex) {
						return '<a href="#" onclick="orderDetail(\''+row.orderId+'\')" >'+row.order_sn + '<br>' + row.orderDate+'</a>';
					},
					edit: false,
				sortable: true},
				{field: "customer_name", title: "客户名称", align: "center", width: '8%', edit:false,sortable: true},
				<@shiro.lacksRole name="021"> 
				{field: "total_amount", title: "订单总额", align: "center", width: '5%',
					formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
				edit:false,sortable: true},
				</@shiro.lacksRole>	
				{field: "receive_type", title: "付款方式", align: "center", width: '5%',
					formatter: function(value, row, rowIndex) {
						return value == 0 ? '账期' : '现金';
					},
					edit: false
				},
				{field: "is_print", title: "打印状态", align: "center", width: '5%',edit: false,
					formatter: function(value, row, rowIndex) {
						if (value == 0) {
							return '未打印';
						} else {
							return '已打印'
						}
					}
				},
				{field: "status", title: "出库状态", align: "center", width: '5%',edit: false,
					formatter: function(value, row, rowIndex) {
						if (value == 0) {
							return '待出库';
						} else if(value == 1000) {
							return '已出库'
						} else {
							return '部分出库'
						}
					}
				},
				{field: "bizName", title: "业务员", align: "center", width: '5%',edit: false},
				{field: "action", title: "操作", align: "center", width: '15%',
				formatter: function(value, row, rowIndex) {
					var url = '${CPATH}/admin/salesOutstock/getDetail?id=' + row.id + '&c=${c}&p=${p}';
					var strHtml ='<div style = "white-space:nowrap"><a class="btn btn-xs btn-primary btn-flat" onclick="detail(\''+row.id+'\')" >详细</a> ';

                    <@shiro.hasPermission name="/admin/salesOutstock/print">
                    <@shiro.lacksRole name="021">  
                      strHtml = strHtml + '<a class="btn btn-xs btn-warning btn-flat" onclick="print(\''+row.id+'\')" >打印</a> ';
					</@shiro.lacksRole>	
                    </@shiro.hasPermission>
                     <@shiro.hasPermission name="/admin/salesOutstock/costPrint">
                     strHtml = strHtml + '<a class="btn btn-xs btn-warning btn-flat" onclick="financePrint(\''+row.id+'\')" >财务打印</a> ';
                     </@shiro.hasPermission>
					<@shiro.hasPermission name="/admin/salesOutstock/check">
						if (row.status == 0) {
							strHtml = strHtml + '<a class="btn btn-xs btn-info btn-flat" onclick="checkIsPrint(\''+row.is_print+'\',\''+url+'\')">出库</a> ';				
						}else{
							strHtml = strHtml + '<div class="btn btn-xs" style="visibility: hidden;"><font style="color:transparent">已出</font></div> ';
						}
					</@shiro.hasPermission>						
					strHtml += '</div>';
					return strHtml;
				},
				edit:false
				}
			];
		return fields;
	}
	
	var validatorFields = {
		'startDate': {
			validators: {
				date : { format : 'YYYY-MM-DD', message : '日期格式不正确' }
			}
		},
		'endDate': {
			validators: {
				date : { format : 'YYYY-MM-DD', message : '日期格式不正确' }
			}
		}
	};
	
function orderDetail(id) {
		layer.open({
			title:"订单详细",
			type: 2, 
			area: ['70%', '80%'],
			content: '${CPATH}/admin/salesOrder/detail/' + id
		}); 
	}

<!-- 单个打印或批量打印调用方法 -->
	function print(id) {
		layer.open({
			title:"出库单打印",
			type: 2, 
			area: ['90%', '90%'],
			content: '${CPATH}/admin/salesOutstock/renderPrintPage/?stockOutId='+id + "&isFinancePrint=" + 0,
			end: function() {
			$("#search-submit").click();
    		},
		}); 
	}
	
	<!-- 财务单个打印或批量打印调用方法 -->
	function financePrint(id) {
		layer.open({
			title:"出库单打印",
			type: 2, 
			area: ['90%', '90%'],
			content: '${CPATH}/admin/salesOutstock/renderPrintPage/?stockOutId='+id + "&isFinancePrint=" + 1,
			end: function() {
			$("#search-submit").click();
    		},
		}); 
	}
	
	
		
	function batchOutConfirmPage(id) {
		layer.open({
			title:"批量出库确认",
			type: 2, 
			area: ['90%', '90%'],
			content: '${CPATH}/admin/salesOutstock/renderBatchOutPage/' + id
		}); 
	}
	
	function detail(id) {
		layer.open({
			title:"出库单详细",
			type: 2, 
			area: ['70%', '80%'],
			content: '${CPATH}/admin/salesOutstock/stockdetail/' + id
		}); 
	}

    //批量打印
    function batchAction(){
   
   	   ids = new Array();
		$("[name='dataItem']:checkbox").each(function() {
			if ($(this).is(":checked")) {
				ids.push($(this).val());
			}
		});
		if(ids.length == 0){
		 layer.alert("请选择要打印的出库单");
		}else{
	     print(ids);
		}
   }
   
     //财务按钮批量打印
    function batchFinanceAction(){
   
   	   ids = new Array();
		$("[name='dataItem']:checkbox").each(function() {
			if ($(this).is(":checked")) {
				ids.push($(this).val());
			}
		});
		if(ids.length == 0){
		 layer.alert("请选择要打印的出库单");
		}else{
	     financePrint(ids);
		}
   }
   
   
       //分业务员汇总打印
    function batchPrintAll(){
      var userId = $("#salesman").val();
      if(userId == ""){
      layer.alert("请选择要打印的业务员");
      return;
      }
    
   	   ids = new Array();
		$("[name='dataItem']:checkbox").each(function() {
			if ($(this).is(":checked")) {
				ids.push($(this).val());
			}
		});
		if(ids.length == 0){
		 layer.alert("请选择要打印的出库单");
		}else{
	     printAll(ids);
		}
   }
   
   
	function printAll(id) {
	   var starDate = $("#startDate").val();
       var endDate = $("#endDate").val();
       var userId = $("#salesman").val();
		layer.open({
			title:"业务员出库单汇总打印",
			type: 2, 
			area: ['90%', '90%'],
			content: '${CPATH}/admin/salesOutstock/renderPrintAll/?stockOutId='+id + "&beginDate=" + starDate + "&endDate=" + endDate + "&userId=" + userId,
			end: function() {
			$("#search-submit").click();
    		},
		}); 
	}
   
   
   var cOutTrStr = '<tr><td class="center">{0}</td><td>{1}</td><td class="hidden-xs">{2}</td><td class="hidden-xs">{3}</td></tr>';
   
   //批量出库
   function batchOut(){
        var str = "";
        var StockOutS=""; 
        var createDate = "";
        var customerName = "";
        var batchStockOut = new Array(); 
        var b = true;
        var confirmTable = $("#confirmTable");
        ids = new Array();
		$("[name='dataItem']:checkbox").each(function() {
			if ($(this).is(":checked")) {
				ids.push($(this).val());
			}
		});
		if(ids.length == 0){
		 layer.alert("请选择出库单");
		 b = false;
		}
	    $("[name='dataItem']:checked").each(function() {
<!-- 	       if($(this).next().val() == 0){ -->
<!-- 	        layer.alert("您所选订单中没全部打印,请先全部打印后再出库"); -->
<!-- 	        b = false; -->
<!-- 	       }else{ -->
	        StockOutSn = $(this).next().next().val();
	        createDate = $(this).next().next().next().val();
	        customerName = $(this).nextAll("input:last").val();
	       var stockOut ={
	       "stockOutSn":StockOutSn,
	       "createDate":createDate,
	       "customerName":customerName
	       }
	       batchStockOut.push(stockOut);
<!-- 	       }	 -->
		});
		if(b){
		$.each(batchStockOut, function(idx, item) {
		  str += $.format(cOutTrStr, (idx + 1), item.stockOutSn, item.createDate, item.customerName);
		});
		$("#conFirmStockOut").find("#cOutTbody").empty().html(str);
	    layer.open({
		type: 1,
		title: '批量出库确认',
		area: ['80%', '80%'],
		content: $("#conFirmStockOut"),
		btn: ["确认", "关闭"],
		btn1: function() {
		    var stockOutDate = $("#sOutDate").val();
		    var remark = $("#remark").val();
		    if (remark) remark = encodeURIComponent(remark);
            batchStoutOut(ids.toString(),stockOutDate,remark);
		}
	   })
		jQuery.mm.initDatetimepicker('stockOutConfId', '#sOutDate', 'sOutDate', 'yyyy-MM-dd', 2, 4, 2);
		}
   }
   

   //全选
   function batchCheckAll() {   
    var items = document.getElementsByName("dataItem");
	for (var i = 0; i < items.length; i++) {
	    if(items[i].checked){
	    items[i].checked = false;
	    }else{
	    items[i].checked = true;
	    }
	}
}

 function checkIsPrint(isPrint,url){
<!--    if(isPrint == 0){ -->
<!--    layer.alert("此订单未打印,请先打印后再出库") -->
<!--    }else{ -->
<!--     window.location.href = url; -->
<!--    } -->
	window.location.href = url;
 }
 
 
 $.format = function(source, params) {
    if (arguments.length == 1) return function() {
        var args = $.makeArray(arguments);
        args.unshift(source);
        return $.format.apply(this, args);
    };
    if (arguments.length > 2) {
        params = $.makeArray(arguments).slice(1);
    }
    if (params.constructor != Array) {
        params = [params];
    }
    $.each(params,
    function(i, n) {
        source = source.replace(new RegExp("\\{" + i + "\\}", "g"), n);
    });
    return source;
};

 function batchStoutOut(ids,oStockDate,remark){
   $.ajax({
     url: "${CPATH}/admin/salesOutstock/batchStockOut",
     data:{
      "outstockId": ids,
      "oStockDate":oStockDate,
      "remark":remark
     },
     type:"POST",
     dataType: "json",
     async: false,
     success: function(data) {
		if (data.message == '出库成功') {
			toastr.success(data.message, '操作成功');
		} else {
			toastr.error(data.message,'操作失败');
		}
	     $table.bootstrapTable('refresh');     
     }
   });
 }
 
 //获取车销仓库
 var initCarWarehouse = function () {
        var strHtml = "";
        var url = '${CPATH}/admin/salesOutstock/queryCarWarehouse';
        $.ajax({
            url: url,
            type: 'post',
            success: function (result) {
                var carWarehouse = result.data;
                strHtml = '<option selected="selected" value="">车销仓库选择</option>';
                for(index in carWarehouse){
                    var row = carWarehouse[index];
                    strHtml +='<option value="'+row.id+'">'+row.name+'</option>';
                }
                $("#carWarehouse").html(strHtml);
            }
        });
    }
    
    
   <!-- 初始化业务员选择框 -->
 var initUser = function () {
        var strHtml = "";
        var print = $("#printStatus").val();
        var stockOutStatus = $("#stockOutStatus").val();
        var url = '${CPATH}/admin/salesOutstock/initUser';
        $.ajax({
            url: url,
            type: 'post',
            data:{
            "startDate": $('#startDate').val() + " 00:00:00",
			"endDate": $('#endDate').val() + " 23:59:59",
			"print": print,
			"stockOutStatus": stockOutStatus
            },
            success: function (result) {
                var user = result.userList;
                strHtml = '<option selected="selected" value="">业务员选择</option>';
                for(index in user){
                    var row = user[index];
                    strHtml +='<option value="'+row.value+'">'+row.title+'</option>';
                }
                $("#salesman").html(strHtml);
            }
        });
    }
    
    <!--打印车销汇总单  -->
    function batchCarPrint(){
    var carWarehouseId = $("#carWarehouse").val();
    var starDate = $("#startDate").val();
    var endDate = $("#endDate").val();
    if(carWarehouseId == null || carWarehouseId=="" || carWarehouseId == undefined){
    layer.alert("请选择一个车销仓库");
     return;
     }
      else{
      layer.open({
			title:"出库单打印",
			type: 2, 
			area: ['90%', '90%'],
			content: '${CPATH}/admin/salesOutstock/renderCarPrintPage?carWarehouseId='+carWarehouseId + "&beginDate=" + starDate + "&endDate=" + endDate,
		    end: function() {
            $("#search-submit").click();
    		},
		}); 
      }
    }
    
    function batchDown(){
  		var keyword = $('#post-search-input').val();
  		<@shiro.hasRole name="021">  
			jQuery.mm.down("${CPATH}/admin/salesOutstock/downloading?startDate=" + $('#startDate').val() + " 00:00:00" + "&endDate=" + $('#endDate').val() + " 23:59:59" + "&printStatus=" + $("#printStatus").val() + "&stockOutStatus="+$("#stockOutStatus").val() + "&k="+keyword+ "&tax=0");
		</@shiro.hasRole>	
		<@shiro.lacksRole name="021">  
			jQuery.mm.down("${CPATH}/admin/salesOutstock/downloading?startDate=" + $('#startDate').val() + " 00:00:00" + "&endDate=" + $('#endDate').val() + " 23:59:59" + "&printStatus=" + $("#printStatus").val() + "&stockOutStatus="+$("#stockOutStatus").val() + "&k="+keyword+ "&tax=1");
		</@shiro.lacksRole>	
    		
    }
    
</#macro>

<@layout active_id=p child_active_id=c>

<section class="content-header">
	<h1>销售订货出库</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li><a href="#">仓库管理</a></li>
	<li class="active">销售订货出库</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
	    <form class="form-horizontal" role="form" id="form">
		<div class="validata-box">
			<input type="hidden" name="userIds" id="userIds" value="">
		</div>
		<div class="form-group">
			<div class="col-sm-4">
				 <label class="control-label col-sm-4">业务员:</label>
                  <div class="col-sm-8 input-group input-group-sm">
					 <select class="form-control" name="salesman" id="salesman">
		             </select>
	             </div>
             </div>
			<div class="col-sm-4">
				<label class="control-label col-sm-4">开始时间:</label>
				<div class="col-sm-8 input-group input-group-sm">
					<input id="startDate" class="form-control" value="${startDate!}" name="startDate" placeholder="开始日期" >
				</div>
			</div>
			<div class="col-sm-4">
				<label class="control-label col-sm-4">结束时间:</label>
				<div class="col-sm-8 input-group input-group-sm">
					<input id="endDate" class="form-control" value="${endDate!}" name="endDate" placeholder="结束日期" >
				</div>
			</div>
		</div>		
		<div class="form-group">
			<div class="col-sm-4">
				<label class="control-label col-sm-4">打印状态 :</label>
				<div class="col-sm-8 input-group input-group-sm">
	                <select class="form-control" name="printStatus" id="printStatus">
	                    <option value="" selected="selected">全部</option>
	                    <option value="0">未打印</option>
	                    <option value="1">已打印</option>
	                </select>
	            </div>
            </div><div class="col-sm-4">    
                <label class="control-label col-sm-4">出库单状态:</label>
                 <div class="col-sm-8 input-group input-group-sm">
	                 <select class="form-control" name="stockOutStatus" id="stockOutStatus">
	                    <option value="" selected="selected">全部</option>
	                    <option value="0">待出库</option>
	                    <option value="1000">已出库</option>
	                    <option value="2000">部分出库</option>
	                </select>
                </div>
            </div><div class="col-sm-4" style="text-align:center;">  
            	 <label class="control-label col-sm-4">车销仓库:</label>
                 <div class="col-sm-8 input-group input-group-sm">
	                 <select class="form-control" name="carWarehouse" id="carWarehouse">
	                </select>
	             </div>
			</div>
		</div>
		<div class="form-group">
                <div class="col-sm-4">
                	<label class="control-label col-sm-4">出库单号:</label>
                    <div class="col-sm-8 input-group input-group-sm">
                        <input id="searchSn" class="form-control" type="search" value="${searchSn!}" name="searchSn" placeholder="出库单号" style="width:100%;">&nbsp;
                    </div>
                </div>
                <div class="col-sm-4">
                	<label class="control-label col-sm-4">客户名称:</label>
                    <div class="col-sm-8 input-group input-group-sm">
                        <input id="searchName" class="form-control" type="search" value="${searchName!}" name="searchName" placeholder="客户名称" style="width:100%;">&nbsp;
                    </div>
                </div>                
                <div class="col-sm-4" style="text-align:center;">
                    <input id="search-submit" class="btn btn-sm btn-primary btn-flat" type="button" value="搜索">
                </div>
			</div>
		<div class="row content-row">
			<div class="jp-left">
				<@shiro.hasPermission name="/admin/salesOutstock/print">
				<@shiro.lacksRole name="021">  
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchAction()"><i class="fa fa-gavel"></i> 批量打印 </button>
				</@shiro.lacksRole>	
				</@shiro.hasPermission>
				<@shiro.hasPermission name="/admin/salesOutstock/costPrint">
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchFinanceAction()"><i class="fa fa-gavel"></i> 财务批量打印 </button>
				</@shiro.hasPermission>
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchOut()"><i class="fa  fa-check-circle"></i> 批量出库</button>
<!-- 				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchCheckAll()"><i class="fa  fa-circle-o-notch"></i>全选</button> -->
			</div>
			<div class="jp-right">
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchCarPrint()"><i class="fa  fa-train"></i>车销订单打印</button>
				<@shiro.hasPermission name="/admin/salesOutstock/downloading">
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchDown()"><i class="fa fa-download"></i> 导出</button>
				</@shiro.hasPermission>
				<button class="btn btn-sm btn-primary btn-flat" type="button" onclick="batchPrintAll()"><i class="fa  fa-rebel"></i> 业务员汇总打印</button>
			</div>
            <div class="input-group input-group-sm " style="float: right;">
               
                
           </div>
       </div>
		<div class="box">
			<table class="table table-striped table-hover table-condensed" id="_salesOutstock_table" ></table>
		</div>
	</form>
	<!-- /.box -->
</section>

	<div id="conFirmStockOut" class="col-xs-12" style="display: none;">
		<form class="form-inline" id="stockOutConfId">
			<div class="widget-box col-xs-12">
				<div class="widget-body col-xs-12">
					<div class="col-xs-12 center" style="margin-bottom: 10px;margin-top: 20px;left: 350px;">
						<span style="color: orange;">
		                	提示：是否确认批量出库？
		               </span>
					</div>

					<div class="widget-main">
						<div class="form-group validata-box">
					<label class="control-label">出库时间:</label>
					<div class="form-group">
						<input id="sOutDate" class="form-control form_datetime" value="" name="sOutDate" placeholder="出库时间" >&nbsp;
					</div>
				    </div>
						<table id="confirmTable" class="table table-striped table-bordered">
							<thead>
								<tr>
									<th class="center"></th>
									<th class="center">订单号</th>
									<th class="hidden-xs center">配送时间</th>
									<th class="hidden-480 center">客户名称</th>
								</tr>
							</thead>

							<tbody id="cOutTbody">
								<tr>
									<td class="center">1</td>
									<td>
									</td>
									<td class="hidden-xs">
									</td>
									<td class="hidden-xs">
									</td>
								</tr>
							</tbody>
						</table>
						<div class="col-xs-12" style="margin-top: 10px;clear: both;">
							<div class="col-xs-10 left" >
							<label  class="control-label">备注：</label>
							<textarea id="remark" rows="3" placeholder="可不填"></textarea></div>
						</div>
					</div>
				</div>
			</div>
			</form>
		</div>
		

</@layout>