<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
 	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
 	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
 	
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
</#macro>
 
<#macro script>
var warehouse_id = '${warehouse_id}';
var seller_id = '${seller_id}';
var product_id= '${product_id}';

$(function() {
	
	var nowDate = new Date();
	var thirtyDaysBefoer = new  Date(nowDate - 1000 * 60 * 60 * 24 * 30);
	initDateValue(thirtyDaysBefoer,nowDate);

	$('#startdate').datetimepicker({
		language: 'zh-CN',
		minView: 'month',
    	format: 'yyyy-mm-dd',
    	endDate: nowDate,
    	todayBtn: true,
    	initialDate: thirtyDaysBefoer
	});
	
	
	$('#enddate').datetimepicker({
		language: 'zh-CN',
		minView: 'month',
    	format: 'yyyy-mm-dd',
    	endDate: nowDate,
    	todayBtn : true,
    	initialDate: nowDate
	});
	
	var url = '${CPATH}/admin/inventory/detaillist';
	jQuery.mm.initEditTable('#_inventory_detail_table', url, initParams, initFields(), null);
	
});

// 日期选择器初始化
function initDateValue(startDate,endDate){
	$("#startdate").val(getDate(startDate));
	$("#enddate").val(getDate(endDate));
}

// 获取日期字符串
function getDate(date){
	var dateStr = '';
	if(getObjectClass(date) === 'Date'){
		var nowY = date.getFullYear();
		var nowM = date.getMonth()+1;
		var nowD = date.getDate();
		dateStr = nowY+"-"+(nowM<10 ? "0" + nowM : nowM)+"-"+(nowD<10 ? "0"+ nowD : nowD);
	}
	return dateStr;
}

// 获取类名
function getObjectClass(obj){
 if (obj && obj.constructor && obj.constructor.toString()) {
   	if(obj.constructor.name) {
    	return obj.constructor.name;
   	}
   	var str = obj.constructor.toString();

    if(str.charAt(0) == '[')
   	{
     	var arr = str.match(/\[\w+\s*(\w+)\]/);
   	} else {
       var arr = str.match(/function\s*(\w+)/);
    }
    if (arr && arr.length == 2) {
        return arr[1];
     }
  }
  return undefined; 
};

// 初始化表格参数
var initParams = function(params){
	var startDate = $("#startdate").val();
	var endDate = $("#enddate").val();
	var param = {
			'size': params.limit,
			'page': params.offset/params.limit + 1,
			'start_date': startDate,
			'end_date': endDate,
			'warehouse_id': warehouse_id,
			'seller_id': seller_id,
			'product_id': product_id
		};
		
	return param;
}

// 初始化列表
var initFields = function(){
	var fields = [
		{field: "id", title: "ID", align: "center", visible:false, edit:false},
		{field: "product_sn", title: "商品编码", align: "center", edit:false},
		{field: "product_name", title: "商品名称", align: "center", edit:false},
		{field: "in_count", title: "商品入库数量", align: "center", edit:false},
		{field: "in_amount", title: "商品入库金额", align: "center", edit:false},
		{field: "in_price", title: "商品入库单价", align: "center", edit:false},
		{field: "out_count", title: "商品出库数量", align: "center", edit:false},
		{field: "out_amount", title: "商品出库金额", align: "center", edit:false},
		{field: "out_price", title: "商品出库单价", align: "center", edit:false},
		{field: "balance_count", title: "剩余商品数量", align: "center", edit:false},
		{field: "balance_amount", title: "剩余商品金额", align: "center", edit:false},
		{field: "balance_price", title: "剩余商品单价", align: "center", edit:false},
		{field: "biz_type", title: "业务类型", align: "center",
			formatter: function(value, row, rowIndex) {
  					if (value == 100209) return '盘亏出库';
  					if (value == 100208) return '盘盈入库';
  					if (value == 100207) return '调拨出库';
  					if (value == 100206) return '调拨单';
  					if (value == 100205) return '销售退货入库';
  					if (value == 100204) return '销售出库';
  					if (value == 100203) return '采购退货出库';
  					if (value == 100202) return '采购入库';
  					if (value == 100201) return '库存建账';
  				},
  				edit: false
  			},
		{field: "realname", title: "业务员", align: "center", edit:false},
		{field: "biz_bill_sn", title: "业务单号", align: "center", edit:false},
		{field: "biz_date", title: "业务日期", align: "center", edit:false},
	];
	
	return fields;
}

</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	 <h1>库存明细账</h1>
	 <ol class="breadcrumb">
	 	<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	 	<li><a href="#">库存管理</a></li>
	 	<li class="active">库存明细账</li>
	 </ol>
</section>

<!-- Main content -->
<section class="content">
	<div class="row content-row">
		<div class="input-group input-group-sm" style="float: right">
			<span >开始时间：</span><input type="text" value="" id="startdate" placeholder="开始时间">&nbsp;&nbsp;<span>截止时间：</span><input type="text" value="" id="enddate" placeholder="截止时间">&nbsp;&nbsp;&nbsp;&nbsp;
			<span id="search-submit" class="btn btn-default btn-sm btn-flat" >搜索</span>
		</div>
	</div>
	<div class="box">
		<table class="table table-striped table-hover table-condensed" id="_inventory_detail_table" ></table>
	</div>
	
</section>

</@layout>