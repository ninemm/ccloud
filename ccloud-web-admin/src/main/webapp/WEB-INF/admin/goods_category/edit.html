<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
</#macro>
 
<#macro script>

var $form = $("#form");

$(function() {
	
	jQuery.mm.initValidator('#form', validatorFields)
	
	$('#_category_tree').click(function() {
		layer.open({
			title:'上级分类',
		    type: 2,
		    area: ['580px', '530px'],
		    fix: false, //不固定
		    content: '${CPATH}/admin/category/category_tree'
		});
	});
	
	$("#company").change(function() {
		var supplierid = $("#company").find("option:selected").val(); 
		$("#brand_op").empty().append("<option value=''>--请选择--</option>");
		$.ajax({
			url:"${CPATH}/admin/category/getBrand",
			type:"post",
			data:{"supplierid":supplierid},
			dataType:"json",
			success:function(data) {
				for (var i = 0; i < data.length; i++) {
					$("#brand_op").append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
				}
			}
		});
	});
		
});

var validatorFields = {
	'goodsCategory.name': {
		validators: {
            notEmpty: { message: '分类名称不能为空' },
            stringLength: { max: 15, message: '分类名称最大长度是15字符，请重新输入' }
        }
	},
	'goodsCategory.code': {
		validators: {
			notEmpty: { message: '分类编码不能为空' },
	        stringLength: { min: 1, max: 20, message: '分类编码最大长度是20字符，请重新输入' }
        }
	},
	'parentName': {
		validators: {
			notEmpty: { message: '上级部门不能为空' }
        }
	},
	'goodsCategory.grade': {
		validators: {
			notEmpty: { message: '层级不能为空' },
			integer: {message: '请输入正整数'}
        }
	},
	'goodsCategory.supplier_id': {
		validators: {
			notEmpty: { message: '供应商不能为空' }
        }
	},
	'goodsCategory.brand_id': {
		validators: {
			notEmpty: { message: '品牌不能为空' }
        }
	},
	'goodsCategory.state': {
		validators: {
			notEmpty: { message: '请选择有效状态' }
        }	
	},
	'goodsCategory.order_list': {
		validators: {
			integer: {message: '请输入正整数'}
		}
	}
};

function doSubmit(){
	$form.ajaxSubmit({
		beforeSubmit: function() {
			var validate = $form.data('bootstrapValidator');
			validate.validate();
			return validate.isValid();
		},
		type : "post", 
		dataType : "json", 
		success : function(data) { 
			if(data.errorCode == 0) {
				//location.reload();
				toastr.success(data.message, '操作成功');
			} else {
				toastr.error(data.message,'操作失败');
			}
		},
		error : function() {
			alert("信息提交错误");
		}
	});
}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (goodsCategory.id) ??>修改<#else>新增</#if>商品分类</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li>商品管理</li>
       	<li class="active"><#if (goodsCategory.id) ??>修改<#else>新增</#if>商品分类</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">分类信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/category/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="goodsCategory.id" value="${(goodsCategory.id)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">分类名称:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="goodsCategory.name" value="${(goodsCategory.name)!}" placeholder="1-15个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">分类编码:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="goodsCategory.code" value="${(goodsCategory.code)!}" placeholder="1-15个任意字符">
		               	</div>
					</div>					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">分类层级:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="number" name="goodsCategory.grade" value="${(goodsCategory.grade)!}" placeholder="2-2个任意数字">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">供应商:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="goodsCategory.supplier_id" id="company">
								<option value="">--请选择--</option>
								<#list (list)! as supplier >
									<option value="${supplier.id}" <#if goodsCategory?? && supplier.id == goodsCategory.supplier_id>selected="selected"</#if>>${(supplier.name)!}</option>
								</#list>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">品牌:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="goodsCategory.brand_id" id="brand_op">
								<option value="">--请选择--</option>
								<#list (blist)! as brand >
									<option value="${brand.id}" <#if goodsCategory?? && brand.id == goodsCategory.brand_id>selected="selected"</#if>>${(brand.name)!}</option>
								</#list>								
							</select>
		               	</div>
					</div>					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">上级分类:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="goodsCategory.parent_id" id="parent_id" value="${(goodsCategory.parent_id)!}">
			                 	<input class="form-control input-sm" readOnly type="text" id="parent_name" name="parentName" value="${(goodsCategory.parent_name)!}">
		                 		<div class="input-group-addon" id="_category_tree" style="cursor:pointer;">
		                 			<i class="fa fa-search"></i> 选择
								</div>
		                 	</div>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">有效状态:</label>
						<div class="input-group col-md-4 col-sm-10">
							<label class="radio-inline">
		                 		<input type="radio" name="goodsCategory.state" value="1" <#if !goodsCategory?? || goodsCategory.state == 1>checked</#if>>有效
		                 	</label>
		                 	<label class="radio-inline">
		                 		<input type="radio" name="goodsCategory.state" value="0" <#if goodsCategory?? && goodsCategory.state == 0>checked</#if>>无效
							</label>		                 		
		               	</div>
					</div>					
					<div class="form-group col-sm-12">
						<label class="control-label col-sm-2">排序:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="number" name="goodsCategory.order_list" value="${(goodsCategory.orderList)!10}">
		               	</div>
					</div>
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-primary">保存更改</button>
			<input type="button" class="btn btn-primary" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>