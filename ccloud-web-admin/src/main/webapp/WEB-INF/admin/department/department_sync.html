<#include "../_inc/_layout.html"/>

<#macro script_import>

	<!-- bootstrap-table -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
 	<!-- <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-edit.js"></script> -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
	<script src="${CPATH}/static/ladda/spin.min.js"></script>
    <script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>

	<!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
	<link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro script>
	var $departmentTable = $("#department_table");
    $(function() {
    	var num = 1;
    	url = "${CPATH}/admin/department/findByDataArea"
    	jQuery.mm.initEditTable('#department_table', url, initParams, initFields(), null);
        $(document).on('change', '#all', function(){
            var $this = this;
            $('input[name=checkItem]').each(function(){
                this.checked = $this.checked;
            })
        }).on('click', 'input[name=checkItem]', function(){
            var all = $('input[name=checkItem]').length;
            var now = $('input[name=checkItem]:checked').length;
            if(all == now) {
                $('#all')[0].checked = true;
            } else {
                $('#all')[0].checked = false;
            }
        })
        
        $("#dataArea").change(function() {
            $departmentTable.bootstrapTable('refresh');
        });
    })
    
    
 	var initParams = function(params) {
		var dataArea = $("#dataArea").find("option:selected").val();
		var keyword = $('#search').val();
		if (keyword) keyword = encodeURIComponent(keyword);
		var param = {
			size: params.limit,
			page: params.offset/params.limit + 1,
			dataArea: dataArea
		};
		return param;
	};
    
    var initFields = function() {
		var fields =
			[
				{field: "", title: "<input type='checkbox' onclick='checkA(this)' name='data1' value=''/>", align: "center", width: '5%',
				formatter: function(value, row, rowIndex) {
					var strHtml = '';
					if(!row.qywx_deptid) {strHtml = '<input type="checkbox" name="data" id="data" value="'+row.id+'"/>';}
					return strHtml;
				},
				edit:false
				},
				{field: "", title: "序号", align: "center", width: '10%',
				formatter: function (value, row, index) {  
                            return index+1;  
                        }
				, edit:false},
				{field: "dept_name", title: "部门名称", align: "center", width: '10%', edit:false},
				{field: "", title: "是否同步", align: "center", width: '10%',
				formatter: function(value, row, rowIndex) {
					if(row.qywx_deptid) {return "同步";}
					else {return "未同步";}
				},
				 edit:false},
			];
		return fields;
	}
	
	  $("#synchronous").click(function(){
            var l = Ladda.create( document.querySelector( '.ladda-button' ) );  
            var departmentIds="";
            $.each($('input:checkbox'),function(){
                if(this.checked){
					if($(this).val()!='on'){
					    departmentIds=departmentIds+$(this).val()+",";
					}
                }
            });
           if(departmentIds==""){
                toastr.error('你没有选择同步对象','操作失败');
            }else{
                l.start();
                $.ajax({
                    url:"${CPATH}/admin/department/synchronous",
                    type:"post",
                    data:{"departmentIds":departmentIds},
                    dataType:"json",
                    success:function(data) {
                        if (data.errorCode > 0) {
                            toastr.error(data.message, '同步失败');
                        } else {
                            toastr.success(data.message, '同步成功');
                        }
                        change();
                        setTimeout( function(){
                            l.stop();
                        }, 2 * 1000 );
                    }
                });
            }
        });
	
</#macro>
<@layout active_id=p child_active_id=c>
<section class="content-header">
    <h1>组织机构同步</h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li>用户权限</li>
        <li class="active">组织机构同步</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="row content-row">
        <div class="form-group"  style="margin-bottom:50px;">
                <div class="col-sm-4">
                    <label class="control-label col-sm-4">请选择公司：</label>
                    <div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" id="dataArea">
                            <option value="">--请选择--</option>
                            <#list list! as list >
                            <option value="${list.data_area!}">${(list.dept_name)!}</option>
                            </#list>
                        </select>
                    </div>
                </div>
                <div class="col-sm-7">
                </div>
                <div class="col-sm-1">
                    <button id="synchronous" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">同步</button>
                </div>
        </div>
        <div class="box">
			<table class="table table-striped table-hover table-condensed" id="department_table" ></table>
		</div>
        <!-- <table class="table table-striped table-bordered" width="100%">
            <thead>
                <tr>
                    <th class="col-sm-2 center" style="text-align: center;"><input type='checkbox' id="all"/></th>
                    <th class="col-sm-2 center" style="text-align: center;">序号</th>
                    <th class="col-sm-4 center" style="text-align: center;">部门名称</th>
                    <th class="col-sm-4 center" style="text-align: center;">是否同步</th>
                </tr>
            </thead>
            <tbody id="dataTbody">
                
            </tbody>
        </table> -->
    </div>
</section>

</@layout>