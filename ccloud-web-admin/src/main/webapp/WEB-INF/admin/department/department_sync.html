<#include "../_inc/_layout.html"/> 

<#macro script_import>
    <script src="${CPATH}/static/ladda/spin.min.js"></script>
    <script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
   <link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro> 

<#macro script>
    
    $(function() {
        $(document).on('change', '#all', function(){
            var $this = this;
            $('input[name=checkItem]').each(function(){
                this.checked = $this.checked;
            })
        }).on('click', 'input[name=checkItem]', function(){
            var all = $('input[name=checkItem]').length;
            var now = $('input[name=checkItem]:checked').length;
            if(all == now) {
                $('#all')[0].checked = true;
            } else {
                $('#all')[0].checked = false;
            }
        })
        
        $("#dataArea").change(function() {
            change();
        });
        
        function change(){
            var dataArea = $("#dataArea").find("option:selected").val(); 
            $.ajax({
                url:"${CPATH}/admin/department/findByDataArea",
                type:"post",
                data:{"dataArea":dataArea},
                dataType:"json",
                success:function(data) {
                    $("#dataTbody").empty();
                    $.each(data,function(index,el){
                        if(el.jpwx_open_id){ 
                            $("#dataTbody").append("<tr data-id='"+el.id+"'><td align='center'></td><td align='center'>"+(index+1)+"</td><td align='center'>"+el.seller_name+"</td><td align='center'>已同步</td></tr>");
                        }else{
                            $("#dataTbody").append("<tr data-id='"+el.id+"'><td align='center'><input type='checkbox' name='checkItem' value='"+el.id+"'/></td><td align='center'>"+(index+1)+"</td><td align='center'>"+el.seller_name+"</td><td align='center'>未同步</td></tr>");
                        }
                    })
                }
            });
        }
        
        
        $("#synchronous").click(function(){
            var l = Ladda.create( document.querySelector( '.ladda-button' ) );  
            var sellerIds="";
            $.each($('input:checkbox'),function(){
                if(this.checked){
                        if($(this).val()!='on'){
                            sellerIds=sellerIds+$(this).val()+",";
                        }
                }
            });
           if(sellerIds==""){
                toastr.error('你没有选择同步对象','操作失败');
            }else{
                l.start();
                $.ajax({
                    url:"${CPATH}/admin/department/synchronous",
                    type:"post",
                    data:{"sellerIds":sellerIds},
                    dataType:"json",
                    success:function(data) {
                        if (data.errorCode > 0) {
                            toastr.error(data.message, '同步失败');
                        } else {
                            toastr.success(data.message, '同步成功');
                        }
                        change();
                        setTimeout( function(){
                            l.stop();
                        }, 2 * 1000 );
                    }
                });
            }
        });
    })
    
</#macro>
<@layout active_id=p child_active_id=c>
<section class="content-header">
    <h1>组织机构同步</h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li>用户权限</li>
        <li class="active">组织机构同步</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <div class="row content-row">
        <div class="form-group"  style="margin-bottom:50px;">
                <div class="col-sm-4">
                    <label class="control-label col-sm-4">请选择公司：</label>
                    <div class="col-sm-8 input-group input-group-sm">
                        <select class="form-control" id="dataArea">
                            <option value="">--请选择--</option>
                            <#list list! as list >
                            <option value="${list.data_area!}">${(list.seller_name)!}</option>
                            </#list>
                        </select>
                    </div>
                </div>
                <div class="col-sm-7">
                </div>
                <div class="col-sm-1">
                    <button id="synchronous" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">同步</button>
                </div>
        </div>
        <table class="table table-striped table-bordered" width="100%">
            <thead>
                <tr>
                    <th class="col-sm-2 center" style="text-align: center;"><input type='checkbox' id="all"/></th>
                    <th class="col-sm-2 center" style="text-align: center;">序号</th>
                    <th class="col-sm-4 center" style="text-align: center;">经销商名称</th>
                    <th class="col-sm-4 center" style="text-align: center;">是否同步</th>
                </tr>
            </thead>
            <tbody id="dataTbody">
                
            </tbody>
        </table>
    </div>
</section>

</@layout>