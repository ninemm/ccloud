<#include "../_inc/_layer_layout.html"/>

<#macro script_import>
	<script type="text/javascript" src="${CPATH}/static/plugins/bootstrap-treeview/js/bootstrap-treeview.js"></script>
	<!-- <script src="${CPATH}/static/plugins/toastr/toastr.js"></script> -->
</#macro> 

<#macro css_import>
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-treeview/css/bootstrap-treeview.css">
	<!-- <link rel="stylesheet" href="${CPATH}/static/plugins/toastr/toastr.css"> -->
</#macro>

<#macro script>
	var $tree = $("#tree");
	var $saveBtn = $("#save_btn");
	var $rootNodeId = 0;
	$(document).ready(function() {
		jQuery.mm.initMultiTreeView('#tree', JSON.parse('${treeData!}'));
	});
	$saveBtn.click(function() {
		$saveBtn.attr("disabled", "disabled");
		var nodes = $tree.treeview("getSelected", $rootNodeId);
		if (nodes.length == 0) {// 未选中资源
			$saveBtn.removeAttr("disabled");
			layer.alert("请选择!", {icon: 2});
			return ;
		}
		var userIds = "";
		var userNames = "";
		$.each(nodes, function(idx, obj) {
			if (obj.tags.length == 2 && obj.tags[1] == 'user') {
				if (userIds == "") {
					userIds = obj.tags[0];
					userNames = obj.text;
				} else {
					userIds = userIds + "," + obj.tags[0];
					userNames = userNames  + "," + obj.text;
				}
			}
		});
		if (userIds.length > 230) {// 不能超过七个人
			$saveBtn.removeAttr("disabled");
			layer.alert("不能超过七个审核人，请重新选择!", {icon: 2});
			return ;
		}
		if(parent.flg == 0){
			parent.$("#order_reviewer_id").val(userIds);
			parent.$("#order_reviewer").val(userNames);
		} else {
			parent.$("#userIds").val(userIds);
			parent.$("#userNames").val(userNames);
		}

		var index = parent.layer.getFrameIndex(window.name); //获取窗口索引

		parent.layer.close(index);
		
	});
</#macro>

<@layout>
<div style="padding: 10px;">
	<div class="container">
		<div class="row">
			<div class="col-sm-8" id="tree"></div>
		</div>
		<div class="row">
			<div class="col-sm-10 offset1">
				<button type="button" id="save_btn" class="btn btn-sm btn-primary btn-flat">确定</button>
			</div>
		</div>
	</div>
</div>	
</@layout>