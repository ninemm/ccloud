<#include "../_inc/_layer_layout.html"/>

<#macro script_import>
	<script type="text/javascript" src="${CPATH}/static/plugins/bootstrap-treeview/js/bootstrap-treeview.js"></script>
	<!-- <script src="${CPATH}/static/plugins/toastr/toastr.js"></script> -->
</#macro> 

<#macro css_import>
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-treeview/css/bootstrap-treeview.css">
	<!-- <link rel="stylesheet" href="${CPATH}/static/plugins/toastr/toastr.css"> -->
</#macro>

<#macro script>

	var $tree = $("#tree");
	var $saveBtn = $("#save_btn");
	var $rootNodeId = 0;
	
	$(document).ready(function() {
	
		jQuery.mm.initTreeView('#tree', JSON.parse('${treeData!}'));
	
		$saveBtn.click(function() {
			$saveBtn.attr("disabled", "disabled");
			let nodes = $tree.treeview("getSelected", $rootNodeId);
			if (nodes.length == 0) {// 未选中资源
				$saveBtn.removeAttr("disabled");
				layer.alert("请选择父菜单!", {icon: 2});
				return ;
			}
			
			let parentId = nodes[0].tags[0];
			let dataArea = nodes[0].tags[1];
			let parentName = nodes[0].text;
			let level = nodes[0].tags[2];
			
			parent.$("#parent_id").val(parentId);
			parent.$("#parent_name").val(parentName);
			parent.$("#data_area").val(dataArea);
			parent.$("#level").val(parseInt(level)+1);
			
			parent.$('#form').data('bootstrapValidator')
			.updateStatus('parent_name', 'NOT_VALIDATED', null)
			.validateField('parent_name');
						
			let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
			parent.layer.close(index);
			
		});
	  	
	});
	
	// 递归获取所有的子节点nodeId
	function getSubNodesByParent(node) {
		var ts = [];
		if (node.nodes) {
			ts.push(node.nodeId);
			for (i in node.nodes) {
				ts.push(node.nodes[i].nodeId);
				if (node.nodes[i].nodes) {
					var parentNode = getSubNodesByParent(node.nodes[i]);
					for (j in parentNode) {
						ts.push(parentNode[j]);
					}
				}
			}
		} else {
			ts.push(node.nodeId);
		}
		return ts;
	}
</#macro>

<@layout>
<div style="padding: 10px;">
	<div class="container">
		<div class="row">
			<div class="col-sm-8" id="tree"></div>
		</div>
		<div class="row">
			<div class="col-sm-10 offset1">
				<button type="button" id="save_btn" class="btn btn-sm btn-primary btn-flat">确定</button>
			</div>
		</div>
	</div>
</div>	
</@layout>