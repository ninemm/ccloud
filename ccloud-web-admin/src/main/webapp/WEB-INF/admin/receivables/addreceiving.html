<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
 	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
</#macro>

<#macro script>
var ref_sn = '${ref_sn}';
var bill_id = '${bill_id}';
var ref_type = '${ref_type}';
var userInfo = JSON.parse('${userInfo}');

var $form = $("#form");

$(function(){
	
    jQuery.mm.initDatetimepicker('form', '#biz_date', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
<!-- 	var nowDate = new Date(); -->
<!-- 	var nowDateStr = getDateTime(nowDate); -->
	
<!-- 	$('#biz_date').datetimepicker({ -->
<!-- 		language: 'zh-CN', -->
<!--     	format: 'yyyy-mm-dd hh:ii:ss', -->
<!--     	endDate: nowDate, -->
<!--     	todayBtn: true, -->
<!--     	initialDate: nowDateStr -->
<!-- 	}); -->
	
<!-- 	$("#biz_date").val(nowDateStr); -->
	
	$('#receive_user').select2({
		'data':userInfo,
		 width: "100%",
		'placeholder':'请选择',
  		'allowClear':false
	});
  
  	var validatorFields = {
  		'act_amount':{
  			validators: {
				notEmpty: { message: '收款金额不能为空' },
				regexp:{regexp:/[1-9]\d*\.?\d*/, message:'收款金额为数字'}
			}
  		}
  	};
  	
  	jQuery.mm.initValidator('#form', validatorFields)
});

function doSubmit(){
	$form.ajaxSubmit({
		beforeSubmit: function() {
			var validate = $form.data('bootstrapValidator');
			validate.validate();
			return validate.isValid()
		},
		type : "post", 
		dataType : "json", 
		success : function(data) {
			if(data.errorCode == 0) {
				//location.reload();
				toastr.success(data.message, '操作成功');
				setTimeout("returnToList()",toastr.options.showDuration);
			} else {
				toastr.error(data.message,'操作失败');
			}
		},
		error : function() {
			alert("信息提交错误");
		}
	});
}

function returnToList(){
	window.location.href = "${CPATH}/admin/receivables/renderlist?ref_sn=${ref_sn}&ref_type=${ref_type}&object_id=${object_id}";
}

// 获取日期字符串
<!-- function getDateTime(date){ -->
<!-- 	var dateStr = ''; -->
<!-- 	if(getObjectClass(date) === 'Date'){ -->
<!-- 		var nowY = date.getFullYear(); -->
<!-- 		var nowM = date.getMonth()+1; -->
<!-- 		var nowD = date.getDate(); -->
<!-- 		var nowH = date.getHours() < 10 ? "0" + date.getHours() : date.getHours(); -->
<!-- 		var nowMin =  date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes(); -->
<!-- 		var nowS = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds(); -->
<!-- 		dateStr = nowY+"-"+(nowM<10 ? "0" + nowM : nowM)+"-"+(nowD<10 ? "0"+ nowD : nowD)+" "+nowH+":"+nowMin+":"+nowS; -->
<!-- 	} -->
<!-- 	return dateStr; -->
<!-- } -->

// 获取类名
function getObjectClass(obj){
 if (obj && obj.constructor && obj.constructor.toString()) {
   	if(obj.constructor.name) {
    	return obj.constructor.name;
   	}
   	var str = obj.constructor.toString();

    if(str.charAt(0) == '[')
   	{
     	var arr = str.match(/\[\w+\s*(\w+)\]/);
   	} else {
       var arr = str.match(/function\s*(\w+)/);
    }
    if (arr && arr.length == 2) {
        return arr[1];
     }
  }
  return undefined; 
};
</#macro>

<@layout active_id=p child_active_id=c>
<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>录入收款记录</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">库存管理</a></li>
       	<li class="active">录入收款记录</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<form action="${CPATH}/admin/receivables/save" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="bill_id" value="${bill_id}"/>
			<input type="hidden" name="ref_type" value="${ref_type}"/>
			<div class="box-body">
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">单号:</label>
					<div class="input-group col-md-4 col-sm-10">
						<input class="form-control input-sm" type="text" name="ref_sn" readonly="true" value="${ref_sn}">
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">*收款日期:</label>
					<div class="input-group col-md-4 col-sm-10">
						<input type="text" value="" name="biz_date" id="biz_date" placeholder="收款日期" class="form-control form_datetime">
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">*收款金额:</label>
					<div class="input-group col-md-4 col-sm-10">
						<input class="form-control input-sm" type="text" name="act_amount" value="${(act_amount)!}" placeholder="收款金额">
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">*收款人:</label>
					<div class="input-group col-md-4 col-sm-10">
						<select id="receive_user" name="receive_user"></select>
					</div>
				</div>
				
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">备注:</label>
					<div class="input-group col-md-4 col-sm-10">
						<input class="form-control input-sm" type="text" name="remark" value="${(remark)!}" placeholder="备注">
					</div>
				</div>
			</div>
		</form>
		
		<div class="box-footer">
			<button type="button" onclick="doSubmit()" class="btn btn-primary">保存</button>
			<input type="button" class="btn btn-primary" onclick="returnToList()" value="返  回" hidefocus="true" />
		</div>
	</div>
</section>
</@layout>