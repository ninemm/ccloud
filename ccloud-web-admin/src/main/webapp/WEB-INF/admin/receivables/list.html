<#include "../_inc/_layout.html"/>

<#macro script_import>

    <!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- bootstrap-table -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
 	<!-- <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-edit.js"></script> -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
 	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
 	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>

	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- bootstrap-table-->	
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro script>
	var ref_sn = '${ref_sn}';
	var ref_type = '${ref_type}';
	var object_id = '${object_id}';
    var type = '${type}';
	var userInfo = JSON.parse('${userInfo}');
	var bill_id = '${bill_id}';
	var balance_amount = '${balance_amount}';
	var $form = $("#form");
	 

	$(function(){
		$('.balance_amount').val(balance_amount);
		if($('.balance_amount').val()==0){
	    	$("#save").attr("disabled",true);
	    }
		var url = '${CPATH}/admin/receivables/list?ref_sn='+ref_sn;
		jQuery.mm.initEditTable('#_receiving_table', url, initParams, initFields(), null);
		jQuery.mm.initDatetimepicker('form', '#biz_date', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
		
		$('#receive_user').select2({
		'data':userInfo,
		 width: "100%",
		'placeholder':'请选择',
  		'allowClear':false
	      });
	      
	     var validatorFields = {
  		'act_amount':{
  			validators: {
				notEmpty: { message: '收款金额不能为空' },
				regexp:{regexp:/[1-9]\d*\.?\d*/, message:'收款金额为数字'},
				between:{min:0,max:balance_amount,message:'请确认收款金额'}
			}
  		}
  	  };
  	  
  	 jQuery.mm.initValidator('#form', validatorFields);
  	 
	});
	
	var initFields = function(){
		var fields = [
			{field: "biz_date", title: "收款日期", align: "center", edit:false},
			{field: "act_amount", title: "收款金额", align: "center",
				formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
			 edit:false},
			{field: "receive_user_name", title: "收款人", align: "center", edit:false},
			{field: "create_date", title: "录入时间", align: "center", edit:false},
			{field: "input_user_name",title: "录入人", align:"center",edit:false},
			{field: "remark",title:"备注",align:"center",edit:false}
		];
		
		return fields;
	};
	
	var initParams = function(params){		
		var param = {
			'size': params.limit,
			'page': params.offset/params.limit + 1,
			'ref_sn': ref_sn
		}
		return param;
	};
	
	
	function doSubmit(){
		var l = Ladda.create( document.querySelector( '.ladda-button' ) );	
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				return validate.isValid();
				if (validate.isValid()) {
					l.start();
				}
			},
			type : "post", 
			dataType : "json", 
			success : function(data) {
				l.start();
				if(data.errorCode == 0) {
					//location.reload();
					var act_amount = $('input[name="act_amount"]').val();
					balance_amount = balance_amount-act_amount;
					toastr.success(data.message, '操作成功');
				    $('#_receiving_table').bootstrapTable('refresh');
				    $('.act_amount').val(0);
				    if($('.balance_amount').val()==0){
				    	$("#save").attr("disabled",true);
				    }
				} else {
					toastr.error(data.message,'操作失败');
				}
				setTimeout( function(){
						l.stop();
						location.reload();
								}, 2 * 1000 );
			},
			error : function() {
				l.stop();
				alert("信息提交错误");
			}
		});
	}
	function changeMoney(){
		var act_amount = $('input[name="act_amount"]').val();
		$('input[name="balance_amount"]').val(balance_amount-act_amount);
		if(parseInt(act_amount)>parseInt(balance_amount)){
			$("#save").attr("disabled",true);
		}else{
			$("#save").attr("disabled",false);
		}
	}
</#macro>


<@layout active_id=p child_active_id=c>

<section class="content-header">
	<h1>收款记录</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i>Home</a></li>
       	<li><a href="#">帐款管理</a></li>
       	<li class="active">收款记录</li>
	</ol>
</section>


<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<form action="${CPATH}/admin/receivables/save" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="bill_id" value="${(bill_id)!}"/>
			<input type="hidden" name="ref_type" value="${(ref_type)!}"/>
			<div class="box-body">
		      <div class="form-group">
				<div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">单号:</label>
					<div class="input-group  col-sm-7">
						<input class="form-control input-sm" type="text" name="ref_sn" readonly="true" value="${(ref_sn)!}">
					</div>
				</div>
				<div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">*收款日期:</label>
					<div class="input-group  col-sm-7">
						<input type="text" value="" name="biz_date" id="biz_date" placeholder="收款日期" class="form-control form_datetime">
					</div>
				</div>
			 </div>
			   <div class="form-group">
			   <div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">*收款人:</label>
					<div class="input-group col-sm-7">
						<select id="receive_user" name="receive_user"></select>
					</div>
				</div>
				<div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">*收款金额:</label>
					<div class="input-group  col-sm-7">
						<input class="form-control input-sm act_amount" type="text" name="act_amount" value="${(act_amount)!}" onblur="changeMoney()" placeholder="收款金额">
					</div>
				</div>
				</div>
				<div class="form-group">
				<div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">备注:</label>
					<div class="input-group col-sm-7">
						<input class="form-control input-sm" type="text" name="remark" value="${(remark)!}" placeholder="备注">
					</div>
				</div>
				<div class="col-sm-5 validata-box">
					<label class="control-label col-sm-3">*未收金额:</label>
					<div class="input-group  col-sm-7">
						<input class="form-control input-sm balance_amount" type="text" name="balance_amount" value="${(balance_amount)!}" placeholder="未收金额" readonly>
					</div>
				</div>
			</div>
			</div>
		</form>
		
		<div class="box-footer">
			<button type="button" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">保 存</button>
			<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</div>
	<div class="box">
		<table class="table table-striped table-hover table-condensed" id="_receiving_table"></table>
	</div>
</section>
</@layout>