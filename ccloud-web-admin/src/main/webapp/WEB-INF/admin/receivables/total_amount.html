<#include "../_inc/_layout.html"/>

<#macro script_import>

    <!-- bootstrap-table -->
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <!-- bootstrapValidator -->
    <script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
</#macro>

<#macro css_import>

    <!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <!-- bootstrapValidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">

</#macro>

<#macro script>
	//var type = $("#selecttype").val();
	
	var detail_object_id = "";
	
	var receivablesUrl = '${CPATH}/admin/receivables/getTotalAmount';
	$(function() {
		updateOptions();
		
		/*$("#selecttype").change(function(){
			updateOptions();
			type = $(this).val();
		});*/
	
		jQuery.mm.initEditTable('#_receivables_table', receivablesUrl, getReceivablesParams, initReceivablesTable(), null);
		$("#search-receivables").click(function(){
			$('#_receivables_table').bootstrapTable('refresh');
		});
		
		
	});
	
	function updateOptions(){
		//var type = $("#selecttype").val();
		$.ajax({
			url: "${CPATH}/admin/receivables/getOptions",
			async: false,
			success: function(data){
				var optionsHtml = '<option value="0" >全部</option>';
				if(data.length && data.length>=1){
					for(var i in data){
						optionsHtml += '<option value="'+data[i].id+'" >'+data[i].name+'</option>';
					}
				}
				$("#category-or-customer").html(optionsHtml);
			}
		});
	}
	var initReceivablesTable = function(){
		var fields = [
			{field: "customer_name",title:"名称",align: "center", width: '12%',sortable: true, edit:false},
			{field: "amount",title:"应收金额",align: "center",
				formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},sortable: true,
			edit:false},
			{field: "actAmount",title:"实收金额",align: "center",
				formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},sortable: true,
			edit:false},
			{field: "balanceAmount",title:"未收金额",align: "center",
				formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},sortable: true,
			edit:false}
		];
		
		return fields;
	};
	
	var  cusType = "";
	var getReceivablesParams = function(params){
		var keyword = $('#search').val();
		if (keyword) keyword = encodeURIComponent(keyword);
		var customerTypeId = $('#category-or-customer').find("option:selected").val();
		cusType = customerTypeId;
			var param = {
		        size: params.limit,
		        page: params.offset/params.limit + 1,
//		        type : type,
		        customerTypeId:customerTypeId,
		        sort: params.sort,      //排序列名  
           		sortOrder: params.order, //排位命令（desc,asc）
		        keyword : keyword
		    };
		    return param;
		}
	
	function batchDown(){
			var keyword = $('#search').val();
			if (keyword) keyword = encodeURIComponent(keyword);
			location.href = "${CPATH}/admin/receivables/downloadingAmount?customerTypeId=" + cusType+"&keyword="+keyword;
	}
	
</#macro>
<@layout active_id=p child_active_id=c>
	
<section class="content-header">
	<h1>帐款汇总</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">帐款汇总</a></li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
		<div class="form-horizontal">
			<div class="form-group">
	                <div class="col-sm-4">
	                	<button onclick="batchDown()" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-upload"></i> 导出</button>
				 	 </div>
					<div class="col-sm-4">
						<label class="control-label col-sm-4">客户类型：</label>
						<div class="col-sm-8 input-group input-group-sm">
							<select id="category-or-customer" class="form-control">
								<option value="0">全部</option>
							</select>
	                    </div>
					</div>
					<div class="col-sm-3">
						<label class="control-label col-sm-4">名称：</label>
						<div class="col-sm-8 input-group input-group-sm">
							<input id="search" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">
	                    </div>
					</div>
					<div class="col-sm-1">
						<input id="search-receivables" class="btn btn-sm btn-primary btn-flat" type="button" value="搜索">
					</div>
				</div>
			</div>
		</div>
	<div class="box" style="margin-top:50px;">
        <table class="table table-striped table-hover table-condensed" id="_receivables_table" ></table>
    </div>
    <div class="box">
        <table class="table table-striped table-hover table-condensed" id="_receivables_detail_table" ></table>
    </div>
</section>

</@layout>