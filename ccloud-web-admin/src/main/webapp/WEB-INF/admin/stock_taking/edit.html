<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
 	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
 	<!--select2  -->
 	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
 	
 	
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <!-- select2 -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
    <link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>
 
<#macro script>
	var $form = $("#form");
	var buer=false;
	$(function() {
		jQuery.mm.initValidator('#form', validatorFields)
	});
	
	var validatorFields = {
		'stockTaking.warehouse_id': {
			validators: {
	            notEmpty: { message: '盘点仓库不能为空' },
	        }
		},
		'stockTaking.biz_user_id': {
			validators: {
	            notEmpty: { message: '盘点人不能为空' },
	        }
		}
	};
	
	function doSubmit(){
		var l = Ladda.create( document.querySelector( '#do_submit' ) );
		var stock = $(".stock");
		stock.each(function(index,element){
			if(index==0){
				return true;
			};
			var x = $(this).val();
			if(x==null||x==""){
				toastr.error('第'+index+'行盘点数量不能为空','操作失败');
				buer=true;
				return false;
			}
			var reg = /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/;
			if (!reg.test(x)) {
				toastr.error('第'+index+'行请正确输入的数量','操作失败');
				buer = true;
				return false;
			}
		});
		if(buer){
			buer=false;
			return;
		}
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				if (validate.isValid()) {
						l.start();
					}
				return validate.isValid();
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if (data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
				setTimeout( function(){
							window.history.back(-1);
									}, 1500 );
			},
			error : function(data) {
				l.stop();
				if(data.status == 200){
					location.href = "${CPATH}/admin/login";
				}else{
					alert("信息提交错误");
				}
			}
		});
	}

	function initProduct(warehouse_id){
         var productList = new Array();
         var productOptionArr = new Array();
         var productMap = new Map();
         var goodsCategory_id = $("#goodsCategory_id").val();
         $.ajax({
			url: "${CPATH}/admin/stockTaking/getProductInfo",
			data:{"warehouse_id":warehouse_id,"goodsCategory_id":goodsCategory_id},
			dataType: "json",
			async: false,
			success: function(data) {
				productList = data;
				pList = productList;
			}
		});
		if(productList) {
			$.each(productList, function(idx, item) {
				var option = {
					id: item.sellerProductId,
					text: item.custom_name
				}
				productOptionArr.push(option);
		        pOptionArr = productOptionArr;
				productMap[item.sellerProductId] = item;
				pMap = productMap;
			});
		}
	}

	<!--商品列表 -->
	var pList = new Array();
	var pOptionArr = new Array();
	var pMap = new Map();
	function removeTr(obj) {
		$(obj).parent().parent().remove();
	}
	
	function deleteTr(obj){
	  $(obj).parent().parent().remove();
	}
	
	
	//切换调入仓库后事件
	$("#warehouse_id").change(function(){
	    var fromWarehouseId = $("#warehouse_id").val();
	    initProduct(fromWarehouseId);
	})
	
	function addNew() {
	   //添加商品验证，是否选择一个盘点仓库
	    var fromWarehouseId = $("#warehouse_id").val();
	    if(fromWarehouseId == "" || fromWarehouseId == null || fromWarehouseId == undefined){
		    alert("请先选择一盘点仓库");
		    return;
	    }
	    initProduct(fromWarehouseId);
		addTr("#dataTable", pList, pOptionArr);
	}
	
	var index = 1;
	
	function addTr(tid, productList, optionArr) {
		var goodsCode = productList[0].sellerProductId;
		var goodsName = productList[0].name;
		var specification = productList[0].specificationValue;
		var big_unit = productList[0].bigUnit;
	    var balance_count = productList[0].balance_count == null ? "暂未盘点": productList[0].balance_count;	
	
		var $tbody = $(tid + " tbody"),
		$tr = $tbody.find("tr:eq(0)"),
		lastTrIdx = $tbody.find("tr:last").index(),
		newTrIdx = lastTrIdx + 1,
		trHtml = $tr.html();
	
		$tbody.append("<tr id='tr" + newTrIdx + "'>" +trHtml+ "</tr>");
	    $tbody.find("tr:last>td>#goodsCode").attr("name","stockTakingList["+ lastTrIdx +"].seller_product_id");
	    $tbody.find("tr:last>td>#stock").attr("name","stockTakingList["+ lastTrIdx +"].product_count"); 
	    $tbody.find("tr:last>td>#remarks").attr("name","stockTakingList["+ lastTrIdx +"].remark");           
	    $tbody.find("tr:last>td>#goodsCode").val(goodsCode);
	    $tbody.find("tr:last>td>#specification").text(specification);
	    $tbody.find("tr:last>td>#big_unit").text(big_unit);
	    $tbody.find("tr:last>td>#balance_count").text(balance_count);
	    $tbody.find("tr:last>td>#factIndex").attr("value",lastTrIdx);
	    $tbody.find("tr:last").find(":input").attr("disabled",false);
	    var productCount = 'stockTakingList['+ lastTrIdx +'].product_coun';
	    $tbody.find("tr:last>td>select.pro-slc2").select2({
	       data:optionArr,
	       width: "100%",
	       language: "zh-CN"
	    });
	
	    $tbody.find("tr:last>td>.hide").text($tbody.find("tr:last>td>select").find("option:selected").val());
	    $tbody.find("tr:last>td>select>pro-slc2").focus();
	
	    <!--添加商品的移除-->
	    $tbody.find("tr:last>td>.removeTr").click(function(){
	      $("#tr" + newTrIdx).remove();  
	    });
	
	    <!--切换商品的方法  -->
	    $tbody.find("tr:last>td>select.pro-slc2").change(function(){
	     	 productChange($(this),$(this).val());
	     });  
	};
	
	function productChange(obj,key){
		 var result = pMap[key];   
	     var cgoodsCode = result.sellerProductId;
	     var cgoodsName = result.name;
	     var cspecification = result.specificationValue;
	     var cbig_unit = result.bigUnit;
	     var balance_count = result.balance_count == null ? "暂未盘点":result.balance_count;
	     var $tr = obj.parent().parent();
	     
	     $tr.find("td>#goodsCode").val(cgoodsCode);
	     $tr.find("td>#goodsName").html(cgoodsName); 
	     $tr.find("td>#specification").text(cspecification);
	     $tr.find("td>#big_unit").text(cbig_unit);
	     $tr.find("td>#balance_count").text(balance_count); 
	     $tr.find("td>#stock").val(0); 
	
	}
	
	function selectWarehouse(){
		var warehouse_id = $('#warehouse_id').val(); 
		var goodsCategory_id = $("#goodsCategory_id").val();
		 if(warehouse_id == "" || warehouse_id == null || warehouse_id == undefined){
		    return;
		}
		$('#dataTable tbody').find("tr:gt(0)").remove();
		$.ajax({
			url: "${CPATH}/admin/stockTaking/getProductInfo",
			data:{"warehouse_id":warehouse_id,"goodsCategory_id":goodsCategory_id},
			dataType: "json",
			success: function(data) {
				if(data!=""){
					 for(var i=0; i<data.length; i++){
					 	addTr("#dataTable", pList, pOptionArr);
					 	var sellerProductId = data[i].sellerProductId;
						var obj=$('#dataTable tbody').find("tr:last>td>select.pro-slc2"); 
						obj.val(sellerProductId).trigger("change");
						productChange(obj,sellerProductId);
					}
				}
			}
		});
	}

</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (stockTaking.id) ??>修改<#else>新增</#if>盘点单</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">库存管理</a></li>
       	<li class="active"><#if (stockTaking.id) ??>修改<#else>新增</#if>盘点单</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">库存盘点</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/stockTaking/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="stockTaking.id" value="${(stockTaking.id)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">单号:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="stockTaking.stock_taking_sn" value="${(stockTaking.stock_taking_sn)!}" placeholder="保存后自动生成" disabled="disabled">
		                 	<input  type="hidden" name="stockTaking.status" value="${(stockTaking.status)!}">
		               	</div>
					</div>
					<#if !(stockTaking.id) ??>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">商品分类:</label>
							<div class="input-group col-md-4 col-sm-10">
								<select class="form-control input-sm"  id="goodsCategory_id" onchange=selectWarehouse()>
									<option value="">--全部--</option>
									<#list (goodsCategory)! as goodsCategory >
										<option value="${goodsCategory.categoryId}">${(goodsCategory.categoryName)!}</option>
									</#list>
								</select>
			               	</div>
						</div>			
					</#if>
					<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">盘点仓库:</label>
							<div class="input-group col-md-4 col-sm-10">
								<select class="form-control input-sm" name="stockTaking.warehouse_id" id="warehouse_id" onchange=selectWarehouse()>
									<option value="">--请选择--</option>
									<#list (wlist)! as warehouse >
										<option value="${warehouse.id}" <#if stockTaking?? && warehouse.id == stockTaking.warehouse_id>selected="selected"</#if>>${(warehouse.name)!}</option>
									</#list>
								</select>
			               	</div>
			               	
						</div>	
						
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">盘点人:</label>
							<div class="input-group col-md-4 col-sm-10">
								<select class="form-control input-sm" name="stockTaking.biz_user_id" id="biz_user_id">
									<option value="">--请选择--</option>
									<#list (ulist)! as user >
										<option value="${user.id}" <#if stockTaking?? && user.id == stockTaking.biz_user_id>selected="selected"</#if>>${(user.realname)!}</option>
									</#list>
								</select>
			               	</div>	
				      </div>
			      </div>

                 <div style="padding: 5px;clear: both;">
				<table id="dataTable" class="table table-striped table-bordered" width="100%" >
					<thead>
						<tr>
							<th class="col-sm-1 center">操作</th>
							<th class="col-sm-3 center">商品名称</th>
							<th class="col-sm-2 center">规格</th>
							<th class="col-sm-1 center">单位</th>
							<th class="col-sm-1 center">库存数量</th>
							<th class="col-sm-2 center">盘盈(+)/盘亏(-)</th>
							<th class="col-sm-2 center">备注</th>
						</tr>
					</thead>
					<tbody id="sProdBody">
						<tr class="hide-always hide">
							<td class="center">
								<a class="btn btn-danger btn-xs removeTr" data-toggle="modal" data-target="#deleteBackProModal" ><span class="glyphicon glyphicon-remove"></span></a>
							</td>
							<td class="text-left">
								<input type="hidden" id="goodsCode" name="stockTakingList[-1].seller_product_id" disabled="true" />
							   <input type="hidden"  id="factIndex" name="factIndex" value="-1"/>
								<select class="pro-slc2">
								</select>
							</td>
							<td>
								<span class="specification" id="specification"></span>
							</td>
							<td>
								<span class="big_unit" id="big_unit"></span>
							</td>
							</td>
							<td>
								<span class="balance_count" id="balance_count"></span>
							</td>
								<td>
									<input type="text" id="stock" class="stock" name="stockTakingList[-1].product_count" disabled="true" />
								</td>
							<td class="text-left">
								<input type="text"  class="remarks" id="remarks" name="stockTakingList[-1].remark" disabled="true">
							</td>
						</tr>
						<#list (ilist)! as list>
							<tr id="tr${list_index+1}">
							    <td class="center">
							<a class="btn btn-danger btn-xs removeTr" data-toggle="modal" data-target="#deleteBackProModal" onclick="deleteTr(this)"><span class="glyphicon glyphicon-remove"></span></a>
							</td>
							<td class="text-left">
								<input type="hidden" id="goodsCode" name="stockTakingList[${list_index}].seller_product_id"  value="${list.sellerProductId!}" />
								<input type="text" id="goodsName" name="goodsName"  value="${list.customName!}" disabled="disabled"/>
							   <input type="hidden"  id="factIndex" name="factIndex" value="${list_index!}"/>
							</td>
							<td>
								<input name="specification" id="specification" value="${list.specificationValue!}" disabled="disabled"></input>
							</td>
							<td>
								<input name="big_unit" id="big_unit" value="${list.bigUnit!}" disabled="disabled"></input>
							</td>
							<td>
								<input name="balance_count" id="balance_count" value="${list.balance_count!}" disabled="disabled"></input>
							</td>
							<td>
							<input type="text" id="stock" class="stock" name="stockTakingList[${list_index}].product_count"  value="${list.productCount!}" />
							</td>
							<td class="text-left">
								<input type="text"  class="remarks" id="remarks" name="stockTakingList[${list_index}].remark" value="${list.remark!}">
							</td>
							</tr>
						</#list>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="7">
								<button id="btnAddProd" type="button" class="btn btn-xs btn-info" style="width: 80px;" onclick="addNew()">添加商品</button>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>
        </div>

		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" id="do_submit" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">保存更改</button>
			<input type="button" class="btn btn-sm bg-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>

	