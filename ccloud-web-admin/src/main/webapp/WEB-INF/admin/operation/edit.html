<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
 	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
    <link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
</#macro>

<#macro css>
	.input-group-addon {
		cursor: pointer;
		padding: 6px 4px;
	}
</#macro>

<#macro script>
	$("#assignRole").select2();
	$("#assignStation").select2();

	var $form = $("#form");
	$(function() {
	
	jQuery.mm.initValidator('#form', validatorFields)
	$.ajax({
		url:"${CPATH}/admin/operation/getRoleAndStation",
		type:"post",
		data:{"id":'${(operation.id)!}'},
		dataType:"json",
		success:function(data) {
			var role = data.roles;
			for (var i = 0; i < role.length; i++) {
				if (role[i].isvalid == 0 ) {
					$("#assignRole").append("<option value=" + role[i].id + ">" + role[i].name + "</option>");
				} else {
					$("#assignRole").append("<option value=" + role[i].id + " selected >" + role[i].name + "</option>");
				}
			}
		}
	});	
	
	$('#_module_tree').click(function() {
			layer.open({
				title:'模块资源',
			    type: 2,
			    area: ['580px', '530px'],
			    fix: false, //不固定
			    content: '${CPATH}/admin/module/module_tree'
			});
		});
		
	$('#_station_tree').click(function() {
		layer.open({
			title:'岗位资源',
			type: 2,
			area: ['580px', '530px'],
			fix: false, //不固定
			content: '${CPATH}/admin/operation/station_tree'
		});
	});	
	
});
	
	
	var validatorFields = {
		'operation.module_id': {
			validators: {
	            notEmpty: { message: '所属模块不能为空' }
	        }
		},
		'operation.station_name': {
			validators: {
	            notEmpty: { message: '岗位不能为空' }
	        }
		},		
		'operation.operation_name': {
			validators: {
	            notEmpty: { message: '功能名称不能为空' },
	            stringLength: { min: 2, max: 15, message: '功能名称最大长度必须在2到30字符之间，请重新输入' }
	        }
		},
		'operation.operation_code': {
			validators: {
	            notEmpty: { message: '功能编码不能为空' },
	            stringLength: { min: 2, max: 15, message: '功能名称最大长度必须在2到30字符之间，请重新输入' }
	        }
		}
		
	};
	

	function doSubmit(){
		var rlist = $("#assignRole").select2("val");
		var roleIds = "";
		if (rlist != null && rlist.length > 0) {
			roleIds = rlist.toString();
		}
		
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				return validate.isValid();
			},
			type : "post", 
			data : { "roleList":roleIds },
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (operation.id) ??>修改<#else>新增</#if>功能</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">用户权限</a></li>
       	<li class="active"><#if (operation.id) ??>更新<#else>新增</#if>功能</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">功能信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/operation/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="operation.id" value="${(operation.id)!}">
		<input type="hidden" name="ucode" value="${(ucode)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">所属模块:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="operation.module_id" id="parent_id" value="${(operation.module_id)!}">
			                 	<input class="form-control input-sm" type="text" id="parent_name" name="operation.module_name" value="${(operation.module_name)!}" placeholder="选择模块" readonly>
		                 		<div class="input-group-addon" id="_module_tree">
		                 			<i class="fa fa-search"></i> 选择
								</div>
		                 	</div>
		               	</div>
					</div>
					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">岗位:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="station_id" id="station_id" value="${(stationId)!}">
								<input class="form-control input-sm" type="text" id="station_name" name="station_name" value="${(stationName)!}" placeholder="请选择岗位"readonly>
								<div class="input-group-addon" id="_station_tree">
									<i class="fa fa-search"></i> 选择
								</div>
							</div>
						</div>
					</div>					
					
					<div class="form-group col-sm-12">
						<label class="control-label col-sm-2">分配角色:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" id="assignRole" multiple="multiple" >
							</select>
						</div>
					</div>
					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">功能名称:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="operation.operation_name" value="${(operation.operation_name)!}" placeholder="2-30个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">功能编码:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="operation.operation_code" value="${(operation.operation_code)!}" placeholder="2-30个任意字符">
		               	</div>
					</div>
					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">URL:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="operation.url" value="${(operation.url)!}">
		               	</div>
					</div>
					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">描述:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="operation.description" value="${(operation.description)!}" placeholder="2-200个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">排序:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="number" name="operation.order_list" value="${(operation.order_list)!10}">
		               	</div>
					</div>
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-primary">保存更改</button>
			<input type="button" class="btn btn-primary" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>