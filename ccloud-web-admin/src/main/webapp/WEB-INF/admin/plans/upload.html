<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>	
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- bootstrap-datetimepicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
</#macro>

<#macro script>

	var $form = $("#form");

	var ti = ${(ti)!};
	$(function() {
		jQuery.mm.initDatetimepicker('form', '#month', 'month', 'yyyy-MM', 3, 10, 3);
		jQuery.mm.initDatetimepicker(null, '#startDate', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
		jQuery.mm.initDatetimepicker(null, '#endDate', 'endDate', 'yyyy-MM-dd', 2, 4, 2);
		jQuery.mm.initValidator('#form', validatorFields)
	});

	var validatorFields = {
		'month': {
			validators: {
				notEmpty: { message: '计划周期不能为空' },
			}
		},
		'file': {
			validators: {
				notEmpty: { message: '请选择文件' },
			}
		}
	};
	$(document).on("change", "#month", function() {
			var date = new Date($("#month").val()+"-"+ti);
			var year = date.getFullYear();
		    var mon = date.getMonth()+2;     
		    var   day=date.getTime()-1000*60*60*24; 
		    date.setTime(day);
		    var strDay=date.getDate();  
			$("#startDate").val($("#month").val()+"-"+ti);
			$("#endDate").val(year+"-"+mon+"-"+strDay);
			
		});
	$('#_user_tree').click(function() {
		layer.open({
			title:'负责人',
			type: 2,
			area: ['580px', '530px'],
			fix: false, //不固定
			content: '${CPATH}/admin/sellerCustomer/user_tree'
		});
	});

	function doSubmit(){
		var start = $("#month").val();
		var l = Ladda.create( document.querySelector( '.ladda-button' ) );	
		$form.ajaxSubmit({
			beforeSubmit: function() {
			    var index = layer.load(1, {shade: false}); //0代表加载的风格，支持0-2
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				return validate.isValid()
			},
			type : "post", 
			dataType : "json", 
			data:{"start":start},
			success : function(data) { 
			    layer.closeAll();
				l.start();
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
				setTimeout( function(){
						window.history.back(-1);
				}, 2 * 1000 );
			},
			error : function() {
			    layer.closeAll();
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>导入计划</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>销售计划</li>
		<li class="active">导入计划</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">导入</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/plans/uploading" enctype="multipart/form-data" method="post" id="form" class="form-horizontal" >
			<div class="box-body">
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2" style = "padding-top:0px;">下载模版:</label>
					<div class="input-group col-md-4 col-sm-4-offset-2">
						<a href="${CPATH}/admin/plans/plansTemplate" target="_black">请点击下载模板</a>
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">计划月份:</label>
					<div class="input-group col-md-4 col-sm-4-offset-2" >
						 <input id="month" class="form-control" type="text" value="${month!}" name="month" placeholder="活动开始日期" style="height:30px;">
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">开始时间:</label>
					<div class="input-group col-md-4 col-sm-4-offset-2">
						<input id="startDate" class="form-control" value="${startDate!}" name="startDate" placeholder="开始日期" >
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2">结束时间:</label>
					<div class="input-group col-md-4 col-sm-4-offset-2">
						<input id="endDate" class="form-control" value="${endDate!}" name="endDate" placeholder="结束日期" >
					</div>
				</div>
				<div class="form-group col-sm-12 validata-box">
					<label class="control-label col-sm-2" style = "padding-top:0px;">*上传文件:</label>
					<div class="input-group col-md-4 col-sm-10">
						<input type="file" id="file" name="file" value="">
					</div>
				</div>
			</div>
		</form>
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat ladda-button">导入</button>
			<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</div>
</section>

</@layout>