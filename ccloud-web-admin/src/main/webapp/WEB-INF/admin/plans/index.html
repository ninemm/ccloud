<#include "../_inc/_layout.html"/>

<#macro script_import>

	<!-- bootstrap-table -->
	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>

</#macro>

<#macro css_import>

	<!-- bootstrap-table-->
<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
	<!-- bootstrap-datetimepicker -->
<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
	<!-- bootstrapvalidator -->
<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">

</#macro>

<#macro script>

	var $table = $("#plans_table");
	var url = '${CPATH}/admin/plans/list';
	
	var batchFlg = true;

	$(function() {
		jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM', 3, 10, 3);
		jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM', 2, 4, 2);
		jQuery.mm.initEditTable('#plans_table', url, initParams, initFields(), null);
		$(".monthType").show();
		/*$(".monthType").hide();
		$(".yearType").hide();*/
		
	});
	
	/*$(document).on("change", "#planType", function() {
		var planType = $("#planType").find("option:selected").val();
		if(planType == '101201'){
			$(".monthType").hide();
			$(".yearType").hide();
		}else if(planType == '101202'){
			$(".monthType").show();
			$(".yearType").hide();
		}else if(planType == '101203'){
			$(".monthType").hide();
			$(".yearType").show();
		}else{
			$(".monthType").hide();
			$(".yearType").hide();
		}
	});*/

	$("#search-submit").click(function() {
		$table.bootstrapTable('refresh');
	});

	var initParams = function(params) {

		var keyword = $('#search').val();
		var customerType = $('#customer_type').val();
//		var type = $("#planType option:selected").val();
		var type = "101202";
		var dateType = $("#startDate").val();
		//dateType =  $("#month option:selected").val();
		/*if(type == '101202'){
			dateType =  $("#month option:selected").val();
		}else if(type == '101203'){
		    dateType =  $("#year option:selected").val();
		}*/
		var param = {
			size: params.limit,
			page: params.offset/params.limit + 1,
			k: keyword,
			type: type,
			dateType : dateType
		};
		return param;
	};

	var initFields = function() {
		var fields =
			[
				{field: "id", title: "ID", align: "center", visible:false, edit:false},
				{field: "", title: "计划类型", align: "center", width: '5%',
					formatter: function(value, row, rowIndex) {
						if(row.type==101201) return "周计划";
						else if(row.type==101202) return "月计划";
						else  return "年计划";
					},
				 edit:false},
				{field: "", title: "计划月份", align: "center", width: '8%',
					formatter: function(value, row, rowIndex) {
						return row.plans_month.substring(0,7);
					},
				 edit: false},
				{field: "start_date", title: "开始时间", align: "center", width: '8%', edit:false},
				{field: "end_date", title: "结束时间", align: "center", width: '8%', edit:false},
				{field: "seller_name", title: "销售商名称", align: "center", width: '15%', edit: false},
				{field: "", title: "计划金额", align: "center", width: '3%',
					formatter: function(value, row, rowIndex) {
						return formatNumber(row.planNumAmount);
					},
				 edit: false},
				{field: "", title: "完成金额", align: "center", width: '3%',
					formatter: function(value, row, rowIndex) {
						return formatNumber(row.completeNumAmount);
					},
				 edit: false},
				{field: "complete_ratio", title: "完成率", align: "center", width: '3%',
					formatter: function(value, row, rowIndex) {
						return (row.completeRatio*100).toFixed(2)+"%";
					},
				 edit: false},
				 {field: "", title: "操作", align: "center", width: '5%',
				formatter: function(value, row, rowIndex) {
					var strHtml = '<a class="btn btn-xs btn-primary btn-flat" onclick="detailPlans(\''+row.id+'\')" >详细</a>';
					return strHtml;
				},
				edit:false
				}
			];
		return fields;
	}
	function batchDown(){
		/*var type = $("#planType option:selected").val();
		var dateType = "";
		if(type == '101202'){
			dateType =  $("#month option:selected").val();
		}else if(type == '101203'){
		    dateType =  $("#year option:selected").val();
		}*/
		type = "101202";
		dateType =  $("#startDate").val();
		jQuery.mm.down("${CPATH}/admin/plans/downloading?type="+type+"&&k="+$("#search").val()+"&&dateType="+dateType);
		window.event.returnValue=false; 
	}
	function detailPlans(id) {
		layer.open({
			title:"计划详细",
			type: 2, 
			area: ['70%', '80%'],
			content: '${CPATH}/admin/plans/detailPlans?plansId=' + id
		}); 
	}
</#macro>

<@layout active_id=p child_active_id=c>

<section class="content-header">
	<h1>计划列表</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li><a href="#">销售计划</a></li>
	<li class="active">计划列表</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
	    <form class="form-horizontal" role="form" id="form">
			 <div class="form-group">
				<!-- <div class="col-sm-4">
					<label class="control-label col-sm-4">计划类型:</label>
                    <div class="col-sm-8 input-group input-group-sm">
                    	<select  class="form-control" name="planType" id="planType" style="float: left;padding-right:5px;margin-right:5px;">
							<option value="">请选择</option>
							<#if dicts??>
								<#list dicts as dict>
									<option value="${(dict.value)}">${(dict.name)}</option>
								</#list>
							</#if>
						</select>
                    </div>
				</div>-->
				 <div class="col-sm-4">
					<@shiro.hasPermission name="/admin/plans/uploading">
						<a href="${CPATH}/admin/plans/upload?c=${c!}&p=${p!}" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-upload"></i> 导入</a>
					</@shiro.hasPermission>
					<@shiro.hasPermission name="/admin/plans/downloading">
						<button onclick="batchDown()" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-download"></i> 导出</button>
					</@shiro.hasPermission>
					<@shiro.hasPermission name="/admin/plans/edit">
						<a href="${CPATH}/admin/plans/edit?c=${c!}&p=${p!}" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-plus"></i> 新增计划 </a>
					</@shiro.hasPermission>
				</div>
				<div class="col-sm-4">
                </div>
				<div class="col-sm-3">
					 <label class="control-label col-sm-5">计划月份:</label>
	                 <div class="col-sm-7 input-group input-group-sm">
	                     <input id="startDate" class="form-control" type="text" value="${startDate!}" name="startDate" placeholder="计划月份" >
	                 </div> 
	             </div>
                <!-- <select  class="form-control" name="month" id="month" style="float: left;padding-right:5px;margin-right:5px;">
							<option value="">请选择</option>
							<#if months??>
								<#list months as month>
									<option value="${(month)}">${(month)}</option>
								</#list>
							</#if>
						</select> -->
				<!-- <div class="col-sm-4 yearType">
					<label class="control-label col-sm-4">计划周期:</label>
                    <div class="col-sm-8 input-group input-group-sm">
                    	<select  class="form-control" name="year" id="year" style="float: left;padding-right:5px;margin-right:5px;">
							<option value="">请选择</option>
							<#if years??>
								<#list years as year>
									<option value="${(year)}">${(year)}</option>
								</#list>
							</#if>
						</select>
                    </div>
				</div> -->
				<div class="col-sm-1">
					<input id="search-submit" class="btn btn-sm btn-primary btn-flat" type="button" value="搜索">
				</div>
			</div>
			<!-- <div class="form-group">
                <div class="col-sm-4">
					<@shiro.hasPermission name="/admin/plans/uploading, /admin/dealer/all, /admin/all">
						<a href="${CPATH}/admin/plans/upload?c=${c!}&p=${p!}" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-upload"></i> 导入</a>
					</@shiro.hasPermission>
					<button onclick="batchDown()" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-download"></i> 导出</button>
					<a href="${CPATH}/admin/plans/edit?c=${c!}&p=${p!}" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-plus"></i> 新增计划 </a>
				</div>
			</div> -->
		<div class="box">
			<table class="table table-striped table-hover table-condensed" id="plans_table" ></table>
		</div>
	</form>
</div>
	<!-- /.box -->
</section>
</@layout>