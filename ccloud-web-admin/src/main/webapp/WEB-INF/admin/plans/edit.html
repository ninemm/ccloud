<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- cityPicker -->
    <script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
	
</#macro>

<#macro css_import>
	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- bootstrap-datetimepicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- cityPicker -->
	<link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
	
</#macro>
<#macro css>
.imgDiv {
    display: inline-block;
    position: relative;
}
.delete {
    position: absolute;
    top: 0px;
    right: 0px;
    width: 32px;
    height: 33px;
    background: url(${CPATH}/static/plugins/goods/image/delete_1.png) repeat-x;
    cursor: pointer;
}
.jp-grids-photos{
	height:100%;
	width:100%;
}
</#macro>
<#macro script>
	
	var $form = $("#form");
	$("#userId").select2({
		width: '100%',
		placeholder: '请选择需要添加的业务员'
	});
	$(".select2-search__field").css("width","120%");
	var num = 0;
	var ti = ${(ti)!};
	$(function() {
		jQuery.mm.initValidator('#form', validatorFields)
		jQuery.mm.initDatetimepicker('form', '#month', 'month', 'yyyy-MM', 3, 10, 3);
		jQuery.mm.initDatetimepicker('form', '#startDate', 'startDate', 'yyyy-MM-dd', 2, 4, 2);
		jQuery.mm.initDatetimepicker('form', '#endDate', 'endDate', 'yyyy-MM-dd', 2, 4, 2);
		addProduct()
		$(".monthYear").show();
		$(".month").show();
		$("#planType").val("101202");
		/*var planType = $("#planType").find("option:selected").val();
		if(planType == '101201'){
			$(".monthYear").hide();
			$(".weekTime").show();
		}else if(planType == '101202'){
			$(".monthYear").show();
			$(".year").hide();
			$(".weekTime").hide();
			$(".month").show();
		}else if(planType == '101203'){
			$(".monthYear").show();
			$(".year").show();
			$(".weekTime").hide();
			$(".month").hide();
		}*/
		
	});
	$(document).on("change", "#month", function() {
		var date = new Date($("#month").val()+"-"+ti);
		var year = date.getFullYear();
	    var mon = date.getMonth()+2;     
		if(ti == "01"){
			mon = date.getMonth()+1;
		}
		if(mon == "13"){
			year = date.getFullYear()+1;
			mon = "01";
		}
	    var day=date.getTime()-1000*60*60*24; 
	    date.setTime(day);
	    var strDay=date.getDate();  
		$("#startDate").val($("#month").val()+"-"+ti);
		$("#endDate").val(year+"-"+mon+"-"+strDay);
		
	});
	$(document).on("change", "#planType", function() {
		var planType = $("#planType").find("option:selected").val();
	    if(planType == '101201'){
			$(".monthYear").hide();
			$(".weekTime").show();
		}else if(planType == '101202'){
			$(".monthYear").show();
			$(".year").hide();
			$(".weekTime").hide();
			$(".month").show();
		}else if(planType == '101203'){
			$(".monthYear").show();
			$(".year").show();
			$(".weekTime").hide();
			$(".month").hide();
		}
	});
	var validatorFields = {
		'month': {
			validators: {
				notEmpty: { message: '计划月份不能为空' }
			}
		},'startDate': {
			validators: {
				notEmpty: { message: '开始时间不能为空' }
			}
		},'endDate': {
			validators: {
				notEmpty: { message: '结束时间不能为空' }
			}
		}
	};
	
	function doSubmit(){
		var l = Ladda.create( document.querySelector( '#do_submit' ) );
		$("#productNum").val(num);
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				if (validate.isValid()) {
					l.start();
				}
				return validate.isValid()
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					toastr.success(data.message, '操作成功');
					setTimeout( function(){
						l.stop();
						location.href = '${CPATH}/admin/plans/index';
								}, 1 * 1000 );
				} else {
					l.stop();
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				l.stop();
				alert("信息提交错误");
			}
		});
	}
	//标志
	var newTrIdx = 0;
	function addProduct(){
		var $tbody = $("#table tbody");
		var newTrHtml = $tbody.find("tr:first").html();
		newTrIdx = newTrIdx + 1;
		$("#num").val(newTrIdx);
		var newTrId = 'tr' + newTrIdx;
		$tbody.append("<tr id='" + newTrId + "'>" + newTrHtml + "</tr>");
		var $newTr = $("#" + newTrId);
		<!--添加validate -->
		$newTr.find("#sellerProduct").attr("name", "sellerProduct"+newTrIdx);
		$newTr.find("#planNum").attr("name","planNum" + newTrIdx);
		orderNum();
		num++;
	}
	function orderNum(){
		var $rowNum = $(".rowNum");
		
		$rowNum.each(function(index, el){
			$(el).text(index);
		});
	}
	
	function deleteTr(obj){
		var $tr = $(obj).parent().parent();
		var trIndex = $tr.attr("id").replace("tr", "");
		$form.bootstrapValidator('removeField', 'sellerProduct' + trIndex);
		$form.bootstrapValidator('removeField', 'planNum' + trIndex);
		$tr.remove();
		orderNum();
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (activity.id) ??>修改<#else>新增</#if>计划</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>计划管理</li>
		<li class="active"><#if (activity.id) ??>修改<#else>新增</#if>计划</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">计划信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/plans/save" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="activity.id" value="${(activity.id)!}">
			<div class="box-body">
				<div class="form-group">
					<div class="col-sm-5 validata-box">
						<label class="control-label col-sm-4">计划类型:</label>
						<div class="input-group col-sm-8 input-group-sm">
							<!-- <select  class="form-control" name="planType" id="planType" style="float: left;padding-right:5px;margin-right:5px;">
								<#if dicts??>
									<#list dicts as dict>
										<option value="${(dict.value)}">${(dict.name)}</option>
									</#list>
								</#if>
							</select> -->
							<input id="aplanType" class="form-control" type="text" value="月计划" name="aplanType" readonly>
						</div>
					</div>
					<div class="col-sm-5 validata-box">
						<label class="control-label col-sm-4">业务人员:</label>
						<input type = "hidden" id = "planType" name = "planType" value="">
						<div class="input-group col-sm-8 input-group-sm">
							<!-- <select  class="form-control" name="userId" id="userId" style="float: left;padding-right:5px;margin-right:5px;">
								<#if users??>
									<#list users as user>
										<option value="${(user.id)}">${(user.realname)}</option>
									</#list>
								</#if>
							</select> -->
							<select class="form-control input-sm" name="userId" id="userId" multiple="multiple" style = "height:30px;">
								<#if users??>
									<#list users as user>
										<option value="${(user.id)}">${(user.realname)}</option>
									</#list>
								</#if>
							</select>
						</div>
					</div>
				</div>
				<div class="form-group monthYear">
					<div class="col-sm-5 validata-box month">
	                    <label class="control-label col-sm-4">计划月份:</label>
	                    <div class="col-sm-8 input-group input-group-sm">
	                        <input id="month" class="form-control" type="text" value="${month!}" name="month" placeholder="活动计划月份" >
	                    </div>
	                </div>
						<!-- <div class="input-group col-sm-8 input-group-sm">
							<select  class="form-control" name="month" id="month" style="float: left;padding-right:5px;margin-right:5px;">
								<#if months??>
									<#list months as month>
										<option value="${(month)}">${(month)}</option>
									</#list>
								</#if>
							</select>
						</div> -->
					</div>
					<!--<div class="col-sm-5 validata-box year">
						<label class="control-label col-sm-4">计划周期:</label>
						<div class="input-group col-sm-8 input-group-sm">
							<select  class="form-control" name="year" id="year" style="float: left;padding-right:5px;margin-right:5px;">
								<#if years??>
									<#list years as year>
										<option value="${(year)}">${(year)}</option>
									</#list>
								</#if>
							</select>
						</div>
					</div>
				</div>-->
				<div class="form-group weekTime">
					<div class="col-sm-5 validata-box">
						<label class="control-label col-sm-4">开始时间:</label>
						<div class="input-group col-sm-8 input-group-sm">
							<input id="startDate" class="form-control" value="${startDate!}" name="startDate" placeholder="开始日期" >
						</div>
					</div>
					<div class="col-sm-5 validata-box">
						<label class="control-label col-sm-4">结束时间:</label>
						<div class="input-group col-sm-8 input-group-sm">
							<input id="endDate" class="form-control" value="${endDate!}" name="endDate" placeholder="结束日期" >
						</div>
					</div>
				</div> 
				<h4>计划明细</h4>
				<table id="table" class="table table-bordered table-hover text-center" width="100%" name="row">
					<thead>
						<tr>
							<th width="2%"></th>
							<th width="5%">序号</th>
							<th width="10%">商品名称</th>
							<th width="11%">计划数量</th>
						</tr>
					</thead>
					<tbody>
						<tr class="hide">
							<td>
								<a class="btn btn-danger btn-xs" onclick="deleteTr(this)"><span class="glyphicon glyphicon-remove"></span></a>
							</td>
							<td>
								<span class="rowNum">0</span>
							</td>
							<td style = "padding-top:0px;">
								<div class = "validata-box">
									<select id="sellerProduct" name="sellerProduct" class="form-control" style="height:30px;">
										<option value="0">---请选择---</option>
										<#if sellerProducts??>
											<#list sellerProducts as sp>
												<option value="${(sp.sell_product_id)}">${(sp.custom_name)}</option>
											</#list>
										</#if>
									</select>
								</div>
							</td>
							<td>
								<input type="hidden" id="convert" value="" />
								<input type="text" id="planNum" name="planNum" style="text-align:center;background-color:transparent;border-bottom: 1px dashed #dbdbdb;border-top:0px;border-left:0px;border-right:0px;width: 60%;" value="0" />
							</td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<td>
								<button class="btn btn-xs btn-info" onclick="addProduct()" ><span class="glyphicon glyphicon-plus"></span></button>
							</td>
							<input type="hidden" name="productNum" id="productNum" value="0" />
						</tr>
					</tfoot>
				</table>
		</div>
		<div class="box-footer"> 
			<button type="button" id="do_submit" onclick="doSubmit()" class="btn btn-sm bg-olive btn-flat ladda-button" data-style="expand-right">提交</button>
			<input type="button" class="btn btn-sm btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
		</form>
	</div>
</section>

</@layout>