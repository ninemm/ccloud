<#include "../_inc/_layer_layout.html"/>

<#macro script_import>
	<!-- <script src="${CPATH}/static/plugins/jquery/jquery-1.9.1.min.js"></script> -->
	<script src="${CPATH}/static/plugins/jquery/jquery-ui.js"></script>
	<script src="${CPATH}/static/layer/layer.min.js"></script>
	<script src="${CPATH}/static/plugins/jquery/jquery.all.print.table.js"></script>

</#macro>

<#macro css_import>
	<link rel="stylesheet"  href="${CPATH}/static/print/print.css">
	<link rel="stylesheet"  href="${CPATH}/static/layer/skin/layer.min.css">
	<link rel="stylesheet"  href="${CPATH}/static/plugins/jquery/jquery-ui.css">
</#macro>

<#macro css>
	td { 
		white-space: nowrap;
	} 
	table {
		width: 100%;
		border:none;
	}
	
	#print-content {
	    width: 390px;
	    margin: 0 -18px;
	}
	.signatureArea{
		height: auto;
	}
</#macro>

<#macro script>
   var $pagesize = $("#pagesize");

   $(function() {
    var ids = '${outstockId!}';
    var financePrint = '${isFinancePrint!}';
	queryPrintDetail(financePrint);
	initEvent();
});

var headerInfo =
	'<div class="header clear clearheader">' +
	    '<div class="titleArea">' +
			'<h1 style="letter-spacing: 15px;">锦时退货单</h1>' +
		'</div>' +
	'</div>';

var headerStr =
	'<table class="printContent clearcontent">' +
		'<thead>' +
		'<tr>' +
			'<td colspan="8" style="text-align:left;">开单时间: {2}  单号: {0}</td>' +
			'<td style="visibility: hidden; ">&nbsp;</td>'+
		'</tr>' +
		'<tr>' +
			'<td colspan="8" style="text-align:left;font-size: 14px;">客户名称:{4}   客户电话:{5}</td>' +
			'<td style="visibility: hidden; ">&nbsp;</td>'+
		'</tr>' +
		'<tr>' +
			'<td colspan="8" style="text-align:left;font-size: 14px;">客户地址:{6}</td>' +
			'<td style="visibility: hidden; ">&nbsp;</td>'+
		'</tr>' +
		'<tr>' +
			'<td colspan="2" style="text-align:left;width: 100px;font-size: 14px;">货品名称</td>' +
			'<td style="font-size: 14px;width: 50px;">规格</td>' +
			'<td style="font-size: 14px;width: 30px;">单位</td>' +
			'<td style="font-size: 14px;width: 30px;">数量</td>' +
			'<td style="font-size: 14px;width: 40px;">单价</td>' +
			'<td style="font-size: 14px;width: 50px;">货款</td>' +
			'<td style="visibility: hidden; ">&nbsp;</td>'+
		'</tr>' +
	'</thead>';

		var contentStr = '<tr>' +
			'<td colspan="2" style="text-align:left;width: 100px;font-size: 14px;">{1}</td>' +
			'<td style="font-size: 14px;width: 50px;">{7}</td>' +
			'<td style="font-size: 14px;width: 30px;">{9}</td>' +
			'<td style="font-size: 14px;width: 30px;">{2}</td>' +
			'<td style="font-size: 14px;width: 40px;">{3}</td>' +
			'<td style="font-size: 14px;width: 50px;">{8}</td>' +
			'<td style="visibility: hidden; width: 1px;">&nbsp;</td>'+
			'</tr>';

		var footerStr = 
		'<div class="signatureArea clearfooter" >'+
			'<div class="stat" style="text-align: center; font-size: 14px;">' + 
				'<span style="float: left;font-size: 14px;">合计:</span>'+
				'<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{6}</span>'+
				'<span style="float: right;font-size: 14px;">{1}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>' + 
			'</div>' + 
			'<div class="stat">' +
				'<div><span style="font-size: 14px;">友情提示:支付宝2229893130@qq.com 货品已出,概不退换</span></div>' +
			'</div>' +
			'<div class="stat">' +
				'<span style="font-size: 14px;">备注:{3}</span>' +
			'</div>' +
			'<div class="stat">' +
				'<span class="width200" style="font-size: 14px;">公司名称：{5}</span>'+
			'</div>' +
			'<div class="stat">' +
				'<span style="font-size: 14px">公司电话: 027-84769588;&nbsp;15727025122</span>' +
			'</div>' +
			'<div class="stat">' +
				'<span style="font-size: 14px;">业务员:{8} 电话:{9} </span>' +
			'</div>' +
			'<div class="stat">' +
				'<span style="font-size: 14px;">开单人:{0}  客户签名:</span>' +
			'</div>' +
		'</div>';
			

function queryPrintDetail(financePrint) {

    var batchPrintContent = '';
    var headerContent = null;
    var footerContent = null;
    var headerInfoContent = null;
    $.ajax({
        url: "${CPATH}/admin/salesInstock/getPrintInfo",
        data: {
            "inStockId": '${inStockId!}'
        },
        dataType: "json",
        async: false,
        success: function(data) {
            if (data && data.rows) {
                var curDate = new Date().Format("yyyy-MM-dd hh:mm");
				var totalRejectAmount=0;
				var totalCount=0;
                $.each(data.rows, function(index, stockInPrintInfo) {
                 item =  stockInPrintInfo.printInfo
                    var content = '<tbody>';
                    if (stockInPrintInfo.ProductInfos) {
                        $.each(stockInPrintInfo.ProductInfos,function(idx, subitem) {
                            let barCode = subitem.bar_code;
                            if (!barCode) barCode = '无';
                            let isGift = subitem.is_gift;
                            if (isGift != 0) {
                                isGift = '(赠品)';
                            } else {
                                isGift = "";
                            }
                            totalCount=totalCount+subitem.bigCount+subitem.smallCount/subitem.convert_relate;
                            var productAmout = subitem.productAmout
                            var convertRelate=""
                            if(subitem.convert_relate!=null){
                            		convertRelate="1*"+	subitem.convert_relate;
                            }
                            <@shiro.hasRole name="021">  
                            		var productAmout = (subitem.tax_price* subitem.bigCount+subitem.tax_price* subitem.smallCount/subitem.convert_relate)
                            		totalRejectAmount=totalRejectAmount+productAmout
                            		productAmout=productAmout.toFixed(2)
                            		var small_price=(subitem.tax_price/subitem.convert_relate).toFixed(2)
	                            content += $.format(contentStr, (idx + 1), subitem.custom_name, subitem.bigCount, subitem.tax_price, subitem.smallCount, small_price, barCode, convertRelate,productAmout,subitem.big_unit)
					    		</@shiro.hasRole>	
					    		<@shiro.lacksRole name="021">  
	                            var productAmout = subitem.reject_amount
	                            content += $.format(contentStr, (idx + 1), subitem.custom_name, subitem.bigCount, subitem.big_Price, subitem.smallCount, subitem.small_price , barCode, convertRelate,productAmout,subitem.big_unit)
					    		</@shiro.lacksRole>	
                        });

                        let len = stockInPrintInfo.ProductInfos.length;
                        for (let i = len; i < 12; i++) {
                            content += $.format(contentStr, (i + 1), '', '', '', '', '', '', '', '', '');
                        }
                    }
                    content += '</tbody></table>';

                    headerInfoContent = $.format(headerInfo, (item.sellerName != null) ? item.sellerName: "", '退');

                    let placeOrderMan = item.realname;
                    let placeOrderPhone = item.mobile ;
                    let warehousePhone = item.warehousePhone;
                    let remark = item.remark;
                    if (!warehousePhone) warehousePhone = '无';
                    if (!remark) remark = '';
                    let placeOrderTime = new Date(item.returnOrderTime).Format("yyyy-MM-dd");;

                    headerContent = $.format(headerStr, item.instock_sn, placeOrderTime, curDate, item.customer_name, item.ccontact, item.cmobile, item.delivery_address, placeOrderMan, placeOrderPhone, item.warehouseName);

                    let printFootContext = item.printFootContext;
                    if (!printFootContext) printFootContext = '';
                     <@shiro.hasRole name="021">   
                    		var salesAmount = DX(totalRejectAmount.toFixed(2));
			    		 	footerContent = $.format(footerStr, '${(session._logined_user.realname)!}', totalRejectAmount.toFixed(2), warehousePhone, remark,printFootContext,item.sellerName,totalCount.toFixed(2),item.sellerPhone,placeOrderMan, placeOrderPhone);
			    		</@shiro.hasRole>	
			    		<@shiro.lacksRole name="021">   
			    		  	var salesAmount = DX(item.total_reject_amount);
	                    footerContent = $.format(footerStr, '${(session._logined_user.realname)!}', item.total_reject_amount,warehousePhone, remark,printFootContext,item.sellerName,totalCount.toFixed(2),item.sellerPhone,placeOrderMan, placeOrderPhone);
			    		</@shiro.lacksRole>	
                    batchPrintContent += headerInfoContent + headerContent + content + footerContent;

                    defaultPageSize = 12;
                });

                $("#print-content").html(batchPrintContent);
                rowNumber(defaultPageSize);

                $pagesize.spinner({
                    min: 1
                }).spinner("value", defaultPageSize);
            }

        }
    });
}


$.format = function(source, params) {
    if (arguments.length == 1) return function() {
        var args = $.makeArray(arguments);
        args.unshift(source);
        return $.format.apply(this, args);
    };
    if (arguments.length > 2) {
        params = $.makeArray(arguments).slice(1);
    }
    if (params.constructor != Array) {
        params = [params];
    }
    $.each(params,
    function(i, n) {
        source = source.replace(new RegExp("\\{" + i + "\\}", "g"), n);
    });
    return source;
};


function initEvent() {
    $("#preview").click(function() {

        $("#print-content .header").not(".clearheader").remove();
        $("#print-content .printContent").not(".clearcontent").remove();
        $("#print-content .signatureArea").not(".clearfooter").remove();
        $("#print-content .pageBreak").remove();

        var pagesize = $pagesize.val();
        if (pagesize != null || pagesize != "") {
            rowNumber(Number(pagesize));
            return;
        }
        rowNumber(defaultPageSize);
    });
}

function DX(n) {
    if (!/^(0|[1-9]\d*)(\.\d+)?$/.test(n))
        return "数据非法";
    var unit = "仟佰拾亿仟佰拾万仟佰拾元角分", str = "";
        n += "00";
    var p = n.indexOf('.');
    if (p >= 0)
        n = n.substring(0, p) + n.substr(p+1, 2);
        unit = unit.substr(unit.length - n.length);
    for (var i=0; i < n.length; i++)
        str += '零壹贰叁肆伍陆柒捌玖'.charAt(n.charAt(i)) + unit.charAt(i);
    return str.replace(/零(仟|佰|拾|角)/g, "零").replace(/(零)+/g, "零").replace(/零(万|亿|元)/g, "$1").replace(/(亿)万|壹(拾)/g, "$1$2").replace(/^元零?|零分/g, "").replace(/元$/g, "元整");
}

function rowNumber(pageSize){
	$(".printContent").printTable({
		 mode          : "rowNumber",
		 header        : ".clearheader",
		 footer        : ".clearfooter",
		 content       : ".clearcontent",
		 pageNumStyle  : "第#p页/共#P页",
		 pageNumClass  : ".pageNum",
		 pageSize      : pageSize
	});
}

$("#print").click(function() {

    if (window.confirm('确认打印吗(订单状态会变为已打印)?')) {
    $.ajax({
      url: "${CPATH}/admin/salesInstock/recordPrintInfo",
        data: {
            "inStockId": '${inStockId!}'
        },
        dataType: "json",
        async: false,
        success: function(data) {
          if (data.result == 200) {
			window.print();
		  } else {
		alert("记录打印日志出错，请联系管理员!");
			}
        }
    })
    }
});


Date.prototype.Format = function (fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}


function getStockIdArray() {

    var stockIdList = new Array();
    var stockIds = ids.split(",");
    for (index in stockIds) {
        stockIdList.push(Number(stockIds[index]));
    }
    return stockIdList;
}

</#macro>


<@layout>
<div id="content-body">
	<div id="action-buttons" class="noPrint">
		<span>每页打印商品数量：<input type="text" id="pagesize" style="width:40px;height: 25px"></span>
		<input type="button" value="分页预览" class="btn" id="preview" >
		<input type="button" value="打印" class="btn" id="print">
	</div>
	<div id="print-content">

	</div>
</div>
</@layout>
