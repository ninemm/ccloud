<#include "../_inc/_layout.html"/>

<#macro script_import>

    <!-- bootstrap-table -->
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <!-- bootstrapValidator -->
    <script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
</#macro>

<#macro css_import>

    <!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <!-- bootstrapValidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">

</#macro>

<#macro script>
//var type = $("#selecttype").val();

var detail_object_id = "";

var payablesUrl = '${CPATH}/admin/payables/getPayables';
var payableDetailUrl = '${CPATH}/admin/payables/getpayablesDetail';
$(function() {
	updateOptions();
	
	/* $("#selecttype").change(function(){
		updateOptions();
		type = $(this).val();
	}); */

	jQuery.mm.initEditTable('#_payables_table', payablesUrl, getpayablesParams, initpayablesTable(), null);
	$("#search-payables").click(function(){
		$('#_payables_table').bootstrapTable('refresh');
	});
	
	// 委托点击事件
	$("#_payables_table").on('click','tr[data-uniqueid]',function(){
		var $this = $(this);
		detail_object_id = $this.attr("data-uniqueid");
		$this.siblings().css("background-color","#ffffff");
		$this.css("background-color","#428bca");
		$('#_payables_detail_table').bootstrapTable('refresh');
	});
	
	jQuery.mm.initEditTable('#_payables_detail_table', payableDetailUrl, getpayablesDetailParams, initpayableDetailTable() , null);
});

function updateOptions(){
	//var type = $("#selecttype").val();
	$.ajax({
		url: "${CPATH}/admin/payables/getOptions",
		async: false,
		success: function(data){
			var optionsHtml = '<option value="0" >全部</option>';
			optionsHtml += '<option value="1" >供应商</option>';
			if(data.length && data.length>=1){
				for(var i in data){
					optionsHtml += '<option value="'+data[i].id+'" >'+data[i].name+'</option>';
				}
			}
			$("#category-or-customer").html(optionsHtml);
		}
	});
}

var initpayablesTable = function(){
	var fields = [
		{field: "object_id",title: "ID", align: "center", visible:false, edit:false},
		{field: "name",title:"名称",align: "center", width: '12%', edit:false},
		{field: "pay_amount",title:"应付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit:false},
		{field: "act_amount",title:"已付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit:false},
		{field: "balance_amount",title:"未付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit:false}
	];
	
	return fields;
};

var  cusType = "";
var getpayablesParams = function(params){
	var customerTypeId = $('#category-or-customer').val();
	var keyword = $('#search').val();
	if (keyword) keyword = encodeURIComponent(keyword);
	cusType = customerTypeId;
		var param = {
	        size: params.limit,
	        page: params.offset/params.limit + 1,
	        keyword :keyword,
	//        type : type,
	        customerTypeId:customerTypeId
	    };
	    return param;
}

var initpayableDetailTable = function(){
	var fields = [
		{field: "ref_type",title:"业务类型编码",align: "center",visible:false, edit: false},	
	    {field: "ref_Name",title:"业务类型",align: "center", edit: false},		
		{field: "ref_sn",title:"单号",align: "center",
			formatter:	function(value,row,index){
				return '<a href="#" name="order_sn" onclick="orderInfo(\''+row.ref_sn+'\')">'+row.ref_sn+'</a>';
			},
		edit: false},
		{field: "biz_date",title:"业务日期",align: "center",edit: false},
		{field: "pay_amount",title:"应付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit: false},
		{field: "act_amount",title:"已付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit: false},
		{field: "balance_amount",title:"未付金额",align: "center",
			formatter: function(value,row,rowIndex){
						return formatNumber(value);
					},
		edit: false},
		{field: "create_date",title:"创建时间",align:"center",edit:false},
		{field: "action", title: "付款详情", align: "center",
			 formatter: function(value, row, rowIndex){
			 	var url = '${CPATH}/admin/payables/renderlist?ref_sn='+row.ref_sn+'&&ref_type='+row.ref_type+'&&object_id='+row.object_id+'&&balance_amount='+row.balance_amount;
			 	return '<a href="' + url + '" class="btn btn-sm" >付款详情</a>';
			 },
			 edit:false}
	];
	
	return fields;
}


var getpayablesDetailParams = function(params){

	var param = {
        size: params.limit,
        page: params.offset/params.limit + 1,
//        type : type,
        id: detail_object_id
    };
    
	return param;
}

function orderInfo(orderSn){
	var url = orderSn.indexOf("SR")==0?'${CPATH}/admin/salesInstock/detailBySn/' + orderSn:'${CPATH}/admin/purchaseInstock/detailBySn/' + orderSn;
	layer.open({
		title:"订单详细",
		type: 2,
		area: ['70%', '80%'],
		content: url
	});
}

function batchDown(){
		var keyword = $('#search').val();
		if (keyword) keyword = encodeURIComponent(keyword);
		location.href = "${CPATH}/admin/payables/downloading?customerTypeId=" + cusType+"&keyword"+keyword;
	}

</#macro>
<@layout active_id=p child_active_id=c>
	
<section class="content-header">
	<h1>应付帐款管理</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">账款管理</a></li>
       	<li class="active">应付帐款管理</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
		<div class="form-horizontal">
			<div class="form-group">
					<div class="col-sm-4">
					 	<button onclick="batchDown()" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-upload"></i> 导出</button>
				 	</div>
					<div class="col-sm-4">
						<label class="control-label col-sm-4">客户类型：</label>
						<div class="col-sm-8 input-group input-group-sm">
							<select id="category-or-customer" class="form-control">
								<option value="0">全部</option>
								<option value="1">供应商</option>
							</select>
						</div>
					</div>
					<div class="col-sm-3">
						<label class="control-label col-sm-4">名称：</label>
						<div class="col-sm-8 input-group input-group-sm">
							<input id="search" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">
						</div>
					</div>
					<div class="col-sm-1">
						<span id="search-payables" class="btn btn-primary btn-sm btn-flat" >搜索</span>
					</div>
			</div>
		</div>
	</div>
	<div class="box" style="margin-top:50px;">
        <table class="table table-striped table-hover table-condensed" id="_payables_table" ></table>
    </div>
    <div class="box">
        <table class="table table-striped table-hover table-condensed" id="_payables_detail_table" ></table>
    </div>
</section>

</@layout>