<#include "../_inc/_layout.html"/>

<#macro script_import>

    <!-- bootstrap-table -->
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
    <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <!-- bootstrapValidator -->
    <script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>

</#macro>

<#macro css_import>

    <!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">
    <!-- bootstrapValidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">

</#macro>

<#macro script>

    var $table = $("#_payable_table");
    var url = '${CPATH}/admin/payables/list';
    var infoUrl = '${CPATH}/admin/payables/payableInfo';
    var payUrl = '${CPATH}/admin/payables/payment';
    var paramId = 0;
    var batchFlg = true;

    $(function() {
        jQuery.mm.initEditTable('#_payable_table', url, initParams, initFields(), null);
        jQuery.mm.initEditTable('#_payableInfo_table', infoUrl, initPayableParams, initPayableFields(), null);
        jQuery.mm.initEditTable('#_payment_table', payUrl, initPaymentParams, initPaymentFields(), null);
    });

    $("#search-submit").click(function() {
        $table.bootstrapTable('refresh');
        paramId = 0;
        $("#_payableInfo_table").bootstrapTable('refresh');
    });

    var initParams = function(params) {
        var keyword = $('#post-search-input').val();
        if (keyword) keyword = encodeURIComponent(keyword);
        var customerType = $('#customer_type').val();
        if (customerType) customerType = encodeURIComponent(customerType);
        var param = {
            size: params.limit,
            page: params.offset/params.limit + 1,
            k: keyword,
            customerType: customerType
        };
        return param;
    };

    var initPayableParams = function(params) {
        var param = {
            size: params.limit,
            page: params.offset/params.limit + 1,
            objId: paramId
        };
        return param;
    };

    var initPaymentParams = function(params){
        var param = {
            size: params.limit,
            page: params.offset/params.limit + 1,
            detail_id: paramId
        };
        return param;
    }

    var initFields = function() {
        var fields =
        [
            {field: "customer_name", title: "客户", align: "center", width: '8%', edit:false},
            {field: "customer_type", title: "客户类型", align: "center", width: '8%', edit:false},
            {field: "pay_amount", title: "应付总额(元)", align: "center", width: '10%',
                formatter: function(value, row, index){
                    return toMoney(value,2);
                }, edit: false
            },
            {field: "act_amount", title: "已付总额(元)", align: "center", width: '10%',
                formatter: function(value, row, index){
                    return toMoney(value,2);
                }, edit: false
            },
            {field: "balance_amount", title: "未付总额(元)", align: "center", width: '10%',
                formatter: function(value, row, index){
                    return toMoney(value,2);
                },edit: false
            },
            {field: "create_date", title: "账款创建", align: "center", width: '15%', edit: false},
            {field: "modify_date", title: "最后一次付款", align: "center", width: '15%', edit: false},
            {field: "action", title: "操作", align: "center", width: '5%',
            formatter: function(value, row, rowIndex) {
                var url = '${CPATH}/admin/account/payableInfo?objId=' + row.obj_id ;
                var strHtml = '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="查看付账明细" onclick="getPayableInfo(\''+row.obj_id+'\'' + ',0' + ')">查看明细</a> ';
                return strHtml;
            },
            edit:false
            }
        ];
        return fields;
    }

    var initPayableFields = function() {
    var fields =
    [
        {field: "ref_sn", title: "单号", align: "center", width: '13%', edit:false},
        {field: "ref_status", title: "单号状态", align: "center", width: '5%', edit: false},
        {field: "pay_amount", title: "应付总额(元)", align: "center", width: '5%',
            formatter: function(value, row, index){
                return toMoney(value,2);
            },edit: false
        },
        {field: "act_amount", title: "已付总额(元)", align: "center", width: '5%',
            formatter: function(value, row, index){
                return toMoney(value,2);
            },edit: false
        },
        {field: "balance_amount", title: "未付总额(元)", align: "center", width: '15%',
            formatter: function(value, row, index){
                return toMoney(value,2);
            },edit: false
        },
        {field: "create_date", title: "单据创建", align: "center", width: '15%', edit: false},
        {field: "modify_date", title: "最后一次付款", align: "center", width: '15%', edit: false},
        {field: "action", title: "操作", align: "center", width: '10%',
        formatter: function(value, row, rowIndex) {
            var url = '${CPATH}/admin/account/paymentInfo?refSn=' + row.ref_sn ;
            var strHtml = '<a href="javascript:void(0);" class="btn btn-xs btn-primary btn-flat" title="查看支付记录" onclick="getPaymentInfo(\''+row.id+'\')">查看记录</a> ';
            return strHtml;
        },
        edit:false
        }
    ];
    return fields;
    }

    var initPaymentFields = function() {
    var fields =
        [
            {field: "ref_sn", title: "业务单号", align: "center", width: '8%', edit:false},
            {field: "act_amount", title: "付款金额(元)", align: "center", width: '5%',
                formatter: function(value, row, index){
                    return toMoney(value,2);
                },edit: false
            },
            {field: "realname", title: "付款人", align: "center", width: '5%', edit: false},
            {field: "biz_date", title: "付款时间", align: "center", width: '15%', edit: false}
        ];
        return fields;
    }

    var validatorFields = {
        'searchParams': {
            validators: {
            }
        }
    };

    function getPayableInfo(id) {
        //infoUrl = '${CPATH}/admin/account/payableInfo?objId=' + id;
        paramId = id;
        //jQuery.mm.initEditTable('#_payableInfo_table', infoUrl, initPayableParams, initPayableFields(), null);
        $("#_payableInfo_table").bootstrapTable('refresh');
    }

    function getPaymentInfo(id){
        paramId = id;
        $("#_payment_table").bootstrapTable('refresh');
        $("#exampleModal").modal('show');
    }

    function toMoney(val, num) {
        num = num > 0 && num <= 9 ? num : 2;
    val = parseFloat((val + "").replace(/[^\d\.-]/g, "")).toFixed(num) + "";
        var l = val.split(".")[0].split("").reverse();
        var r = val.split(".")[1];
        var t = "";
        for (i = 0; i < l.length; i++) {
            t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");
        }
        return t.split("").reverse().join("") + "." + r;
    }

</#macro>
<@layout active_id=p child_active_id=c>
<section class="content-header">
    <h1>应付账款列表</h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">账款管理</a></li>
        <li class="active">应付账款列表</li>
    </ol>
</section>
<!-- Main content -->
<section class="content">
    <form class="form-horizontal" id="form">
        <div class="validata-box">
            <input type="hidden" name="searchParams" id="searchParams" value="">
        </div>
        <div class="row content-row">
            <div class="input-group input-group-sm " style="float: right">
                <select class="input-sm" name="customer_type" id="customer_type" style="float: left;padding-right:5px;margin-right:5px;">
                    <option selected="selected" value="customer">客户</option>
                    <option value="supplier">供应商</option>
                </select>
                <input id="post-search-input" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">&nbsp;
                <input id="search-submit" class="btn btn-default btn-sm btn-flat" type="button" value="搜索">
            </div>
        </div>

        <div class="box">
            <table class="table table-striped table-hover table-condensed" id="_payable_table" ></table>
        </div>
        <div class="box">
            <table class="table table-striped table-hover table-condensed" id="_payableInfo_table" ></table>
        </div>
    </form>
    <!-- /.box -->
</section>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" style="padding-top:200px;">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">支付记录</h4>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-hover table-condensed" id="_payment_table" ></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
</@layout>