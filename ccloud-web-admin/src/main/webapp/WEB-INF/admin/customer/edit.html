<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- cityPicker -->
	<script src="${CPATH}/static/plugins/cityPicker/js/citydata.js"></script>
	<script src="${CPATH}/static/plugins/cityPicker/js/cityPicker-1.1.4.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- bootstrapvalidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- cityPicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/cityPicker/css/city-picker.css">
</#macro>

<#macro script>

	var $form = $("#form");

	$(function() {
		$('#customerTypes').select2({
			placeholder: '请把默认类型设置为第一个'
		});
		
		var selector = $('#city-picker-selector').cityPicker({
			dataJson: cityData,
			renderMode: false
		});
		
		<#if customer?exists>
			selector.setCityVal([
				{
					'id': '${customer.prov_code!}',
					'name': '${customer.prov_name!}'
				}, {
					'id': '${customer.city_code!}',
					'name': '${customer.city_name!}'
				}, {
					'id': '${customer.country_code!}',
					'name': '${customer.country_name!}'
				}
			]);
		</#if>
		
		jQuery.mm.initValidator('#form', validatorFields)
		
	});

	var validatorFields = {
		'customer.customer_name': {
			validators: {
				notEmpty: { message: '客户名称不能为空' },
				stringLength: { max: 25, message: '客户名称最大长度是25字符，请重新输入' }
			}
		},
		'customer.customer_code': {
			validators: {
				notEmpty: { message: '客户编码不能为空' },
				stringLength: { max: 15, message: '客户编码最大长度是15字符，请重新输入' }
			}
		},
		'customer.contact': {
			validators: {
				notEmpty: { message: '联系人不能为空' },
				stringLength: { max: 15, message: '客户名称最大长度是15字符，请重新输入' }
			}
		},
		'customer.mobile': {
			validators: {
				notEmpty: { message: '手机号不能为空' },
				stringLength: { min: 11, max: 11, message: '请输入11位手机号' },
				regexp:{regexp:/^1[3|5|8]{1}[0-9]{9}$/, message:'请输入正确的手机号码' }
			}
		},
		'userProvinceId': {
			validators: {
				notEmpty: { message: '省不能为空' },
				callback: {  
					message: '省不能为空',  
					callback: function(value, validator) {
						if(value == '请选择省份'){
							return false;
						}
						return true;
					}
				} 
			}
		},
		'userCityId': {
			validators: {
				notEmpty: { message: '市不能为空' },
				callback: {  
					message: '市不能为空',  
					callback: function(value, validator) {
						if(value == '请选择城市'){
							return false;
						}
						return true;
					}
				} 
			}
		},
		'userDistrictId': {
			validators: {
				notEmpty: { message: '区不能为空' },
				callback: {  
					message: '区不能为空',  
					callback: function(value, validator) {
						if(value == '请选择区县'){
							return false;
						}
						return true;
					}
				} 
			}
		},
		'customer.address': {
			validators: {
				notEmpty: { message: '地址不能为空' },
				stringLength: { max: 50, message: '地址最大长度是15字符，请重新输入' }
			}
		},
		'customerTypes': {
			validators: {
				notEmpty: { message: '客户类型不能为空' }
			}
		},
		'userIds': {
			validators: {
				notEmpty: { message: '负责人不能为空' }
			}
		}
	};

	$('#_menu_tree').click(function() {
		layer.open({
			title:'负责人',
			type: 2,
			area: ['580px', '530px'],
			fix: false, //不固定
			content: '${CPATH}/admin/customer/user_tree'
		});
	});

	function doSubmit(){
		$("#userProvinceText").val($("select[name='userProvinceId']").find("option:selected").text()); 
		$("#userCityText").val($("select[name='userCityId']").find("option:selected").text()); 
		$("#userDistrictText").val($("select[name='userDistrictId']").find("option:selected").text()); 
	
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				return validate.isValid()
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (customer.id) ??>修改<#else>新增</#if>客户</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>客户管理</li>
		<li class="active"><#if (customer.id) ??>修改<#else>新增</#if>客户</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">客户信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/customer/save" method="post" id="form" class="form-horizontal" >
		<input type="hidden" name="customer.id" value="${(customer.id)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*客户名称:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" name="customer.customer_name" value="${(customer.customer_name)!}" placeholder="1-25个任意字母数字">
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*客户编码:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" name="customer.customer_code" value="${(customer.customer_code)!}" placeholder="1-15个任意字母数字">
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*联系人:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" name="customer.contact" value="${(customer.contact)!}" placeholder="1-15个任意字母数字">
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*手机号:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" name="customer.mobile" value="${(customer.mobile)!}" placeholder="11位数字">
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*省-市-区:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="city-picker-selector" id="city-picker-selector"></div>
							<input type="hidden" name="userProvinceText" id="userProvinceText" value="" />
							<input type="hidden" name="userCityText" id="userCityText" value="" />
							<input type="hidden" name="userDistrictText" id="userDistrictText" value="" />
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*详细地址:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" name="customer.address" value="${(customer.address)!}" placeholder="1-50个任意字母数字">
						</div>
					</div>	
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*客户类型:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="customerTypes" id ="customerTypes" multiple="multiple" >
								<#list (customerTypeList)! as customerType >
									<option value="${customerType.id}" <#if cTypeList??&&cTypeList?contains(customerType.id)>selected="selected"</#if>>${(customerType.name)!}</option>
								</#list>
							</select>
						</div>
					</div>
 					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*负责人:</label>
						<div class="input-group col-md-4 col-sm-10">
							<div class="input-group">
								<input type="hidden" name="userIds" id="userIds" value="${cUserIds!}">
								<input class="form-control input-sm" type="text" id="userNames" name="userNames" value="${cUserNames!}" disabled="disabled">
								<div class="input-group-addon" id="_menu_tree" style="cursor:pointer;">
									<i class="fa fa-search"></i> 选择
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-primary">保存更改</button>
			<input type="button" class="btn btn-primary" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>