<#include "../_inc/_layer_layout.html"/>

<#macro script_import>
	<script type="text/javascript" src="${CPATH}/static/plugins/bootstrap-treeview/js/bootstrap-treeview.js"></script>
	<!-- <script src="${CPATH}/static/plugins/toastr/toastr.js"></script> -->
</#macro> 

<#macro css_import>
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-treeview/css/bootstrap-treeview.css">
	<!-- <link rel="stylesheet" href="${CPATH}/static/plugins/toastr/toastr.css"> -->
</#macro>

<#macro script>

	var $tree = $("#tree");
	var $saveBtn = $("#save_btn");
	var $rootNodeId = 0;
	
	$(document).ready(function() {
		jQuery.mm.initMultiTreeView('#tree', JSON.parse('${treeData!}'));
	});
	
	$saveBtn.click(function() {
		$saveBtn.attr("disabled", "disabled");
		var nodes = $tree.treeview("getSelected", $rootNodeId);
		if (nodes.length == 0) {// 未选中资源
			$saveBtn.removeAttr("disabled");
			layer.alert("请选择!", {icon: 2});
			return ;
		}
		
		var userIds = "";
		var userNames = "";
		$.each(nodes, function(idx, obj) {
			if (obj.tags.length == 2 && obj.tags[1] == 'user') {
				if (userIds == "") {
					userIds = obj.tags[0];
					userNames = obj.text;
				} else {
					userIds = userIds + "," + obj.tags[0];
					userNames = userNames  + "," + obj.text;
				}
			}
		});
		
		parent.$("#userIds").val(userIds);
		parent.$("#userNames").val(userNames);
		var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		
		if(parent.batchFlg){
			parent.$('#form').attr("action", "${CPATH}/admin/customer/batchSetUser");
			parent.$('#form').ajaxSubmit({
				type : "post",
				dataType : "json",
				success : function(result) { 
					if (result.errorCode > 0) {
						parent.toastr.error(result.message, '操作失败');
					} else {
						parent.toastr.success(result.message, '操作成功');
						parent.$table.bootstrapTable('refresh');
						parent.layer.close(index);
					}
				},
				error : function() {
					parent.toastr.error("信息提交错误", '操作失败');
				}
			});
		} else {
			parent.$('#form').data('bootstrapValidator')
				.updateStatus('userIds', 'NOT_VALIDATED', null)
				.validateField('userIds');
			parent.layer.close(index);
		}


		
	});
	
	// 递归获取所有的子节点nodeId
	function getSubNodesByParent(node) {
		var ts = [];
		if (node.nodes) {
			ts.push(node.nodeId);
			for (i in node.nodes) {
				ts.push(node.nodes[i].nodeId);
				if (node.nodes[i].nodes) {
					var parentNode = getSubNodesByParent(node.nodes[i]);
					for (j in parentNode) {
						ts.push(parentNode[j]);
					}
				}
			}
		} else {
			ts.push(node.nodeId);
		}
		return ts;
	}
</#macro>

<@layout>
<div style="padding: 10px;">
	<div class="container">
		<div class="row">
			<div class="col-sm-8" id="tree"></div>
		</div>
		<div class="row">
			<div class="col-sm-10 offset1">
				<button type="button" id="save_btn" class="btn btn-sm btn-primary">确定</button>
			</div>
		</div>
	</div>
</div>	
</@layout>