<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- bootstrapTypeAhead -->
	<script src="${CPATH}/static/plugins/bootstrap-autocomplete/bootstrap3-typeahead.js"></script>
	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- cityPicker -->
	<script src="${CPATH}/static/plugins/city-picker/js/city-picker.data.js"></script>
    <script src="${CPATH}/static/plugins/city-picker/js/city-picker.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- cityPicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/city-picker/css/city-picker.css">
</#macro>

<#macro script>

	var $form = $("#form");
	var $city = $('#cityPicker');
	var queryList = new Array();

	$(function() {
		$('#customerTypes').select2({
			placeholder: '请把默认类型设置为第一个'
		});

		$city.citypicker({
		    simple: true,
            responsive: true,
            province: '${(sellerCustomer.prov_name)!}',
            city: '${(sellerCustomer.city_name)!}',
            district: '${(sellerCustomer.country_name)!}'
        });

        var $selectItem = $(".select-item");
		$.each($areaName, function(index, el) {
			$(el).val($selectItem.eq(index).text());
			$areaCode.eq(index).val($selectItem.eq(index).data('code'));
		});
		
		jQuery.mm.initValidator('#form', validatorFields);
		var query = $("#customer_name").val();
		$("#customer_name").typeahead({
			source: function (query, process) {
				return $.ajax({
					url: '${CPATH}/admin/sellerCustomer/searchByCustomerName',
					type: 'post',
					data: {name: query},
					success: function (result) {
						if(queryList!=null)queryList.length = 0;
						queryList = result.data;
						var resultList = [];
						for(row in queryList){
							var aItem = {id: row,name:queryList[row].columns.customer_name,mobile:queryList[row].columns.mobile};
							resultList.push(JSON.stringify(aItem));
						}
						return process(resultList);
					}
				});
			},
			highlighter: function (obj) {
				var item = JSON.parse(obj);
				var query = this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');
				return item.name.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
					return '<strong>' + match + '</strong>'
				});
			},
			updater: function (obj) {
				var item = JSON.parse(obj);
				var checkOption = queryList[item.id].columns;
				$('input[name="customer.mobile"]').val(checkOption.mobile);
				$('input[name="customer.contact"]').val(checkOption.contact);
				$('input[name="customer.address"]').val(checkOption.address);
				$('#userIds').val(checkOption.principalIds);
				$('#userNames').val(checkOption.principal);
				$('input[name="customer.prov_name"]').val(checkOption.prov_name);
				$('input[name="customer.city_name"]').val(checkOption.city_name);
				$('input[name="customer.country_name"]').val(checkOption.country_name);
				$('input[name="customer.prov_code"]').val(checkOption.prov_code);
				$('input[name="customer.city_code"]').val(checkOption.city_code);
				$('input[name="customer.country_code"]').val(checkOption.country_code);
				$('input[name="sellerCustomer.nickname"]').val(checkOption.nickName);
				$('select[name="sellerCustomer.customer_kind"]').val(checkOption.kind);
				$('select[name="sellerCustomer.customer_kind"]').find("option[value='"+checkOption.kind+"']").attr("selected",true);
				$('select[name="sellerCustomer.sub_type"]').val(checkOption.subType);
				$('select[name="sellerCustomer.sub_type"]').find("option[value='"+checkOption.subType+"']").attr("selected",true);
				$city.citypicker('destroy');
				$city.citypicker({
					simple: true,
					responsive: true,
					province: checkOption.prov_name,
					city: checkOption.city_name,
					district: checkOption.country_name
				});
				$.ajax({
					url: '${CPATH}/admin/sellerCustomer/searchTypeById',
					type: 'post',
					data: {sellerC_Id: checkOption.sellercId},
					success: function (result) {
						var query = result.data;
						var strHtml = '';
						for(index in query){
							var row = query[index].columns;
							$("#customerTypes option").each(function(){
								if(row.id == $(this)[0].value){
									$("#customerTypes").val($(this)[0].value).select2();
								}
							});
						}
					},
					error: function(result){
						toastr.error(result.errorCode,result.message);
					}
				});
				return item.name;
			}
		});
	});

	$("#customer_name").on("blur",function(){
		var customer_name = $("#customer_name").val();
		if($.trim(customer_name)==""){
			$('input[name="customer.mobile"]').val("");
			$('input[name="customer.contact"]').val("");
			$('input[name="customer.address"]').val("");
			$('#userIds').val("");
			$('#userNames').val("");
			$('input[name="customer.prov_name"]').val("");
			$('input[name="customer.city_name"]').val("");
			$('input[name="customer.country_name"]').val("");
			$('input[name="customer.prov_code"]').val("");
			$('input[name="customer.city_code"]').val("");
			$('input[name="customer.country_code"]').val("");
			$('input[name="sellerCustomer.nickname"]').val("");
			$('select[name="sellerCustomer.customer_kind"]').val("100401");
			$('select[name="sellerCustomer.customer_kind"]').find("option[value='100401']").attr("selected",true);
			$('select[name="sellerCustomer.sub_type"]').val("100301");
			$('select[name="sellerCustomer.sub_type"]').find("option[value='100301']").attr("selected",true);
			$city.citypicker('reset');
			$("#customerTypes").val("").select2();
	}
	});

	var validatorFields = {
		'customer.customer_name': {
			validators: {
				notEmpty: { message: '客户名称不能为空' },
				stringLength: { max: 25, message: '客户名称最大长度是25字符，请重新输入' }
			}
		},
		'sellerCustomer.nickname': {
			validators: {
				stringLength: { max: 15, message: '客户昵称最大长度是15字符，请重新输入' }
			}
		},
		'customer.contact': {
			validators: {
				notEmpty: { message: '联系人不能为空' },
				stringLength: { max: 15, message: '客户联系人最大长度是15字符，请重新输入' }
			}
		},
		'customer.mobile': {
			validators: {
				notEmpty: { message: '手机号不能为空' },
				stringLength: { min: 11, max: 11, message: '请输入11位手机号' },
				regexp:{regexp:/^1[3|5|8]{1}[0-9]{9}$/, message:'请输入正确的手机号码' }
			}
		},
		'customer.prov_name': {
			validators: {
				notEmpty: { message: '省不能为空' },
			}
		},
		'customer.city_name': {
			validators: {
				notEmpty: { message: '市不能为空' },
			}
		},
		'customer.country_name': {
			validators: {
				notEmpty: { message: '区不能为空' },
			}
		},
		'customer.address': {
			validators: {
				notEmpty: { message: '地址不能为空' },
				stringLength: { max: 50, message: '地址最大长度是50字符，请重新输入' }
			}
		},
		'customerTypes': {
			validators: {
				notEmpty: { message: '客户类型不能为空' }
			}
		},
		'userIds': {
			validators: {
				notEmpty: { message: '负责人不能为空' }
			}
		}
	};

	$('#_menu_tree').click(function() {
		layer.open({
			title:'负责人',
			type: 2,
			area: ['580px', '530px'],
			fix: false, //不固定
			content: '${CPATH}/admin/sellerCustomer/user_tree'
		});
	});
	
	var $areaName = $(".areaName");
	var $areaCode = $(".areaCode");
	
	$city.on('cp:updated', function() {
		areaCheck();
	});
	
	function areaCheck() {
		var $selectItem = $(".select-item");
		$.each($areaName, function(index, el) {
			$(el).val($selectItem.eq(index).text());
			$areaCode.eq(index).val($selectItem.eq(index).data('code'));

			$form.data('bootstrapValidator')
			.updateStatus($(el).attr('name'), 'NOT_VALIDATED', null)
			.validateField($(el).attr('name'));
		});
	}

	function doSubmit(){
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				return validate.isValid()
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (customer.id) ??>修改<#else>新增</#if>客户</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>客户管理</li>
		<li class="active"><#if (sellerCustomer.id) ??>修改<#else>新增</#if>客户</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">客户信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/sellerCustomer/save" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="sellerCustomer.id" value="${(sellerCustomer.id)!}">
			<div class="box-body">
			    <div class="form-group">
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">客户名称:</label>
                        <div class="input-group col-sm-7">
							<input type="text" class="form-control input-sm typeahead" data-provide="typeahead" autocomplete="off" id="customer_name" name="customer.customer_name" value="${(sellerCustomer.customer_name)!}" placeholder="1-25个任意字母数字">
                            <!---<input class="form-control input-sm" type="text" name="customer.customer_name" value="${(sellerCustomer.customer_name)!}" placeholder="1-25个任意字母数字">--->
                        </div>
                    </div>
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">客户昵称:</label>
                        <div class="input-group col-sm-7">
                            <input class="form-control input-sm" type="text" name="sellerCustomer.nickname" value="${(sellerCustomer.nickname)!}" placeholder="1-15个任意字母数字">
                        </div>
                    </div>
                </div> 
                <div class="form-group">
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">联系人:</label>
                        <div class="input-group col-sm-7">
                            <input class="form-control input-sm" type="text" name="customer.contact" value="${(sellerCustomer.contact)!}" placeholder="1-15个任意字母数字">
                        </div>
                    </div>
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">手机号:</label>
                        <div class="input-group col-sm-7">
                            <input class="form-control input-sm" type="text" name="customer.mobile" value="${(sellerCustomer.mobile)!}" placeholder="11位数字">
                        </div>
                    </div>
                </div>
				
                <div class="form-group">
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">客户类型:</label>
                        <div class="input-group col-sm-7">
                            <select class="form-control input-sm" name="customerTypes" id ="customerTypes" multiple="multiple" >
	                            <#list (customerTypeList)! as customerType>
	                                <option value="${customerType.id}" <#if cTypeList??&&cTypeList?contains(customerType.id)>selected="selected"</#if>>${(customerType.name)!}</option>
	                            </#list>
	                        </select>
                        </div>
                    </div>
                    <@shiro.hasPermission name="/admin/dealer/all, /admin/all"> 
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">负责人:</label>
                        <div class="input-group col-sm-7">
                            <input type="hidden" name="userIds" id="userIds" value="${cUserIds!}">
                            <input class="form-control input-sm" type="text" id="userNames" name="userNames" value="${cUserNames!}" disabled="disabled">
                            <div class="input-group-addon" id="_menu_tree" style="cursor:pointer;">
                                <i class="fa fa-search"></i> 选择
                            </div>
                        </div>
                    </div>
                    </@shiro.hasPermission>
                </div>
                
                <div class="form-group">
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">客户子类:</label>
                        <div class="input-group col-sm-7">
                            <select class="form-control input-sm" name="sellerCustomer.sub_type">
                                ${DICT_BOX('customer_subtype', 'select', (sellerCustomer.sub_type)!)}
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-5 validata-box">
                        <label class="control-label col-sm-4">客户种类:</label>
                        <div class="input-group col-sm-7">
                            <select class="form-control input-sm" name="sellerCustomer.customer_kind">
                                ${DICT_BOX('customer_kind', 'select', (sellerCustomer.customer_kind)!)}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
	                <div class="col-sm-5 validata-box">
	                    <label for="_title" class="col-sm-4 control-label">省市区:</label>
	                    <div class="input-group col-sm-7">
	                        <input readonly type="text" id="cityPicker" data-toggle="cityPicker" style="width:100%;">
	                        <input type="hidden" class="areaName" name="customer.prov_name">
	                        <input type="hidden" class="areaName" name="customer.city_name">
	                        <input type="hidden" class="areaName" name="customer.country_name">
	                        <input type="hidden" class="areaCode" name="customer.prov_code">
	                        <input type="hidden" class="areaCode" name="customer.city_code">
	                        <input type="hidden" class="areaCode" name="customer.country_code">
	                    </div>
	                </div>
	                
	                <div class="col-sm-5 validata-box">
	                    <label for="_title" class="col-sm-4 control-label">详细地址:</label>
	                    <div class="input-group col-sm-7">
	                        <input class="form-control input-sm" type="text" name="customer.address" value="${(sellerCustomer.address)!}" placeholder="1-50个任意字母数字">
	                    </div>
	                </div>
	            </div>
			</div>
		</form>
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-primary btn-flat">保存更改</button>
			<input type="button" class="btn btn-primary btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</div>
</section>

</@layout>