<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!--select2  -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
	<script src="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- bootstrap-datetimepicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
	<link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro script>
	$(function() {
		jQuery.mm.initValidator('#form', validatorFields);
		jQuery.mm.initDatetimepicker('form', '#deliveryDate', 'deliveryDate', 'yyyy-MM-dd', 2, 4, 2);
		addProduct();
		initCustomer();
	});
	var discount = 1;
	var $form = $("#form");
	var productInfoMap = ${productInfoMap!}
	var productOptionList = ${productOptionList!}
	var customerInfoMap = ${customerInfoMap!}
	var customerOptionList = ${customerOptionList!}
	var customerTypeCodeMap = [];
	//标志
	var newTrIdx = 0;
	
	var validatorFields = {
		'deliveryAddress': {
			validators: {
				notEmpty: { message: '配送地址不能为空' },
				stringLength: { max: 50, message: '配送地址最大长度是50字符，请重新输入' }
			}
		},
		'deliveryDate': {
			validators: {
				notEmpty: { message: '配送日期不能为空' },
				date : { format : 'YYYY-MM-DD', message : '日期格式不正确' }
			}
		},
		'customerId': {
			validators: {
				notEmpty: { message: '客户不能为空' },
			}		
		}
	};

	function addProduct(type){
		var type = $("input[name='receiveType']:checked").val();
		var $tbody = $("#table tbody");
		var newTrHtml = $tbody.find("tr:first").html();
		newTrIdx = newTrIdx + 1;
		var newTrId = 'tr' + newTrIdx;
		$tbody.append("<tr id='" + newTrId + "'>" + newTrHtml + "</tr>");

		var $newTr = $("#" + newTrId);
		var $productSelect = $newTr.find("#sellProductId")

		$productSelect.select2({
			data: productOptionList,
			width: "100%",
			language: "zh-CN"
		});
		
		<!--切换商品的方法  -->
		$productSelect.change(function(){
			productChange($(this),type);
		});

		<!--触发一次 -->
		productChange($productSelect,type);
		
		<!--添加validate -->
		var bigPriceName = "bigPrice" + newTrIdx;
		$newTr.find("#bigPrice").attr("name", bigPriceName)
		$newTr.find("#accountPrice").attr("name","accountPrice" + newTrIdx);
		$newTr.find("#price").attr("name","price" + newTrIdx);
		$form.data('bootstrapValidator').addField(bigPriceName,
			{
				validators: {
					notEmpty: { message: '价格不能为空' },
					regexp:{regexp:/^[0-9]+(.[0-9]{1,3})?$/, message:'请输入正确的价格' }
				}
		});
		
		var bigNumName = "bigNum" + newTrIdx;
		$newTr.find("#bigNum").attr("name", bigNumName)
		$form.data('bootstrapValidator').addField(bigNumName,
			{
				validators: {
					notEmpty: { message: '数量不能为空' },
					regexp:{regexp:/^[0-9]\d*$/, message:'请输入正确的数量' }
				}
		});
		
		var smallPriceName = "smallPrice" + newTrIdx;
		$newTr.find("#smallPrice").attr("name", smallPriceName)
		$form.data('bootstrapValidator').addField(smallPriceName,
			{
				validators: {
					notEmpty: { message: '价格不能为空' },
					regexp:{regexp:/^[0-9]+(.[0-9]{1,3})?$/, message:'请输入正确的价格' }
				}
		});
		
		var smallNumName = "smallNum" + newTrIdx;
		$newTr.find("#smallNum").attr("name", smallNumName)
		$form.data('bootstrapValidator').addField(smallNumName,
			{
				validators: {
					notEmpty: { message: '数量不能为空' },
					regexp:{regexp:/^[0-9]\d*$/, message:'请输入正确的数量' }
				}
		});
		
		$newTr.find("#sellProductId").attr("name", "sellProductId" + newTrIdx);
		$newTr.find("#productId").attr("name", "productId" + newTrIdx);
		$newTr.find("#convert").attr("name", "convert" + newTrIdx);
		$newTr.find("#isGift").attr("name", "isGift" + newTrIdx);
		$newTr.find("#inputRowTotal").attr("name", "rowTotal" + newTrIdx);

		orderNum();
	}
	
	function productChange(obj,type){
			var product = productInfoMap[obj.val()].columns;
			var $tr = obj.parent().parent().parent();

			$tr.find("#productId").val(product.product_id);
			if (product.store_count == null) {
				$tr.find("#stock").text(0);
			} else {
				$tr.find("#stock").text(product.store_count);
			}

			var convert = product.convert_relate;
			$tr.find("#convert").val(convert);
			var smallUnit = product.small_unit;
			if(type == 1){
				var smallPrice = (product.price/convert).toFixed(2);
				var bigPrice = product.price;
			}else{
				var smallPrice = (product.account_price/convert).toFixed(2);
				var bigPrice = product.account_price;
			}
			$tr.find("#bigPrice").val(bigPrice);
			$tr.find("#accountPrice").val(product.account_price);
			$tr.find("#price").val(product.price);
			$tr.find("#bigPrice-span").text(bigPrice);
			$tr.find("#bigUnit-span").text(product.big_unit + "(x" + convert + smallUnit + ")");
			
			$tr.find("#smallPrice").val(smallPrice);
			$tr.find("#smallPrice-span").text(smallPrice);
			$tr.find("#smallUnit-span").text(smallUnit);
			
			rowTotalF(obj);
	}
	
	function deleteTr(obj){
		var $tr = $(obj).parent().parent();
		var trIndex = $tr.attr("id").replace("tr", "");
		$form.bootstrapValidator('removeField', 'bigPrice' + trIndex);
		$form.bootstrapValidator('removeField', 'bigNum' + trIndex);
		$form.bootstrapValidator('removeField', 'smallPrice' + trIndex);
		$form.bootstrapValidator('removeField', 'smallNum' + trIndex);
		
		$tr.remove();
		
		totalF();
		orderNum();
	}
	
	function orderNum(){
		var $rowNum = $(".rowNum");
		
		$rowNum.each(function(index, el){
			$(el).text(index);
		});
	}
	
	function initCustomer(){
		var $customerSelect = $("#customerId");

		$customerSelect.select2({
			data: customerOptionList,
			width: "100%",
			language: "zh-CN"
		});
		
		<!--切换客户的方法  -->
		$customerSelect.change(function(){
			customerChange($(this));
		});

		<!--触发一次 -->
		customerChange($customerSelect);
	
	}

	function customerChange(obj){
		var customer = customerInfoMap[obj.val()].columns;

		$("#contact").val(customer.contact);
		$("#mobile").val(customer.mobile);
		$("#customerName").val(customer.customer_name);

		var address = customer.prov_name + customer.city_name + customer.country_name + " " + customer.address
		$("#address").val(address);
		$("#deliveryAddress").val(address);
		
		var $customerSelect = $("#customerId");
		
		$.post('${CPATH}/admin/salesOrder/customerTypeById', { customerId: $("#customerId").val() },
			function(data){
				var $customerTypeSelect = $("#customerType");
				$customerTypeSelect.empty();
				var proc_def_key = "";
				$.each(data, function(index, obj){
					$customerTypeSelect.append("<option value='" + obj.id + "'>" + obj.name + "</option>");
					customerTypeCodeMap[obj.id] = {
							id : obj.id,
							name : obj.name,
							code : obj.code,
							factor : obj.factor,
							proc_def_key : obj.proc_def_key
						}
				});

				$customerTypeSelect.change(function(){
					customerTypeChange($(this));
				});

				customerTypeChange($customerTypeSelect);
				totalF();
			}
		);

	}
	
	function customerTypeChange(obj){
		$("#customerTypeCode").val(customerTypeCodeMap[obj.val()].code);
		$("#proc_def_key").val(customerTypeCodeMap[obj.val()].proc_def_key);
		var priceoff = customerTypeCodeMap[obj.val()].factor;
		if (priceoff != null) {
			discount = priceoff;
		} else {
			discount = 1;
		}		
		if (discount == 1) {
			$("#discount").val('无');
		} else {
			$("#discount").val(discount);
		}		
	}
	
	function changeBigPrice(obj){
		var $curTr = $(obj).parent().parent().parent();
		var bigPrice = $(obj).val();
		var convert = $curTr.find("#convert").val();

		var smallPrice = (bigPrice / convert).toFixed(2);
		$curTr.find("#smallPrice").val(smallPrice);

		rowTotalF(obj);
	}

	function changeSmallPrice(obj){
		var $curTr = $(obj).parent().parent().parent();
		var smallPrice = $(obj).val();
		var convert = $curTr.find("#convert").val();

		var bigPrice = (smallPrice * convert).toFixed(2);
		$curTr.find("#bigPrice").val(bigPrice);

		rowTotalF(obj);
	}

	function rowTotalF(obj){
		var $curTr = $(obj).parent().parent().parent();
		var rowTotal = 0;

		var isCheck = $curTr.find("input[type='checkbox']").is(':checked');
		if (!isCheck) {
			var bigPrice = $curTr.find("#bigPrice").val();
			var bigNum = $curTr.find("#bigNum").val();
			var smallPrice = $curTr.find("#smallPrice").val();
			var smallNum = $curTr.find("#smallNum").val();
			rowTotal = Number(bigPrice) * Number(bigNum) + Number(smallPrice) * Number(smallNum);
			rowTotal.toFixed(2);
		}
		$curTr.find(".rowTotal").text(rowTotal);
		$curTr.find("#inputRowTotal").val(rowTotal);

		totalF();
	}

	function totalF() {
		var rows = $(".rowTotal");
		var total = 0;
		$.each(rows, function(index, item) {
			total += Number($(item).text());
		});
		total = total * discount
		total.toFixed(2);
		$("#total").text(total);
		$("#inputTotal").val(total);
	}
	
	function checkStore() {
		var store = $(".storeCount");
		var shouldCheck = ${(isCheckStore!)?string("true","false")};
		if (!shouldCheck) {
			return true;
		}
		var check = false;
		if (store.length <= 1) {
			check = false;
			return check;
		}
		store.each(function(index,element){
		  	var x = parseInt($(this).html());
			var bigNum =$(this).parent().parent().find("#bigNum").val();
			var smallNum = $(this).parent().parent().find("#smallNum").val();
			var convert = $(this).parent().parent().find("#convert").val();
			var producttotal = parseInt(bigNum) + parseInt(smallNum)/parseInt(convert);	
		  	if (x <= 0 || producttotal > x) {
				return false;
		 	}
	    	if (index == store.length-1) {
	    		check = true;
	    	}
		});
		return check;	
	}
	
	function checkProductNumber() {
		var store = $(".product tr");
		var check = false;
		var alltotal = 0;
		if (store.length <= 1) {
			check = false;
			return check;
		}
		store.each(function(index,obj){
			var bigNum = $(obj).find("#bigNum").val();
			var smallNum = $(obj).find("#smallNum").val();
			var total = parseInt(bigNum) + parseInt(smallNum);
			var convert = $(obj).find("#convert").val();
			var producttotal = parseInt(bigNum) + (parseInt(smallNum)/parseInt(convert)).toFixed(2)*1;
			if (isNaN(producttotal)) {
				producttotal = 0;
			}					
		  	if (total <= 0) {
				return false;
		 	}
	    	if (index == store.length-1) {
	    		check = true;
	    	}
	    	alltotal = alltotal + producttotal;
		});
    	$("#productTotalCount").val(alltotal);
		
		return check;	
	}

	function doSubmit(){
		$("#productTotalCount").text($("#total").text());
		$("#productNum").val($(".rowNum").length - 1);
		if (!checkStore()) {
			toastr.error('未选择商品或库存不足!','操作失败');
			return;
		}
		if (!checkProductNumber()) {
			toastr.error('商品购买数量不能为零!','操作失败');
			return;			
		}
		var l = Ladda.create( document.querySelector( '.ladda-button' ) );
		$form.ajaxSubmit({
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				if (validate.isValid()) {
					l.start();
				}				
				return validate.isValid();
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if (data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
				setTimeout( function(){
						l.stop();
								}, 2 * 1000 );
			},
			error : function() {
				l.stop();
				alert("信息提交错误");
			}
		});
	}
	
	function changeMoney(obj){
		var type = $(obj).val();
		var num = $(".rowNum").length-1;
		var index = 1;
		for(index = 1;index<=num;index++){
			var accountPriceName = 'accountPrice' +index;
			var bigPriceName = 'bigPrice'+index;
			var convert = 'convert'+index;
			var priceName = 'price'+index;
			var accountPrice = $("input[name='"+accountPriceName+"']").val();
			var price = $("input[name='"+priceName+"']").val();
			if(type == 0){
				$("input[name='"+bigPriceName+"']").val(accountPrice);
				changeBigPrice($("input[name='"+bigPriceName+"']"));
			}else{
				$("input[name='"+bigPriceName+"']").val(price);
				changeBigPrice($("input[name='"+bigPriceName+"']"));
			}
		}
	}
	
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>新增销售订单</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
		<li><a href="#">订单管理</a></li>
		<li class="active">新增销售订单</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">销售订单信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/salesOrder/save" method="post" id="form" class="form-horizontal" >
			<div class="box-body">
				<table id="table" class="table table-bordered table-hover text-center" width="100%">
					<thead>
						<tr>
							<th width="2%"></th>
							<th width="5%">序号</th>
							<th width="20%">商品名称</th>
							<th width="8%">库存</th>
							<th width="11%">大单位价格</th>
							<th width="12%">大单位数量</th>
							<th width="11%">小单位价格</th>
							<th width="11%">小单位数量</th>
							<th width="5%">赠品</th>
							<th width="7%">小计</th>
						</tr>
					</thead>
					<tbody class="product">
						<tr class="hide">
							<td>
								<a class="btn btn-danger btn-xs" onclick="deleteTr(this)"><span class="glyphicon glyphicon-remove"></span></a>
							</td>
							<td>
								<span class="rowNum">0</span>
							</td>
							<td>
								<div class = "validata-box">
									<select id="sellProductId" name="sellProductId" class="form-control">
									</select>
									<input type="hidden" name="productId" id="productId" value="" />
									<input type="hidden" name="productTotalCount" id="productTotalCount" value="" />
									<input type="hidden" name="price" id="price" value="" />
								</div>
							</td>
							
							<td>
								<span class="storeCount" id="stock"></span>
							</td>
							<td>
								<input type="hidden" name="convert" id="convert" value="" />
								<div class = "validata-box">
									<input type="hidden" id = "accountPrice" name = "accountPrice" value = "">								
									<input type="hidden" name="price" id="price" value="" />
									￥<input type="text" id="bigPrice" name="bigPrice" style="width: 60%" onblur="changeBigPrice(this)" value="0" />
									</br>(<span id="bigPrice-span"></span>)
								</div>
							</td>
							<td>
								<div class = "validata-box">
									<input type="text" id="bigNum" name="bigNum" style="width: 60%" onblur="rowTotalF(this)" value="1" />
									</br><span id="bigUnit-span"></span>
								</div>
							</td>
							<td>
								<div class = "validata-box">
									￥<input type="text" id="smallPrice" name="smallPrice" style="width: 60%" onblur="changeSmallPrice(this)" value="0"/>
									</br>(<span id="smallPrice-span"></span>)
								</div>
							</td>
							<td>
								<div class = "validata-box">
									<input type="text" id="smallNum" name="smallNum" style="width: 60%" onblur="rowTotalF(this)" value="0" />
									</br><span id="smallUnit-span"></span>
								</div>
							</td>
							<td>
								<div class = "validata-box">
									<input type="checkbox" id="isGift" name="isGift" value ="1" onclick="rowTotalF(this)"/>
								</div>
							</td>
							<td>￥<span class="rowTotal">0</span> <input type="hidden" name="rowTotal" id="inputRowTotal" value="0" /></td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<td>
								<button class="btn btn-xs btn-info" onclick="addProduct()" ><span class="glyphicon glyphicon-plus"></span></button>
							</td>
							<th colspan="8" style="text-align:right">合计:</th>
							<th>￥<span id="total">0</span> <input type="hidden" name="total" id="inputTotal" value="0" /></th>
							<input type="hidden" name="productNum" id="productNum" value="0" />
						</tr>
					</tfoot>
				</table>

				<div class="form-group col-sm-12"></div>

				<div id="customer">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*客户名称:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input type="hidden" id="customerName" name="customerName" value="" >
							<select id="customerId" name="customerId" class="form-control">
							</select>
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*联系人:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" id="contact" name="contact" value="" readonly>
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*手机号:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" id="mobile" name="mobile" value="" readonly>
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*客户类型:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input type="hidden" id="proc_def_key" name="proc_def_key" value="" >
							<input type="hidden" id="customerTypeCode" name="customerTypeCode" value="" >
							<select id="customerType" name="customerType" class="form-control">
							</select>
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">折扣:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input type="text" id="discount" value="无" readonly="readonly" class="form-control">
						</div>
					</div>					
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*配送地址:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input  type="hidden" id="address" name="address" value="" >
							<input class="form-control input-sm" type="text" id="deliveryAddress" name="deliveryAddress" value="" placeholder="1-50个任意字母数字">
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">*配送时间:</label>
						<div class="input-group col-md-4 col-sm-10">
							<input class="form-control input-sm" type="text" id="deliveryDate" name="deliveryDate" value="${deliveryDate!}"  >
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">收款方式:</label>
						<div class="input-group col-md-4 col-sm-10">
							<label class="radio-inline">
								<input type="radio" name="receiveType" value="1" checked onclick = "changeMoney(this)">现结
							</label>
							<label class="radio-inline">
								<input class="minimal" type="radio" name="receiveType" value="0" onclick = "changeMoney(this)">账期账款
							</label>
						</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">备注:</label>
						<div class="input-group col-md-4 col-sm-10">
							<textarea class="form-control input-sm" id="remark" name="remark" type="text" ></textarea>
						</div>
					</div>
				</div>
			</div>

			<div class="box-footer"> 
				<button type="button" onclick="doSubmit()" class="btn btn-sm btn-primary btn-flat ladda-button" data-style="expand-right"><span class="ladda-label">提交订单</span></button>
				<input type="button" class="btn btn-sm btn-danger btn-flat" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
			</div>
		</form>
	</div>
</section>

</@layout>