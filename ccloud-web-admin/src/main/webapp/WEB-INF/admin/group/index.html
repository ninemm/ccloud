<#include "../_inc/_layout.html"/>

<#macro script>

	$('.modal').on('show.bs.modal', centerModals);
	// 在窗口大小改变的时候调用垂直居中函数
	$(window).on('resize', centerModals);

    $('#add').click(function() {
    //获取选中的选项，删除并追加给对方
        $('#select1 option:selected').appendTo('#select2');
    });
    //移到左边
    $('#remove').click(function() {
        $('#select2 option:selected').appendTo('#select1');
    });
    //全部移到右边
    $('#add_all').click(function() {
        //获取全部的选项,删除并追加给对方
        $('#select1 option').appendTo('#select2');
    });
    //全部移到左边
    $('#remove_all').click(function() {
        $('#select2 option').appendTo('#select1');
    });
    //双击选项
    $('#select1').dblclick(function(){ //绑定双击事件
        //获取全部的选项,删除并追加给对方
        $("option:selected",this).appendTo('#select2'); //追加给对方
    });
    //双击选项
    $('#select2').dblclick(function(){
       $("option:selected",this).appendTo('#select1');
    });

	function centerModals(){
	  $('.modal').each(function(i){
	    var $clone = $(this).clone().css('display', 'block').appendTo('body');
	    var top = Math.round(($clone.height() - $clone.find('.modal-content').height()) / 2);
	    top = top > 50 ? top : 0;
	    $clone.remove();
	    $(this).find('.modal-content').css("margin-top", top-50);
	  });
	}  

	function del(id) {
		jQuery.mm.del('${CPATH}/admin/group/delete?ucode=${ucode}&id=' + id);
	}

	function batchAction() {
		var $form = $("#form");
		$form.attr("action", "${CPATH}/admin/group/batchDelete?ucode=${ucode}&c=${c!}&p=${p!}");
	
		jQuery.mm.batchAction('#form', '请选择分组记录');
	}
	var saveGruopType = "";
	function save(){
	if(saveGruopType == "role"){
	  saveRole();
     }else{
     saveUser();
     }
	}
	
	function group(id,name) {
	    saveGruopType = "role";
		var title = name + "角色管理";
		$("#myModalLabel").html(title);
		$("#groupId").val(id);
		$("#select1").empty();
		$("#select2").empty();
		$.ajax({
			url:"${CPATH}/admin/group/getRoleCheck",
			type:"post",
			data:{"groupId":id},
			dataType:"json",
			success:function(data) {
				var select = data.checkList;
				var unselect = data.uncheckList;
				for (var i = 0; i < select.length; i++) {
					$("#select2").append("<option value=" + select[i].id + ">" + select[i].name + "</option>");
				}
				for (var i = 0; i < unselect.length; i++) {
					$("#select1").append("<option value=" + unselect[i].id + ">" + unselect[i].name + "</option>");
				}			
				$("#myModal").modal('show');
			}
		});	
	}
	
	function saveRole() {
		 var id = $("#groupId").val();
	     var array = new Array();  //定义数组   
	     $("#select2 option").each(function(){  //遍历所有option  
	          var txt = $(this).val();   //获取option值   
	          if(txt!=''){  
	               array.push(txt);  //添加到数组中  
	          }  
	     })
		$.ajax({
			url:"${CPATH}/admin/group/saveRole",
			type:"post",
			data:{
				"roleIds":array,
				"groupId": id
			},
			dataType:"json",
			success:function(data) {
				$('#myModal').modal('hide');
				if (data.errorCode == 0) {
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			}
		});     
	}
	
		
	function userGroup(id,name) {
	    saveGruopType = "user";
		var title = name + "用户管理";
		$("#myModalLabel").html(title);
		$("#groupId").val(id);
		$("#select1").empty();
		$("#select2").empty();
		$.ajax({
			url:"${CPATH}/admin/group/getUserCheck",
			type:"post",
			data:{"groupId":id},
			dataType:"json",
			success:function(data) {
				var select = data.checkList;
				var unselect = data.uncheckList;
				for (var i = 0; i < select.length; i++) {
					$("#select2").append("<option value=" + select[i].id + ">" + select[i].name + "</option>");
				}
				for (var i = 0; i < unselect.length; i++) {
					$("#select1").append("<option value=" + unselect[i].id + ">" + unselect[i].name + "</option>");
				}			
				$("#myModal").modal('show');
			}
		});	
	}
	
	function saveUser() {
		 var id = $("#groupId").val();
	     var array = new Array();  //定义数组   
	     $("#select2 option").each(function(){  //遍历所有option  
	          var txt = $(this).val();   //获取option值   
	          if(txt!=''){  
	               array.push(txt);  //添加到数组中  
	          }  
	     })
		$.ajax({
			url:"${CPATH}/admin/group/saveUser",
			type:"post",
			data:{
				"userIds":array,
				"groupId": id
			},
			dataType:"json",
			success:function(data) {
				$('#myModal').modal('hide');
				if (data.errorCode == 0) {
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			}
		});     
	}
	
	
	$("input").on("keydown",function(){
		if (event.keyCode == 13) {
			event.keyCode = 0;
			event.returnValue = false;
		}
	});
</#macro>

<@layout active_id=p child_active_id=c>

<section class="content-header">
	<h1>分组管理</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
		<li><a href="#">用户权限</a></li>
		<li class="active">分组管理</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
		<form class="form-horizontal" action="${CPATH}/admin/group?c=${c!}&p=${p!}" method="post">
			<div class="form-group">
				<div class="col-sm-4">
				<@shiro.hasPermission name="/admin/group/edit,/admin/all">
					<a href="${CPATH}/admin/group/edit?c=${c!}&p=${p!}" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-plus"></i> 新增 </a>
					<a href="javascript:void(0);" onclick="batchAction()" class="btn btn-sm btn-danger btn-flat"><i class="fa fa-remove"></i> 删除 </a>
				</@shiro.hasPermission>
				</div>
				<div class="col-sm-4">
				</div>
				<div class="col-sm-3">
					<label class="control-label col-sm-4">名称:</label>
	                <div class="col-sm-8 input-group input-group-sm">
						<input id="search" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">&nbsp;
					</div>
				</div>
				<div class="col-sm-1">
					<input id="search-submit" class="btn btn-sm btn-primary btn-flat" type="submit" value="搜索">
				</div>
			</div>
		</form>
	</div>
	<div class="box ">
		<!-- /.box-header -->
		<div class="box-body jp-common-pad">
			<form action="" method="POST" id="form">
				<table class="table table-striped">
					<thead>
					<tr>
						<th style="width: 20px">
							<label class="jp-common-pad ">
								<input class="jp-common-pad " id="dataItem" onclick="checkAll(this)" title="全选" type="checkbox">
							</label>
						</th>
						<th style="width: 20%">分组名称</th>
						<th>分组编号</th>
						<th>部门</th>
						<th>排序</th>
						<@shiro.hasPermission name="/admin/group/edit,/admin/all">
						<th style="width: 20%">操作</th>
						</@shiro.hasPermission>
					</tr>
					</thead>
					<tbody>
					<#if page??> <#list page.getList() as bean>
						<tr class="jp-onmouse">
							<td>
								<label class="jp-common-pad">
									<input class="jp-common-pad" name="dataItem" type="checkbox" value="${(bean.id)!}">
								</label>
							</td>
							<td>
								<a href="${CPATH}/admin/group/edit?id=${bean.id}&c=${c!}&p=${p!}">${bean.group_name!}</a>
							</td>
							<td>${bean.group_code!}</td>
							<td>${bean.dept_name!}</td>
							<td>${bean.order_list!}</td>
							<td>
							<@shiro.hasPermission name="/admin/group/edit,/admin/all">
								<a href="${CPATH}/admin/group/edit?id=${bean.id}&c=${c!}&p=${p!}" class="btn btn-xs bg-olive btn-flat">编辑</a>
								<a onclick="group('${bean.id}','${bean.group_name!}')" class="btn btn-xs btn-warning btn-flat">角色</a>
						        <a onclick="userGroup('${bean.id}','${bean.group_name!}')" class="btn btn-xs btn-primary btn-flat">用户</a>
								<a href="javascript:void(0);" onclick="del('${bean.id}')" class="btn btn-xs btn-danger btn-flat">删除</a>
							</@shiro.hasPermission>	
							</td>
						</tr>
					</#list> </#if>
					</tbody>
				</table>
			</form>
		</div>
		
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		    <div class="modal-dialog">
		        <div class="modal-content">
		            <div class="modal-header">
		                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		                <h4 class="modal-title" id="myModalLabel"></h4>
		                <input type="hidden" id="groupId">
		            </div>
		            <div class="modal-body">
			        <div style="padding-left:111px;">
						<h4 style="margin-bottom:12px">
							<i class="glyphicon glyphicon-user"></i> 未选分组
							<span style="margin-left:127px"></span>
							<i class="glyphicon glyphicon-user"></i> 已选分组
						</h4>			        
			          <select multiple="multiple" id="select1" style="width:150px;height:200px; float:left; padding:4px; ">
			          </select>
			        </div>
			        <div style="float:left;margin:20px 15px;"> <span id="add" style="width: 100%;display: inline-block;margin-bottom:5px">
			          <input type="button" class="btn btn-default" value=">" style="width: 100%;"/>
			          </span><br />
			          <span id="add_all" style="width: 100%;display: inline-block;margin-bottom:5px">
			          <input type="button" class="btn btn-default" value=">>" style="width: 100%;"/>
			          </span> <br />
			          <span id="remove" style="width: 100%;display: inline-block;">
			          <input type="button" class="btn btn-default" value="<" style="width: 100%;margin-bottom:5px"/>
			          </span><br />
			          <span id="remove_all" style="width: 100%;display: inline-block;">
			          <input type="button" class="btn btn-default" value="<<" style="width: 100%;"/>
			          </span> </div>
			        <div>
			          <select multiple="multiple" id="select2" style="width: 150px;height:200px; float:lfet; padding:4px;">
			          </select>
			        </div>
			      </div>		            
		            <div class="modal-footer">
		                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		                <button type="button" class="btn btn-primary" onclick="save()">提交更改</button>
		            </div>
		        </div><!-- /.modal-content -->
		    </div><!-- /.modal-dialog -->
		</div>			
		<!-- /.box-body -->
	</div>
	<!-- /.box -->

	<div class="cf">
		<div class="pull-right"><#include "../_inc/_paginate_wrapper.html" /></div>
	</div>
</section>
</@layout>