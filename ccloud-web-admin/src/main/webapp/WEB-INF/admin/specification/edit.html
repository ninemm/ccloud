<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapvalidator -->
 	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapvalidator -->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
</#macro>
 
<#macro script>

var $form = $("#form");

$(function() {
	
	jQuery.mm.initValidator('#form', validatorFields)
	
	var MaxInputs       = 15; //maximum input boxes allowed  
	var InputsWrapper   = $("#InputsWrapper"); //Input boxes wrapper ID  
	var AddButton       = $("#AddMoreFileBox"); //Add button ID  
	var x = InputsWrapper.length; //initlal text box count 
	<#if childList?exists>
		x = ${childList.size()};
	</#if>
	var select =  $("#showType").val();
    if (select == 1) {
		$("#imageFile").show();
		$(".image").show();
		$("#previewImage").show();
		$(".preview").show();
		var str = "<input type='file' name='file[]' onChange='checkValue()'/>";
		$(".image").append(str);    	
    }	
	var FieldCount=1; //to keep track of text box added  
	$(AddButton).click(function (e)  //on add input button click  
	{
	        if(x <= MaxInputs) //max input box allowed  
	        {  
	            FieldCount++; //text box added increment  
	            //add input box
	            var select =  $("#showType").val();
	            if (select == 1) {
					$(InputsWrapper).append('<tr><td class="col-xs-4"><input class="form-control input-sm" type="text" name="mytext[]" id="field_'+ FieldCount +'"/><input type="hidden" name="childId[]" id="child_'+ FieldCount +'"/></td><td class="image"><input type="file" name="file[]" onChange="checkValue()"/></td><td class="col-xs-2"><input class="form-control input-sm" type="number" name="order[]" id="order_'+ FieldCount +'"></td><td><a href="#" class="removeclass"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></td><tr>');					            
	            } else {
	            	$(InputsWrapper).append('<tr><td class="col-xs-4"><input class="form-control input-sm" type="text" name="mytext[]" id="field_'+ FieldCount +'"/><input type="hidden" name="childId[]" id="child_'+ FieldCount +'"/></td><td class="image" style="display:none"></td><td class="col-xs-2"><input class="form-control input-sm" type="number" name="order[]" id="order_'+ FieldCount +'"></td><td><a href="#" class="removeclass"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></td><tr>');
	            }
	            x++; //text box increment  
	        }  
	return false;  
	});
	$("body").on("click",".removeclass", function(e){ //user click on remove text 
          $(this).parent('td').parent('tr').remove(); //remove text box  
          x--; //decrement textbox  
	return false;
	})
});

var validatorFields = {
	'ccGoodsSpecification.name': {
		validators: {
            notEmpty: { message: '规格名称不能为空' },
            stringLength: { max: 15, message: '规格名称最大长度是15字符，请重新输入' }
        }
	},
	'ccGoodsSpecification.type': {
		validators: {
			notEmpty: { message: '请选择规格类型' },
        }
	},
	'ccGoodsSpecification.show_type': {
		validators: {
			notEmpty: { message: '请选择显示方式' },
        }
	}
};

function addImage(obj) {
	var select =  $("#showType").val();
	if (select == "1") {
		$("#imageFile").show();
		$(".image").show();
		var str = "<input type='file' name='file[]' onChange='checkValue()'/>";
		$(".image").append(str);
	} else {
		$("#imageFile").hide();
		$(".image").hide();
		$(".image").empty();
	}
}

var imageStatus = false;

function checkValue() {
	checkImage();
	if(imageStatus) {
		$("#warnImage").remove();
	}
}

function checkImage() {
	var imageList = $(".image");
	var select =  $("#showType").val();
	if (select == 1) {
		imageList.each(function(index,element){
	    	var x = $(this).find("input").val();
	    	if (!x) {
				if ($("#warnImage").html() == undefined) {
					$("#valueTable").after('<small style="color:#a94442;" id="warnImage" class="help-block" data-bv-validator="notEmpty" data-bv-for="ccGoodsSpecification.show_type" data-bv-result="INVALID">您有未选择的图片</small>');
				}	    	
	    		return false;
	    	}
	    	if (index == imageList.length-1) {
	    		imageStatus = true;
	    	}
	  	});	
	}
}

function doSubmit(){
	checkImage();
	if (!imageStatus) {
		return false;
	}
	$form.ajaxSubmit({
		beforeSubmit: function() {
			var validate = $form.data('bootstrapValidator');
			validate.validate();
			return validate.isValid();
		},
		type : "post", 
		dataType : "json", 
		success : function(data) { 
			if (data.errorCode == 0) {
				//location.reload();
				toastr.success(data.message, '操作成功');
			} else {
				toastr.error(data.message,'操作失败');
			}
		},
		error : function() {
			alert("信息提交错误");
		}
	});
}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (ccGoodsSpecification.id) ??>修改<#else>新增</#if>规格信息</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">商品管理</a></li>
       	<li class="active"><#if (ccGoodsSpecification.id) ??>修改<#else>新增</#if>规格信息</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">规格信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/specification/save" method="post" id="form" class="form-horizontal" enctype="multipart/form-data">
		<input type="hidden" name="ccGoodsSpecification.id" value="${(ccGoodsSpecification.id)!}">
		<div class="box-body">
			<div class="col-sm-12 ">
				<div class="row">
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">名称:</label>
						<div class="input-group col-md-4 col-sm-10">
		                 	<input class="form-control input-sm" type="text" name="ccGoodsSpecification.name" value="${(ccGoodsSpecification.name)!}" placeholder="1-15个任意字符">
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">类型:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="ccGoodsSpecification.type" onChange="addImage()" id="showType">
								<option value="">--请选择--</option>
								<option value="0" <#if (ccGoodsSpecification.type)! == "0">selected="selected"</#if>>文字类型</option>
								<option value="1" <#if (ccGoodsSpecification.type)! == "1">selected="selected"</#if>>图片类型</option>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">显示方式:</label>
						<div class="input-group col-md-4 col-sm-10">
							<select class="form-control input-sm" name="ccGoodsSpecification.show_type">
								<option value="">--请选择--</option>
								<option value="0" <#if (ccGoodsSpecification.show_type)! == "0">selected="selected"</#if>>平铺显示</option>
								<option value="1" <#if (ccGoodsSpecification.show_type)! == "1">selected="selected"</#if>>下拉显示</option>
							</select>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2">规格值:</label>
						<div class="input-group col-md-2 col-sm-10">
							<span id='AddMoreFileBox' class="btn btn-default">添加规格值</span>
		               	</div>
					</div>
					<div class="form-group col-sm-12 validata-box">
						<label class="control-label col-sm-2"></label>
						<div class="input-group col-md-6 col-sm-10">
						<table class="table table-bordered" id="valueTable">
							<th>规格值</th>
							<th style="display:none" id="imageFile">附件</th>
							<th style="display:none" id="previewImage">预览</th>
							<th>排序</th>
							<th>操作</th>
							<tbody id="InputsWrapper">
							<#if (childList)?exists>
							<#if childList?size gt 0>
							<#list (childList)! as child >
							<tr>
								<td class="col-xs-4"><input class="form-control input-sm" type="text" name="mytext[]" id="field_${child_index}" value="${child.name}"><input type="hidden" name="childId[]" id="child_${child_index}" value="${child.id}"></td>
								<td class="image" style="display:none"></td>
								<td class="preview" style="display:none"><a>预览</a></td>
								<td class="col-xs-2"><input class="form-control input-sm" type="number" name="order[]" id="order_${child_index}" value="${(child.orderList)!}"></td>
								<td><a href="#" class="removeclass"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></td>
							<tr>
							</#list>
							<#else>
							<tr>
								<td class="col-xs-4"><input class="form-control input-sm" type="text" name="mytext[]" id="field_1"><input type="hidden" name="childId[]" id="child_1"></td>
								<td class="image" style="display:none"></td>
								<td class="col-xs-2"><input class="form-control input-sm" type="number" name="order[]" id="order_1"></td>
								<td><a href="#" class="removeclass"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></td>
							<tr>								
							</#if>
							</#if>
							<#if (childList)! = "">							
							<tr>
								<td class="col-xs-4"><input class="form-control input-sm" type="text" name="mytext[]" id="field_1"><input type="hidden" name="childId[]" id="child_1"></td>
								<td class="image" style="display:none"></td>
								<td class="col-xs-2"><input class="form-control input-sm" type="number" name="order[]" id="order_1"></td>
								<td><a href="#" class="removeclass"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></td>
							<tr>
							</#if>
							</tbody>						
						</table>						
		               	</div>
					</div>														
				</div>
			</div>
		</div>
	
		<div class="box-footer"> 
			<button type="button" onclick="doSubmit()" class="btn btn-primary">保存更改</button>
			<input type="button" class="btn btn-primary" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
	</form>
	</div>
</section>

</@layout>