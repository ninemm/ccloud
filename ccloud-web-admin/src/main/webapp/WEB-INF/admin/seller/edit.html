<#include "../_inc/_layout.html"/>

<#macro script_import>
	<!-- bootstrapValidator -->
	<script src="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.js"></script>
	<!-- select2 -->
	<script src="${CPATH}/static/plugins/select2/js/select2.js"></script>
	<!-- cityPicker -->
	<script src="${CPATH}/static/plugins/city-picker/js/city-picker.data.js"></script>
    <script src="${CPATH}/static/plugins/city-picker/js/city-picker.js"></script>
    <script src="${CPATH}/static/ladda/spin.min.js"></script>
	<script src="${CPATH}/static/ladda/ladda.min.js"></script>
</#macro>

<#macro css_import>
	<!-- bootstrapValidator -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/bootstrapvalidator/bootstrapValidator.css">
	<!-- select2 -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/select2/css/select2.css">
	<!-- cityPicker -->
	<link rel="stylesheet" href="${CPATH}/static/plugins/city-picker/css/city-picker.css">
	<link rel="stylesheet" href="${CPATH}/static/ladda/ladda-themeless.min.css">
</#macro>

<#macro script>
	
	var $form = $("#form");
	var $city = $('#cityPicker');
	$("#brand_option").select2();
	$("#product_type_store_option").select2();
	$(function() {
		$.ajax({
			url:"${CPATH}/admin/seller/getBrand",
			type:"post",
			dataType:"json",
			data:{"id":'${(seller.id)!}'},
			success:function(data)
			{
				for (var i = 0; i < data.length; i++) {
					if (data[i].isvalid == 0 ) {
						$("#brand_option").append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
					} else {
						$("#brand_option").append("<option value=" + data[i].id + " selected >" + data[i].name + "</option>");
					}
				}
			}
		});
		$.ajax({
			url:"${CPATH}/admin/seller/getGoodsType",
			type:"post",
			dataType:"json",
			data:{"id":'${(seller.id)!}'},
			success:function(data)
			{
				for (var i = 0; i < data.length; i++) {
					if (data[i].isvalid == 0 ) {
						$("#product_type_store_option").append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
					} else {
						$("#product_type_store_option").append("<option value=" + data[i].id + " selected >" + data[i].name + "</option>");
					}
				}
			}
		});
		$city.citypicker({
            simple: true,
            responsive: true,
            province: '${(seller.prov_name)!}',
            city: '${(seller.city_name)!}',
            district: '${(seller.country_name)!}',
        });
		$city.on('choose-province.citypicker', function(event, tagert, storage) {
			alert("asdasdsadas");
		    console.log(storage);
		});        
		$('#_dept_tree').click(function() {
		layer.open({
			title:'所属部门',
		    type: 2,
		    area: ['580px', '530px'],
		    fix: false, //不固定
		    content: '${CPATH}/admin/department/department_tree'
		});
	});	
		
		jQuery.mm.initValidator('#form', validatorFields)
		
	});

	var validatorFields = {
		'seller.seller_name': {
			validators: {
				notEmpty: { message: '销售商名称不能为空' },
				stringLength: { max: 25, message: '销售商名称最大长度是25字符，请重新输入' }
			}
		},
		'seller.contact': {
			validators: {
				notEmpty: { message: '联系人不能为空' },
				stringLength: { max: 15, message: '联系人名称最大长度是15字符，请重新输入' }
			}
		},
		'seller.jywx_open_id': {
			validators: {
				notEmpty: { message: '带*的企业微信号不能为空' },
				stringLength: { max: 15, message: '企业微信号最大长度是15字符，请重新输入' }
			}
		},
		'seller.product_type_store': {
			validators: {
				notEmpty: { message: '产品类型不能为空' },
				stringLength: { max: 15, message: '产品类型最大长度是15字符，请重新输入' }
			}
		},
		'seller.phone': {
			validators: {
				notEmpty: { message: '手机号不能为空' },
				regexp:{regexp:/^1[3|4|5|7|8|9]{1}[0-9]{9}$/, message:'请输入正确的手机号码' }
			}
		},
		'seller.market_name': {
			validators: {
				notEmpty: { message: '市场名称不能为空' },
				stringLength: { max: 50, message: '市场名称最大长度是15字符，请重新输入' }
			}
		},
		'seller.market_code': {
			validators: {
				notEmpty: { message: '市场代码不能为空' },
				stringLength: { max: 50, message: '市场代码最大长度是15字符，请重新输入' }
			}
		},
		'parent_name':{
			validators: {
				notEmpty: { message: '组织机构不能为空' },
			}
		},
		'brand':{
			validators: {
				notEmpty: { message: '品牌不能为空' },
			}
		},
	};
	
	function doSubmit(){
		var l = Ladda.create( document.querySelector( '#do_submit' ) );
		$("#areaCodes").val($city.data('citypicker').getCode());
		$("#areaNames").val($city.data('citypicker').getVal());
	
		var list = $("#brand_option").select2("val");
		var ids = "";
		if (list != null && list.length > 0) {
			ids = list.toString();
		}
		
		var listp = $("#product_type_store_option").select2("val")
		var idps = "";
		if (list != null && listp.length > 0) {
			idps = listp.toString();
		}
		$form.ajaxSubmit({
			
			beforeSubmit: function() {
				var validate = $form.data('bootstrapValidator');
				validate.validate();
				if (validate.isValid()) {
					l.start();
				}
				return validate.isValid()
			},
			type : "post", 
			data : {
				"brandList":ids,"productTypeList":idps},
			dataType : "json", 
			success : function(data) { 
				if(data.errorCode == 0) {
					toastr.success(data.message, '操作成功');
					setTimeout( function(){
						l.stop();
						location.href = '${CPATH}/admin/seller/index';
								}, 1 * 1000 );
				} else {
					l.stop();
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				l.stop();
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1><#if (seller.id) ??>修改<#else>新增</#if>销售商</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
	<li>销售商管理</li>
		<li class="active"><#if (seller.id) ??>修改<#else>新增</#if>销售商信息</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="box box-default">
		<div class="box-header with-border">
			<h3 class="box-title">销售商信息</h3>
			<div class="box-tools">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<form action="${CPATH}/admin/seller/save" method="post" id="form" class="form-horizontal" >
			<input type="hidden" name="seller.id" value="${(seller.id)!}">
					<div class="box-body">
						<div class="form-group col-sm-12 validata-box">
								<label class="control-label col-sm-2">所属部门组织:</label>
								<div class="input-group col-md-4 col-sm-10">
									<div class="input-group">
										<input type="hidden" name="dept_id" id="parent_id" value="${(seller.dept_id)!}">
					                 	<input class="form-control input-sm" type="text" id="parent_name" name="parent_name" value="${(seller.parent_name)!}">
				                 		<div class="input-group-addon" id="_dept_tree" style="cursor:pointer;">
				                 			<i class="fa fa-search"></i> 选择
										</div>
				                 	</div>
				               	</div>
							</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*销售商名称:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.seller_name" value="${(seller.seller_name)!}" placeholder="1-25个任意字母数字">
							</div>
						</div>
						<#if (seller.id) ??>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*销售商编码:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" readonly name="seller.seller_code" value="${(seller.seller_code)!}">
							</div>
						</div>
						</#if>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*联系人:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.contact" value="${(seller.contact)!}" placeholder="1-15个任意字母数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*手机号:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.phone" value="${(seller.phone)!}" placeholder="11位数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
										<label class="control-label col-sm-2">是否启用:</label>
										<div class="input-group col-md-4 col-sm-10">
											<label class="radio-inline">
						                 		<input type="radio" name="seller.is_enabled" value="1" <#if !seller?? || seller.is_enabled == 1>checked</#if>>是
						                 	</label>
						                 	<label class="radio-inline">
						                 		<input type="radio" name="seller.is_enabled" value="0" <#if seller?? && seller.is_enabled == 0>checked</#if>>否
											</label>		                 		
						               	</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
		                    <label for="_title" class="col-sm-2 control-label">省市区:</label>
		                    <div class="input-group col-sm-10">
		                        <input readonly type="text" id="cityPicker" data-toggle="cityPicker" style="width:40%;">
		                        <input type="hidden" id="areaNames" name="areaNames">
		                        <input type="hidden" id="areaCodes" name="areaCodes">
		                    </div>
						</div>
						<#if (seller.id) ??><#else>
						<div class="form-group col-sm-12 validata-box">
		                    <label for="_title" class="col-sm-2 control-label">详细地址:</label>
		                    <div class="input-group col-sm-10">
		                        <input class="form-control input-sm" style="width:40%;" type="text" name="address" value="${(seller.address)!}" placeholder="1-50个任意字母数字">
		                    </div>
		                </div>
		                </#if>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*市场名称:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.market_name" value="${(seller.market_name)!}" placeholder="1-25个任意字母数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*市场代码:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.market_code" value="${(seller.market_code)!}" placeholder="1-25个任意字母数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*企业微信号ID1:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.jywx_open_id" value="${(seller.jywx_open_id)!}" placeholder="1-25个任意字母数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">企业微信号ID2:</label>
							<div class="input-group col-md-4 col-sm-10">
								<input class="form-control input-sm" type="text" name="seller.jpwx_open_id" value="${(seller.jpwx_open_id)!}" placeholder="1-25个任意字母数字">
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*产品类型:</label>
							<div class="input-group col-md-4 col-sm-10">
 								<select class="form-control input-sm" name="product_type_store" id="product_type_store_option" multiple="multiple" >
								</select>
 							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
							<label class="control-label col-sm-2">*品牌管理:</label>
							<div class="input-group col-md-4 col-sm-10" style="width=300px;">
								<select class="form-control input-sm" name="brand" id="brand_option" multiple="multiple" >
								</select>
							</div>
						</div>
						<div class="form-group col-sm-12 validata-box">
										<label class="control-label col-sm-2">备注:</label>
										<div class="input-group col-md-4 col-sm-10">
						                 	<textarea class="form-control" rows="3" name="seller.remark" value="${(seller.remark)!}" placeholder="2-20个任意字母数字">${(seller.remark)!}</textarea>
						               	</div>
						</div>
					</div>
		<div class="box-footer"> 
			<button type="button" id="do_submit" onclick="doSubmit()" class="btn btn-primary ladda-button" data-style="expand-right">保存更改</button>
			<input type="button" class="btn btn-primary" onclick="window.history.back(); return false;" value="返  回" hidefocus="true" />
		</div>
		</form>
	</div>
</section>

</@layout>