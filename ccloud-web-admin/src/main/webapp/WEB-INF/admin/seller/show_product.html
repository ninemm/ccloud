<#include "../_inc/_layout.html"/>

<#macro script_import>

	<!-- bootstrap-table -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.js"></script>
 	<!-- <script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-edit.js"></script> -->
 	<script src="${CPATH}/static/plugins/bootstrap-table/bootstrap-table-zh-CN.js"></script>

</#macro>

<#macro css_import>

	<!-- bootstrap-table-->
    <link rel="stylesheet" href="${CPATH}/static/plugins/bootstrap-table/bootstrap-table.css">

</#macro>

<#macro script>
	var $table = $("#_seller_product_table");
	$("#sellerId").change(function(){
			$("#_seller_product_table").bootstrapTable('destroy');
			var url = '${CPATH}/admin/seller/showProduct?seller_id=' + this.value + '&c=${c}&p=${p}';
			jQuery.mm.initEditTable('#_seller_product_table', url, initParams, initFields(), null);
			$("#search-submit").click(function() {
				$table.bootstrapTable('refresh');
			});
			if(this.value==""){
				$(".content").hide();
				$(".jp-left").hide();
				$(".box").hide();
			}else{
				$(".jp-left").show();
				$(".box").show();
				$(".content").show();
			}
	})
		$('#exampleModal').on('show.bs.modal', function (event) {
		console.log($('input[name="row"]:checked').parent().parent().find('td').eq(0).find("input").val());
		  var id = $("#sellerId").find("option:selected").val();
		  $("#group_id").find("option").remove(); 
		  var Html = '<option value="">----请选择----</option>';
		  $("#group_id").append(Html);
		  $.ajax({
				url:"${CPATH}/admin/seller/show_warehouse",
				type:"post",
				dataType:"json",
				data: {sellerId : id},
				success:function(data){
					$.each(data,function(index, item) {
						var html='<option value="'+item.id+'">'+item.name+'</option>';
						$("#group_id").append(html);
					});
				}
			});
				 
			})
	
		
	$(function() {
		$(".jp-left").hide();
		$(".content").hide();
		$.ajax({
				url:"${CPATH}/admin/seller/show_product",
				type:"post",
				dataType:"json",
				success:function(data){
					$.each(data,function(index, item) {
						var html='<option value="'+item.id+'">'+item.seller_name+'</option>';
						$("#sellerId").append(html);
					});
				}
			});
			
		
	});
	

	var initParams = function(params) {

		var keyword = $('#post-search-input').val();
		if (keyword) keyword = encodeURIComponent(keyword);
		var param = {
			size: params.limit,
			page: params.offset/params.limit + 1,
			k: keyword
		};
		return param;
	};

	var initFields = function() {
		var fields =
			[	
				{field: "", title: "全选", align: "center", width: '5%',
				formatter: function(value, row, rowIndex) {
					var strHtml = '<input type="checkbox" name="row" id="id_name" value="'+row.product_id+'"/>';
					return strHtml;
				},
				edit:false
				},
      			{field: "custom_name", title: "产品名称", align: "center", width: '10%',edit:false},
      			{field: "cps_name", title: "产品规格", align: "center", width: '20%',edit:false},
      			{field: "store_count", title: "库存数量", align: "center", width: '8%',edit:false},
      			{field: "price", title: "销售价格", align: "center", width: '8%',edit:false},
      			{field: "cost", title: "成本价", align: "center", width: '8%',edit:false},
      			{field: "market_price", title: "市场价", align: "center", width: '8%',edit:false},
      			{field: "is_enable", title: "是否上架", align: "center", width: '8%',
      				formatter: function(value, row, rowIndex) {
   						if (value == 1) return '是';
   						else return '否';
   					},
      				edit:false
      			},
   				{field: "order_list", title: "排序", align: "center", width: '8%', edit: false},   
				{field: "action", title: "操作", align: "center", width: '10%',
				formatter: function(value, row, rowIndex) {
					var url2 = '${CPATH}/admin/seller/change?id=' + row.id +'&is_enable='+row.is_enable+ '&c=${c}&p=${p}';
					var strHtml = '<a onclick="savePro(\''+row.id+'\')" name="row" class="btn btn-sm" title="保存"><i class="fa fa-check-square"></i></a>'
					if(row.is_enable == 0){
					  strHtml = '<a href="' + url2 + '" class="btn btn-sm" title="上架"><i class="fa fa-arrow-circle-o-up"></i></a>';
					}else{
					  strHtml = '<a href="' + url2 + '" class="btn btn-sm" title="下架"><i class="fa fa-arrow-circle-o-down"></i></a>';
					}
					return strHtml;
				},
				edit:false
				}
   			];
   		return fields;
	}
	
	function getA(){
		var id = $("#sellerId").find("option:selected").val();
		var url = '${CPATH}/admin/seller/addProduct?sellerId='+id+'&c=${c!}&p=${p!}';
		location.href=url;
	}

	function saveWarehouse(){
		var warehouseId = $("#group_id").find("option:selected").val();
		var orderItems = new Array();
		 var checklist = $('input[name="row"]:checked').parent().parent();
		 if(checklist.length == 0){
			alert("未选中任何产品!");
			return;		 
		 }
		 $('input[name="row"]:checked').parent().parent().each(function(idx, item) {
		  	var obj = {
								"productId":  $(this).find('td').eq(0).html(),
							};
							orderItems.push(obj);
						})
		$.ajax({
			url:"${CPATH}/admin/seller/savePro",
			type:"post",
			dataType:"json",
			data : {orderItems : JSON.stringify(orderItems), warehouseId :warehouseId},
			success:function(data){
				alert(data.result);
			}
		});
	}
</#macro>

<@layout active_id=p child_active_id=c>

<section class="content-header">
	<h1>产品信息</h1>
	<div class="input-group col-md-2 col-sm-8" style="padding-top:10px;">
		<select class="form-control input-sm" name="id" id="sellerId" >
			<option value="">----请选择经销商----</option>
		</select>
    </div>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
       	<li><a href="#">产品信息</a></li>
       	<li class="active">产品信息</li>
	</ol>
</section>
<!-- Main content -->
<section class="content">
	<div class="row content-row">
		<div class="jp-left">
			<a onclick="getA()" class="btn btn-sm btn-primary btn-flat"><i class="fa fa-plus"></i> 新增 </a>
			<button type="button" class="btn btn-primary" id="product_warehouse"  data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">产品入库</button>
			<!-- <a onclick="savePro()" class="btn btn-sm btn-primary btn-flat" ><i class="fa fa-check-square-o fa-1x"></i><span style="font-size:12px;"> 保存</span> </a> -->
		</div>
		<form class="form-horizontal" style="float: right" action="${CPATH}/admin/seller/show_product?c=${c!}&p=${p!}" method="post">
			<div class="input-group input-group-sm">
				<input id="post-search-input" class="form-control" type="search" value="${k!}" name="k" placeholder="搜索名称">&nbsp; 
				<input id="search-submit" class="btn btn-default btn-sm btn-flat" type="button" value="搜索">
			</div>
		</form>
	</div>
	<div class="box">
		<table class="table table-striped table-hover table-condensed" id="_seller_product_table" ></table>
	</div>
	<!-- /.box -->
</section>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" style="padding-top:200px;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">产品入库操作</h4>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="recipient-name" class="control-label">选择仓库:</label>
            <select class="form-control input-sm" name="user.group_id" id="group_id">
			</select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="saveWarehouse()">保存</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
</@layout>