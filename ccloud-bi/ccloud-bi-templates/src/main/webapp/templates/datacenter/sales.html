<#include "_inc/_layout.html"/>
<#macro script_import>

 	<script src="${CPATH}/templates/datacenter/js/echarts.min.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=su3AmHLUcBprpnOLmVHo7r8AljbW8X6t"></script>
 	<!-- <script src="${CPATH}/templates/datacenter/js/bootstrap.min.js"></script> -->

</#macro>
<#macro css_import>

    <link rel="stylesheet" href="${CPATH}/templates/datacenter/css/bootstrap.min.css">

</#macro>
<#macro css>
    #customer_rank{
        width: 100%;
        height:11.5rem;
        margin-top:.5rem;
    }

    #area_rank{
        width: 100%;
        height:14rem;
    }
    #stock_125{
      width: 100%;
      height:14rem;
    }

    #stock_258{
      width: 100%;
      height:14rem;
    }

    #stock_520{
      width: 100%;
      height:14rem;
    }
    .table{
      font-size:0.3rem;
    }

    .weui-tab__bd {
       width: 200%;
       position: relative;
       left: 0;
       display: flex;
       transition: .3s all linear;
     }
     #tab1,#tab2 {
       width: 50%;
     }
     .active {
       left: -100%;
       transition: .3s all linear;
     }

</#macro>
<#macro script>
    var provName = '';
    var cityName = '';
    var countryName = '';
    var dateType = 0;
    var prov_data = [];
    var city_data = [];
    var country_data = [];
    $(function() {
        var MapSet = {
          GetLocation:function(){
            var geolocation = new BMap.Geolocation();
            geolocation.getCurrentPosition(function(r) {
              if(this.getStatus() == BMAP_STATUS_SUCCESS) {
                var rp = new BMap.Point(r.point.lng,r.point.lat);
                var gc = new BMap.Geocoder();
                gc.getLocation(rp,function(rs){
                  var addComp = rs.addressComponents;
                  provName = addComp.province;
                  cityName = addComp.city;
                  countryName = addComp.district;
                  provName = provName.substring(0, provName.length - 1);

                  console.log(provName + "");
                  console.log(cityName.toString());
                  console.log(typeof countryName);

                  if(countryName.length != 0) {
                    clickCity({"name": cityName}, provName);
                    mapRender(false);
                    clickProv({"name": provName}, false);
                    cityName = addComp.city;
                  } else if(cityName.length !=0){
                    mapRender(false);
                    clickProv({"name": provName}, true);
                  } else mapRender(true);
                });
              }
            },{enableHighAccuracy: true})
          }
        };
        MapSet.GetLocation();
        FastClick.attach(document.body);
        $(".date").click(function(e) {
            var $a = $(e.currentTarget);
            $a.parent().find(".date").removeClass("active-date");
            $a.addClass("active-date");
        });

	var ITEM_ON = "weui-bar__item--on";

    var showTab = function(a) {
        var $a = $(a);
        if ($a.hasClass(ITEM_ON)) return;
        var href = $a.attr("href");

        if (!/^#/.test(href)) return;

        $a.parent().find("." + ITEM_ON).removeClass(ITEM_ON);
        $a.addClass(ITEM_ON);

        if (href == "#tab2") {
            $(".weui-tab__bd").addClass("active");
        } else {
            $(".weui-tab__bd").removeClass("active");
        }


    }

    $.showTab = showTab;

    $(".weui-navbar__item").click(function(e) {
        var $a = $(e.currentTarget);
        var href = $a.attr("href");
        if ($a.hasClass(ITEM_ON)) return;
        if (!/^#/.test(href)) return;

        e.preventDefault();
        showTab($a);
    })

        customer_rank();
   		  area_rank();
   		  product_rank();
   		  stock_rank();
        stock(125,"za000053");
      });

    //回到中国地图界面
    function goBackChinaMap() {
      $('#china_map').css('display','block');
      $('#city_map').css('display','none');
      $('#prov_map').css('display','none');

      $('#prov').css('visibility','hidden');
    	$('#city').css('visibility','hidden');
    }

    //回到省界面
    function goBackProvMap() {
      $('#prov_map').css('display','block');
  		$('#china_map').css('display','none');
  		$('#city_map').css('display','none');

  		$('#city').css('visibility','hidden');
  	}

    //做时间的切换选择
    function setDateType(type){
      dateType = type;
      customer_rank();
      area_rank();
      product_rank();
      stock_rank();
      stock(125,"za000053");
      mapRender(false);
      var cityNameCopy = cityName;
      clickProv({"name": provName.substring(0, provName.length - 1)}, false);
      clickCity({"name": cityNameCopy}, provName.substring(0, provName.length - 1));
    }

    //点击地图上的省
    function clickProv (result, isRender) {
      cityName = '';
      if(result.name == '北京' || result.name == '上海' || result.name == '天津' || result.name == '台湾' || result.name == '重庆'){
        provName = result.name + '市';
      } else {
        provName = result.name + '省';
      }

      var maxData = 0;
      var url = "${CPATH}/sales/queryMapData?provName=" + provName + "&cityName=&countryName=&dateType=" +dateType;
      $.get(url,function(data){
          city_data = [];
        for(var i = 0; i < data.length; i++)
        {
          city_data.push({"name": data[i].cityName, "value": data[i].totalAmount});
          if(data[i].totalAmount > maxData) maxData = data[i].totalAmount;
        }
        setTimeout(function () {
          $('#prov_view').text(result.name);
          $('#prov').css('visibility','visible');

          if (isRender) {
            $('#china_map').css('display','none');
            $('#city_map').css('display','none');
            $('#prov_map').css('display','block');
          }
        }, 500);
        //选择省的单击事件
        var selectProv = result.name;
        //    调取后台数据
        $.get('${CTPATH}/json/'+selectProv+'/'+selectProv+'.json', function (Citymap) {
          echarts.registerMap(selectProv, Citymap);
          var myChartProv = echarts.init(document.getElementById('prov_map'));
          $(document.getElementById('prov_map')).width(400);
          myChartProv.resize();
          myChartProv.setOption({
            tooltip: {
              trigger: 'item',
              textStyle: {fontSize: 9},
              formatter: function loadData(result){
                if(isNaN(result.value)) return result.name + '<br />总金额: 0';
                else return result.name+'<br />总金额:'+result.value + '万元';
              }
            },
            visualMap:{
              min:0,
              max:maxData+1,
              splitNumber:0,
              text:['高','低'],
              realtime:false,
              selectedMode:false,
              realtime:false,
              show:true,
              itemWidth:20,
              itemHeight:120
            },
            series: [{
              type: 'map',
              map: selectProv ,//要和echarts.registerMap（）中第一个参数一致
              roam: 'scale',
              scaleLimit: { min: 1, max: 4 },//缩放
              mapLocation:{
                y:60
              },
              itemSytle:{
                emphasis:{label:{show:false}}
              },
              label: {
                normal: {
                  show: true
                },
                emphasis: {
                  show: true
                }
              },
              data : city_data.reverse()
            }]
          })
          myChartProv.on('click', function(rel){
            clickCity(rel, selectProv);
          });
        });
      });
    }

    //点击地图上的市
    function clickCity(rel, selectProv) {
      var maxData = 0;
      cityName = rel.name;
      var url = "${CPATH}/sales/queryMapData?provName=" + provName + "&cityName=" + cityName + "&countryName=&dateType=" +dateType;
      $.get(url,function(data){
          country_data = [];
        for(var i = 0; i < data.length; i++)
        {
          country_data.push({"name": data[i].countryName, "value": data[i].totalAmount});
          if (data[i].totalAmount > maxData) maxData = data[i].totalAmount;
        }
        setTimeout(function () {
          function contains(arr, obj) {
            var i = arr.length;
            while (i--) {
              if (arr[i] === obj) {
                return true;
              }
            }
            return false;
          }
          var arr = new Array('北京','上海','天津','台湾','重庆');
          if(contains(arr,selectProv)==false){
            $('#city_view').text(rel.name);
            $('#city').css('visibility','visible');

            $('#china_map').css('display','none');
            $('#prov_map').css('display','none');
            $('#city_map').css('display','block');
          }
          else{
            $('#china_map').css('display','none');
            $('#prov_map').css('display','block');
            $('#city_map').css('display','none');
          }

        }, 500);
        //选择市的单击事件
        var selectCity = rel.name;

        //    调取后台数据
        countryMapRender(selectProv, selectCity, maxData);
      });
    }

    function countryMapRender(selectProv, selectCity, maxData) {
      $.get('${CTPATH}/json/'+selectProv+'/'+selectCity+'.json', function (Citymap) {
        echarts.registerMap(selectCity, Citymap);
        var myChartCity = echarts.init(document.getElementById('city_map'));
        $(document.getElementById('city_map')).width(400);
        myChartCity.resize();
        myChartCity.setOption({
          tooltip: {
            trigger: 'item',
            textStyle: {fontSize: 9},
            formatter: function loadData(result){
              if(isNaN(result.value)) return result.name + '<br />总金额: 0';
              else return result.name+'<br />总金额:'+result.value + '万元';
            }
          },
          visualMap:{
            min:0,
            max:maxData+1,
            splitNumber:0,
            text:['高','低'],
            realtime:false,
            selectedMode:false,
            realtime:false,
            show:true,
            itemWidth:20,
            itemHeight:120
          },
          series: [{
            type: 'map',
            map: selectCity ,//要和echarts.registerMap（）中第一个参数一致
            roam: 'scale',
            scaleLimit: { min: 1, max: 4 },//缩放
            mapLocation:{
              y:60
            },
            itemSytle:{
              emphasis:{label:{show:false}}
            },
            label: {
              normal: {
                show: true
              },
              emphasis: {
                show: true
              }
            },
            data : country_data.reverse()
          }]
        })
        myChartCity.on('click',function(rel){
          setTimeout(function () {
          }, 500);
        })
      });
    }
    //中国地图渲染
    function mapRender(isRender) {
      /*echarts*/
      var maxData = 0;
      var url = "${CPATH}/sales/queryMapData?provName=&cityName=&countryName=&dateType=" +dateType;
      $.get(url,function(data){
          prov_data = [];
        for(var i = 0; i < data.length; i++)
        {
          prov_data.push({"name": data[i].provName.substring(0, data[i].provName.length -1), "value": data[i].totalAmount});
          if (data[i].totalAmount > maxData) maxData = data[i].totalAmount;
        }
        setTimeout(function () {

          if (isRender) {
            $('#china_map').css('display','block');
            $('#city_map').css('display','none');
            $('#prov_map').css('display','none');
          }
        }, 500);
      $.get('${CTPATH}/json/china.json', function (mapJson) {
        echarts.registerMap('china', mapJson);
        var chart = echarts.init(document.getElementById('china_map'));//在id为mainMap的dom元素中显示地图
        $(document.getElementById('china_map')).width(400);
        chart.resize();
        chart.setOption({
          tooltip: {
            trigger: 'item',
            textStyle: {fontSize: 9},
            formatter: function (result){
              if(isNaN(result.value)) return result.name + '<br />总金额: 0';
              else return result.name+'<br />总金额:'+result.value + '万元';
            }
          },
          visualMap:{
            min:0,
            max:maxData+1,
            splitNumber:0,
            text:['高','低'],
            realtime:false,
            selectedMode:false,
            realtime:false,
            show:true,
            itemWidth:20,
            itemHeight:120
          },
          series: [{
            type: 'map',
            map: 'china',//要和echarts.registerMap（）中第一个参数一致
            roam: 'scale',
            scaleLimit: { min: 1, max: 4 },//缩放
            mapLocation:{
              y:60
            },
            itemSytle:{
              emphasis:{label:{show:false}}
            },
            label: {
              normal: {
                show: true,
                textStyle: {fontSize: 9},
              },
              emphasis: {
                show: true,
                textStyle: {fontSize: 9},
              }
            },
            data : prov_data.reverse()
          }]
        }),

        chart.on('click', function(result) {
          clickProv(result, true);
        });
      });
     });
    }

	  //客户
	  function customer_rank(){
	    $.ajax({
			url:"${CPATH}/sales/customerType",
			type:"post",
			data:{"provName": "湖北省", "cityName": "武汉市",countryName:""},
			dataType:"json"
		}).done(function(data){

			var crSeriesData = [];
			var length = data.length > 5 ? 5 : data.length;

		    for(var i = 0; i < length; i++){
                crSeriesData.push({
                    name: data[i][0] + '(' + data[i][1] + ')',
                    value: data[i][1]
                });
		    }

			var crTitle = '客户销售情况前五名(金额/万元)';


			var customer_rank = document.getElementById('customer_rank');
			var $customer_rank = $(customer_rank);

			var customerRankChart = echarts.init(customer_rank);
			var crOption = {
			    title: [{
			        text: crTitle,
			        textStyle: {
			            fontWeight: 'normal',
			            fontSize: 16
			        }
			    }],
			    color: ['#4ac7f5', '#f36f8a', '#fd9173', '#AF89D6', '#5f71d2'],
			    series: [
			        {
			            name:crTitle,
			            type:'pie',
			            radius: ['25%', '45%'],
			            center: ['50%', '60%'],
			            avoidLabelOverlap: false,
			            label: {
			                normal: {
			                    textStyle: {
			                        fontSize: 10
			                    }
			                }
			            },
			            data:crSeriesData
			        }
			    ]
			};
			customerRankChart.resize();
			customerRankChart.setOption(crOption,true);
		});
	}

	 //区域
    function area_rank(){
      $.ajax({
  			url:"${CPATH}/sales/area",
  			type:"post",
  			data:{"provName": "湖北省", "cityName": "武汉市",countryName:""},
  			dataType:"json"
  		}).done(function(data){
        var areaYData = [];
        var areaSeriesData = [];
		    var length = data.length > 5 ? 5 : data.length;

		    for(var i = 0; i < length; i++){
          areaYData.push(data[i][0]) ;
          areaSeriesData.push(data[i][1]);
		    }

		    var areaTitle = '销售情况前五名(金额/万元)';

        var area_rank = document.getElementById('area_rank');
			  var $area_rank = $(area_rank);

        var areaRankChart = echarts.init(area_rank);
			  var option = {
			    title: [{
            text: areaTitle,
            textStyle: {
              fontWeight: 'normal',
              fontSize: 16
			      }
			    }],
			    color: ['#4ac7f5'],
			    grid: {
            left: '2%',
            right: '15%',
            bottom: 15,
            top: 60,
            containLabel: true
			    },
			    calculable : true,
			    xAxis : [
			    {
			      show : false,
			      name : '金额/万元',
	          type : 'value',
		        boundaryGap: [0, 0.01]
			    }
			    ],
			    yAxis : [
			    {
		        type : 'category',
		        data : areaYData.reverse()
			    }
			    ],
			    series : [
			    {
		        type:'bar',
		        barWidth: 25,
		        data:areaSeriesData.reverse(),
		        label:{
	            normal:{
                show:true,
                position:'right'
	            }
		        }
          }
			   ]
       };
       areaRankChart.resize();
       areaRankChart.setOption(option,true);
     });
   }

    //产品
    function product_rank(){
  		$.ajax({
  			url:"${CPATH}/sales/product",
  			type:"post",
  			data:{"provName": "湖北省", "cityName": "武汉市",countryName:""},
  			dataType:"json"
  		}).done(function(data){
  			var length = data.length > 5 ? 5 : data.length;

        var $tbody = $("#product_rank tbody");
        $tbody.empty();
        $tbody.append("<tr><th>产品</th><th>数量(件)</th><th>金额</th></tr>");
        for(var i = 0; i < length; i++){
          $tbody.append("<tr><td>" + data[i][0] + "</td><td>" + data[i][1] + "</td><td>" + data[i][2] + "</td></tr>");
        }
      });
    }

	//库存
  function stock_rank(){
    $.ajax({
			url:"${CPATH}/stock/area",
			type:"post",
			data:{"provName": "湖北省", "cityName": "武汉市",countryName:""},
			dataType:"json"
		}).done(function(data){
			var length = data.length > 5 ? 5 : data.length;
      var $tbody = $("#stock_rank tbody");
      $tbody.empty();
	    $tbody.append("<tr><th>产品</th><th>数量(件)</th></tr>");
	    for(var i = 0; i < length; i++){
        $tbody.append("<tr><td>" + data[i][0] + "</td><td>" + data[i][1] + "</td></tr>");
	    }
    });
	}

    //库存趋势
    function stock(name,cInvCode){
		$.ajax({
			url:"${CPATH}/stock/date",
			type:"post",
			data:{"provName": "湖北省", "cityName": "武汉市", countryName:"", cInvCode: cInvCode},
			dataType:"json"
		}).done(function(data){
            var areaYData = [];
			var areaSeriesData = [];
		    var length = data.length > 5 ? 5 : data.length;

		    for(var i = 0; i < length; i++){
                areaYData.push(data[i][0]) ;
                areaSeriesData.push(data[i][1]);
            }

			var title = '客户库存趋势情况(单位/件)';

			var seriesData = [12320.23, 12812.2, 13223.91, 33323.34, 22120, 23330, 12233.10];


			var stock = document.getElementById('stock'+'_'+name);
			var $stock = $(stock);

			var stockChart = echarts.init(stock);
			var option = {
                title: {
                    text: title
                },
                 tooltip : {
                   //  trigger: 'axis',
                   //  formatter:function(v){
                   //     return v[0].name+":"+ v[0].data.toString().replace(/(\d)(?=(\d{3})+(\.|$))/g, '$1,');
		      //  }
                 },
				  grid: {
				       left: '13%',
				       right: '14%',
				       top:'30%'
				  },
				  xAxis: {
				       data: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
			      },
				  yAxis: {},
				  series: [{
				       name: title,
				       type: 'line',
				          markPoint : {
				              label: {
				                  normal: {
				                      textStyle: {
				                          color: '#000',
				                      }
				                 }
				          },
				          data : [
				              {type : 'max', name: '最大值'},
				              {type : 'min', name: '最小值'}
				              ]
				          },
				          markLine: {
				              data: [
				                  {type: 'average', name: '平均值'}
				              ]
				          },
				          data:seriesData
				  }]
            };
            stockChart.resize();
			stockChart.setOption(option,true);
		});
    }
</#macro>
<section>
    <div class="bi-body">
        <div class="date-div">
            <a class="date active-date" onclick="setDateType(0)">最近一天</a>
            <a class="date"onclick="setDateType(1)">最近一周</a>
            <a class="date"onclick="setDateType(2)">最近一月</a>
        </div>
        <div class="map" style="width: 100%;height:20rem;background: #efeff4">
            <p>2017-08-15销售情况</p>
            <div>
              <span id="china"style="visibility:visible;">  <a href ="javascript:void(0);" onclick="goBackChinaMap()" > 全国</a></span>
              <span id="prov" style="visibility:hidden;" > > <a href ="javascript:void(0);" onclick="goBackProvMap()" id="prov_view"></a></span>
              <span id="city" style="visibility:hidden;"> > <a herf = "javascript:void(0);" id="city_view"></a></span>
            </div>
            <div id="china_map" style="width: 100%;height:16rem;margin:0 auto;position: relative;display: none;"></div>
            <div id="prov_map"  style="width: 100%;height:16rem;margin:0 auto;position: relative;display: none;"></div>
            <div id="city_map"  style="width: 100%;height:16rem;margin:0 auto;position: relative;display: none;"></div>
        </div>
        <!-- 容器 -->
        <div class="weui-tab report">
            <div class="weui-navbar">
                <a class="weui-navbar__item weui-bar__item--on" href="#tab1">
                  销售报表
                </a>
                <a class="weui-navbar__item" href="#tab2">
                  库存报表
                </a>
            </div>
            <div class="weui-tab__bd">
                <div id="tab1" class="weui-tab__bd-item weui-tab__bd-item--active">
                      <div id="customer_rank">

                      </div>
                      <div id="area_rank">
                      </div>
                      <div>
                          <table id="product_rank" class="table">
                            <thead>产品销售前五名(金额/万元)</thead>
                            <tbody>
                              <tr>
                                <th>产品</th>
                                <th>数量(件)</th>
                                <th>金额</th>
                              </tr>
                            </tbody>
                          </table>
                      </div>
                </div>
                <div id="tab2" class="weui-tab__bd-item weui-tab__bd-item--active">
                    <div>
                        <table id="stock_rank" class="table">
                          <thead>库存排行</thead>
                          <tbody>
                            <tr>
                              <th>产品</th>
                              <th>数量(件)</th>
                            </tr>
                          </tbody>
                        </table>
                    </div>
                    <p class="title">全国库存趋势</p>
                    <div>
                      <div id="stock_125">

                      </div>

                      <div id="stock_258">

                      </div>

                      <div id="stock_520">

                      </div>

                      </div>
                </div>
            </div>
        </div>
    </div>
</section>
<@layout>
</@layout>
