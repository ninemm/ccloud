<#include "_inc/_layout.html"/>
<#macro script_import>

 	<script src="${CPATH}/templates/datacenter/js/echarts.min.js"></script>
 	<!-- <script src="${CPATH}/static/bootstrap/js/bootstrap.min.js"></script> -->

</#macro>
<#macro css_import>

    <link rel="stylesheet" href="${CPATH}/static/bootstrap/css/bootstrap.min.css">

</#macro>
<#macro css>
	.weui-cells {
		margin-top: 0;
		background: inherit;
		font-size: 0.6rem;
	}
	table {
		background: #fff;
		margin-bottom: 0!important;
	}
	table a {
		text-decoration: underline;
	}
	th {
		vertical-align: middle!important;
		text-align: center!important;
	}
	td {
		vertical-align: middle!important;
	}
	tr {
		line-height: 1.5rem;
		height: 1.5rem;
	}
    #customer_rank{
        width: 100%;
        height:8rem;
    }
    #area_rank{
        width: 100%;
        height:8rem;
    }

</#macro>
<#macro script>
    $(function() {
        customer('', '', '', dateType);
        product_rank('', '', '', dateType, customerTypeName);
        area_rank('', '', '', dateType, customerTypeName);
    });
    var dateType = 0;
    var customerTypeName = '零售终端';
    
    //做时间的切换选择
    $(".date").click(function(e) {
        var $a = $(e.currentTarget);
        $a.parent().find(".date").removeClass("active-date");
        $a.addClass("active-date");
    });
    function setDateType(type){
        dateType = type;
        customer('', '', '', dateType);
        product_rank('', '', '', dateType, customerTypeName);
        area_rank('', '', '', dateType, customerTypeName);
    }
    
  	var customer_rank = document.getElementById('customer_rank');
	var $customer_rank = $(customer_rank);

	var customerRankChart = echarts.init(customer_rank);
    
    //客户
    function customer(provName, cityName, countryName, dateType){
	    $.ajax({
			url:"${CPATH}/sales/customerType",
			type:"post",
			data:{"provName": provName, "cityName": cityName, countryName: countryName, dateType: dateType},
			dataType:"json"
		}).done(function(data){

			var crLegendData = [];
			var crSeriesData = [];

		    for(var i = 0; i < data.length; i++){
		        crLegendData.push(data[i].customerTypeName + '(' + data[i].totalAmount + '万元)');
                crSeriesData.push({
                    name: data[i].customerTypeName + '(' + data[i].totalAmount + '万元)',
                    value: data[i].totalAmount
                });
		    }
            var crTitle = '客户分布';
            if((provName + cityName + countryName).trim() != '' ){
			    crTitle = provName + cityName + countryName + crTitle;
			} else {
			    crTitle = '' + crTitle;
			}
			var $p = $("#p_customer_rank");
			$p.empty();
			$p.text(crTitle);


			var crOption = {
                 backgroundColor: '#f2f2f2',
			     color: ['#4ac7f5', '#f36f8a', '#fd9173', '#AF89D6', '#5f71d2'],
                 legend: {
                     //selectedMode:false,
                     orient: 'vertical',
                     x: 'right',
                     data:crLegendData
                 },
			     series: [
			         {
			             name:crTitle,
			             type:'pie',
			             selectedMode: 'single',
			             radius: ['25%', '55%'],
			             center: ['30%', '40%'],
			             label: {
			                 normal: {
			                     show: false
			                 }
			             },
			             labelLine: {
                             normal: {
                                 show: false
                             }
                         },
			             data:crSeriesData
			         }
			     ]
			};
			customerRankChart.resize();
			customerRankChart.setOption(crOption,true);
			customerRankChart.on('legendselectchanged', customerClick);
		});
	}
	
    function customerClick(obj){
        var selected = obj.selected;
        var typeName = obj.name;

        // 消除点击图例会消失
        // 使用 legendToggleSelect Action 会重新触发 legendselectchanged Event，导致本函数重复运行使得 无 selected 对象
        if (selected != undefined) {
            var lt = Object.keys(selected);
		    var legend = [];
		
		    for (var i = 0; i < lt.length; i++) {
		        var name = lt[i];
		        legend.push({
		            name : name
		        });
		    }
		
		    customerRankChart.dispatchAction({
		        type: 'legendSelect',
		        batch: legend
		    });
        }
        customerTypeName = typeName.slice(0, typeName.lastIndexOf('('));
        
        product_rank('', '', '', dateType, customerTypeName);
        area_rank('', '', '', dateType, customerTypeName);
    }
    
    
    //产品
    function product_rank(provName, cityName, countryName, dateType, customerTypeName){
      $.ajax({
  			url:"${CPATH}/sales/productByCustomerType",
  			type:"post",
  			data:{provName: provName, cityName: cityName, countryName: countryName, dateType: dateType, customerTypeName: customerTypeName},
  			dataType:"json"
  		}).done(function(data){
  		    var prTitle = customerTypeName + '产品销售排行';
            if((provName + cityName + countryName).trim() != '' ){
			    prTitle = provName + cityName + countryName + prTitle;
			} else {
			    prTitle = '' + prTitle;
			}
			var $p = $("#p_product_rank");
			$p.empty();
			$p.text(prTitle);

            var $tbody = $("#product_rank tbody");
            $tbody.empty();
            $tbody.append("<tr><th>产品</th><th>数量(件)</th><th>金额(万元)</th></tr>");
            for(var i = 0; i < data.length; i++){
                $tbody.append("<tr><td>" + data[i].cInvName + "</td><td>" + data[i].totalNum + "</td><td>" + data[i].totalAmount + "</td></tr>");
            }
       });
    }
    
    //区域
    function area_rank(provName, cityName, countryName, dateType, customerTypeName){
      $.ajax({
  			url:"${CPATH}/sales/areaByCustomerType",
  			type:"post",
  			data:{provName: provName, cityName: cityName, countryName: countryName, dateType: dateType, customerTypeName: customerTypeName},
  			dataType:"json"
  		}).done(function(data){
            var areaYData = [];
            var areaSeriesData = [];
            var area_rank = document.getElementById('area_rank');
			var $area_rank = $(area_rank);
			
		    $area_rank.height(80);
		    for(var i = 0; i < data.length; i++){
		        var height = $area_rank.height();
                $area_rank.height(height += 16);
		    
                if (cityName.trim() != '') {
                    areaYData.push(data[i].countryName);
                }else if(provName.trim() != ''){
                    areaYData.push(data[i].cityName);
                }else{
                    areaYData.push(data[i].provName);
                }
                areaSeriesData.push(data[i].totalAmount);
		    }

		    var areaTitle = customerTypeName + '销售分布';
		    if((provName + cityName + countryName).trim() != '' ){
			    areaTitle = provName + cityName + countryName + areaTitle;
			} else {
			    areaTitle = '' + areaTitle;
			}
			var $p = $("#p_area_rank");
			$p.empty();
			$p.text(areaTitle);


            var areaRankChart = echarts.init(area_rank);
			var option = {
                backgroundColor: '#f2f2f2',
			    color: ['#4ac7f5'],
			    grid: {
                    left: '2%',
                    right: '15%',
                    bottom: 15,
                    top: 15,
                    containLabel: true
			    },
			    calculable : true,
			    xAxis : {
			        show : false,
			        name : '金额万元/件',
	                type : 'value',
		            boundaryGap: [0, 0.01]
			    },
			    yAxis : {
		            type : 'category',
		            data : areaYData.reverse(),
		            axisLabel : {
		                interval : 0,
		                fontSize : 8
                    }
			    },
			    series : {
		            type:'bar',
		            barWidth:15,
		            data:areaSeriesData.reverse(),
		            label:{
	                    normal:{
                            show:true,
                            position:'right',
                            formatter: '{c}万元'
	                    }
		            }
                }
           };
           areaRankChart.resize();
           areaRankChart.setOption(option,true);
           //areaRankChart.on('click', areaClick);
       });
    }

    
</#macro>
<@layout>
<section>
    <div class="bi-body">
   	   	<#include "_inc/_search_box.html"/>
        <p class="title" id="p_customer_rank"></p>
        <div id="customer_rank" id="customer_rank">
        </div> 

   	   	<p class="title" id="p_product_rank"></p>
   	   	<div class="weui-cells weui-cells_form">
   			<div class="weui-cell" style="padding: 0">
   		        <table class="table table-striped table-bordered" id="product_rank">
	   		        <tbody style="text-align: center;">
	   		        	<tr>
		        			<th>
		        				产品
		        			</th>
		        			<th>
		        				省份
		        			</th>
		        			<th>
		        				数量(件)
		        			</th>
	   		        	</tr>
	   		        </tbody>
   		        </table>
   	        </div>
   	   	</div>
   	   	<p class="title" id="p_area_rank"></p>
        <div id="area_rank">
        </div>

	</div>
</section>
</@layout>
