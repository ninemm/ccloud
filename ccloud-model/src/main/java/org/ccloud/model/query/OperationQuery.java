/**
 * Copyright (c) 2015-2016, Eric Huang 黄鑫 (hx50859042@gmail.com).
 *
 * Licensed under the GNU Lesser General Public License (LGPL) ,Version 3.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.gnu.org/licenses/lgpl-3.0.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ccloud.model.query;

import java.util.LinkedList;

import org.ccloud.model.Operation;

import com.jfinal.kit.StrKit;
import com.jfinal.plugin.activerecord.Page;

/**
 * Generated by 九毫米(http://9mm.tech).
 */
public class OperationQuery extends JBaseQuery { 

	protected static final Operation DAO = new Operation();
	private static final OperationQuery QUERY = new OperationQuery();

	public static OperationQuery me() {
		return QUERY;
	}

	public Operation findById(final String id) {
//		return DAO.getCache(id, new IDataLoader() {
//			@Override
//			public Object load() {
				return DAO.findById(id);
//			}
//		});
	}

	public Page<Operation> paginate(int pageNumber, int pageSize, String keyword, String orderby) {
		String select = "select o.*,m.module_name  ";
		StringBuilder fromBuilder = new StringBuilder("from `operation` o ");
		fromBuilder.append("join `module` m on m.id = o.module_id ");

		boolean needWhere = true;
		LinkedList<Object> params = new LinkedList<Object>();
		needWhere=appendIfNotEmptyWithLike(fromBuilder, "o.operation_name", keyword, params, needWhere);
		
		buildOrderBy(orderby, fromBuilder);

		if (params.isEmpty())
			return DAO.paginate(pageNumber, pageSize, select, fromBuilder.toString());

		return DAO.paginate(pageNumber, pageSize, select, fromBuilder.toString(), params.toArray());
	}

	public Page<Operation> queryModuleAndOperation(int pageNumber, int pageSize, String keyword, String orderby) {
		String select = "select m.*, s.name as sys_name, me.module_name as parent_name, o.operation_name, o.id as operation_Id, o.description ";

		StringBuilder fromBuilder = new StringBuilder("from `module` m ");
		fromBuilder.append("join `systems` s on s.id = m.system_id ");
		fromBuilder.append("join `module` me on me.id = m.parent_id ");
		fromBuilder.append("left join `operation` o on o.module_id = m.id ");

		boolean needWhere = true;
		LinkedList<Object> params = new LinkedList<Object>();
		needWhere = appendIfNotEmptyWithLike(fromBuilder, "m.module_name", keyword, params, needWhere);

		fromBuilder.append("GROUP BY m.id, o.id ");

		if (params.isEmpty())
			return DAO.paginate(pageNumber, pageSize, select, fromBuilder.toString());

		return DAO.paginate(pageNumber, pageSize, select, fromBuilder.toString(), params.toArray());
	}
	
	protected void buildOrderBy(String orderBy, StringBuilder fromBuilder) {
		
		fromBuilder.append(" order by ");
		
		if (StrKit.isBlank(orderBy)) {
			fromBuilder.append("o.order_list asc ");
			return ;
		}
		
		String orderbyInfo[] = orderBy.trim().split("\\s+");
		orderBy = orderbyInfo[0];
		
		fromBuilder.append("o.order_list ");
		
		if (orderbyInfo.length == 1) {
			fromBuilder.append("desc");
		} else {
			fromBuilder.append(orderbyInfo[1]);
		}
	}
	
	
}
