<#include "_inc/_bi_layout.html"/>
<#macro css>
    section {
        background: #fff;
    }
    .topTotal {
        margin-top: 2.4rem;
        text-align: center;
    }
    .compare .gather {
        display: inline-block;
        width: 49%;
    }
    .compare .gather:first-child {
        border-right: 1px solid #e0e0e0;
    }
    .compare .gather:nth-child(2) {
        border-left: 1px solid #e0e0e0;
    }
    .compare .gather p,.compare .gather span {
        display: block;
        width: 100%;
    }
    #dealer_in_china_map {
      width: 100%;
      height: 16rem;
    }

    header {
        background: #f9f9f9;
    }

    .more-dealer {
        line-height: 2rem;
        width: 2rem;
        text-align: center;
        position: absolute;
        bottom: 4.8rem;
        right: 0;
    }

    .map-wrapper div {
        z-index:1800;
    }

</#macro>

<#macro script_import>
    <script type='text/javascript' src="${CTPATH}/js/countUp.js"></script>
    <!-- <script type="text/javascript" src="${CTPATH}/js/city-data.js"></script>
    <script type="text/javascript" src="${CTPATH}/js/city-picker.js"></script> -->
    <script type="text/javascript" src="${CTPATH}/json/china-city-map.js"></script>
    
    <!--<script type="text/javascript" src="${CTPATH}/js/index_map.js"></script>-->
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=su3AmHLUcBprpnOLmVHo7r8AljbW8X6t"></script>
 <!--   <script type="text/javascript" src="${CTPATH}/js/headroom.min.js"></script>   -->
</#macro>
<#macro script>

    $(function() {
        if($.cookie(Utils.longitudeCache) == null || $.cookie(Utils.latitudeCache) == null) {
            initWxConfig('${appId!}', '${timestamp!}', '${nonceStr!}', '${signature!}');
    
            wxReadyGetLocation(
                function(lng, lat, addComp, address) {
                    console.log('定位成功');
                }
            );
        }
        //dealerSelect.init();
        if(dataArea != ''){
            $("#dealerName").text($("#" + dataArea).text());
        }
        topTotal();
        renderChinaMap();
        total();

    });

    function setDateType(type){
        setFilter(type);
        renderChinaMap();
        total();
    }
    $(document).on("click", ".confirm-search-btn", function () { //点击确定按钮
        setFilter(3);
        renderChinaMap();
        total();
        closeCombinSearch();
    })

    /*$(document).on("click", ".relocation", function () { //定位
        initWxConfig('${appId!}', '${timestamp!}', '${nonceStr!}', '${signature!}');
        
        wxReadyGetLocation(
            function(lng, lat, addComp, address) {

            }
        );
    })*/

    /*var dealerSelect = new Headroom($("#dealer-select")[0], {
        tolerance: 5,
        offset: 200,
        classes: {
            initial: "animated",
            pinned: "slideInRight",
            unpinned: "slideOutRight"
        }
    });*/ 


    //顶部统计
    function topTotal(){
        
        var dealerCount = new CountUp("dealerCount",0, parseInt(${session['dealer_data_area_array']?size}));
        dealerCount.start();
        var orderCustomerCount = new CountUp("orderCustomerCount",0, parseInt(${orderCustomerCount!}));
        orderCustomerCount.start();
        var  userCount = new CountUp("userCount",0, parseInt(${userCount!}));
        userCount.start();
        var visitCount = new CountUp("visitCount",0, parseInt(${visitCount!}));
        visitCount.start();
        
        setTimeout(function() {
            $("#dealerCount").addClass('animated pulse');
            setTimeout(function() {
                $("#orderCustomerCount").addClass('animated pulse');
                setTimeout(function() {
                    $("#userCount").addClass('animated pulse');
                    setTimeout(function() {
                        $("#visitCount").addClass('animated pulse');
                    }, 500);
                }, 500);
            }, 500);
        }, 500);
    }

    var dealerMapId = document.getElementById("dealer_in_china_map");
    var chinaMapCharts = echarts.init(dealerMapId);
    
    //中国地图渲染
    function renderChinaMap() {

            chinaMapCharts.showLoading({
                text: '加载中...',
                effect: 'whirling'
            });
            
            var maxData = 0;
            
            $.ajax({
                url: "${CPATH}/biSales/queryMapData",
                type: "post",
                data: {startDate: startDate, endDate: endDate},
                dataType:"json"
            }).done(function(data) {
                prov_data = [];
                for(var i = 0; i < data.length; i++) {
                    prov_data.push({
                        "name": data[i].prov_name.substring(0, data[i].prov_name.length -1),
                        "value": data[i].realAmount
                    });
            
                if (data[i].realAmount > maxData)
                    maxData = data[i].realAmount;
                }
            
                $.get('${CTPATH}/json/china.json', function (mapJson) {
                
                    echarts.registerMap('china', mapJson);
                    chinaMapCharts.hideLoading();
                    chinaMapCharts.resize();
    
                    chinaMapCharts.setOption({
                        tooltip: {
                            trigger: 'item',
                            textStyle: {fontSize: 9},
                            formatter: function (result){
                                if(isNaN(result.value))
                                    return result.name + '<br />总金额: 0';
                                else
                                    return result.name + '<br />总金额:' + result.value + '万元';
                            }
                        },
                        visualMap: {
                            min: 0,
                            max: maxData + 1,
                            splitNumber: 0,
                            text: ['高','低'],
                            realtime: false,
                            selectedMode: false,
                            realtime: false,
                            show: true,
                            itemWidth: 20,
                            itemHeight: 120
                        },
                        series: [{
                            type: 'map',
                            map: 'china',                   // 要和echarts.registerMap（）中第一个参数一致
                            roam: true,
                            scaleLimit: { min: 1, max: 4},  // 缩放
                            mapLocation:{
                            y:60
                        },
                        itemSytle: {
                            emphasis: {label: {show: false}}
                        },
                        label: {
                            normal: {
                                show: true,
                                textStyle: {fontSize: 9},
                            },
                            emphasis: {
                                show: true,
                                textStyle: {fontSize: 9},
                            }
                        },
                        data: prov_data.reverse()
                        }]
                    });
                });
            });
    }

    $("#searchInput").on("input", function() {
        if ($("#searchInput").val() == '') {
            $(".weui-cell").show();
        }
        
        $(".weui-cell").hide().filter(":contains("+ $("#searchInput").val().trim() +")").show();
    });

    $("#searchClear").on("click", function() {
        $(".weui-cell").show();
    });

    $("#searchCancel").on("click", function() {
        $(".weui-cell").show();
    });

    function selectDealer(selectDataArea,obj) {
        Utils.loading();
        dataArea = selectDataArea;
        $.cookie(Utils.dataAreaCache, dataArea, { expires: 1 });
        $("#dealerName").text($(obj).find(".weui-cell__hd").eq(0).text() + '汇总信息');
        $.ajax({
            url:"${CPATH}/selectDealer",
            type:"post",
            data:{dataArea: dataArea},
            dataType:"json"
        }).done(function(data){
            
            $.cookie(Utils.provCacheName, data.provName, { expires: 7 });
            $.cookie(Utils.cityCacheName, data.cityName, { expires: 7 });
            $.cookie(Utils.countryCacheName, data.countryName, { expires: 7 });
            $.ajax({
            async: false,
                type: "GET",
                dataType: 'jsonp',
                jsonp: 'callback',
                jsonpCallback: 'callbackfunction',
                url: "http://api.map.baidu.com/geocoder/v2/?city="+ data.cityName +"&address=" + data.countryName +"&output=json&ak=su3AmHLUcBprpnOLmVHo7r8AljbW8X6t&callback=showLocation",
                contentType: "application/json;utf-8"
            }).done(function(data){
                if(data.status == 0){
                    $.cookie(Utils.longitudeCache, data.result.location.lng, { expires: 7 });
                    $.cookie(Utils.latitudeCache, data.result.location.lat, { expires: 7 });
                }
            });
            renderChinaMap();
            total();
            closeCombinSearch();
        });
    }

    function total(){
        Utils.loading();
        $.ajax({
            url:"${CPATH}/total",
            type:"post",
            data:{startDate: startDate, endDate: endDate, dataArea: dataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){
            Utils.close();
            var salesTotal = new CountUp("order-sales", 0, parseInt(data.totalOrderAmount));
            salesTotal.start();
            var orderTotal = new CountUp("order-total",0, parseInt(data.totalOrderCount));
            orderTotal.start();
            var customerTotal = new CountUp("order-customer",0, parseInt(data.totalCustomerCount));
            customerTotal.start();
            var visitTotal = new CountUp("visit-total",0, parseInt(data.totalVisitCount));
            visitTotal.start();
        
            setTimeout(function() {
                $("#order-sales").addClass('animated pulse');
                setTimeout(function() {
                    $("#order-total").addClass('animated pulse');
                    setTimeout(function() {
                        $("#order-customer").addClass('animated pulse');
                        setTimeout(function() {
                            $("#visit-total").addClass('animated pulse');
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        });
    }

</#macro>

<@layout>
<section>

    <div class="bi-body">
        <#include "_inc/_bi_search_box.html"/>
        <div class="topTotal">
            <div class="compare">
                <div class="gather">
                    <p>
                        经销商总数(个):<br/><span id="dealerCount"></span>
                    </p>
                </div>
                <div class="gather">
                    <p>
                        总下单客户数(个):<br/><span id="orderCustomerCount"></span>
                    </p>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="compare">
                <div class="gather">
                    <p>
                        总用户数(个):<br/><span id="userCount"></span>
                    </p>
                </div>
                <div class="gather">
                    <p>
                        总拜访数(次):<br/><span id="visitCount"></span>
                    </p>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        
        <div class="divide-line"></div>
        <header>
            <div class="title">全国销售分布图</div>
        </header>
        
        <div id="map-wrapper" class="map-wrapper">
            <div id="dealer_in_china_map" class="maps"></div>
        </div>
        <div class="divide-line"></div>
        <header>
            <div class="title" id="dealerName">全部经销商汇总信息</div>
            <!--<div id="combin-filter-btn" class="more-dealer font-20"><i class="icon-list"></i></div>-->
        </header>
        <div class="sales-gather">
            <div class="gather">
                <img src="${CTPATH}/images/bi_money.png">
                <p>
                    销售金额(元):<br/><span id="order-sales"></span>
                </p>
                <div class="clearfix"></div>
            </div>
            <div class="gather">
                <img src="${CTPATH}/images/bi_order.png">
                <p>
                    订单数量(笔):<br/><span id="order-total"></span>
                </p>
                <div class="clearfix"></div>
            </div>
            <div class="gather">
                <img src="${CTPATH}/images/bi_customer.png">
                <p>
                    下单客户数(个):<br/><span id="order-customer"></span>
                </p>
                <div class="clearfix"></div>
            </div>
            <div class="gather">
                <img src="${CTPATH}/images/bi_visit.png">
                <p>
                    拜访数量(次):<br/><span id="visit-total"></span>
                </p>
                <div class="clearfix"></div>
            </div>
        </div>
        
    </div>
</section>
<img src="${CTPATH}/images/dealer-select.svg" alt="" id="dealer-select" data-target="dealer-filter">

<article id="dealer-filter" class="combin-filter animated slideOutRight">
    <div id="customer">
        <header>
            <div class="weui-search-bar" id="searchBar">
                <form class="weui-search-bar__form">
                    <div class="weui-search-bar__box">
                        <i class="weui-icon-search"></i>
                        <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索" required="">
                        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                    </div>
                    <label class="weui-search-bar__label" id="searchText">
                        <i class="weui-icon-search"></i>
                        <span>请输入经销商名称</span>
                    </label>
                </form>
                <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
            </div>
        </header>
        <article id="infinite">
            <div class="weui-cells" id="dealerList">
                <div class='weui-cell'onclick="selectDealer('',this)"><div class='weui-cell__hd'>全部经销商</div></div>
                <#list session['dealer_data_area_array'] as dealerDataArea>
                    <div class='weui-cell'onclick="selectDealer('${dealerDataArea!}',this)"><div class='weui-cell__hd' id="${dealerDataArea!}">${session['dealer_name_array'][dealerDataArea_index]!}</div></div>
                </#list>
            </div>
            <div class="weui-loadmore" id="loading" style="display: none;">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
            <div class="weui-loadmore weui-loadmore_line" id="noMore" style="display: none;">
                <span class="weui-loadmore__tips">暂无数据</span>
            </div>
        </article>
        <footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
            <button class="red-button cancel-search-btn weui-flex__item">取消</button>
        </footer>
    </div>
</article>
<#include "_inc/_combin_filter.html"/>
<#include "_inc/_nav_box.html"/>
</@layout>