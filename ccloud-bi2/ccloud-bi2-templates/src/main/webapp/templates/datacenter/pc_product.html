<#include "_inc/_pc_layout.html"/>
<#macro script_import>
</#macro>
<#macro css_import>
</#macro>
<#macro css>
    #area_rank{
        height:18rem;
    }
    #customer_rank{
        height:18rem;
    }
    #div_product_rank{
        overflow-y:scroll;
        max-height: 34rem;
    }
</#macro>
<#macro script>

    var cInvCode = '';
    var cInvName = '';

    function setDateType(type){
        setFilter(type)
        product();
    }

    //产品选择
    function setProduct(Code, obj){
        Utils.loading();
        cInvCode = Code;
        cInvName = $(obj).text();
        area_rank(cInvCode, cInvName);
        customer_rank(cInvCode, cInvName);
    }
    
    //产品
    function product(){
        Utils.loading();
        $.ajax({
            url:"${CPATH}/biSales/product",
            type:"post",
            data:{"provName": provName, "cityName": cityName, countryName: '', startDate: startDate, endDate: endDate, dataArea: dataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){
            Utils.close();

            var prTitle = '产品销售排行';
            if((provName + cityName).trim() != '' ){
                prTitle = provName + cityName + prTitle;
            } else {
                prTitle = '全国' + prTitle;
            }
            var $p = $("#p_product_rank");
            $p.empty();
            $p.text(prTitle);

            var $tbody = $("#product_rank tbody");
            $tbody.empty();
            $tbody.append("<tr><th>产品</th><th>数量(件)</th><th>金额(万元)</th></tr>");
            for(var i = 0; i < data.length; i++){
                var fun = "setProduct('" + data[i].id + "',this" + ")";
                $tbody.append("<tr ><td><a href='javascript:void();' onclick=" + fun +">" + data[i].custom_name + "</a></td><td class='t-r'>" + data[i].productCount + "</td><td class='t-r'>" + data[i].totalAmount + "</td></tr>");
            }

            var $tr = $("#product_rank tbody tr:gt(5)");
            if($tr.length > 0){
                $tr.hide();
                $(".trOpen").show();
                $(".trClose").hide();
                $("#product_rank tfoot").show();
            }else {
                $("#product_rank tfoot").hide();
            }

            var dataCInvCode = (data[0] != undefined ? data[0].id : '');
            var dataCInvName = (data[0] != undefined ? data[0].custom_name : '');

            //调用其他纬度
            area_rank(dataCInvCode, dataCInvName);
            customer_rank(dataCInvCode, dataCInvName);
       });
    }
    
    //区域
    function area_rank(cInvCode, cInvName){
      $.ajax({
            url:"${CPATH}/biSales/areaByProduct",
            type:"post",
            data:{provName: provName, cityName: cityName, countryName: '', startDate: startDate, endDate: endDate, cInvCode: cInvCode, dataArea: dataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){
            Utils.close();

            var areaYData = [];
            var areaSeriesData = [];
            var area_rank = document.getElementById('area_rank');
            var $area_rank = $(area_rank);
            
            $area_rank.height(80);
            for(var i = 0; i < data.length; i++){
                var height = $area_rank.height();
                $area_rank.height(height += 16);
            
                if (cityName.trim() != '') {
                    areaYData.push(data[i].countryName);
                }else if(provName.trim() != ''){
                    areaYData.push(data[i].cityName);
                }else{
                    areaYData.push(data[i].provName);
                }
                areaSeriesData.push(data[i].totalNum);
            }

            var areaTitle = cInvName + '销售情况';
            //if((provName + cityName).trim() != '' ){
            //    areaTitle = provName + cityName + areaTitle;
            //} else {
            //    areaTitle = '' + areaTitle;
            //}
            var $p = $("#p_area_rank");
            $p.empty();
            $p.text(areaTitle);


            var areaRankChart = echarts.init(area_rank);
            var option = {
                color: ['#4ac7f5'],
                grid: {
                    left: '2%',
                    right: '15%',
                    bottom: 15,
                    top: 15,
                    containLabel: true
                },
                calculable : true,
                xAxis : {
                    show : false,
                    name : '数量/件',
                    type : 'value',
                    boundaryGap: [0, 0.01]
                },
                yAxis : {
                    type : 'category',
                    data : areaYData.reverse(),
                    axisLabel : {
                        interval : 0,
                        fontSize : 8
                    }
                },
                series : {
                    type:'bar',
                    barWidth:15,
                    data:areaSeriesData.reverse(),
                    label:{
                        normal:{
                            show:true,
                            position:'right',
                            formatter: '{c}件'
                        }
                    }
                }
           };
           areaRankChart.resize();
           areaRankChart.setOption(option,true);
           //areaRankChart.on('click', areaClick);
       });
    }
    
    //客户
    function customer_rank(cInvCode, cInvName){
        $.ajax({
            url:"${CPATH}/biSales/customerTypeByProduct",
            type:"post",
            data:{"provName": provName, "cityName": cityName, countryName: '', startDate: startDate, endDate: endDate, cInvCode: cInvCode, dataArea: dataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){
            Utils.close();

            var crSeriesData = [];

            for(var i = 0; i < data.length; i++){
                crSeriesData.push({
                    name: data[i].customerTypeName + '(' + data[i].totalAmount + '万元)',
                    value: data[i].totalAmount
                });
            }
            var crTitle = cInvName +'客户分布';
            //if((provName + cityName).trim() != '' ){
            //    crTitle = provName + cityName + crTitle;
            //} else {
            //    crTitle = '' + crTitle;
            //}
            var $p = $("#p_customer_rank");
            $p.empty();
            $p.text(crTitle);

            var customer_rank = document.getElementById('customer_rank');
            var $customer_rank = $(customer_rank);

            var customerRankChart = echarts.init(customer_rank);
            var crOption = {
                color: ['#4ac7f5', '#f36f8a', '#fd9173', '#AF89D6', '#5f71d2', '#a6c84c', '#ffa022', '#46bee9'],
                series: [
                    {
                        name:crTitle,
                        type:'pie',
                        radius: ['30%', '50%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: false,
                        label: {
                            normal: {
                                textStyle: {
                                    fontSize: 9
                                }
                            }
                        },
                        data:crSeriesData
                    }
                ]
            };
            customerRankChart.resize();
            customerRankChart.setOption(crOption,true);
            //customerRankChart.on('click', customerClick);
        });
    }

    function initData() {
        product();
    }
</#macro>
<@layout>
<section>
    <div class="bi-body">
        <div class="row" >
            <div class="col-md-9">
                <#include "_inc/_pc_search_box.html"/>
                <div class="row">
                    <div class="col-md-3">
                         <p class="title" id="p_customer_rank"></p>
                        <div id="customer_rank"></div>
                    </div>
                    <div class="col-md-3">
                        <p class="title" id="p_area_rank"></p>
                        <div id="area_rank"></div>
                    </div>
                    <div class="col-md-6">

                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <p class="title" id="p_product_rank"></p>
                <div id="div_product_rank">
                    <table id="product_rank" class="table table-striped table-bordered">
                        <thead>
                          <tr>
                            <tr><th>产品</th><th width="20%">数量(件)</th><th width="25%">金额(万元)</th></tr>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
</@layout>
