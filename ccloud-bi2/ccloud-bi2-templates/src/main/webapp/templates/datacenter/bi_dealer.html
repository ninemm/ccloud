<#include "_inc/_bi_layout.html"/>
<#macro script_import>
</#macro>
<#macro css_import>
</#macro>
<#macro css>
    .weui-cells {
        margin-top: 0;
        background: inherit;
        font-size: 0.6rem;
    }
    table {
        background: #fff;
        margin-bottom: 0!important;
    }
    table a {
        text-decoration: underline;
    }
    th {
        vertical-align: middle!important;
        text-align: center!important;
    }
    td {
        vertical-align: middle!important;
    }
    tr {
        line-height: 1.5rem;
        height: 1.5rem;
    }
    .wy-header {
        background: #f2f2f2;
        margin-top: 2.4rem;
    }
    #orderNum{
        width: 100%;
        height:14rem;
    }
</#macro>
<#macro script>
    $(function() {
        dealer();
        
        $('#goback').on('click', function() {
            historyUtils.back();
        });
    });

    var dealerCode = '';
    var dealerName = '';
    var selectDataArea = '';

    function setDateType(type){
        setFilter(type);
        dealer();
    }
    $(document).on("click", ".confirm-search-btn", function () { //点击确定按钮
        setFilter(4);
        dealer();
        closeCombinSearch();
    })
    
    //经销商选择
    function setDealer(Code, Name, Area){
        dealerCode = Code;
        dealerName = Name;
        selectDataArea = Area;
        dealer_detail(dealerCode, dealerName, selectDataArea);
    }
    
    //经销商
    function dealer(){
        Utils.loading();
        $.ajax({
            url:"${CPATH}/biSales/dealer",
            type:"post",
            data:{"provName": provName, "cityName": cityName, countryName: '', startDate: startDate, endDate: endDate, dataArea: dataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){

            var drTitle = '经销商销售排行';
            if((provName + cityName).trim() != '' ){
                drTitle = provName + cityName + drTitle;
            } else {
                drTitle = '全国' + drTitle;
            }
            var $p = $("#p_dealer_rank");
            $p.empty();
            $p.text(drTitle);

            var $tbody = $("#dealer_rank tbody");
            $tbody.empty();
            $tbody.append("<tr><th>经销商</th><th>订单数(笔)</th><th>金额(万元)</th></tr>");
            for(var i = 0; i < data.length; i++){
                var fun = "setDealer('" + data[i].dealerCode + "'" + "," + "'" + data[i].dealerName + "'," + "'" + data[i].data_area + "')";
                $tbody.append("<tr onclick=" + fun +"><td><a href=\"javascript:void();\">" + data[i].dealerName + "</a></td><td class='t-r'>" + data[i].totalCount + "</td><td class='t-r'>" + data[i].totalAmount + "</td></tr>");
            }
            
            var dataDealerCode = (data[0] != undefined ? data[0].dealerCode : '');
            var dataDealerName = (data[0] != undefined ? data[0].dealerName : '');
            var dataDataArea = (data[0] != undefined ? data[0].data_area : '');

            //调用其他纬度
            dealer_detail(dataDealerCode, dataDealerName, dataDataArea);
       });
    }
    
    //订单数和产品
    function dealer_detail(dealerCode, dealerName, selectDataArea){
      Utils.loading();
      $.ajax({
            url:"${CPATH}/biSales/dealerDetail",
            type:"post",
            data:{provName: provName, cityName: cityName, countryName: '', startDate: startDate, endDate: endDate, dataArea: selectDataArea, brandId: brandId},
            dataType:"json"
        }).done(function(data){

            //订单数量
            var oTitle = dealerName + '每日订单数量(单位/笔)';
            orderNum(data.orderNumList, oTitle);
            
            var prTitle = dealerName + '产品销售排行';
            var $p = $("#p_product_rank");
            $p.empty();
            $p.text(prTitle);
            
            //产品
            product_rank(data.productList);
       });
    }
    
    //产品
    function product_rank(productList){
        Utils.close();

        var $tbody = $("#product_rank tbody");
        $tbody.empty();
        $tbody.append("<tr><th>产品</th><th>数量(件)</th><th>金额(万元)</th></tr>");
        for(var i = 0; i < productList.length; i++){
            $tbody.append("<tr><td>" + productList[i].cInvName + "</td><td class='t-r'>" + productList[i].totalNum + "</td><td class='t-r'>" + productList[i].totalAmount + "</td></tr>");
        }

        var $tr = $("#product_rank tbody tr:gt(5)");
        if($tr.length > 0){
            $tr.hide();
            $(".trOpen").show();
            $(".trClose").hide();
            $("#product_rank tfoot").show();
        }else {
            $("#product_rank tfoot").hide();
        }
      
    }

    //订单数量
    function orderNum(data, oTitle){
    
        var xData = [];
        var seriesData = [];
        
        for(var i = 0; i < data.length; i++){
            xData.push(data[i].date) ;
            seriesData.push(data[i].orderNum);
        }
        
        var orderNum = document.getElementById('orderNum');
        
        var orderNumChart = echarts.init(orderNum);
        var option = {
            title: {
                left: 'center',
                top: 'top',
                text: oTitle,
                textStyle: {
                    fontWeight: 'normal',
                    color: '#ea6f5a',
                    fontSize: '.7rem'
                }
            },
            tooltip : {
            },
            grid: {
                left: '13%',
                right: '8%',
                top: '25%'
            },
            xAxis: {
                data: xData
            },
            yAxis: {},
            series: [{
                name: oTitle,
                type: 'line',
                itemStyle: {
                normal: {color: '#a6c84c'}
            },
            lineStyle: {
                normal: {color: '#a6c84c'}
            },
            markPoint: {
                label: {
                    normal: {
                        textStyle: {
                            color: '#000',
                            }
                        }
                    },
                    data : [
                        {type: 'max', name: '最大值'},
                        {type: 'min', name: '最小值'}
                    ]
                 },
                data:seriesData
                }]
            };
            orderNumChart.resize();
            orderNumChart.setOption(option, true);
    }


</#macro>
<@layout>
<section>
    <div class="bi-body">
        <#include "_inc/_bi_search_box.html"/>
        <header class="wy-header">
            <div id="goback" class="wy-header-icon-back"><span></span></div>
            <div id="p_dealer_rank" class="wy-header-title"></div>
        </header>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell" style="padding: 0">
                <table class="table table-striped table-bordered" id="dealer_rank">
                    <tbody>
                        <tr>
                            <th>
                                经销商
                            </th>
                            <th>
                                订单数(单)
                            </th>
                            <th>
                                金额(万元)
                            </th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
<!--        <p class="title" id="p_seller_rank"></p>
        <div id="seller_rank">
        </div>-->
        <div class="divide-line"></div>
        <div id="orderNum"></div>
        <div class="divide-line"></div>
        <p class="title" id="p_product_rank"></p>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell" style="padding: 0">
                <table class="table table-striped table-bordered" id="product_rank">
                    <tbody>
                        <tr>
                            <th>
                                经销商
                            </th>
                            <th>
                                数量(件)
                            </th>
                            <th>
                                金额(万元)
                            </th>
                        </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th colspan="3">
                          <span class="fr txt-color-red trOpen"><i class="icon-arrow-down2"></i> 查看更多</span>
                          <span class="fr txt-color-red trClose" style="display: none"><i class="icon-arrow-up2"></i> 收起</span>
                        </th>
                      </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</section>
<#include "_inc/_combin_filter.html"/>
<#include "_inc/_nav_box.html"/>
</@layout>