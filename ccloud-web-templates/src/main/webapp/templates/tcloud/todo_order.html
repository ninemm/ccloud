<#include "_inc/_layout.html"/>

<#macro css> 
	main{
		top: 0!important;
	}
</#macro>
<#macro script_import>
	<script src="${CPATH}/static/layer_mobile/layer.js"></script>
</#macro>
<#macro script>
	$(function() {

	});

	function refuse(id, taskId, pass) {
      layer.open({
        type: 1,
        title: ['订单审核',
          'border-bottom: 1px solid #eee;height:2rem;line-height:2rem'
        ],
        content: '<p class="t-c">是否确认拒绝该订单？</p>' +
          '<p class="gray">可选择拒绝原因</p>' +
          '<div class="refuse-radio"><label><input type="radio" name="refuseReson" id="" value="库存无足够货物">库存无足够货物</label></div>' +
          '<div class="refuse-radio"><label><input type="radio" name="refuseReson" id="" value="产品价格滞后">产品价格滞后</label></div>' +
          '<div class="refuse-radio"><label><input type="radio" name="refuseReson" id="" value="该商家已被停用">该商家已被停用</label></div>'+
          '<div><textarea id="comment" placeholder="补充说明，可选填"></textarea></div>',
        anim: 'scale',
        className: 'audit',
        btn: ['确认拒绝','取消拒绝'],
        yes: function() {
          var refuseReson = $("input[name='refuseReson']:checked").val();
          var comment = $("#comment").val();
          if (refuseReson == undefined && comment == ""){
            toastr.warning('请选择一个理由');
            return;
          }
          doReject(id, taskId, pass, refuseReson, comment);
        },
        no:function() {

        }
      });
	}

	function doReject(id, taskId, pass, refuseReson, comment){

		layer.open({
			type: 2,
			content: '保存中...'
		});
		var params = {
			"id": id,
			"taskId": taskId,
			"comment": comment,
			"refuseReson" : refuseReson,
			'pass' : pass
		}


		Utils.ajax('${CPATH}/order/complete', params, 
			function(res){
				if (res.errorCode == 0) {
					location.href = '${CPATH}/todo/order'
				} else {
					$.alert(res.message);
				}
				layer.closeAll();
			}
		)
	};

	function doSubmit(url) {
		layer.open({
			type: 2,
			content: '保存中...'
		});
		$.get(url ,
			function(res){
				if (res.errorCode == 0) {
					location.href = '${CPATH}/todo/order'
				} else {
					$.alert(res.message);
				}
				layer.closeAll();
			}
		)
	};

</#macro> 

<@layout>
<div class="weui-content">
	<div id="customer-audit">
		<main>
			<#if (todoList?? && todoList?size>0) >
				<#list todoList as order>
					<div class="weui-panel weui-panel_access">
						<div class="weui-cell weui-cell_access">
							<a href="${CPATH}/order/orderReview?orderId=${order.id!}&taskId=${order.taskId!}&assignee=${order.assignee!}"> 
							<div class="weui-cell__bd ft16">
								<#if order.receive_type == 0>
									<span class="tag">账期</span>
								</#if>
								<p class="customer_name">${(order.customer_name)!}</p>
								<div class="ft14 gray">
									<p>订单号：${(order.order_sn)!}</p>
									<p>
										联系人：<span>${(order.ccontact)!} / ${(order.cmobile)!}</span>
										<span class="fr">${(order.customerTypeName)!}</span>
									</p>
									<p>
										金额：￥<span>${(order.total_amount)!}</span>
										<span class="fr" id="date">时间：${(order.create_date)!}</span>
									</p>
								</div>
							</div>
							</a>
						</div>
						<div class="weui-cell weui-cell_access">
							<a class="weui-cell__bd" style="color: gray" href="${CPATH}/order/orderReview?orderId=${order.id!}&taskId=${order.taskId!}&assignee=${order.assignee!}">订单详情</a>
							<span class="weui-cell__ft"></span>
						</div>
						<#if order.assignee?contains(username)>
							<div class="weui-cell weui-cell_access">
								<div class="width-100 ft14 operate-btn">
										<div class="button white-button fl" onclick="refuse('${(order.id)!}', '${(order.taskId)!}', 0)">拒绝</div>
										<div class="button red-button fr" onclick="doSubmit('${CPATH}/order/complete?id=${(order.id)!}&taskId=${(order.taskId)!}&pass=1')">同意</div>
								</div>
							</div>
						</#if>
					</div>
				</#list>
			<#else>
				<div class="weui-loadmore weui-loadmore_line">
					<span class="weui-loadmore__tips">暂无数据</span>
				</div>
			</#if>
		</main>
		<#include "_inc/_goback.html" />
	</div>
</div>
</@layout>