<#include "_inc/_layout.html"/>
<#macro script_import>
	<script src="${CPATH}/static/ccloud/admin/js/common.js"></script>
</#macro>
<#macro title>出库单</#macro>
<#macro css>
	#orderSn {
		color: #999;
	}
	#my-order {
		top: 44px;
		position: absolute;
		bottom: 0;
	}
	.list-layer {
		position: absolute;
		top:0;
		left:0;
		right:4rem;
		height:3rem;
		background: rgba(0,0,0,0);
	}
	.t-c{
		padding: 50px 0;
		font-size: 0.8rem;
	}
</#macro>
<#macro script>
    $(function () {
  		<#if history??>
  			var statusName = getItemBykey("statusName");
  			var customerTypeName = getItemBykey("customerTypeName");
  			var bizUserName = getItemBykey("bizUserName");
  			var dayName = getItemBykey("dayName");
  			var keywordName = getItemBykey("keyword");
  			$("#status").val(statusName);
  			$("#customerTypeId").val(customerTypeName);
  			$("#bizUserId").val(bizUserName);
  			$("#date").val(dayName);
  			$("#searchInput").val(keywordName);
  		<#else>
  			clearStorage();
			setItemBykey("startDate", $.today());
			setItemBykey("endDate", $.today() + ' 23:59:59');    			
		</#if>
		
		$(document).on("submit", ".weui-search-bar__form", function() {
			setItemBykey("keyword", $("#searchInput").val());
			combo();
			return false;
		}).on("click", "#searchCancel", function() {
			setItemBykey("keyword", $("#searchInput").val());
			combo();
		}).on("change", "#status", function() {
			setItemBykey("status", $("#status").data('values'));
			setItemBykey("statusName", $("#status").val());		
			combo();
		}).on("change", "#customerTypeId", function() {
			setItemBykey("customerTypeId", $("#customerTypeId").data('values'));
			setItemBykey("customerTypeName", $("#customerTypeId").val());		
			combo();
		}).on("change", "#bizUserId", function() {
			setItemBykey("bizUserId", $("#bizUserId").data('values'));
			setItemBykey("bizUserName", $("#bizUserId").val());		
			combo();
		}).on("change", "#date", function() {
			getDateOrder();
		}).off("click", "#combin-filter .confirm-search-btn")
		.on("click", "#combin-filter .confirm-search-btn", function() {
			startDate = $('#start-date').val();
			endDate = $('#end-date').val() + ' 23:59:59';
			setItemBykey("startDate", startDate);
			setItemBykey("endDate", endDate);				
			combo();
		}).on('click', '.list-layer', function () {
			var $this = $(this);
			$this.parent().find('.customer_name').find('.show-more-btn').trigger('click');
		}).on('click', '.show-more-btn', function () {
			showOutstockProductDetail(this);
			var $this = $(this);
			var $detail = $this.parent().next();
			if ($detail.is(':visible')) {
				$detail.slideUp('fast');
				$this.html('显示详情 <i class="icon-angle-down"></i>');
			} else {
				$detail.slideDown('fast');
				$this.html('隐藏详情 <i class="icon-angle-up"></i>');
			}
		}).on('click', '#batchOutStock', function () {
			var $outstock = $(".outstock");
			var outstockIds = new Array();
			//var outstockSn = '';
			$.each($outstock, function(index, el){
				$el = $(el);
				if($el.find("#oStatus").val() == 0){
					outstockIds.push($el.find("#oId").val());
					//outstockSn += '<p class="t-c">' + $el.find("#orderSn").text() + '</p>';
				}
			});

			if(outstockIds.length == 0){
				$.toptip('暂无可以出库的订单', 'warning');
				return;
			}

			layer.open({
				type: 1,
				title: ['批量出库','border-bottom: 1px solid #eee;height:2rem;line-height:2rem;margin-top:2.5rem'],
				content: '<img src="${CTPATH}/images/image_orderpopups.png">' +
				'<p class="t-c">共有'+ outstockIds.length +'单批量出库</p>',
				anim: 'scale',
				className: 'audit',
				btn: ['确认','取消'],
				yes: function() {
					batchOutStock(outstockIds);
				},
				no:function() {
				
				}
			});
		});

		$("#start-date").calendar({
			maxDate: function() {
				return $('#end-date').val()
			}
		});
		$("#start-date").val($.today());
		$("#end-date").calendar({
			minDate: function() {
				var date = new Date($('#start-date').val().replace(/-/g,"/"));
				date.setDate(date.getDate() - 1);
				return date.Format("yyyy-MM-dd")
			}
 		});
        $("#end-date").val($.today());

	    combo();

		$("#status").select({
	        title: "订单状态",
	        items: [{
		       title: "全部", value: ""
		       },{
		       title: "待出库", value: "0"
		       },{
		       title: "全部出库", value: "1000"
		       },{
		       title: "部分出库", value: "2000"
		    }]
		});
	
		$("#customerTypeId").select({
		  title: "选择客户类型",
		  items: ${customerTypes!}
		});
		$("#bizUserId").select({
		  title: "选择业务员",
		  items: ${bizUsers!}
		});
		$('#date').select({
			title: '选择时间',
			items: [{
				title: '今天', value: '0'
				},{title: "最近3天", value: "1"
				},{title: "最近7天", value: "2"
				},{title: "最近30天", value: "3"
			}]
		})
	});
  
	var newHtml = $(".weui-panel").eq(0).html();
	var $panel = $('.weui-panel');
	var $main = $("#main");
	var $loading = $("#loading");
	var $noMore = $("#noMore");
	
	var loading = false;
	var keyword = '';
	var startDate = $.today();
	var endDate = $.today() + ' 23:59:59';
	var page = 1;
	var size = 10;

	function loadOrderData() {
		
		$loading.show();
		$noMore.hide();
		layer.open({type: 2,content: '加载中'});
		var params = getParam();
		Utils.ajax('${CPATH}/outstock/outstockList', params,
			function(data) {
				$loading.hide();
				layer.closeAll();
				if(data.outstockList.length == 0) {
					if($('.weui-panel').length == 0) $noMore.show();
					loading = true;
					return;
				}

				$.each(data.outstockList, function(index, el) {
	
					$main.append("<div class='weui-panel weui-panel_access outstock'>" + newHtml + "</section>");
					var $newOrder = $main.find(".weui-panel:last");
					
					if(el.receive_type == 1) {
						$newOrder.find("#receiveType").remove();
					}
					
					$newOrder.find("#outstockId").attr('href', '${CPATH}/outstock/outstockDetail?outstockId=' + el.id);
					$newOrder.find("#orderSn").text(el.outstock_sn);
					$newOrder.find("#status").text(getStatus(el.status));
					$newOrder.find("#customerName").text(el.customer_name);
					$newOrder.find("#oId").val(el.id);
					$newOrder.find("#oStatus").val(el.status);
					$newOrder.find(".appendOutstockProductDetail").attr('id',"p"+el.id);
					$newOrder.find("#contact").text(el.ccontact + '/' + el.cmobile);
					$newOrder.find("#customerType").text(el.customerTypeName);
					if(el.status == 0) {
						$newOrder.find("#allOut").on('click', function() {
							$.confirm({
								title: "出库单出库",
								text: '是否确认出库？',
								onOK: function () {
									Utils.openLoadingWin('出库中...');
									$.get('${CPATH}/outstock/outStock?outstockId=' + el.id,
										function(result) {
											if (result.errorCode > 0) {
												$.toptip(result.message, 'error');
											} else {
												$.toptip(result.message, 'success');
												combo();
											}
											Utils.closeLoadingWin();
										}
									);
								}
							});
						});
					} else {
						$newOrder.find("#allOut").remove();
					}

					$newOrder.find("#status").on('click', function(){ 
 						 window.location.href = "${CPATH}/order/operateHistory?id=" + el.order_id + "&proc_inst_id=" + el.proc_inst_id;
 						 event.stopPropagation();
					});
	
					$newOrder.find("#amount").text(formatNumber(el.total_amount));
					$newOrder.find("#date").text('时间：' + el.create_date);
					$noMore.hide();
				});
				page++;
				loading = false;
			}
		);
	}
	
	function getParam () {
		<#if !history??>
		var params = {
			"page": page,
			"size": size,
			"keyword": $("#searchInput").val(),
			"status": $("#status").data('values'),
			"customerTypeId": $("#customerTypeId").data('values'),
			"bizUserId": $("#bizUserId").data('values'),
			"startDate": startDate,
			"endDate" : endDate
		}
		<#else>
		var keywordSession = getItemBykey("keyword");
		var statusSession = getItemBykey("status");
		var customerTypeIdSession = getItemBykey("customerTypeId");
		var startDateSession = getItemBykey("startDate");
		var endDateSession = getItemBykey("endDate");
		var bizUserSession = getItemBykey("bizUserId");
		var params = {
			"page": page,
			"size": size,
			"keyword": keywordSession,
			"status": statusSession,
			"customerTypeId": customerTypeIdSession,
			"bizUserId":bizUserSession,
			"startDate": startDateSession,
			"endDate" : endDateSession
		}		
		</#if>		
		return params;
	}	
	
	function getDateOrder(){
		var dateType = $("#date").data('values');
		var date = new Date();
		if(dateType == 0){
			startDate = $.today();
		}else if(dateType == 1){
			date.setDate(date.getDate() - 3);
			startDate = date.Format("yyyy-MM-dd");
		}else if(dateType == 2){
			date.setDate(date.getDate() - 7);
			startDate = date.Format("yyyy-MM-dd");
		}else if(dateType == 3){
			date.setDate(date.getDate() - 30);
			startDate = date.Format("yyyy-MM-dd");
		}

		endDate = $.today() + ' 23:59:59';
		setItemBykey("dayName", $("#date").val());
		setItemBykey("startDate", startDate);
		setItemBykey("endDate", endDate);		
		combo();
	}

	function getStatus(value) {
		if (value == 0) {
			return '待出库';
		} else if (value == 1000) {
			return '全部出库'
		} else if (value == 2000) {
			return '部分出库'
		}
		return value
	}
	
	
	//滑动方法
	$("main").infinite().on("infinite", function() {
		if(loading) {
			return;
		}
		loading = true;
		loadOrderData();
	});
	
	function combo() {
		$main.empty();
		loading = true;
		page = 1;
		loadOrderData();
	}
	
	function showOutstockProductDetail(outstockDetail){
	  var outstockId =  $(outstockDetail).next().val();
	  var productName = $("#o"+outstockId).text();
	  var str = "";
	  if(productName == ""){
	     $.ajax({
            type: "post",
            url: "${CPATH}/outstock/getOutstockProductDetail?outstockId="+outstockId,
            dataType: "json",
            success:function(data) {
            $.each(data.outstockDetail, function(idx, item) {
                var productName = "";
                if(item.is_composite == 1){
                    productName = "<span class='ctag'>组合</span>";
                    productName = productName + item.custom_name;                
                }else if (item.is_gift == 1) {
                    productName = "<span class='tag'>赠品</span>";
                    productName = productName + item.custom_name;
                } else {
                	productName = item.custom_name;
                }
                var bigCount = parseInt(item.product_count/item.convert_relate);//下单大单位数量
                var smallPrice = (item.product_amount/item.product_count).toFixed(2);//下单小价格
                var sPrice = (item.price/item.convert_relate).toFixed(2);//商品标准小价格
                var smallCount = (item.product_count %  item.convert_relate);//下单小单位数量
                
                str += "<div><p id='o"+ outstockId +"'>" +productName+ "</p>"+
                    "<div class='weui-flex'><div class='weui-flex__item flex-grow2'>"+
                    "<div class='fr width-60'>￥"+item.product_price+" "+
                    "<span class='gray'>("+ item.price +")</span>"+
                    "</div></div><div class='weui-flex__item t-r'>"+bigCount+" "+item.big_unit+" "+
                    "</div></div></div>"+
                    "<div class='weui-flex'><div class='weui-flex__item flex-grow2'>"+
                    "<div class='fr width-60'>￥"+smallPrice+" "+
                    "<span class='gray'>("+sPrice+")</span></div></div>"+
                    "<div class='weui-flex__item t-r'>"+smallCount+" " +item.small_unit+" "+
                    "</div></div>"; 
            });
            
            $("#p"+outstockId).append(str);
            }
        });
	  }  
	}

	function batchOutStock(outstockIds){
		Utils.openLoadingWin('出库中...');
		Utils.ajax('${CPATH}/outstock/batchOutStock', {'outstockIds': outstockIds},
			function(data) {
				if (data.errorCode > 0) {
					$.toptip(data.message, 'error');
				} else {
					$.toptip(data.message, 'success');
					combo();
				}
				Utils.closeLoadingWin();
			});
	}
	
</#macro>

<@layout>
<div class="weui-content">
	<header>
		<div class="weui-search-bar" id="SearchBar">
			<form class="weui-search-bar__form">
				<div class="weui-search-bar__box">
					<i class="weui-icon-search"></i>
					<input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索" required="">
					<a href="javascript:" class="weui-icon-clear" id="searchClear" ></a>
				</div>
				<label class="weui-search-bar__label" id="searchText">
					<i class="weui-icon-search"></i>
					<span>客户名或出库单号</span>
				</label>
			</form>
			<a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel" >取消</a>
		</div>
	</header>
	<article id="my-order" class="ft14">
	
		<header class="has-th-list weui-flex">
			<div class="head-search select-area weui-flex__item">
				<div class="weui-flex">
					<div class="weui-flex__item">
						<input type="text" id="status" class="weui-input" readonly placeholder="订单状态">
						<i class="icon-sort-desc"></i>
					</div>
					<div class="weui-flex__item">
						<input type="text" id="customerTypeId" placeholder="客户类型" class="weui-input" readonly>
						<i class="icon-sort-desc"></i>
					</div>
					<div class="weui-flex__item">
						<input type="text" id="bizUserId" placeholder="业务员" class="weui-input" readonly>
						<i class="icon-sort-desc"></i>
					</div>
					<div class="weui-flex__item">
						<input type="text" id="date" placeholder="今天" class="weui-input" readonly>
						<i class="icon-sort-desc"></i>
					</div>
				</div>
			</div>
			<div id="combin-filter-btn">
				<i class="icon-th-list"></i>
			</div>
		</header>
		<main>
			<div id="main">
				<div class="weui-panel weui-panel_access outstock" style="display: none">
					<div class="list-layer"></div>
					<div class="ft14 gray">
						<span class="tag" id="receiveType">账期</span>
						<span id="orderSn"></span>
						<span class="fr orange">
							&nbsp;<i class="icon-angle-right"></i>
						</span>
						<span class="fr orange" id="status"></span>
					</div>
					<div class="customer_name gray">
						<span id="customerName" class=""></span>
						<span class="fr show-more-btn" id="showOrderProductDetail">
							显示详情 <i class="icon-angle-down"></i>
						</span>
						<input type="hidden" id="oId"/>
						<input type="hidden" id="oStatus"/>
					</div>
					<div class="none">
						<a href="" id="outstockId">
						<div class="hr"></div>
							<div class="appendOutstockProductDetail">

							</div>
							<div class="hr"></div>							
							<div class="gray">
								<p>
									联系人：<span id="contact"></span>
									<span class="fr" id="customerType"></span>
								</p>
							</div>
							<div class="gray">
								<p>
									金额：￥<span id="amount"></span>
									<span class="fr" id="date"></span>
								</p>
							</div>
						</a>
						<div class="hr"></div>
						<div id="allOut" class="button red-button fr">全部出库</div>
<!--						<div id="partOut" class="button yellow-button fr m-r-5">部分出库</div>-->
					</div>
				</div>
			</div>
			<div class="weui-loadmore" id="loading" style="display: none;">
			  <i class="weui-loading"></i>
			  <span class="weui-loadmore__tips">正在加载</span>
			</div>
			<div class="weui-loadmore weui-loadmore_line" id="noMore" style="display: none;">
			  <span class="weui-loadmore__tips">暂无数据</span>
			</div>
		</main>
	</article>
</div>
<article id="combin-filter" >
	<div class="filter-item">
		<h4>日期区间</h4>
		<div class="relative weui-flex" id="getDate">
			<input type="text" id="start-date" class="weui-input weui-flex__item" readonly>
			<div style="width:1rem" class="t-c">—</div>
			<input type="text" id="end-date" class="weui-input weui-flex__item" readonly>
		</div>
	</div>
	<footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
		<button class="white-button-no-border  cancel-search-btn weui-flex__item border-top-1px">取消</button>
		<button class="red-button confirm-search-btn weui-flex__item">确定</button>
	</footer>
</article>
<div class="layer"></div>

<#include "_inc/_goback.html" />
<footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
	<button id="batchOutStock" class="white-button-no-border weui-flex__item border-top-1px">批量出库</button>
	<button class="red-button weui-flex__item goback">返回</button>
</footer>
</@layout>