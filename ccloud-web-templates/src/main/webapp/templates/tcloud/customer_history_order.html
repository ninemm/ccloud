<#include "_inc/_layout.html"/>
<#macro title>历史订单</#macro>
<#macro css>
    #history {
        font-size: .7rem;
        background: ##f3f5f7;
        height: inherit;
    }
    
    .t-c {
        background: #ea6f5a;
        font-size: .8rem;
        color: #fff;
    }
    
    #history header, #activity-list header {
	    height: 2rem;
	    line-height: 2rem;
	    margin: 0;
	    color: #fff;
    }

</#macro>
<#macro script>
    var pageNumber = 2;
    var pageSize = 10;
    var loading = false;

    var $endNode = null;
    var $loadmore = $(".weui-loadmore");

    var paramData = function() {
        return  {
            "customerId": "${(customerId)!}",
            "pageNumber": pageNumber,
            "pageSize": pageSize
        };
    }

    //滚动监听
    $(".infinite").infinite().on("infinite", function() {
        var self = this;
        $endNode = $(".weui-panel_access:last");
        $loadmore = $(self).find(".weui-loadmore");
        if ($loadmore) $loadmore.show();
        if (loading) return ;
        loading = true;

        $.ajax({
            type: "post",
            url: "${CPATH}/customer/refreshHistoryOrder",
            data: paramData(),
            dataType: "json",
            success:function(data) {
                if ($loadmore) $loadmore.show();
                if (data.totalPage >= pageNumber) {
                    $endNode.after(data.html);
                }
                if (data.totalPage == pageNumber) {
                    $(".infinite").destroyInfinite();
                    $loadmore.hide();
                }
                pageNumber++;
                loading = false;
            }
        });
    });

    function refresh() {
        pageNumber = 1;
        $.ajax({
            url: "${CPATH}/customer/refreshHistoryOrder",
            type:"post",
            data:paramData(),
            dataType:"json",
            success:function(data) {
                $loadmore = $(this).find(".weui-loadmore");
                $(".infinite").destroyInfinite();
                $loadmore.hide();

                if (data.totalPage > pageNumber) {
                    loading = false;
                    $(".infinite").infinite();
                    $(".weui-loadmore").removeAttr("style");
                }

                $(".infinite")[0].scrollTop = 0;
                $("#orderList").empty();
                $("#orderList").html(data.html);
                pageNumber = 2;
            }
        });
    }
    
    function orderAgain(id) {
		 window.location.href = "${CPATH}/order/getOldOrder?orderId=" + id;
    }
    function getback() {
    window.location.href = '${CPATH}/customer?history=' + 1;
    }
</#macro>
<@layout>
<div id="history" class="ft12 weui-content">
<div class="infinite">
    <header class="t-c">
        ${(customerName)!}
    </header>
    <main class="infinite" id="orderList">
        <#if orderList??>
            <#list orderList.list as order>
                    <div class="weui-panel weui-panel_access">
                        <a href="/order/orderDetail?orderId=${(order.id)!}">
                        <div class="ft14">
                            <#if order.receive_type = 0>
                                <span class="tag">${(order.receive_Name)!}</span>
                            </#if>
                            ${(order.order_sn)}
                            <span class="fr blue">${(order.statusName)!}</span>
                        </div>
                        <div class="gray">
                            <p>数量：${order.total_count?string("0.00")}件
                                <span class="fr">时间：${(order.create_date)!}</span>
                            </p>
                            <p>金额：${order.total_amount?string("0.00")}
                                <span class="fr">业务员：${(order.realname)!}</span>
                            </p>
                        </div>
                        </a>
                        <div class="hr"></div>
                        <div>
                            <#if order.status = 0><div class="button white-button fl">撤销</div></#if>
                            <div class="button red-button fr" onclick="orderAgain('${(order.id)!}')">再次购买</div>
                        </div>
                    </div>
            </#list>
        </#if>
        <#if orderList??>
        <#if orderList.totalRow = 0>
                <div class="weui-loadmore weui-loadmore_line">
                    <span class="weui-loadmore__tips">暂无数据</span>
                </div>
                <#elseif orderList.totalRow &gt; 10>
                    <div class="weui-loadmore">
                        <i class="weui-loading"></i>
                        <span class="weui-loadmore__tips">正在加载</span>
                    </div>
            </#if>
        </#if>
    </main>
</div>
    <footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
        <button class="white-button-no-border weui-flex__item _submit_btn border-top-1px return_index">首页</button>
        <button class="red-button weui-flex__item _submit_btn"onclick="getback()">返回</button>
    </footer>
</div>
</@layout>