<#include "_inc/_layout.html"/>
<#macro title>拜访列表</#macro>
<#macro css>
    .t-c {
    background: #ea6f5a;
    font-size: .8rem;
    color: #fff;
    }

    #visit-record header, #activity-list header {
    height: 2rem;
    line-height: 2rem;
    margin: 0;
    color: #fff;
    }
</#macro>
<#macro script>
    var pageNumber = 2;
    var pageSize = 10;
    var loading = false;

    var $endNode = null;
    var $loadmore = $(".weui-loadmore");

    var paramData = function() {
        return {
        "pageNumber": pageNumber,
        "pageSize": pageSize
        };
    }

    $(".infinite").infinite().on("infinite", function() {
        var self = this;
        $endNode = $(".weui-cell_access:last");
        $loadmore = $(self).find(".weui-loadmore");
        if ($loadmore) $loadmore.show();
        if (loading) return ;
        loading = true;

        $.ajax({
            type: "post",
            url: "${CPATH}/customerVisit/oneRefresh?id=${(id)!}&name=${(name)!}",
            data: paramData(),
            dataType: "json",
            success:function(data) {
                if ($loadmore) $loadmore.show();
                if (data.totalPage >= pageNumber) {
                    $endNode.after(data.html);
                }
                if (data.totalPage == pageNumber) {
                    $(".infinite").destroyInfinite();
                    $loadmore.hide();
                }
                pageNumber++;
                loading = false;
            }
        });
    });

    function refresh() {
        pageNumber = 1;
        $.ajax({
            url:"${CPATH}/customerVisit/oneRefresh",
            type:"post",
            data:paramData(),
            dataType:"json",
            success:function(data) {
                $(".weui-loadmore").hide();
                $(".infinite").destroyInfinite();

                if (data.totalPage > pageNumber) {
                    loading = false;
                    $(".infinite").infinite();
                }

                $(".infinite")[0].scrollTop = 0;
                $("#visitList").empty();
                if(data.html.length ==0) data.html = data.html +'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';
                $("#visitList").html(data.html);
                pageNumber = 2;
            }
        });
    }

</#macro>
<@layout>
<div id="visit-record">
    <div class="list-box"style="width: 100%">
            <header class="t-c">${(name)!}</header>
        <main id="visitList" class="infinite">
            <#if visitList??>
                <#list visitList.list as visit>
                    <a class="weui-cell weui-cell_access" href="${(CPATH)}/customerVisit/detail?id=${(visit.id)!}&one=1">
                        <div class="weui-cell__bd ft14">
                            <p>${(visit.customer_name)!}</p>
                            <p class="gray ft12">${(visit.contact)!}/${(visit.mobile)!}
                                <span class="fr">${(visit.create_date)!}</span>
                            </p>
                            <p>活动类型：
                                <span class="orange">${DICT_NAME(visit.question_type)}</span>
                                <span class="green fr">${DICT_NAME(visit.status)}</span>
                            </p>
                        </div>
                        <span class="weui-cell__ft"></span>
                    </a>
                </#list>
            </#if>
            <#if visitList??>
                <#if visitList.totalRow = 0>
                    <div class="weui-loadmore weui-loadmore_line">
                        <span class="weui-loadmore__tips">暂无数据</span>
                    </div>
                    <#elseif visitList.totalRow &gt; 10>
                        <div class="weui-loadmore">
                            <i class="weui-loading"></i>
                            <span class="weui-loadmore__tips">正在加载</span>
                        </div>
                </#if>
            </#if>
        </main>
    </div>
        <#include "_inc/_goback_bottom.html" />
    </body>
</@layout>