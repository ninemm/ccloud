<#include "_inc/_layout.html"/>
<#macro title>产品列表</#macro>
<#macro css>

</#macro>
<#macro script_import>
	<script type='text/javascript' src="${CTPATH}/js/shopping-cart.js"></script>
</#macro>  

<#macro script>
$(function() {
    $(document).on("touchstart", ".gift-open", function () {
        if ($(this).text() === "展开") {
	        $(this).text("收起");
	        $(this).parent().next().show();
        } else {
	        $(this).text("展开");
	        $(this).parent().next().hide();
        }
    }).on("touchstart", "#sidebar li", function () {
 
        $(this).addClass("active").siblings().removeClass("active");
        var index = $(this).index();
     	$('.type').eq(index).show().siblings('.type').hide();

    }).on("input", "#searchInput", function () {
    	keyword = $(this).val();
		initProduct();
		
    }).on("touchstart", "#searchCancel", function () {
    	keyword = $(this).val();
		initProduct();
		
    }).on("touchstart", "#shoppingCart", function () {
    	save()
    	
    }).on("touchend", ".operate:first-child", function () { //减少商品数量
      productChange($(this));
      
    }).on("touchend", ".operate:last-child", function () { //增加商品数量
      productChange($(this));
      
    }).on('touchend', '#confirm-input', function () {
      var val = parseFloat($currentInput.val());
      if(val < 0 || val == ""){
        $currentInput.val(0);
      }else{
        $currentInput.val(val);
      }
      productChange($currentInput);

    }).on("touchend", ".product-top .weui-cell__ft, #productName", function () {
		layer.open({
		  type: 1,
		  title: ['商品详情',
			'border-bottom: 1px solid #eee;height:2rem;line-height:2rem'
		  ],
		  content: '<img src="${CTPATH}/images/jp.jpg" />' +
			'<p>名称：35度中国劲酒</p>' +
			'<p>规格：125ml</p>' +
			'<p>描述：劲牌劲牌劲牌劲牌劲牌劲劲牌劲牌</p>',
		  anim: 'scale',
		  className: 'product-detail',
		  btn: '关闭'
		});
	  });
    
    initProduct();
});

var keyword = '';
var newHtml = $(".common").eq(0).html();
var $sidebar = $("#sidebar ul");
var $menuRight = $(".menu-right");
function initProduct(){
	$sidebar.empty();
	var typeId = '';
	Utils.ajax('${CPATH}/product/productList', {'keyword': keyword}, 
		function(data){
			$menuRight.empty();
			$.each(data.productList, function(index, el) {
				if(typeId != el.typeId) {
					if(typeId == '') {
						$sidebar.append("<li id='" + el.typeId + "' class='active'>" + el.typeName + " <span class='goods-num'>8</span> </li>");
						$menuRight.append("<div class='type' id='" + el.typeId + "' > </div>")
					} else {
						$sidebar.append("<li id='" + el.typeId + "'>" + el.typeName + " <span class='goods-num'>8</span> </li>");
						$menuRight.append("<div class='type' id='" + el.typeId + "' style='display:none'> </div>")
					}
					typeId = el.typeId;
				}

				var $type = $menuRight.find(".type:last");
				$type.append("<section class='product_detail weui-panel weui-panel_access common' id='" + el.sell_product_id + "'>" + newHtml + "</section>");
				var $newProductDetail = $type.find(".common:last");
				$newProductDetail.find("#productName").text(el.custom_name);
				$newProductDetail.find("#valueName").text(el.valueName);
				
				var bigPrice = el.price;
				var convert = el.convert_relate;
				var smallPrice = (bigPrice / convert).toFixed(2);

				$newProductDetail.find("#bigPriceSpan").text('￥' + bigPrice);
				$newProductDetail.find("#smallPriceSpan").text('￥' + smallPrice);
				$newProductDetail.find("#bigUnitSpan").text(' / '+ el.big_unit);
				$newProductDetail.find("#smallUnitSpan").text(' / ' + el.small_unit);
				$newProductDetail.find("#stock").text('库存：' + el.store_count + el.big_unit);

				$newProductDetail.find("#bigPrice").val(bigPrice);
				$newProductDetail.find("#smallPrice").val(smallPrice);
				$newProductDetail.find("#bigUnit").val(el.big_unit);
				$newProductDetail.find("#smallUnit").val(el.small_unit);
				$newProductDetail.find("#sellProductId").val(el.sell_product_id);
				$newProductDetail.find("#productId").val(el.product_id);
				$newProductDetail.find("#convert").val(el.convert_relate);
				
			});
			
		initComposition(data.compositionList);
		productNum();
		calTotal();
		}
	);
	
}

function productNum(){
	var productList = getItemBykey("productList") == undefined ? [] : getItemBykey("productList");
		$.each(productList, function(index, el){
			var $newProductDetail =$("#" + el.sellProductId);
			$newProductDetail.find("#bigNum").val(el.bigNum);
			$newProductDetail.find("#smallNum").val(el.smallNum);
			$newProductDetail.find("#isGift").val(el.isGift);
		});
}

var compositionHtml = $(".composition").eq(0).html();
function initComposition(data){
	if(data.length > 0) {
		$sidebar.append("<li id='composition'> 组合商品 <span class='goods-num'>8</span> </li>");
		$menuRight.append("<div class='type' id='composition' style='display:none'> </div>");
	}
	
	var parentId = '';
	$.each(data, function(index, el) {
		if(parentId != el.parent_id) {
			parentId = el.parent_id;

			var $type = $menuRight.find(".type:last");
			$type.append("<section class='product_detail weui-panel weui-panel_access composition' id='" + el.id  + "' >" + compositionHtml + "</section>");
			var $newProductDetail = $type.find(".composition:last");
			$newProductDetail.find("#compositionName").text(el.name);
			
			$newProductDetail.find("#compositionPriceSpan").text('￥' + el.price);

			$newProductDetail.find("#compositionPrice").val(el.price);
			$newProductDetail.find("#compositionId").val(el.id);
			
			$newProductDetail.find("#compositionValueName").text(el.product_sp);
			$newProductDetail.find("#subProduct").text(el.sub_product_name + el.sub_product_sp + ' x ' + el.sub_product_count + '件')
		}else{
			$newProductDetail.find("#sub").append("<a class='fr gift-open' >展开</a>");
			$newProductDetail.find("#subsubProduct").append("el.sub_product_name + el.sub_product_sp + ' x ' + el.sub_product_count + '件' </br>");
		}

	});
	compositionNum();
}

function compositionNum(){
	var compositionList = getItemBykey("compositionList") == undefined ? [] : getItemBykey("compositionList");
		$.each(compositionList, function(index, el){
			var $newProductDetail =$("#" + el.compositionId);
			$newProductDetail.find("#compositionNum").val(el.compositionNum);
		});
}

function calTotal() {
 	var types = $(".type");
  
	$.each(types, function(typeIndex, typeEl) {
		var total = 0;
		var $typeEl = $(typeEl);
		var id = $typeEl.attr('id');
		var products = $typeEl.find('.product_detail')
		$.each(products, function(index, el) {
			var $el = $(el);
			if(id == 'composition'){
				total += Number($el.find("#compositionNum").val());
			}else{
				total += Number($el.find("#bigNum").val()) + Number($el.find("#smallNum").val());
			}
		});

		var $total = $sidebar.find("#" + id + " .goods-num");
		if (total > 0) {
		    $total.show().text(total);
		} else {
		    $total.hide().text(total);
		}
	});
}

function productChange(obj){
      var $el = obj.parents(".common");
      if($el.length > 0){
      	var product = getProduct($el);
      	cart.changeProduct(product);
      }else{
        var $co = obj.parents(".composition");
        if($co.length > 0){
          var composition = getComposition($co);
          cart.changeComposition(composition);
        }
      }
      calTotal();
}

function getProduct($el){
	return product = {
		productName : $el.find("#productName").text(),
		valueName : $el.find("#valueName").text(),
		
		bigPriceSpan : $el.find("#bigPriceSpan").text(),
		smallPriceSpan : $el.find("#smallPriceSpan").text(),
		bigUnitSpan : $el.find("#bigUnitSpan").text(),
		smallUnitSpan : $el.find("#smallUnitSpan").text(),
		stock : $el.find("#stock").text(),
		
		bigPrice : $el.find("#bigPrice").val(),
		smallPrice : $el.find("#smallPrice").val(),
		bigUnit : $el.find("#bigUnit").val(),
		smallUnit : $el.find("#smallUnit").val(),
		sellProductId : $el.find("#sellProductId").val(),
		productId : $el.find("#productId").val(),
		convert : $el.find("#convert").val(),

		bigNum : $el.find("#bigNum").val(),
		smallNum : $el.find("#smallNum").val(),
		isGift : $el.find("#isGift").val(),
		
		subProduct : [{
			productName : "",
			valueName : "",
					
			bigPriceSpan : "",
			smallPriceSpan : "",
			bigUnitSpan : "",
			smallUnitSpan : "",
			stock : "",
			
			bigPrice : "",
			smallPrice : "",
			bigUnit : "",
			smallUnit : "",
			sellProductId : "",
			productId : "",
			convert : "",
	
			bigNum : "",
			smallNum : "",
			isGift : 1
		}]
	}
}

function getComposition($el){
	return composition = {
		compositionName : $el.find("#compositionName").text(),
		
		compositionPriceSpan : $el.find("#compositionPriceSpan").text(),
		stock : $el.find("#stock").text(),
		
		compositionPrice : $el.find("#compositionPrice").val(),
		compositionId : $el.find("#compositionId").val(),

		compositionNum : $el.find("#compositionNum").val(),
		
		compositionValueName : $el.find("#compositionValueName").text()
	}
}


function save(){	

	var productList = getItemBykey("productList") == undefined ? [] : getItemBykey("productList");
	var compositionList = getItemBykey("compositionList") == undefined ? [] : getItemBykey("compositionList");
	
	if(productList.length == 0 && compositionList.length == 0) {
		toastr.warning("你还没有选择商品!"); 
		return;
	}
	window.location.href = '${CPATH}/product/shoppingCart';
}


</#macro>

<@layout>
<div class="weui-content">
	<div id="product">
		<header>
			<div class="weui-search-bar" id="searchBar">
				<form class="weui-search-bar__form">
					<div class="weui-search-bar__box">
						<i class="weui-icon-search"></i> <input type="search"
							class="weui-search-bar__input" id="searchInput" placeholder="搜索"
							required=""> <a href="javascript:"
							class="weui-icon-clear" id="searchClear"></a>
					</div>
					<label class="weui-search-bar__label" id="searchText"> <i
						class="weui-icon-search"></i> <span>请输入商品名称</span>
					</label>
				</form>
				<a href="javascript:" class="weui-search-bar__cancel-btn"
					id="searchCancel">取消</a>
			</div>
		</header>
		<aside>
			<div id="sidebar" class="menu-left">
				<ul>

				</ul>
			</div>
		</aside>
		
		<article class="menu-right">
			<div class="" style="display: none">
				<section class="product_detail weui-panel weui-panel_access common" >
					<div>
						<input type="hidden" id="sellProductId" value="">
						<input type="hidden" id="productId" value="">
						<input type="hidden" id="convert" value="">
						<input type="hidden" id="bigPrice" value="">
						<input type="hidden" id="smallPrice" value="">
						<input type="hidden" id="bigUnit" value="">
						<input type="hidden" id="smallUnit" value="">
						<input type="hidden" id="isGift" value="0">
						<div class="product-top">
							<img src="${CTPATH}/images/jp.jpg" style="width:2rem;">
							<div class="weui-cell_access product-top-right">
								<div class="product_name" id="productName">
									35度中国劲酒
								</div>
								<div class="product_unit">
									规格： <span id="valueName">125ml</span> 
								</div>
								<span class="weui-cell__ft"></span>
							</div>
						</div>
						<div class="product_bUnit">
							<span class="price" id="bigPriceSpan">￥210</span> <span class="unit" id="bigUnitSpan">&nbsp;/&nbsp;件</span>
							<div class="spinner">
								<div class="operate fl">
									<i class="icon-minus2"></i>
								</div>
								<input type="number" min="0" value="0" class="fl" id="bigNum">
								<div class="operate fl">
									<i class="icon-plus2"></i>
								</div>
							</div>
						</div>
						<div class="product_mUnit">
							<span class="price" id="smallPriceSpan">￥12</span> <span class="unit" id="smallUnitSpan">&nbsp;/&nbsp;瓶</span>
							<div class="spinner">
								<div class="operate fl">
									<i class="icon-minus2"></i>
								</div>
								<input type="number" min="0" value="0" class="fl" id="smallNum">
								<div class="operate fl">
									<i class="icon-plus2"></i>
								</div>
							</div>
						</div>
						<div id="stock">库存：1000件</div>
					</div>
				</section>
			</div>
			<div class="" style="display: none">
				<section class="product_detail weui-panel weui-panel_access composition" >
					<div>
						<input type="hidden" id="compositionId" value="">
						<input type="hidden" id="compositionPrice" value="">
						<div class="product-top">
							<img src="${CTPATH}/images/jp.jpg" alt="" style="width:2rem;">
							<div class="weui-cell_access product-top-right">
								<div class="product_name" id="compositionName">
									35度中国劲酒
								</div>
								<div class="product_unit">
									规格： <span id="compositionValueName">125ml</span> 
								</div>
								<span class="weui-cell__ft"></span>
							</div>
						</div>
						<div class="product_bUnit">
							<span class="price" id="compositionPriceSpan">￥210</span>
							<div class="spinner">
								<div class="operate fl">
									<i class="icon-minus2"></i>
								</div>
								<input type="number" min="0" value="0" class="fl" id="compositionNum">
								<div class="operate fl">
									<i class="icon-plus2"></i>
								</div>
							</div>
						</div>
						<div id="stock"></div>
					</div>
					<hr>
					<div id="gift">
						<p id="sub">赠品：<span id="subProduct">参茸劲酒_250ml_1*6 x 1 件</span>
						</p>
						<p class="t-r width-50 none" id="subsubProduct">
						</p>
					</div>
				</section>
			</div>
		</article>
		<a class="hidden-menu" id="shoppingCart" >
			<img src="${CTPATH}/images/shopping_cart.png" alt="">
		</a>
		<div class="layer"></div>
	</div>
</div>
<#include "_inc/_footer_nav.html" />
</@layout>