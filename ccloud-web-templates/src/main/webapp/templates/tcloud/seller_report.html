<#include "_inc/_layout.html"/>
<#macro title>直营商报表</#macro>
<#macro css>
    .report {
        font-size: 0.7rem;
	    position: absolute;
	    top: 0;
	    width: 100%;
	    bottom: 50px;
	    overflow: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .report .weui-panel__hd:after {
        left: 0;
        height: 0;
    }
    
    p { 
    	margin:0
		}
		
		.weui-tabbar {
			position: fixed;
		}

		.overview-title span {
			bottom: 0;
		}

		.weui-flex__item {
			overflow: auto;
			-webkit-overflow-scrolling: touch;
		}    
</#macro>

<#macro css_import>
<link rel="stylesheet" href="${CTPATH}/css/normalize.css">
<link rel="stylesheet" href="${CPATH}/static/bootstrap/css/bootstrap.min.css">
</#macro>
<#macro script_import>
<script type='text/javascript' src="${CTPATH}/js/echarts.min.js"></script>
</#macro>  
<#macro script>
  $(function () {
  
    $(".end-date").calendar();
    $(".begin-date").calendar();
   	$(".begin-date").val("${(startDate)!}");
   	$(".end-date").val("${(endDate)!}");
    $("#dayTag").val("${(dayTag)!}");
    
    <#if dayTag??>
	    <#if dayTag == 'today'>
	    	$(".dayTagText").text('今日')
	    <#elseif dayTag == 'yesterday'>
	    	$(".dayTagText").text('昨日')
	    <#elseif dayTag == 'week'>
	    	$(".dayTagText").text('本周')
	    <#elseif dayTag == 'lastweek'>
	    	$(".dayTagText").text('上周')
	    <#elseif dayTag == 'month'>
	    	$(".dayTagText").text('本月')
	    <#else>
	    	$(".dayTagText").text('上月')
	    </#if>
    </#if>
	var params = {
		"dayTag":  '${(dayTag)!}',
		"startDate": '${(startDate)!}',
		"endDate" : '${(endDate)!}',
		"sellerId": '${(sellerId)!}'
	}
	var params2 = {
		"dayTag":  '${(dayTag)!}',
		"startDate": '${(startDate)!}',
		"endDate" : '${(endDate)!}',
		"sellerId": '${(sellerId)!}',
		"isGift": 'true'
	}	  
 	orderAmount(params);
 	productCount(params);
 	userCount(params);
 	giftCount(params2);
  })
  
    function orderAmount(params) {
		Utils.ajax('${CPATH}/report/sellerOrderAmount', params, 
			function(data){
				$("#productCount").html(data.productCount+"件/");
				$("#totalCount").html(data.orderCount+"笔");
				$("#totalAmount").html(data.totalAmount+"元");
			}
		);    	
    }
    
    function productCount(params) {
		$.showLoading();
		Utils.ajax('${CPATH}/report/sellerProductCount', params, 
			function(data){
				$.hideLoading();
	            var length = data.length;
	            var $tbody = $("#productCount tbody");
	            $tbody.empty();
	            $tbody.append("<tr><th width='60%' style='text-align:center'>产品</th><th width='20%' style='padding: 8px 0;text-align:center'>数量(件)</th><th width='20%' style='padding: 8px 0;text-align:center'>金额(元)</th></tr>");
	            for(var i = 0; i < length; i++){
	                $tbody.append("<tr><td>" + data[i].custom_name + "</td><td class='t-r'>" + (data[i].productCount).toFixed(2) + "</td><td class='t-r'>" + formatNumber(data[i].totalAmount) + "</td></tr>");
	            }	
		    }   		
		);    	
    }    
    
    var salesObj = [];
    function userCount(params) {
    	var salesIndent = document.getElementById('userCount');
    	var salesIndentChart = echarts.init(salesIndent);
    	salesIndentChart.showLoading();
		Utils.ajax('${CPATH}/report/getUserRank', params, 
			function(data){
				var high = 40 * data.length + 100;
		        if (high < 300) {
		        	$("#userCount").height(300);
		        } else {
		        	$("#userCount").height(high);
		        }			
				salesIndentChart.hideLoading();
		        var yData = [];
		        var seriesData = [];
		        for (var i = 0; i < data.length; i++) {
		           yData.push(data[i].realname);
		           seriesData.push(data[i].productCount);
		           salesObj[data[i].realname] = data[i].id;
		       	}
		
				option = {
				    tooltip: {
				        trigger: 'axis',
				        axisPointer: {
				            type: 'shadow'
				        }
				    },
				    legend: {
				        data: yData.reverse(),
				        x: 'left'
				    },
				    grid: {
				        bottom: '3%',
				        containLabel: true
				    },
				    xAxis: {
				        type: 'value',
				        boundaryGap: [0, 0.01]
				    },
				    yAxis: {
				        type: 'category',
				        data: yData,
				        axisLabel:{
				            interval: 0,
				            formatter:function(params){
				            	if (!params) {
				            		params = "暂无数据";
				            	}
							    var newParamsName = "";// 最终拼接成的字符串
							    var paramsNameNumber = params.length;// 实际标签的个数
							    var provideNumber = 4;// 每行能显示的字的个数
							    var rowNumber = Math.ceil(paramsNameNumber / provideNumber);// 换行的话，需要显示几行，向上取整
							    /**
							     * 判断标签的个数是否大于规定的个数， 如果大于，则进行换行处理 如果不大于，即等于或小于，就返回原标签
							     */
							    // 条件等同于rowNumber>1
							    if (paramsNameNumber > provideNumber) {
							        /** 循环每一行,p表示行 */
							        for (var p = 0; p < rowNumber; p++) {
							            var tempStr = "";// 表示每一次截取的字符串
							            var start = p * provideNumber;// 开始截取的位置
							            var end = start + provideNumber;// 结束截取的位置
							            // 此处特殊处理最后一行的索引值
							            if (p == rowNumber - 1) {
							                // 最后一次不换行
							                tempStr = params.substring(start, paramsNameNumber);
							            } else {
							                // 每一次拼接字符串并换行
							                tempStr = params.substring(start, end) + "\n";
							            }
							            newParamsName += tempStr;// 最终拼成的字符串
							        }
							
							    } else {
							        // 将旧标签的值赋给新标签
							        newParamsName = params;
							    }
							    //将最终的字符串返回
							    return newParamsName				            
				            }
				        }				        
				    },
				    series: [
		            {
		                type:'bar',
		                barWidth: 15,
		                data:seriesData.reverse(),
		                label:{
		                    normal:{
		                        show:true,
		                        position:'right',
		                        formatter: '{c}件'
		                    }
		                }
		
		            }
				    ]
				};
		
		        salesIndentChart.resize();
		        salesIndentChart.setOption(option, true);
		        salesIndentChart.on('click',salesClick);
		    }    		
		);    	
    }
    
    function giftCount(params) {
    	var salesIndent = document.getElementById('giftCount');
    	var salesIndentChart = echarts.init(salesIndent);
    	salesIndentChart.showLoading();
		Utils.ajax('${CPATH}/report/getGiftCountByUser', params, 
			function(data){
				salesIndentChart.hideLoading();
		        var yData = [];
		        var seriesData = [];
		        for (var i = 0; i < data.length; i++) {
		           yData.push(data[i].realname);
		           seriesData.push(data[i].productCount);
		       	}
		
				option = {
				    tooltip: {
				        trigger: 'axis',
				        axisPointer: {
				            type: 'shadow'
				        }
				    },
				    legend: {
				        data: yData,
				        x: 'left'
				    },
				    grid: {
				        bottom: '3%',
				        containLabel: true
				    },
				    xAxis: {
				        type: 'value',
				        boundaryGap: [0, 0.01]
				    },
				    yAxis: {
				        type: 'category',
				        data: yData,
				        axisLabel:{
				            interval: 0,
				            formatter:function(params){
				            	if (!params) {
				            		params = "暂无数据";
				            	}
							    var newParamsName = "";// 最终拼接成的字符串
							    var paramsNameNumber = params.length;// 实际标签的个数
							    var provideNumber = 4;// 每行能显示的字的个数
							    var rowNumber = Math.ceil(paramsNameNumber / provideNumber);// 换行的话，需要显示几行，向上取整
							    /**
							     * 判断标签的个数是否大于规定的个数， 如果大于，则进行换行处理 如果不大于，即等于或小于，就返回原标签
							     */
							    // 条件等同于rowNumber>1
							    if (paramsNameNumber > provideNumber) {
							        /** 循环每一行,p表示行 */
							        for (var p = 0; p < rowNumber; p++) {
							            var tempStr = "";// 表示每一次截取的字符串
							            var start = p * provideNumber;// 开始截取的位置
							            var end = start + provideNumber;// 结束截取的位置
							            // 此处特殊处理最后一行的索引值
							            if (p == rowNumber - 1) {
							                // 最后一次不换行
							                tempStr = params.substring(start, paramsNameNumber);
							            } else {
							                // 每一次拼接字符串并换行
							                tempStr = params.substring(start, end) + "\n";
							            }
							            newParamsName += tempStr;// 最终拼成的字符串
							        }
							
							    } else {
							        // 将旧标签的值赋给新标签
							        newParamsName = params;
							    }
							    //将最终的字符串返回
							    return newParamsName				            
				            }
				        }				        
				    },
				    series: [
		            {
		                type:'bar',
		                barWidth: 15,
		                data:seriesData,
		                label:{
		                    normal:{
		                        show:true,
		                        position:'right',
		                        formatter: '{c}件'
		                    }
		                }
		
		            }
				    ]
				};
		
		        salesIndentChart.resize();
		        salesIndentChart.setOption(option, true);
		        salesIndentChart.on('click',salesClick);
		    }    		
		);    	
    }
    
	function salesClick(param) {
		var tag = $("#dayTag").val();
		var startDate = $("#startDay").val();
		var endDate = $("#endDay").val();		
	    if (typeof param.seriesIndex != 'undefined') {
	        window.location.href = "${(CPATH)}/report/userReportDetail?userId=" + salesObj[param.name] + "&userName=" + param.name + "&dayTag=" + tag + "&startDate=" + startDate + "&endDate=" + endDate; 
	    }
	}    
    
    function urlSelect(params, params2, type){
<!--     	if (type == 'order') { -->
<!-- 			orderAmount(params); -->
<!-- 		} else { -->
<!-- 			productCount(params); -->
<!-- 			giftCount(params2); -->
<!-- 		} -->
	 	orderAmount(params);
	 	productCount(params);
	 	userCount(params);
	 	giftCount(params2);
    }
    
    function startDaySelect(obj,type) {
		var params = {
    		"startDate": $(obj).val(),
			"endDate": $(obj).parent().find('#endDay').val() + ' 23:59:59',
			"sellerId": '${(sellerId)!}'
		}
		var params2 = {
    		"startDate": $(obj).val(),
			"endDate": $(obj).parent().find('#endDay').val() + ' 23:59:59',
			"sellerId": '${(sellerId)!}',
			"isGift": 'true'
		}		
		urlSelect(params,params2,type); 
    }
    
    function endDaySelect(obj,type) {
		var params = {
    		"startDate": $(obj).parent().find('#startDay').val(),
			"endDate": $(obj).val() + ' 23:59:59',
			"sellerId": '${(sellerId)!}'
		}
		var params2 = {
    		"startDate": $(obj).parent().find('#startDay').val(),
			"endDate": $(obj).val() + ' 23:59:59',
			"sellerId": '${(sellerId)!}',
			"isGift": 'true'
		}		
		urlSelect(params,params2,type); 
    }    
    
 	function dayTagSelect(obj,type) {
      $.actions({
        actions: [{
          text: "今日",
          onClick: function () {
			var params = {
				"dayTag": 'today',
				"sellerId": '${(sellerId)!}'
			}
			var params2 = {
				"dayTag": 'today',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
			urlSelect(params,params2,type); 
            $(obj).find(".dayTagText").text('今日')
            $("#dayTag").val("today");
          }
        }, {
          text: "昨日",
          onClick: function () {
			var params = {
				"dayTag": 'yesterday',
				"sellerId": '${(sellerId)!}'
			}
			var params2 = {
				"dayTag": 'yesterday',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
          	urlSelect(params,params2,type); 
            $(obj).find(".dayTagText").text('昨日')
            $("#dayTag").val("yesterday");
          }
        }, {
          text: "本周",
          onClick: function () {
			var params = {
				"dayTag": 'week',
				"sellerId": '${(sellerId)!}'
			}
			var params2 = {
				"dayTag": 'week',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
			urlSelect(params,params2,type); 			
          	$(obj).find(".dayTagText").text('本周')
          	$("#dayTag").val("week");
          }
        }, {
          text: "上周",
          onClick: function () {
			var params = {
				"dayTag": 'lastweek',
				"sellerId": '${(sellerId)!}'
			}
			var params2 = {
				"dayTag": 'lastweek',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
			urlSelect(params,params2,type); 
          $(obj).find(".dayTagText").text('上周')
          $("#dayTag").val("lastweek");
          }
        }, {
          text: "本月",
          onClick: function () {
			var params = {
				"dayTag": 'month',
				"sellerId": '${(sellerId)!}'
			}     
			var params2 = {
				"dayTag": 'month',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
			urlSelect(params,params2,type);     
         	$(obj).find(".dayTagText").text('本月')
         	$("#dayTag").val("month");
          }
        }, {
          text: "上月",
          onClick: function () {
			var params = {
				"dayTag": 'lastmonth',
				"sellerId": '${(sellerId)!}'
			}         
			var params2 = {
				"dayTag": 'lastmonth',
				"sellerId": '${(sellerId)!}',
				"isGift": 'true'
			}			
			urlSelect(params,params2,type); 			
          	$(obj).find(".dayTagText").text('上月')
          	$("#dayTag").val("lastmonth");
          }
        }]
      }); 	
 	}  
</#macro>
<@layout>
	<div class="weui-content">
		<div class="report">
			<div class="weui-panel weui-panel_access report-header">
				<div class="weui-panel__hd">
					<span class="overview-hd-title">${sellerName!}销售简报</span>
					<span class="briefly" onclick="dayTagSelect(this,'order')">
						<p class="dayTagText">今日</p>
						<i class="icon-angle-down"></i>
					</span>
					<input type="hidden" id="dayTag">
					<input class="weui-input end-date fr" type="text" id="endDay" onchange="endDaySelect(this,'order')" readonly="">
					<span class="overview-hd-segmenting fr"> - </span>
					<input class="weui-input begin-date fr" type="text" id="startDay" onchange="startDaySelect(this,'order')" readonly="">
				</div>
				<div class="weui-panel__bd">
					<div class="weui-flex overview-block">
						<div class="weui-flex__item">
							<div class="overview-title">
								<img src="${CTPATH}/images/order.png">
								<span>订单总数</span>
							</div>
							<div class="t-c">
								<strong id="productCount"></strong>
								<small id="totalCount"></small>
							</div>
						</div>
						<div class="weui-flex__item">
							<div class="overview-title">
								<img src="${CTPATH}/images/money.png">
								<span>订单金额</span>
							</div>
							<div class="t-c">
								<strong id="totalAmount"></strong>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="weui-panel weui-panel_access">
				<div class="weui-panel__hd pro t-c">
					商品销售统计
					<!--<div>
					<span class="briefly" onclick="dayTagSelect(this,'product')">
					<p class="dayTagText">今日</p>
						<i class="icon-angle-down"></i>
					</span> <input class="weui-input end-date fr" type="text" id="endDay" onchange="endDaySelect(this,'product')" readonly="">
					<span class="overview-hd-segmenting fr"> - </span> <input
						class="weui-input begin-date fr" type="text" id="startDay" onchange="startDaySelect(this,'product')" readonly="">
				</div>-->
				</div>
				<div class="weui-cells weui-cells_form mg-0">
					<div class="weui-cell" style="padding: 0">
						<table class="table table-striped table-bordered mg-0" id="productCount">
							<tbody>

							</tbody>
						</table>
					</div>
					<!-- 				<a class="report-detail" onClick="proDetail()">详情></a> -->
				</div>
			</div>			
			<div class="weui-panel weui-panel_access">
				<div class="weui-panel__hd ft16 t-c">
					业务员统计
				</div>
				<div class="weui-panel__bd report-area border-top-1px relative">
					<div class="weui-media-box ft14">
						<div id="userCount" style="height: 300px;">

						</div>
					</div>
					<div class="read-more">
						点击柱子可查看详情
					</div>
				</div>
			</div>
			<div class="weui-panel weui-panel_access">
				<div class="weui-panel__hd ft16 t-c">
					赠品统计
				</div>
				<div class="weui-panel__bd report-area border-top-1px">
					<div class="weui-media-box ft14">
						<div id="giftCount" style="height: 300px;">

						</div>
					</div>
				</div>
			</div>
		</div>
		<#include "_inc/_footer_nav.html" />
	</div>
</@layout>