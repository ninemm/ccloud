<#include "_inc/_layout.html"/>
<#macro title>客户列表</#macro>
<#macro css>
    #customer {
        background: #f3f5f7;
    }
</#macro>
<#macro script_import>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Ec4VbDTTjjuEGtVGzSvPwwQtvnvWFeGY"></script>
</#macro>

<#macro script>
    var pageNumber = 2;
    var pageSize = 10;
    var loading = false;

    var $endNode = null;
    var $loadmore = $(".weui-loadmore");

    $(function() {

    		<#if history??>
  			var region = getItemBykey("region");
  			var customerType = getItemBykey("customerType");
  			var ifOrder = getItemBykey("ifOrder");
  			var keywordName = getItemBykey("keyword");
  			$("#region").val(region);
  			$("#customer-type").val(customerType);
  			$("#if-order").val(ifOrder);
            if(keywordName !=null && keywordName.length!=0) {
                $('.weui-search-bar').addClass('weui-search-bar_focusing');
  			    $("#searchInput").val(keywordName);
                }
  		<#else>
  			clearStorage();
  		</#if>
  		refresh();
    		$(document).on("input", "#searchInput", function() {
			setItemBykey("keyword", $("#searchInput").val());
			refresh();
		}).on("change", "#region", function() {
			setItemBykey("regionId", $("#region").data('values'));
			setItemBykey("region", $("#region").val());
			refresh();
		}).on("change", "#customer-type", function() {
			setItemBykey("customerTypeId", $("#customer-type").data('values'));
			setItemBykey("customerType", $("#customer-type").val());
			refresh();
		}).on("change", "#if-order", function() {
			setItemBykey("ifOrderId", $("#if-order").data('values'));
			setItemBykey("ifOrder", $("#if-order").val());
			refresh();
		});
    

        //筛选项获取
        $.ajax({
            url:"${CPATH}/customer/getCustomerRegionAndType",
            type:"post",
            dataType:"json",
            success:function(data) {

                $("#region").select({
                title: "选择业务员",
                items: data.region
                });

                $("#customer-type").select({
                title: "选择客户类型",
                items: data.customerType
                });

                $("#if-order").select({
                    title: "是否下单",
                    items: [{
                        title: "全部客户", value: ""
                        },{
                        title: "已下单", value: "0"
                        },{
                        title: "未下单", value: "1"
                        },{
                        title: "近一周未下单", value: "2"
                        },{
                        title: "近一月未下单", value: "3"
                        },{
                        title: "近三月未下单", value: "4"
                        },{
                        title: "近六月未下单", value: "5"
                    }]
                });

                var str = '';
                for(var i = 0; i < data.searchArea.length; i++)
                    if(i == 0) str = str + '<span class="red-button" data-id="' + data.searchArea[i].value + '">'+ data.searchArea[i].title + '</span>';
                    else str = str + '<span data-id="' + data.searchArea[i].value + '">'+ data.searchArea[i].title + '</span>';
                $("#getDate").append(str);
            }
        });
    });

    var paramData = function() {
		<#if !history??>
			return  {
			    "searchKey": $("#searchInput")[0].value,
			    "pageNumber": pageNumber,
			    "pageSize": pageSize,
			    "region": $("#region")[0].dataset.values,
			    "customerType": $("#customer-type")[0].dataset.values,
			    "isOrdered": $("#if-order")[0].dataset.values
			};
		<#else>
			var region = getItemBykey("regionId");
  			var customerType = getItemBykey("customerTypeId");
  			var ifOrder = getItemBykey("ifOrderId");
  			var keywordName = getItemBykey("keyword");
			return  {
			    "searchKey": keywordName,
			    "pageNumber": pageNumber,
			    "pageSize": pageSize,
			    "region": region,
			    "customerType": customerType,
			    "isOrdered": ifOrder
			};
       </#if>
    }

    //监听滚动
    $(".infinite").infinite().on("infinite", function() {
        var self = this;
        $endNode = $(".weui-panel_access:last");
        $loadmore = $(self).find(".weui-loadmore");
        if ($loadmore) $loadmore.show();
        if (loading) return ;
        loading = true;

        $.ajax({
            type: "post",
            url: "${CPATH}/customer/refresh",
            data: paramData(),
            dataType: "json",
            success:function(data) {
                if ($loadmore) $loadmore.show();
                if (data.totalPage >= pageNumber) {
                    $endNode.after(data.html);
                }
                if (data.totalPage == pageNumber) {
                    $(".infinite").destroyInfinite();
                    $loadmore.hide();
                }
                pageNumber++;
                loading = false;
            }
        });
    });

    function refresh() {
        pageNumber = 1;
        $.ajax({
            url:"${CPATH}/customer/refresh",
            type:"post",
            data:paramData(),
            dataType:"json",
            success:function(data) {
                $(".weui-loadmore").hide();
                $(".infinite").destroyInfinite();

                if (data.totalPage > pageNumber) {
                    loading = false;
                    $(".infinite").infinite();
                }

                $(".infinite")[0].scrollTop = 0;
                $("#customerList").empty();
                if(data.html.length == 0) data.html = data.html +'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';
                $("#customerList").html(data.html);
                pageNumber = 2;
            }
        });
    }

    var paramData2 = function() {
        return  {
            "searchArea": $("#getDate").find(".red-button").data("id"),
            "lon": $('#lon').val(),
            "lat": $('#lat').val()
        }
    }

    function reset() {
        $("#searchInput")[0].value = '';
        $("#customer-type")[0].dataset.values = '';
        $("#region")[0].dataset.values = '';
        $("#if-order")[0].dataset.values = '';
        $("#customer-type").val("客户类型");
        $("#region").val("客户区域");
        $("#if-order").val("是否下单");
    }

    function getAreaCustomer(){
        reset();
        pageNumber = 1;
        $.ajax({
            url:"${CPATH}/customer/getAreaCustomer",
            type:"post",
            data:paramData2(),
            dataType:"json",
            success:function(data) {
                $(".infinite").destroyInfinite();
                $(".weui-loadmore").hide();
                loading = false;

                $(".infinite")[0].scrollTop = 0;
                $("#customerList").empty();
                if(data.html.length == 0) data.html = data.html +'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';
                $("#customerList").html(data.html);
                pageNumber = 2;
            }
        });
    }

    function newOrder(customer){
        setItemBykey("customerInfo", customer);
        window.location.href = '${CPATH}/product';
    }

    function newVisit(customer){
        setItemBykey("customerInfo", customer);
        window.location.href = '${CPATH}/customerVisit/edit';
    }

    wx.config({
        debug: false,
        appId: '${appId!}',
        timestamp: ${timestamp},
        nonceStr: '${nonceStr!}',
        signature: '${signature!}',
        jsApiList: [
            'checkJsApi',
            'getLocation'
        ]
    });

    wx.ready(function() {
        // 获取定位信息
        wx.getLocation({
            type: 'wgs84',
            success: function (res) {
                var latitude = res.latitude;                      // 纬度，浮点数，范围为90 ~ -90
                var longitude = res.longitude;                    // 经度，浮点数，范围为180 ~ -180。
                var speed = res.speed;                            // 速度，以米/每秒计
                var accuracy = res.accuracy;                      // 位置精度

                var point = new BMap.Point(longitude, latitude);  // 将经纬度转化为百度经纬度
                var geoc = new BMap.Geocoder();                   // 获取百度地址解析器
                $("#lon").val(parseFloat(longitude).toFixed(2));
                $("#lat").val(parseFloat(latitude).toFixed(2));
            },
            cancel: function (res) {
                console.log('用户拒绝授权获取地理位置');
            },
            fail: function (res) {
                console.log(JSON.stringify(res));
            }
        });
    });

    //搜索框叉掉和取消时，先清input值，再调用接口
    function searchCancel() {
        $("#searchInput")[0].value = "";
        refresh();
    }
</#macro>

<@layout>
<div id="customer">
    <header>
        <div class="weui-search-bar" id="SearchBar">
            <form class="weui-search-bar__form">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索" required="">
                    <a href="javascript:" class="weui-icon-clear" id="searchClear" onclick="searchCancel()"></a>
                </div>
                <label class="weui-search-bar__label" id="searchText">
                    <i class="weui-icon-search"></i>
                    <span>请输入客户名或联系人</span>
                </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel" onclick="searchCancel()">取消</a>
        </div>
    </header>
    <article class="customer">
        <header class="has-th-list weui-flex">
            <div class="head-search select-area weui-flex__item">
                <div class="weui-flex">
                <div class="weui-flex__item">
                    <input type="text" id="region" placeholder="客户区域" class="weui-input" readonly>
                    <i class="icon-sort-desc"></i>
                </div>
                <div class="weui-flex__item">
                    <input type="text" id="customer-type" placeholder="客户类型" class="weui-input" readonly>
                    <i class="icon-sort-desc"></i>
                </div>
                <div class="weui-flex__item">
                    <input type="text" id="if-order" placeholder="是否下单" class="weui-input" readonly>
                    <i class="icon-sort-desc"></i>
                </div>
                    <input type="hidden" name="lon" id="lon">
                    <input type="hidden" name="lat" id="lat">
                </div>
            </div>
            <div id="combin-filter-btn">
                <i class="icon-th-list"></i>
            </div>
        </header>
	    <article  class="infinite">
	        <div id = "customerList">
	            <#if customerList??>
	                    <#list customerList.list as customer>
	                         <div class="weui-panel weui-panel_access">
	                            <div class="weui-flex">
	                                <a class="weui-flex__item customer-info" href="/customer/edit?sellerCustomerId=${(customer.sellerCustomerId)!}">
	                                    <p class="ft14">${(customer.customer_name)!}</p>
	                                    <p class="gray">${(customer.contact)!}/${(customer.mobile)!}</p>
	                                </a>
	                                <div class="weui-flex__item customer-href">
	                                    <div class="weui-flex">
	                                        <a href="tel:${(customer.mobile)!}"class="weui-flex__item">
	                                            <p>
	                                                <i class="icon-phone green"></i>
	                                            </p>
	                                            <p>电话</p>
	                                        </a>
	                                        <@shiro.hasPermission name="/admin/salesOrder">
	                                        <a class="weui-flex__item" href="${(CPATH)!}/customer/historyOrder?sellerCustomerId=${(customer.sellerCustomerId)!}&customerName=${(customer.customer_name)!}">
	                                            <p>
	                                                <i class="icon-file-text-o blue"></i>
	                                            </p>
	                                            <p>订单</p>
	                                        </a>
	                                        </@shiro.hasPermission>
	                                        <@shiro.hasPermission name="/admin/customerVisit">
	                                        <a class="weui-flex__item" href="${CPATH}/customerVisit/one?id=${(customer.sellerCustomerId)!}&name=${(customer.customer_name)!}">
	                                            <p>
	                                                <i class="icon-paw" style="color:#ff9800"></i>
	                                            </p>
	                                            <p>拜访</p>
	                                        </a>
	                                        </@shiro.hasPermission>
	                                        <a class="weui-flex__item relative" href="/customer/edit?sellerCustomerId=${(customer.sellerCustomerId)!}">
	                                            <i class="icon-chevron-right gray"></i>
	                                        </a>
	                                    </div>
	                                </div>
	                            </div>
	                            <hr />
	                            <div class="operate-btn">
	                            	<@shiro.hasPermission name="/admin/customerVisit/add">
	                                <div class="button white-button fl" onclick="newVisit({customerName:'${(customer.customer_name)}',
                                                                                            sellerCustomerId:'${(customer.sellerCustomerId)}',
                                                                                            contact:'${(customer.contact)}',
                                                                                            mobile:'${(customer.mobile)}',
                                                                                            address:'${(customer.address)}'})">客户拜访</div>
                                   	</@shiro.hasPermission>
                                   	<#if customer.customer_kind == '100402'>
                                    <div class="button red-button fr" onclick="newOrder({customerName:'${(customer.customer_name)}',
                                                                                            sellerCustomerId:'${(customer.sellerCustomerId)}',
                                                                                            contact:'${(customer.contact)}',
                                                                                            mobile:'${(customer.mobile)}',
                                                                                            address:'${(customer.address)}'})">下订单</div>
									<#else>
									<@shiro.hasPermission name="/admin/salesOrder/add">
                                    <div class="button red-button fr" onclick="newOrder({customerName:'${(customer.customer_name)}',
                                                                                            sellerCustomerId:'${(customer.sellerCustomerId)}',
                                                                                            contact:'${(customer.contact)}',
                                                                                            mobile:'${(customer.mobile)}',
                                                                                            address:'${(customer.address)}'})">下订单</div>
									</@shiro.hasPermission>									
									</#if>                                                                                    
	                            </div>
	                            <p class="gray">
	                                <span class="icon-map-marker ft16 green"></span>
	                                ${(customer.prov_name)!} ${(customer.city_name)!} ${(customer.country_name)!} ${(customer.address)!}
	                            </p>
	                        </div>
	                    </#list>
	            </#if>
	        </div>
            <#if customerList??>
	        <#if customerList.totalRow = 0>
	            <div class="weui-loadmore weui-loadmore_line">
	                <span class="weui-loadmore__tips">暂无数据</span>
	            </div>
	            <#elseif customerList.totalRow &gt; 10>
	                <div class="weui-loadmore">
	                    <i class="weui-loading"></i>
	                    <span class="weui-loadmore__tips">正在加载</span>
	                </div>
	        </#if>
            </#if>
	    </article>
    </article>
</div>
<@shiro.hasPermission name="/admin/sellerCustomer/edit">
<a class="hidden-menu" href="${CPATH}/customer/edit">
    <img src="${CTPATH}/images/customer_add.png" alt="">
</a>
</@shiro.hasPermission>
<div class="layer"></div>
<#include "_inc/_footer_nav.html" />
<article id="combin-filter">
    <div class="filter-item">
        <h4 class="ft14">选择搜索范围</h4>
        <div class="relative ft12" id="getDate">
        </div>
    </div>
    <footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
        <button class="white-button-no-border  cancel-search-btn weui-flex__item border-top-1px">取消</button>
        <button class="red-button confirm-search-btn weui-flex__item" onclick="getAreaCustomer()">确定</button>
    </footer>
</article>
</@layout>