<#include "_inc/_layout.html"/>
<#macro css> </#macro>

<#macro script>
$(function() {
  $(document).on("touchstart", "#customerName", function () {
		window.location.href = '${CPATH}/product/customerChoose';
  }).on("touchstart", "#placeOrder", function () {
		doSubmit();
  });

  initCustomer();
  $("#deliveryTime").calendar();
  initProduct();
  total();

})
var $form = $('#form');
var newHtml = $(".goods-detail").eq(0).html();
var $product = $("#productList");
var customerTypeInfoMap = [];

function initCustomer(){
	var customerInfo = getItemBykey("customerInfo");

	if(customerInfo){
		$("#sellerCustomerId").val(customerInfo.sellerCustomerId);
		$("#customerName").val(customerInfo.customerName);
		$("#contact").val(customerInfo.contact);
		$("#mobile").val(customerInfo.mobile);
		$("#address").val(customerInfo.address);
	
		$("#deliveryAddress").val(customerInfo.address);
		
		Utils.ajax('${CPATH}/product/customerTypeById', {"customerId" : customerInfo.sellerCustomerId}, 
			function(data){
				var items = [];
				$.each(data, function(index, el) {
					customerTypeInfoMap[el.id] = {
						id : el.id,
						name : el.name,
						code : el.code,
						factor : el.factor
					}
					
					items.push({
						title : el.name,
						value : el.id
					})
				});

				var $customerType = $("#customerType");
				$customerType.select({
			         title: "客户类型",
			         items: items,
			         onChange: function(data) {
			         	$("#customerTypeId").val(customerTypeInfoMap[data.values].id);
				        $("#customerTypeCode").val(customerTypeInfoMap[data.values].code);
				        $("#factor").val(customerTypeInfoMap[data.values].factor);
			         }
		        });
		        $customerType.val(items[0].title);
		        $customerType.attr('data-values', items[0].value);

		        $("#customerTypeId").val(customerTypeInfoMap[items[0].value].id);
		        $("#customerTypeCode").val(customerTypeInfoMap[items[0].value].code);
		        $("#factor").val(customerTypeInfoMap[items[0].value].factor);
			}
		);
	}

}

function initProduct(){
	var productList = getItemBykey("productList");
	$product.empty();
	$.each(productList, function(index, el) {
		$product.append("<div class='weui-panel weui-panel_access goods-detail'>" + newHtml + "</div>");
		var $newProductDetail = $product.find(".weui-panel:last");
		$newProductDetail.find("#productName").text(el.productName);
		$newProductDetail.find("#valueName").text(el.valueName);

		$newProductDetail.find("#bigPriceSpan").text(el.bigPriceSpan);
		$newProductDetail.find("#smallPriceSpan").text(el.smallPriceSpan);
		$newProductDetail.find("#bigUnitSpan").text(el.bigUnitSpan);
		$newProductDetail.find("#smallUnitSpan").text(el.smallUnitSpan);

		$newProductDetail.find("#bigPrice").val(el.bigPrice);
		$newProductDetail.find("#smallPrice").val(el.smallPrice);
		$newProductDetail.find("#bigUnit").val(el.bigUnit);
		$newProductDetail.find("#smallUnit").val(el.smallUnit);
		$newProductDetail.find("#sellProductId").val(el.sellProductId);
		$newProductDetail.find("#productId").val(el.productId);
		$newProductDetail.find("#convert").val(el.convert);
		
		$newProductDetail.find("#bigNum").val(el.bigNum);
		$newProductDetail.find("#smallNum").val(el.smallNum);

	});
}

	function total() {
		var products = $(".goods-detail");
		var total = 0;
		$.each(products, function(index, el) {
			total += $(el).find("#bigNum").val() * $(el).find("#bigPrice").val();
			total += $(el).find("#smallNum").val() * $(el).find("#smallPrice").val();
		});
		$("#totalNum").text("共" + products.length + "款,合计:" + total + "元")
	
	} 

	function doSubmit(){
		if ($("#sellerCustomerId").val() == "") {
			toastr.warning('请选择客户');
			return;
		}
	//	if (!checkStore()) {
	//		toastr.error('未选择商品或库存不足!','操作失败');
	//		return;
	//	}
		$form.ajaxSubmit({
			beforeSubmit: function() {
				return true
			},
			type : "post", 
			dataType : "json", 
			success : function(data) { 
				if (data.errorCode == 0) {
					//location.reload();
					toastr.success(data.message, '操作成功');
				} else {
					toastr.error(data.message,'操作失败');
				}
			},
			error : function() {
				alert("信息提交错误");
			}
		});
	}
</#macro>

<@layout>
<body id="order">
	<form action="${CPATH}/product/salesOrder" method="post" id="form">
		<main>
			<section class="weui-panel weui-panel_access order-customer-info">
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div class="order-customer-info-title">
							客户名称
							<span class="require">*</span>
						</div>
						<input type="hidden" id="sellerCustomerId" value="" >
						<input type="text" placeholder="请选择客户" class="weui-input" id="customerName" name="customerName" value="" readonly>
						<span class="weui-cell__ft"></span>
					</div>
				</div>
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div class="order-customer-info-title">
							联系人
							<span class="require">*</span>
						</div>
						<input type="text" placeholder="请输入客户信息" class="weui-input" id="contact" name="contact" value="" readonly>
					</div>
				</div>
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div class="order-customer-info-title">
							 电话号码
							<span class="require">*</span>
						</div>
						<input type="text" placeholder="请输入电话号码" class="weui-input" id="mobile" name="mobile" value="" readonly>
					</div>
				</div>
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div class="order-customer-info-title">
							详细地址
							<span class="require">*</span>
						</div>
						<input type="hidden" id="address" name="address" value="">
						<input type="text" placeholder="请输入详细地址" class="weui-input" id="deliveryAddress" name="deliveryAddress" value="" readonly>
					</div>
				</div>
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div class="order-customer-info-title">
							客户类型
							<span class="require">*</span>
						</div>
						<input type="hidden" id="customerTypeId" name="customerTypeId" value="">
						<input type="hidden" id="customerTypeCode" name="customerTypeCode" value="">
						<input type="hidden" id="factor" name="factor" value="">
						<input type="text" placeholder="请选择客户类型" class="weui-input" id="customerType" name="customerType" value="" readonly>
						<span class="weui-cell__ft"></span>
					</div>
				</div>
			</section>
			<section class="weui-panel weui-panel_access delivery-info">
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						配送时间
						<input type="text" placeholder="请选择配送时间" class="weui-input" data-toggle='date' id="deliveryTime" name="deliveryAddress" readonly>
						<span class="weui-cell__ft"></span>
					</div>
				</div>
			</section>
			<section class="weui-panel weui-panel_access ft14">
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<div>
							<input type="checkbox" name="receiveType" value="0"> 是否账期
						</div>
					</div>
				</div>
			</section>
			<section class="weui-panel weui-panel_access ft14 remark">
				<div class="weui-cell weui-cell_access">
					<div class="weui-cell__bd">
						<textarea name="remark" placeholder="备注说明（70字以内）"></textarea>
					</div>
				</div>
			</section>
			<div class="weui-cells__title black">商品明细</div>
			<div id="productList">
				<div class="weui-panel weui-panel_access goods-detail">
					<input type="hidden" name="sellProductId" id="sellProductId" value="">
					<input type="hidden" name="productId" id="productId" value="">
					<input type="hidden" name="convert" id="convert" value="">
					<div class="product_name" id="productName">
						35度中国劲酒_125ml_1*24
		<!-- 				<span class="gift-tag">赠品</span> -->
					</div>
					<div class="product_unit">
						规格：<span id="valueName">125ml</span>
					</div>
					<div class="product_bUnit">
						<span class="price" id="bigPriceSpan">￥725</span>
						<span class="unit" id="bigUnitSpan">&nbsp;/&nbsp;件</span>
						<div class="spinner">
							<input type="number" min="0" value="0" class="fl" id="bigNum" name="bigNum" disabled>
						</div>
						<input type="number" class="street-value"  id="bigPrice" value="720" name="bigPrice" disabled>
					</div>
					<div class="product_mUnit">
						<span class="price" id="smallPriceSpan">￥30</span>
						<span class="unit" id="smallUnitSpan">&nbsp;/&nbsp;瓶</span>
						<div class="spinner">
							<input type="number" min="0" value="0" class="fl" id="smallNum" name="smallNum" disabled>
						</div>
						<input type="number" class="street-value" value="30" id="smallPrice" name="smallPrice" disabled>
					</div>
					<hr />
					<div class="gift">
						<div>
							<input type="checkbox" name="add-gift" disabled>
							<span>添加赠品</span>
						</div>
						<div style="display:none">
							<div class="number">
			 					<span>数量</span>
									<div class="spinner">
										<div class="operate fl">
											<i class="icon-minus2"></i>
										</div>
										<input type="number" min="0" value="0" class="fl" disabled>
										<div class="operate fl">
											<i class="icon-plus2"></i>
										</div>
									</div>
							</div>
							<div class="number">
								<span>单位</span>
								<select disabled>
									<option>件</option>
									<option>瓶</option>
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
		<div class="hidden-menu">
			<ul>
				<li>
					<a href="index.html">
							首页
						<i class="icon-home blue"></i>
					</a>
				</li>
				<li>
					<a href="javascript:history.go(-1)">
							上一页
						<i class="icon-undo green"></i>
					</a>
				</li>
			</ul>
			<i class="icon-menu-open orange fr" id="button"></i>
		</div>
		<div class="layer"></div>
		<footer class="weui-footer weui-footer_fixed-bottom">
			<p class="total bg-gray" id="totalNum">共2款，总数10件&nbsp;总额：2600元</p>
			<a id="placeOrder" class="place-order bg-blue white">提交订单</a>
		</footer>
	</form>
</body>
</@layout>
