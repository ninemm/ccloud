<#include "_inc/_layout.html"/>
<#macro title>业务员拜访轨迹</#macro>
<#macro css>
#container {
    position: absolute;
    top:2rem;
    bottom:2.25rem;
    width:100%
}
    #combin-filter>.filter-item {
        margin: 1rem 0;
    }
    #list {
        position: absolute;
        top: 3rem;
        bottom: 2.25rem;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }
</#macro>

<#macro css_import>

</#macro>
<#macro script_import>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Ec4VbDTTjjuEGtVGzSvPwwQtvnvWFeGY"></script>
    <script type="text/javascript" src="${CTPATH}/js/convertor.js"></script>
    <script type="text/javascript" src="${CTPATH}/js/comm.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
</#macro>
<#macro script>

    var lng = 0;
    var lat = 0;
    var center;
    var startDate = $.today();
    var endDate = $.today() + ' 23:59:59';

    var map = new BMap.Map("container");

    function ComplexCustomOverlay(point,index){
        this._point = point;
        this._index = index;
    }

    ComplexCustomOverlay.prototype = new BMap.Overlay();

    ComplexCustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var span=this._span = document.createElement("span");

        //画图标中间的数字
        $(span).css({
            'position':'absolute',
            'zIndex':BMap.Overlay.getZIndex(this._point.lat),
            'display':'block',
            'width':'26px',
            'color':'#FFF',
            'text-align':'center',
            'font-size':'12px',
            'point-events':'none'
        });

        this._span.innerHTML = this._index;
        map.getPanes().labelPane.appendChild(span);
        return span;
    }

    ComplexCustomOverlay.prototype.draw = function(){
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._span.style.left = pixel.x - 14+'px';
        this._span.style.top  = pixel.y - 24+'px';
    }

    $(function() {

        initWxConfig('${appId!}', ${timestamp}, '${nonceStr!}', '${signature!}');

        wxReadyGetLocation(
            function(lng, lat, addComp, address) {
                lng = lng.toFixed(6);
                lat = lat.toFixed(6);
                center = new BMap.Point(lng, lat);
                map.centerAndZoom(center, 15);
                map.enableScrollWheelZoom(true);
                layer.closeAll();
            }
        )
        refresh();
        $(document).on("change", "#customer", function() {
            refresh();
        }).on("change", "#date", function() {
            getDateOrder();
        }).off("click", "#combin-filter .confirm-search-btn")
        .on("click", "#combin-filter .confirm-search-btn", function() {
            startDate = $('#start-date').val();
            endDate = startDate + ' 23:59:59';
            setItemBykey("startDate", startDate);
            setItemBykey("endDate", endDate);
            refresh();
        })

        $("#start-date").calendar({
            maxDate: function() {
                return $.today();
            }
        });

        $("#start-date").val($.today());

        /*$("#end-date").calendar({
            minDate: function() {
                var date = new Date($('#start-date').val().replace(/-/g,"/"));
                date.setDate(date.getDate() - 1);
                return date.Format("yyyy-MM-dd")
            }
        });

        $("#end-date").val($.today());*/

        $('#date').select({
            title: '选择时间',
            items: [{
                title: '今天', value: '0'
                },{title: "昨天", value: "1"
                },{title: "前天", value: "2"
            }]
        })
        $('#customer').select({
            title:'选择业务员',
            items: ${users}
        })
    })

    function getDateOrder(){
        var dateType = $("#date").data('values');
        var date = new Date();
        if(dateType == 0){
            startDate = $.today();
        }else if(dateType == 1){
            date.setDate(date.getDate() - 1);
            startDate = date.Format("yyyy-MM-dd");
        }else if(dateType == 2){
            date.setDate(date.getDate() - 2);
            startDate = date.Format("yyyy-MM-dd");
        }
        endDate = startDate + ' 23:59:59';

        refresh();
    }

    function refresh(){
        layer.open({
            type: 2,
            content: '加载中...'
        });
        var url = "${CPATH}/customerVisit/trajectoryRefresh?userId=" + $("#customer")[0].dataset.values + "&startDate=" + startDate + "&endDate=" + endDate;
        $.get(url, function(result){
            map.clearOverlays();//清除所有标注
            if(result.length>0) {
                center = new BMap.Point(result[0].lng, result[0].lat);//坐标点
                map.centerAndZoom(center, 15);
                render(result);
            } else {
                if(lng != 0 && lat != 0) {
                    map.centerAndZoom(center, 15);
                    map.enableScrollWheelZoom(true);
                    layer.closeAll();
                }
            }
        })
    }

    function render(result){
        layer.open({
            type: 2,
            content: '加载中...'
        });
        map.enableScrollWheelZoom(true);
        var visitList = result;
        var pointArray = [];
        for(var i = 0; i < visitList.length; i++)
        {
            var point = new BMap.Point(visitList[i].lng, visitList[i].lat);
            pointArray.push(point);
            var marker = new BMap.Marker(point);

            map.addOverlay(marker);
            var opts = {
                width : 240,     // 信息窗口宽度
                height: 110,     // 信息窗口高度
                title : '客户名称：' + visitList[i].customer_name
            };

            var content = "拜访时间：" + visitList[i].create_date + "<br>";
            content = content + "客户类型：" + visitList[i].customerTypeName + "<br>";
            content = content + "拜访类型：" + visitList[i].name;

            addClickHandler(content,marker,opts);

            var myCompOverlay = new ComplexCustomOverlay(point,i+1);
            map.addOverlay(myCompOverlay);
        }

        var polyline = new BMap.Polyline(pointArray,{strokeColor:"#0066ff", strokeWeight:4, strokeOpacity:1});
        map.addOverlay(polyline);

        var str ="<div class='filter-item'><div class='weui-cell'>共拜访：" + result.length + "家</div>";
        str = str +"<div id='operate-history'><div class='weui-cells mg-0'>";
        for(var i = 0; i < visitList.length; i++)
        {
            str = str + "<div class='weui-cell weui-cell_access'><div></div><p>" + visitList[i].customer_name
                + "<e class='fr'>" + visitList[i].customerTypeName + "</e></p><p>" + visitList[i].create_date
                + "<e class='fr'>" + visitList[i].name + "</e></p></div>";
        }
        str = str + "</div></div> </div>"
        $("#list").empty();
        $("#list").append(str);
        layer.closeAll();
    }

    function addClickHandler(content,marker,opts){
        marker.addEventListener("click",function(e){
            var p = e.target;
            var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);

            var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象

            map.openInfoWindow(infoWindow,point);
        });
    }

</#macro>
<@layout>
<div class="weui-content">
    <article class="ft14">
        <header class="weui-flex">
            <div class="head-search select-area weui-flex__item">
                <div class="weui-flex__item">
                    <input type="text" id="customer" data-values="${(userId)!}" value="${(userName)!}" placeholder="业务员" class="weui-input" readonly >
                    <i class="icon-sort-desc"></i>
                </div>
                <div class="weui-flex__item">
                    <input type="text" id="date" placeholder="今天" class="weui-input" readonly>
                    <i class="icon-sort-desc border-right-1px"></i>
                </div>
            </div>
            <div id="combin-filter-btn">
                <i class="icon-th-list"></i>
            </div>
        </header>
    </article>
    <div id="container">
    </div>
</div>

<article id="combin-filter">
    <div class="filter-item">
        <div class="relative weui-flex" style="padding: 0 0.5rem;" id="getDate">
            <div>拜访日期：</div>
            <input type="text" id="start-date" class="weui-input weui-flex__item" readonly>
            <!--<div style="width:1rem" class="t-c">—</div>-->
            <!--<input type="text" id="end-date" class="weui-input weui-flex__item" readonly>-->
        </div>
    </div>
    <div id="list"></div>
    <footer class="weui-footer weui-footer_fixed-bottom ft16 weui-flex">
        <button class="white-button-no-border  cancel-search-btn weui-flex__item border-top-1px">取消</button>
        <button class="red-button confirm-search-btn weui-flex__item">确定</button>
    </footer>
</article>
<div class="layer"></div>

<#include "_inc/_goback_bottom.html" />

</@layout>