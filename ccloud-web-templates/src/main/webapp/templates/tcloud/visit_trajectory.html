<#include "_inc/_layout.html"/>
<#macro title>业务员拜访轨迹</#macro>
<#macro css>
</#macro>

<#macro css_import>

</#macro>
<#macro script_import>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Ec4VbDTTjjuEGtVGzSvPwwQtvnvWFeGY"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
</#macro>
<#macro script>

    var startDate = $.today();
    var endDate = $.today() + ' 23:59:59';

    var map = new BMap.Map("container");
    var point = new BMap.Point(114.35, 30.53);//坐标点
    map.centerAndZoom(point, 15);
    map.enableScrollWheelZoom(true);

    function ComplexCustomOverlay(point,index){
        this._point = point;
        this._index=index;
    }

    ComplexCustomOverlay.prototype = new BMap.Overlay();

    ComplexCustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var span=this._span=document.createElement("span");

        $(span).css({
            'position':'absolute',
            'zIndex':BMap.Overlay.getZIndex(this._point.lat),
            'display':'block',
            'width':'26px',
            'color':'#FFF',
            'text-align':'center',
            'font-size':'12px',
            'point-events':'none'
        });

        this._span.innerHTML=this._index;
        map.getPanes().labelPane.appendChild(span);
        return span;
    }

    ComplexCustomOverlay.prototype.draw = function(){
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._span.style.left = pixel.x - 14+'px';
        this._span.style.top  = pixel.y - 24+'px';
    }

    $(function() {
        refresh();
        $(document).on("change", "#customer", function() {
            refresh();
        }).on("change", "#date", function() {
            getDateOrder();
        })
        $('#date').select({
            title: '选择时间',
            items: [{
                title: '今天', value: '0'
                },{title: "最近3天", value: "1"
                },{title: "最近7天", value: "2"
                },{title: "最近30天", value: "3"
            }]
        })
        $('#customer').select({
            title:'选择业务员',
            items: ${users}
        })
    })

    function getDateOrder(){
        var dateType = $("#date").data('values');
        var date = new Date();
        if(dateType == 0){
            startDate = $.today();
        }else if(dateType == 1){
            date.setDate(date.getDate() - 3);
            startDate = date.Format("yyyy-MM-dd");
        }else if(dateType == 2){
            date.setDate(date.getDate() - 7);
            startDate = date.Formaft("yyyy-MM-dd");
        }else if(dateType == 3){
            date.setDate(date.getDate() - 30);
            startDate = date.Format("yyyy-MM-dd");
        }

        endDate = $.today() + ' 23:59:59';
        refresh();
    }

    function refresh(){
        var url = "${CPATH}/customerVisit/trajectoryRefresh?userId=" + $("#customer")[0].dataset.values + "&startDate=" + startDate + "&endDate=" + endDate;
        $.get(url, function(result){
            map.clearOverlays();
            var point = new BMap.Point(114.35, 30.53);//坐标点
            map.centerAndZoom(point, 15);
            map.enableScrollWheelZoom(true);
            var visitList = result;
            var pointArray = [];
            for(var i = 1; i <= visitList.length; i++)
                {
                    //var point = new BMap.Point(visitList[i-1].lng + (i-1)*0.01, visitList[i-1].lat + (i-1)*0.01);
                    var point = new BMap.Point(visitList[i-1].lng, visitList[i-1].lat);
                    pointArray.push(point);
                    var marker = new BMap.Marker(point);
                    map.addOverlay(marker);
                    var myCompOverlay = new ComplexCustomOverlay(point,i);
                    map.addOverlay(myCompOverlay);
                }
            var polyline = new BMap.Polyline(pointArray,{strokeColor:"blue", strokeWeight:2, strokeOpacity:0.7});
            map.addOverlay(polyline);
        })
    }
</#macro>
<@layout>
<div class="weui-content">
    <article class="ft14">
        <header class=" weui-flex">
            <div class="head-search select-area weui-flex__item">
                <div class="weui-flex__item">
                    <input type="text" id="customer" data-values="" placeholder="业务员" class="weui-input" readonly >
                    <i class="icon-sort-desc"></i>
                </div>
                <div class="weui-flex__item">
                    <input type="text" id="date" placeholder="今天" class="weui-input" readonly>
                    <i class="icon-sort-desc"></i>
                </div>
            </div>
            <div id="combin-filter-btn">
                <i class="icon-th-list"></i>
            </div>
        </header>
    </article>
    <div id="container" style="height: 100%">
    </div>
</div>


<!--<div id="combin-filter-btn">-->
    <!--<i class="icon-th-list"></i>-->
<!--</div>-->
<#include "_inc/_goback_bottom.html" />

</@layout>