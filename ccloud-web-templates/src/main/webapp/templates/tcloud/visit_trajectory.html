<#include "_inc/_layout.html"/>
<#macro title>业务员拜访轨迹</#macro>
<#macro css>
</#macro>

<#macro css_import>

</#macro>
<#macro script_import>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Ec4VbDTTjjuEGtVGzSvPwwQtvnvWFeGY"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
</#macro>
<#macro script>

    var lng;
    var lat;
    var startDate = $.today();
    var endDate = $.today() + ' 23:59:59';

    var map = new BMap.Map("container");

    function ComplexCustomOverlay(point,index){
        this._point = point;
        this._index=index;
    }

    ComplexCustomOverlay.prototype = new BMap.Overlay();

    ComplexCustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var span=this._span=document.createElement("span");

        $(span).css({
            'position':'absolute',
            'zIndex':BMap.Overlay.getZIndex(this._point.lat),
            'display':'block',
            'width':'26px',
            'color':'#FFF',
            'text-align':'center',
            'font-size':'12px',
            'point-events':'none'
        });

        this._span.innerHTML=this._index;
        map.getPanes().labelPane.appendChild(span);
        return span;
    }

    ComplexCustomOverlay.prototype.draw = function(){
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._span.style.left = pixel.x - 14+'px';
        this._span.style.top  = pixel.y - 24+'px';
    }

    $(function() {
        refresh();
        $(document).on("change", "#customer", function() {
            refresh();
        }).on("change", "#date", function() {
            getDateOrder();
        })
        $('#date').select({
            title: '选择时间',
            items: [{
                title: '今天', value: '0'
                },{title: "最近3天", value: "1"
                },{title: "最近7天", value: "2"
                },{title: "最近30天", value: "3"
            }]
        })
        $('#customer').select({
            title:'选择业务员',
            items: ${users}
        })
    })

    function getDateOrder(){
        var dateType = $("#date").data('values');
        var date = new Date();
        if(dateType == 0){
            startDate = $.today();
        }else if(dateType == 1){
            date.setDate(date.getDate() - 3);
            startDate = date.Format("yyyy-MM-dd");
        }else if(dateType == 2){
            date.setDate(date.getDate() - 7);
            startDate = date.Formaft("yyyy-MM-dd");
        }else if(dateType == 3){
            date.setDate(date.getDate() - 30);
            startDate = date.Format("yyyy-MM-dd");
        }

        endDate = $.today() + ' 23:59:59';
        refresh();
    }

    function refresh(){
        var url = "${CPATH}/customerVisit/trajectoryRefresh?userId=" + $("#customer")[0].dataset.values + "&startDate=" + startDate + "&endDate=" + endDate;
        $.get(url, function(result){
            if(result.length>0) var point = new BMap.Point(result[0].lng, result[0].lat);//坐标点
            else var point = new BMap.Point(lng, lat);
            map.centerAndZoom(point, 15);
            map.enableScrollWheelZoom(true);
            var visitList = result;
            var pointArray = [];
            for(var i = 1; i <= visitList.length; i++)
                {
                    //var point = new BMap.Point(visitList[i-1].lng + (i-1)*0.01, visitList[i-1].lat + (i-1)*0.01);
                    var point = new BMap.Point(visitList[i-1].lng, visitList[i-1].lat);
                    pointArray.push(point);
                    var marker = new BMap.Marker(point);
                    map.addOverlay(marker);
                    var myCompOverlay = new ComplexCustomOverlay(point,i);
                    map.addOverlay(myCompOverlay);
                }
            var polyline = new BMap.Polyline(pointArray,{strokeColor:"blue", strokeWeight:2, strokeOpacity:0.7});
            map.addOverlay(polyline);
        })
    }

    wx.config({
        debug: false,
        appId: '${appId!}',
        timestamp: '${timestamp!}',
        nonceStr: '${nonceStr!}',
        signature: '${signature!}',
        jsApiList: [
            'checkJsApi',
            'getLocation'
        ]
    });

    wx.ready(function() {
        // 获取定位信息
        wx.getLocation({
            type: 'wgs84',
            success: function (res) {
                var latitude = res.latitude;                      // 纬度，浮点数，范围为90 ~ -90
                var longitude = res.longitude;                    // 经度，浮点数，范围为180 ~ -180。
                lng = parseFloat(longitude).toFixed(6);
                lat = parseFloat(latitude).toFixed(6);

                var speed = res.speed;                            // 速度，以米/每秒计
                var accuracy = res.accuracy;                      // 位置精度

                var point = new BMap.Point(longitude, latitude);  // 将经纬度转化为百度经纬度
                var geoc = new BMap.Geocoder();                   // 获取百度地址解析器

                setTimeout(function() {
                    BMap.Convertor.translate(point, 0, translateCallback);//真实经纬度转成百度坐标
                }, 100);
            },
            cancel: function (res) {
                console.log('用户拒绝授权获取地理位置');
            },
            fail: function (res) {
                console.log(JSON.stringify(res));
            }
        });
    });
</#macro>
<@layout>
<div class="weui-content">
    <article class="ft14">
        <header class=" weui-flex">
            <div class="head-search select-area weui-flex__item">
                <div class="weui-flex__item">
                    <input type="text" id="customer" data-values="${(userId)!}" value="${(userName)!}" placeholder="业务员" class="weui-input" readonly >
                    <i class="icon-sort-desc"></i>
                </div>
                <div class="weui-flex__item">
                    <input type="text" id="date" placeholder="今天" class="weui-input" readonly>
                    <i class="icon-sort-desc border-right-1px"></i>
                </div>
            </div>
            <div id="combin-filter-btn">
                <i class="icon-th-list"></i>
            </div>
        </header>
    </article>
    <div id="container" style="height: 100%">
    </div>
</div>

<article id="combin-filter">
    <div class="filter-item">
        <div class="weui-cell">
            今日拜访：20家
        </div>
        <div id="operate-history">
            <div class="weui-cells mg-0">
                <div class="weui-cell weui-cell_access">
                    <div></div>
                    <p>华润万家
                        <e class="fr">商超</e>
                    </p>
                    <p>2018-02-02</p>
                </div>
                <div class="weui-cell weui-cell_access">
                    <p>老王</p>
                    <p>2018-02-02</p>
                    <div></div>
                </div>
                <div class="weui-cell weui-cell_access">
                    <p>小张</p>
                    <p>2018-02-02</p>
                    <div></div>
                </div>
            </div>
        </div>
    </div>
</article>
<div class="layer"></div>

<#include "_inc/_goback_bottom.html" />

</@layout>