<#include "_inc/_layout.html"/>
<#macro title>附近客户</#macro>
<#macro css> 
	#customer {
		bottom: 2.25rem;
	}
	#customerList {
		position: absolute;
		top: 2rem;
		bottom: 0;
		overflow: auto;
		-webkit-overflow-scrolling: touch;
		width: 100%;
	}
	.customer {
		width: 100%;
		top: 0;
	}
	.head-search i {
		border: 0;
	}
</#macro>
<#macro script_import>
	<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Ec4VbDTTjjuEGtVGzSvPwwQtvnvWFeGY"></script>
	<script type="text/javascript" src="${CTPATH}/js/convertor.js"></script>
</#macro>
<#macro script>


    $(function() {

		initWxConfig('${appId!}', '${timestamp!}', '${nonceStr!}', '${signature!}');

		wxReadyGetLocation(
			function(lng, lat, addComp, address) {
				$loading.show();
				$noMore.hide();
				$("#lng").val(lng.toFixed(6));
				$("#lat").val(lat.toFixed(6));
				combo();
			}
		)
        //搜索框监听
        $(document).on("change", "#searchArea", function() {
            combo();
        }).on("click", "#customerInfo", function() {
			var el = $(this);
	        var customerInfo = {
	        	customerName : el.find("#customerName").text(),
	        	sellerCustomerId : el.find("#sellerCustomerId").val(),
	        	contact : el.find("#contact").val(),
	        	mobile : el.find("#mobile").val(),
	        	address : el.find("#address").val()
	        }
	        setItemBykey("customerInfo", customerInfo)
	        window.location.href = '${CPATH}/product/order';
        });
         
       //combo();

    });

    //筛选项获取
    $("#searchArea").select({
     title: "选择搜索范围",
     items:${(areaCoverage)!}
    });
    
	var newHtml = $(".weui-panel").eq(0).html();
	var $loading = $("#loading");
	var $noMore = $("#noMore");
	var loading = false;
    
    var keyword = '';
    var page = 1;
	var size = 10;

	var $customerList = $("#customerList");
	$customerList.empty();
	
    
    function initCustomer() {
    	$loading.show();
		$noMore.hide();

	    var params = {
		    "page": page,
	        "size": size,
	        "dist": $("#searchArea").data('values'),
			"lng": $('#lng').val(),
			"lat": $('#lat').val()
	    }

		Utils.ajax('${CPATH}/product/customerNearbyChoseRefresh', params,
			function(data){
				$loading.hide();
				if(data.customerList.length == 0){
					$noMore.show();
					loading = true;
					return;
				}
				$.each(data.customerList, function(index, el) {
					$customerList.append("<div class='weui-panel weui-panel_access'>" + newHtml + "</div>");
					var $newCustomer = $customerList.find(".weui-panel:last");
					$newCustomer.find("#customerName").text(el.customer_name);
					$newCustomer.find("#contactP").text(el.contact + "/" + el.mobile);
					$newCustomer.find("#addressSpan").text(el.prov_name + " " + el.city_name + " " + el.country_name + " " + el.address);

					$newCustomer.find("#sellerCustomerId").val(el.id);
					$newCustomer.find("#contact").val(el.contact);
					$newCustomer.find("#mobile").val(el.mobile);
					$newCustomer.find("#address").val(el.prov_name + " " + el.city_name + " " + el.country_name + " " + el.address);
				});
				page++;
				loading = false;
			}
		);
    }

	//滑动方法
	$("main").infinite().on("infinite", function() {
		if(loading) {
			return;
		}
		loading = true;
		initCustomer();
	});
	
	function combo() {
		$customerList.empty();
		loading = false;
		page = 1;
		initCustomer();
	}

</#macro>

<@layout>
<div class="weui-content">
	<div id="customer">
		<article class="customer">
			<header class="has-th-list weui-flex">
				<div class="head-search select-area weui-flex__item relative">
                    <input type="text" id="searchArea" class="weui-input" placeholder="附近客户" readonly>
                    <i class="icon-sort-desc"></i>
				</div>
				<input type="hidden" name="lng" id="lng">
				<input type="hidden" name="lat" id="lat">
			</header>
				<div id="customerList">
					<div class="weui-panel weui-panel_access" style="display: none">
					<div class="weui-flex">
						<div class="weui-flex__item customer-info" id="customerInfo">
							<p class="ft14" id="customerName">小张烤鱼</p>
							<p class="gray" id="contactP">小张/18611111111</p>
							<input type="hidden" id="sellerCustomerId" value="">
							<input type="hidden" id="contact" value="">
							<input type="hidden" id="mobile" value="">
							<input type="hidden" id="address" value="">
						</div>
					</div>
					<p class="gray">
						<span class="icon-map-marker ft16 green"></span>
						<span id="addressSpan">湖北省 武汉市 江汉区 德盛街</span>
					</p>
				</div>
			</div>
				<div class="weui-loadmore" id="loading" style="display: none;">
				<i class="weui-loading"></i>
				<span class="weui-loadmore__tips">正在加载</span>
				</div>
				<div class="weui-loadmore weui-loadmore_line" id="noMore" style="display: none;">
				<span class="weui-loadmore__tips">暂无数据</span>
				</div>				
		</article>
	</div>
	<#include "_inc/_goback_bottom.html" />
</div>
</@layout>

